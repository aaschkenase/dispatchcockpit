<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
  <title>Tag Driver Command Center</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0f172a; --card:#1e293b; --border:#334155;
      --accent:#38bdf8; --text:#f8fafc; --muted:#94a3b8;
      --success:#22c55e; --danger:#ef4444; --warning:#eab308;
      --soft: rgba(255,255,255,0.06);
    }
    *{box-sizing:border-box;font-family:'Segoe UI',system-ui,sans-serif}
    body{margin:0;background:var(--bg);color:var(--text);padding-bottom:50px}
    .container{max-width:1400px;margin:0 auto;padding:15px}

    /* Top bar */
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap}
    .brand{font-size:24px;font-weight:900;letter-spacing:-1px}
    .mini{font-size:11px;color:var(--muted);font-weight:800}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#020617;border:1px solid var(--border);padding:8px 10px;border-radius:999px;color:var(--muted);font-size:12px;font-weight:800}

    .controls{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
    .control-block{display:flex;flex-direction:column;gap:6px}
    select,input{
      width:100%; background:#020617; border:1px solid var(--border); color:#fff;
      padding:10px; border-radius:10px; font-weight:800;
    }
    select:focus,input:focus{border-color:var(--accent);outline:none;box-shadow:0 0 0 3px rgba(56,189,248,0.15)}
    .btnSmall{
      border:1px solid var(--border); background:#020617; color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:900;
    }
    .btnSmall:hover{border-color:var(--accent)}
    .btnSmall.danger{border-color:var(--danger);color:var(--danger)}
    .btnSmall.danger:hover{background:var(--danger);color:#fff}

    /* Status/warn */
    .status-msg{
      font-size:12px;color:var(--warning);display:none;font-weight:900;
      background:rgba(234,179,8,0.12);padding:10px 12px;border-radius:12px;border:1px solid rgba(234,179,8,0.35)
    }
    .warn-banner{
      display:none;margin-bottom:14px;padding:12px 14px;border-radius:14px;
      border:1px solid rgba(239,68,68,0.35);background:rgba(239,68,68,0.10);
      font-weight:900;color:#fecaca
    }
    .warn-banner b{color:#fff}

    /* Nav */
    nav{display:flex;gap:10px;margin-bottom:14px;border-bottom:2px solid var(--border);padding-bottom:10px;overflow-x:auto}
    .nav-btn{padding:10px 20px;background:transparent;border:none;color:var(--muted);font-weight:900;cursor:pointer;border-radius:10px;transition:.2s;white-space:nowrap}
    .nav-btn.active{background:var(--accent);color:#000}
    .tab-content{display:none}
    .tab-content.active{display:block}

    /* Layout */
    .dash-grid{display:grid;grid-template-columns:420px 1fr;gap:20px}
    @media (max-width:1050px){.dash-grid{grid-template-columns:1fr}}

    /* Cards */
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;margin-bottom:20px;overflow:hidden}
    .card-header{background:var(--soft);padding:12px 15px;font-weight:1000;font-size:12px;color:var(--accent);text-transform:uppercase;letter-spacing:1px}
    .card-body{padding:15px}
    .input-row{display:flex;gap:10px;margin-bottom:12px}
    .input-group{flex:1}
    label{display:block;font-size:11px;color:var(--muted);margin-bottom:4px;font-weight:1000;text-transform:uppercase}
    input{width:100%;background:#020617;border:1px solid var(--border);color:#fff;padding:10px;border-radius:10px;font-weight:800}

    /* Stats */
    .stats-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:18px}
    .stat-box{background:var(--card);border:1px solid var(--border);padding:15px;border-radius:14px}
    .stat-label{font-size:11px;color:var(--muted);text-transform:uppercase;font-weight:1000}
    .stat-val{font-size:24px;font-weight:1100}
    .pos{color:var(--success)} .neg{color:var(--danger)}

    /* Map */
    #map{height:520px;width:100%;border-radius:14px;border:1px solid var(--border);z-index:0}

    /* Table */
    table{width:100%;border-collapse:collapse;font-size:13px}
    th{text-align:left;color:var(--muted);padding:10px;border-bottom:1px solid var(--border);font-size:11px;text-transform:uppercase;font-weight:1000}
    td{padding:10px;border-bottom:1px solid var(--border)}
    .action-btn{background:transparent;border:1px solid var(--border);color:var(--accent);cursor:pointer;padding:6px 10px;border-radius:10px;font-size:11px;font-weight:1000;text-transform:uppercase}
    .action-btn:hover{background:var(--accent);color:#000}
    .delete-btn{color:var(--danger);border-color:var(--danger)}
    .delete-btn:hover{background:var(--danger);color:#fff}

    /* Buttons */
    .btn{width:100%;padding:12px;border:none;border-radius:12px;font-weight:1000;cursor:pointer;margin-top:10px}
    .btn-primary{background:var(--accent);color:#000}
    .btn-tool{
      background:#334155;color:var(--accent);margin-top:5px;font-size:12px;padding:10px;border:1px solid var(--border);
      cursor:pointer;border-radius:12px;font-weight:1000
    }
    .btn-tool:hover{background:var(--card);border-color:var(--accent)}

    /* Modal */
    #modal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--card);border:1px solid var(--accent);
      padding:20px;border-radius:14px;z-index:1000;width:92%;max-width:460px;box-shadow:0 0 60px rgba(0,0,0,.8)}
    #overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:999}
    .breakdown-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:14px}

    /* Sticky add (mobile) */
    .sticky-add{
      display:none;position:fixed;bottom:12px;left:12px;right:12px;z-index:998;
      background:var(--card);border:1px solid var(--border);border-radius:16px;padding:10px;box-shadow:0 12px 40px rgba(0,0,0,.35)
    }
    @media (max-width:1050px){.sticky-add{display:block} body{padding-bottom:120px}}

    /* PRINT */
    #printArea{display:none}
    @media print{
      nav,.no-print,.sticky-add,#status,.warn-banner{display:none!important}
      body{background:#fff;color:#000}
      .container{max-width:none}
      #map{display:none!important}
      #printArea{display:block}
      #printArea *{color:#000!important}
      #printArea h1,#printArea h2,#printArea h3{margin:0 0 8px 0}
      #printArea .pCard{border:1px solid #ccc;border-radius:10px;padding:12px;margin:10px 0}
      #printArea table{width:100%;border-collapse:collapse}
      #printArea th,#printArea td{border-bottom:1px solid #ddd;padding:8px;font-size:11px}
      #printArea .pGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
      #printArea .pStat{border:1px solid #ddd;border-radius:10px;padding:10px}
      #printArea .right{text-align:right}
    }
  </style>
</head>
<body>

<div id="overlay" onclick="closeModal()"></div>
<div id="modal" role="dialog" aria-modal="true" aria-label="Trip Financials">
  <h3 style="margin-top:0;color:var(--accent)">Trip Financials</h3>
  <div id="modal-content"></div>
  <button class="btn btn-primary" onclick="closeModal()">Close</button>
</div>

<!-- Print-only -->
<div id="printArea"></div>

<div class="container">
  <header class="topbar">
    <div class="brand">TAG<span style="color:var(--accent)">DRIVER</span>PRO</div>

    <div class="controls no-print">
      <div class="control-block" style="min-width:240px;max-width:72vw;">
        <div class="mini">Driver</div>
        <select id="driverSelect" onchange="onDriverChange()"></select>
      </div>

      <button class="btnSmall" onclick="addDriver()">‚ûï Add Driver</button>
      <button class="btnSmall danger" onclick="removeDriver()">üóëÔ∏è Remove Driver</button>

      <div class="control-block" style="min-width:240px;max-width:72vw;">
        <div class="mini">Week</div>
        <select id="weekSelect" onchange="onWeekChange()"></select>
      </div>

      <button class="btnSmall" onclick="startNewWeek()">‚ûï Start New Week</button>
      <button class="btnSmall danger" onclick="resetCurrentWeek()">üßπ Clear This Week</button>

      <span class="pill">Data stays on this device</span>
    </div>

    <div id="status" class="status-msg">Processing...</div>
  </header>

  <div id="warn" class="warn-banner"></div>

  <nav class="no-print">
    <button class="nav-btn active" onclick="showTab('dashboard', this)">Dashboard & Map</button>
    <button class="nav-btn" onclick="showTab('analytics', this)">Yearly Reports</button>
    <button class="nav-btn" onclick="showTab('settings', this)">Settings & Costs</button>
  </nav>

  <div id="dashboard" class="tab-content active">
    <div class="stats-bar">
      <div class="stat-box"><div class="stat-label">Weekly Gross</div><div class="stat-val" id="wk_gross">$0.00</div></div>
      <div class="stat-box"><div class="stat-label">Weekly Miles</div><div class="stat-val" id="wk_miles">0</div></div>
      <div class="stat-box"><div class="stat-label">Net Profit</div><div class="stat-val pos" id="wk_profit">$0.00</div></div>
      <div class="stat-box"><div class="stat-label">Avg RPM (Gross)</div><div class="stat-val" id="wk_rpm">$0.00</div></div>
      <div class="stat-box"><div class="stat-label">Break-even RPM</div><div class="stat-val" id="wk_be_rpm">$0.00</div></div>
    </div>

    <div class="dash-grid">
      <div>
        <div class="card no-print">
          <div class="card-header">New Trip Entry (for selected driver)</div>
          <div class="card-body">
            <div class="input-row">
              <div class="input-group"><label>Pickup</label><input id="origin" placeholder="City, State" autocomplete="off" /></div>
              <div class="input-group"><label>Drop</label><input id="dest" placeholder="City, State" autocomplete="off" /></div>
            </div>

            <div style="display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap;">
              <button class="btn-tool" onclick="calcRoute()">üì° Get Miles</button>
              <button class="btn-tool" onclick="verifyMap()">üó∫Ô∏è Verify</button>
              <button class="btn-tool" onclick="checkTolls()">üí∞ Tolls</button>
              <button class="btn-tool" onclick="swapCities()">üîÅ Swap</button>
            </div>

            <div class="input-row">
              <div class="input-group"><label>Loaded Mi</label><input id="mi_load" type="number" inputmode="numeric" min="0" step="1" oninput="preview()"></div>
              <div class="input-group"><label>Deadhead</label><input id="mi_dh" type="number" inputmode="numeric" min="0" step="1" oninput="preview()"></div>
              <div class="input-group"><label>Tolls ($)</label><input id="cost_tolls" type="number" inputmode="decimal" min="0" step="0.01" value="0" oninput="preview()"></div>
            </div>
            <div class="input-row">
              <div class="input-group"><label>Gross Pay ($)</label><input id="pay_gross" type="number" inputmode="decimal" min="0" step="0.01" oninput="preview()"></div>
            </div>

            <div style="background:#020617;padding:12px;border-radius:12px;margin-bottom:10px;text-align:center;border:1px solid var(--border);">
              <span style="font-size:11px;color:var(--muted);text-transform:uppercase;font-weight:1000;">Trip Net Preview</span>
              <div id="preview_net" style="font-size:22px;font-weight:1100;color:var(--text);margin-top:4px;">$0.00</div>
              <div id="preview_hint" class="mini" style="margin-top:6px;"></div>
            </div>

            <button class="btn btn-primary" onclick="addLoad()">Add Load to Week</button>
            <div class="mini" style="margin-top:10px;">Tip: after clicking <b>Get Miles</b>, you can still adjust deadhead/tolls manually.</div>
          </div>
        </div>

        <div class="card no-print">
          <div class="card-header">Quick Actions</div>
          <div class="card-body" style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btnSmall" onclick="copySummary()">üìã Copy Weekly Summary</button>
            <button class="btnSmall" onclick="exportCSV('week')">‚¨áÔ∏è Export Week CSV</button>
            <button class="btnSmall" onclick="printWeeklySummary()">üñ®Ô∏è Print Weekly Summary</button>
          </div>
        </div>
      </div>

      <div>
        <div class="card">
          <div class="card-header">Weekly Route Map</div>
          <div class="card-body" style="padding:0;">
            <div id="map"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Weekly Load Log</div>
      <div style="overflow-x:auto;">
        <table>
          <thead><tr><th>Route</th><th>Miles</th><th>Gross</th><th>Net</th><th>Gross RPM</th><th>Actions</th></tr></thead>
          <tbody id="loadList"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="analytics" class="tab-content">
    <div class="stats-bar">
      <div class="stat-box"><div class="stat-label">YTD Gross</div><div class="stat-val" id="ytd_gross">$0.00</div></div>
      <div class="stat-box"><div class="stat-label">YTD Net Profit</div><div class="stat-val pos" id="ytd_profit">$0.00</div></div>
      <div class="stat-box"><div class="stat-label">Est. Tax</div><div class="stat-val neg" id="ytd_tax">$0.00</div></div>
      <div class="stat-box"><div class="stat-label">Operating Expense Ratio</div><div class="stat-val" id="oer_val">0%</div></div>
    </div>

    <div class="card">
      <div class="card-header">Business Health (Selected Driver)</div>
      <div class="card-body">
        <div class="breakdown-row"><span>Total Fuel Spend (YTD):</span><span id="ytd_fuel" class="neg">$0.00</span></div>
        <div class="breakdown-row"><span>Total Maintenance Saved (YTD):</span><span id="ytd_maint" class="pos">$0.00</span></div>
        <div class="breakdown-row"><span>Best Week Net:</span><span id="best_week" class="pos">$0.00</span></div>
        <div class="breakdown-row"><span>Worst Week Net:</span><span id="worst_week" class="neg">$0.00</span></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Week History (Selected Driver)</div>
      <div style="overflow-x:auto;">
        <table>
          <thead><tr><th>Week</th><th>Loads</th><th>Miles</th><th>Gross</th><th>Net</th><th>Gross RPM</th></tr></thead>
          <tbody id="weekHistory"></tbody>
        </table>
      </div>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;" class="no-print">
      <button class="btnSmall" onclick="exportCSV('ytd')">‚¨áÔ∏è Export YTD CSV</button>
      <button class="btnSmall" onclick="printDriverYTD()">üñ®Ô∏è Print Driver YTD</button>
      <button class="btnSmall danger" onclick="factoryReset()">Factory Reset Data</button>
    </div>
  </div>

  <div id="settings" class="tab-content">
    <div class="dash-grid">
      <div class="card">
        <div class="card-header">Fixed Weekly Costs</div>
        <div class="card-body">
          <div class="input-row"><div class="input-group"><label>Truck Pmt</label><input id="f_truck" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
          <div class="input-row"><div class="input-group"><label>Trailer Pmt</label><input id="f_trailer" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
          <div class="input-row"><div class="input-group"><label>Insurance</label><input id="f_ins" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
          <div class="mini" style="margin-top:10px;">Fixed costs are split across loads using ‚ÄúLoads per week‚Äù below.</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Variable Weekly Deductions</div>
        <div class="card-body">
          <div class="input-row"><div class="input-group"><label>Advances</label><input id="f_adv" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
          <div class="input-row"><div class="input-group"><label>Food/Personal</label><input id="f_food" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
          <div class="input-row"><div class="input-group"><label>Repairs (Actual)</label><input id="f_rep" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
          <div class="mini" style="margin-top:10px;">Tip: keep ‚ÄúRepairs‚Äù for true out-of-pocket repairs; maintenance savings is calculated per mile.</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Specs, Rates & Goals</div>
        <div class="card-body">
          <div class="input-row"><div class="input-group"><label>Split % (0.80)</label><input id="s_split" type="number" inputmode="decimal" min="0" max="1" step="0.01"></div></div>
          <div class="input-row"><div class="input-group"><label>Fuel Price ($/gal)</label><input id="s_fuel" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
          <div class="input-row"><div class="input-group"><label>MPG</label><input id="s_mpg" type="number" inputmode="decimal" min="0.1" step="0.1"></div></div>
          <div class="input-row"><div class="input-group"><label>Maint ($/mi)</label><input id="s_maint" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
          <div class="input-row"><div class="input-group"><label>Loads per Week (for fixed split)</label><input id="s_loads_per_week" type="number" inputmode="numeric" min="1" step="1"></div></div>
          <div class="input-row"><div class="input-group"><label>Target Net / Week</label><input id="s_target_net" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
          <div class="input-row"><div class="input-group"><label>Tax Rate (0.25)</label><input id="s_tax" type="number" inputmode="decimal" min="0" max="1" step="0.01"></div></div>
          <button class="btn btn-primary no-print" onclick="saveSettings()">Save Settings</button>
          <div class="mini" style="margin-top:10px;">Privacy: this tool stores data in your browser (local). Use ‚ÄúFactory Reset‚Äù if you‚Äôre switching phones/devices.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="sticky-add no-print">
  <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
    <div>
      <div class="mini">Trip preview</div>
      <div id="sticky_preview" style="font-weight:1100;font-size:18px;">$0.00</div>
    </div>
    <button class="btnSmall" onclick="addLoad()" style="border-color:var(--accent);">Add Load</button>
  </div>
</div>

<script>
/*************************
 * STORAGE
 *************************/
const STORE_KEY = "tagdriverpro_v2_state";
const SETTINGS_KEY = "tagdriverpro_v2_settings";
const GEO_CACHE_KEY = "tagdriverpro_v2_geo_cache";

const defaultSettings = {
  f_truck: 800, f_trailer: 400, f_ins: 350,
  f_adv: 0, f_food: 0, f_rep: 0,
  s_split: 0.80, s_fuel: 3.25, s_mpg: 6.5, s_maint: 0.17,
  s_loads_per_week: 5, s_target_net: 1500, s_tax: 0.25
};

function startOfWeekMonday(date = new Date()){
  const d = new Date(date);
  const day = d.getDay();
  const diff = (day === 0 ? -6 : 1 - day);
  d.setDate(d.getDate() + diff);
  d.setHours(0,0,0,0);
  return d;
}
function isoDate(d){
  const x = new Date(d);
  const yyyy = x.getFullYear();
  const mm = String(x.getMonth()+1).padStart(2,"0");
  const dd = String(x.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function fmtWeekLabel(dateObj){
  const d = new Date(dateObj);
  const m = d.toLocaleString(undefined, { month: "short" });
  return `Week of ${m} ${d.getDate()}, ${d.getFullYear()}`;
}
function nowStamp(){
  const d = new Date();
  return d.toLocaleString();
}

function loadSettings(){
  const raw = localStorage.getItem(SETTINGS_KEY);
  const s = raw ? JSON.parse(raw) : {};
  return { ...defaultSettings, ...s };
}
function persistSettings(s){
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
}

function migrateOrCreateState(){
  const raw = localStorage.getItem(STORE_KEY);
  if (raw) return JSON.parse(raw);

  // Fresh state with one default driver
  const wk = startOfWeekMonday(new Date());
  const baseId = isoDate(wk);

  const driverId = "driver_1";
  const state = {
    currentDriverId: driverId,
    drivers: {
      [driverId]: {
        name: "Driver 1",
        currentWeekId: baseId,
        weeks: {
          [baseId]: { start: baseId, label: fmtWeekLabel(wk), loads: [], lastDropCoords: null }
        }
      }
    }
  };
  localStorage.setItem(STORE_KEY, JSON.stringify(state));
  return state;
}

let state = migrateOrCreateState();
let settings = loadSettings();

function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

function getDriver(){
  const id = state.currentDriverId;
  if (!state.drivers[id]) {
    // safety fallback
    const keys = Object.keys(state.drivers);
    state.currentDriverId = keys[0];
    saveState();
  }
  return state.drivers[state.currentDriverId];
}
function getCurrentWeek(){
  const d = getDriver();
  const wkId = d.currentWeekId;
  if (!d.weeks[wkId]) {
    const base = wkId.split("_")[0];
    const dt = new Date(base + "T00:00:00");
    d.weeks[wkId] = { start: base, label: fmtWeekLabel(dt), loads: [], lastDropCoords: null };
    saveState();
  }
  return d.weeks[d.currentWeekId];
}

/*************************
 * UI HELPERS
 *************************/
function money(v){
  const n = Number(v);
  const safe = Number.isFinite(n) ? n : 0;
  return "$" + safe.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function setStatus(msg, show=true){
  const el = document.getElementById("status");
  el.innerText = msg;
  el.style.display = show ? "block" : "none";
}
function showTab(id, btn){
  document.querySelectorAll('.tab-content').forEach(d=>d.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
  if (id === "dashboard") setTimeout(initMap, 200);
}

/*************************
 * DRIVER MENU
 *************************/
function renderDriverSelect(){
  const sel = document.getElementById("driverSelect");
  const ids = Object.keys(state.drivers);
  sel.innerHTML = ids.map(id => {
    const d = state.drivers[id];
    const selected = (id === state.currentDriverId) ? "selected" : "";
    return `<option value="${id}" ${selected}>${escapeHtml(d.name)}</option>`;
  }).join("");
}
function onDriverChange(){
  const sel = document.getElementById("driverSelect");
  state.currentDriverId = sel.value;
  saveState();
  renderWeekSelect();
  updateUI();
  setTimeout(initMap, 150);
}
function addDriver(){
  const name = prompt("Driver name (ex: John Smith):");
  if (!name) return;

  const ids = Object.keys(state.drivers);
  const nextNum = ids.length + 1;
  const id = `driver_${Date.now()}_${nextNum}`;

  const wk = startOfWeekMonday(new Date());
  const baseId = isoDate(wk);

  state.drivers[id] = {
    name: name.trim(),
    currentWeekId: baseId,
    weeks: {
      [baseId]: { start: baseId, label: fmtWeekLabel(wk), loads: [], lastDropCoords: null }
    }
  };
  state.currentDriverId = id;
  saveState();
  renderDriverSelect();
  renderWeekSelect();
  updateUI();
  setTimeout(initMap, 150);
}
function removeDriver(){
  const d = getDriver();
  if (!confirm(`Remove driver "${d.name}" and all their data on THIS device?`)) return;
  const ids = Object.keys(state.drivers);
  if (ids.length <= 1) return alert("You must keep at least one driver.");

  delete state.drivers[state.currentDriverId];
  const remaining = Object.keys(state.drivers);
  state.currentDriverId = remaining[0];
  saveState();
  renderDriverSelect();
  renderWeekSelect();
  updateUI();
  setTimeout(initMap, 150);
}

/*************************
 * WEEK MENU (per driver)
 *************************/
function renderWeekSelect(){
  const sel = document.getElementById("weekSelect");
  const d = getDriver();
  const ids = Object.keys(d.weeks).sort().reverse();
  sel.innerHTML = ids.map(id=>{
    const w = d.weeks[id];
    const selected = (id === d.currentWeekId) ? "selected" : "";
    return `<option value="${id}" ${selected}>${escapeHtml(w.label || id)}</option>`;
  }).join("");
}
function onWeekChange(){
  const sel = document.getElementById("weekSelect");
  const id = sel.value;
  const d = getDriver();
  if (!d.weeks[id]) return;
  d.currentWeekId = id;
  saveState();
  updateUI();
  setTimeout(initMap, 150);
}

// Always create a brand-new week (even same calendar week), per driver
function startNewWeek(){
  if (!confirm("Start a new week for this driver? Current week will remain saved.")) return;

  const d = getDriver();
  const base = startOfWeekMonday(new Date());
  const baseId = isoDate(base);
  let id = baseId;

  let counter = 1;
  while (d.weeks[id]) {
    counter++;
    id = baseId + "_v" + counter;
  }

  d.weeks[id] = {
    start: baseId,
    label: fmtWeekLabel(base) + (counter > 1 ? ` (${counter})` : ""),
    loads: [],
    lastDropCoords: null
  };

  d.currentWeekId = id;
  saveState();
  renderWeekSelect();
  updateUI();
  setTimeout(initMap, 150);
}

function resetCurrentWeek(){
  const wk = getCurrentWeek();
  if (!confirm("Clear all loads for this week?")) return;
  wk.loads = [];
  wk.lastDropCoords = null;
  saveState();
  updateUI();
  initMap();
}

/*************************
 * SETTINGS
 *************************/
function bindSettingsToInputs(){
  const s = settings;
  document.getElementById('f_truck').value = s.f_truck;
  document.getElementById('f_trailer').value = s.f_trailer;
  document.getElementById('f_ins').value = s.f_ins;
  document.getElementById('f_adv').value = s.f_adv;
  document.getElementById('f_food').value = s.f_food;
  document.getElementById('f_rep').value = s.f_rep;

  document.getElementById('s_split').value = s.s_split;
  document.getElementById('s_fuel').value = s.s_fuel;
  document.getElementById('s_mpg').value = s.s_mpg;
  document.getElementById('s_maint').value = s.s_maint;
  document.getElementById('s_loads_per_week').value = s.s_loads_per_week;
  document.getElementById('s_target_net').value = s.s_target_net;
  document.getElementById('s_tax').value = s.s_tax;

  document.querySelectorAll("#settings input").forEach(inp => inp.addEventListener("input", ()=>{
    preview(); updateUI();
  }));
}
function saveSettings(){
  const s = {
    f_truck: parseFloat(document.getElementById('f_truck').value) || 0,
    f_trailer: parseFloat(document.getElementById('f_trailer').value) || 0,
    f_ins: parseFloat(document.getElementById('f_ins').value) || 0,
    f_adv: parseFloat(document.getElementById('f_adv').value) || 0,
    f_food: parseFloat(document.getElementById('f_food').value) || 0,
    f_rep: parseFloat(document.getElementById('f_rep').value) || 0,
    s_split: parseFloat(document.getElementById('s_split').value) || 0.8,
    s_fuel: parseFloat(document.getElementById('s_fuel').value) || 3.25,
    s_mpg: parseFloat(document.getElementById('s_mpg').value) || 6.5,
    s_maint: parseFloat(document.getElementById('s_maint').value) || 0.17,
    s_loads_per_week: Math.max(1, parseInt(document.getElementById('s_loads_per_week').value || "5", 10)),
    s_target_net: parseFloat(document.getElementById('s_target_net').value) || 1500,
    s_tax: parseFloat(document.getElementById('s_tax').value) || 0.25
  };
  settings = { ...defaultSettings, ...s };
  persistSettings(settings);
  alert("Settings saved on this device.");
  updateUI();
}

/*************************
 * CALCS
 *************************/
function getSpecs(){
  const split = parseFloat(document.getElementById('s_split').value);
  const fuel  = parseFloat(document.getElementById('s_fuel').value);
  const mpg   = parseFloat(document.getElementById('s_mpg').value);
  const maint = parseFloat(document.getElementById('s_maint').value);
  const loadsPerWeek = Math.max(1, parseInt(document.getElementById('s_loads_per_week').value || "5", 10));
  const targetNet = parseFloat(document.getElementById('s_target_net').value);
  const taxRate = parseFloat(document.getElementById('s_tax').value);

  const fixedWeekly = ['f_truck','f_trailer','f_ins','f_adv','f_food','f_rep']
    .reduce((sum,id)=> sum + (parseFloat(document.getElementById(id).value)||0), 0);

  return {
    split: Number.isFinite(split) ? split : 0.80,
    fuel: Number.isFinite(fuel) ? fuel : 3.25,
    mpg: (Number.isFinite(mpg) && mpg>0) ? mpg : 6.5,
    maint: Number.isFinite(maint) ? maint : 0.17,
    fixedWeekly,
    loadsPerWeek,
    fixedPerLoad: fixedWeekly / loadsPerWeek,
    targetNet: Number.isFinite(targetNet) ? targetNet : 1500,
    taxRate: Number.isFinite(taxRate) ? taxRate : 0.25
  };
}

function computeWeekTotals(week){
  const loads = week.loads || [];
  const gross = loads.reduce((s,l)=>s+(Number(l.gross)||0),0);
  const miles = loads.reduce((s,l)=>s+(Number(l.miles)||0),0);
  const net   = loads.reduce((s,l)=>s+(Number(l.net)||0),0);
  const fuel  = loads.reduce((s,l)=>s+(Number(l.details?.fuel)||0),0);
  const maint = loads.reduce((s,l)=>s+(Number(l.details?.maint)||0),0);
  const tolls = loads.reduce((s,l)=>s+(Number(l.details?.tolls)||0),0);
  const fixed = loads.reduce((s,l)=>s+(Number(l.details?.fixed)||0),0);
  const rpm   = miles>0 ? gross/miles : 0;
  return { gross,miles,net,fuel,maint,tolls,fixed,rpm };
}

function preview(){
  const s = getSpecs();
  const gross = parseFloat(document.getElementById('pay_gross').value) || 0;
  const miles = (parseFloat(document.getElementById('mi_load').value)||0) + (parseFloat(document.getElementById('mi_dh').value)||0);
  const tolls = parseFloat(document.getElementById('cost_tolls').value) || 0;

  const fuel = (miles / s.mpg) * s.fuel;
  const maint = miles * s.maint;
  const fixed = s.fixedPerLoad;
  const net = (gross * s.split) - fuel - maint - fixed - tolls;

  const el = document.getElementById('preview_net');
  el.innerText = money(net);
  el.style.color = net >= 0 ? 'var(--success)' : 'var(--danger)';

  const grossRpm = miles>0 ? gross/miles : 0;
  const beGross = miles>0 ? ((fuel + maint + fixed + tolls) / s.split) : 0;
  const beRpm = miles>0 ? (beGross/miles) : 0;
  document.getElementById('preview_hint').innerText = miles>0 ? `Gross RPM: ${money(grossRpm)} ‚Ä¢ Break-even RPM: ${money(beRpm)}` : "";

  document.getElementById('sticky_preview').innerText = money(net);
  document.getElementById('sticky_preview').style.color = net >= 0 ? 'var(--success)' : 'var(--danger)';
}

function updateWarnBanner(){
  const s = getSpecs();
  const wk = getCurrentWeek();
  const t = computeWeekTotals(wk);

  const warn = document.getElementById("warn");
  if (wk.loads.length > 0 && t.net < s.targetNet) {
    const gap = s.targetNet - t.net;
    warn.style.display = "block";
    warn.innerHTML = `‚ö†Ô∏è Target not met for <b>${escapeHtml(getDriver().name)}</b>: goal <b>${money(s.targetNet)}</b> ‚Ä¢ currently <b>${money(t.net)}</b> ‚Ä¢ gap <b>${money(gap)}</b>.`;
  } else {
    warn.style.display = "none";
    warn.innerHTML = "";
  }
}

/*************************
 * LOAD CRUD
 *************************/
function addLoad(){
  const originEl = document.getElementById('origin');
  const destEl = document.getElementById('dest');

  const origin = originEl.value.trim();
  const dest = destEl.value.trim();
  const gross = parseFloat(document.getElementById('pay_gross').value) || 0;

  const miles = (parseFloat(document.getElementById('mi_load').value)||0) + (parseFloat(document.getElementById('mi_dh').value)||0);
  const tolls = parseFloat(document.getElementById('cost_tolls').value) || 0;

  if (!origin || !dest) return alert("Enter pickup & drop first.");
  if (gross <= 0 || miles <= 0) return alert("Enter miles and gross pay.");

  const oLat = Number(originEl.dataset.lat);
  const oLon = Number(originEl.dataset.lon);
  const dLat = Number(destEl.dataset.lat);
  const dLon = Number(destEl.dataset.lon);

  const s = getSpecs();
  const fuel = (miles / s.mpg) * s.fuel;
  const maint = miles * s.maint;
  const fixed = s.fixedPerLoad;
  const cut = gross * s.split;
  const net = cut - fuel - maint - fixed - tolls;

  let routeGeo = null;
  try { routeGeo = JSON.parse(originEl.dataset.routeGeo || "null"); } catch(e){ routeGeo=null; }

  const wk = getCurrentWeek();
  wk.loads.push({
    origin, dest, gross, miles, net,
    createdAt: new Date().toISOString(),
    details: { fuel, maint, fixed, tolls, cut, split: s.split, mpg: s.mpg, fuelPrice: s.fuel, maintRate: s.maint, loadsPerWeek: s.loadsPerWeek },
    coords: (Number.isFinite(oLat) && Number.isFinite(dLat)) ? { start:{lat:oLat, lon:oLon}, end:{lat:dLat, lon:dLon} } : null,
    routeGeo
  });

  if (Number.isFinite(dLat) && Number.isFinite(dLon)) wk.lastDropCoords = { lat: dLat, lon: dLon };
  else wk.lastDropCoords = null;

  saveState();
  updateUI();
  initMap();

  ['origin','dest','mi_load','mi_dh','cost_tolls','pay_gross'].forEach(i => document.getElementById(i).value="");
  originEl.dataset.lat=""; originEl.dataset.lon=""; originEl.dataset.routeGeo="";
  destEl.dataset.lat=""; destEl.dataset.lon="";
  document.getElementById('preview_net').innerText="$0.00";
  document.getElementById('preview_hint').innerText="";
  document.getElementById('sticky_preview').innerText="$0.00";
}

function delLoad(i){
  const wk = getCurrentWeek();
  wk.loads.splice(i,1);

  if (wk.loads.length === 0) wk.lastDropCoords = null;
  else {
    const last = wk.loads[wk.loads.length-1];
    if (last?.coords?.end?.lat && last?.coords?.end?.lon) wk.lastDropCoords = { lat:last.coords.end.lat, lon:last.coords.end.lon };
  }

  saveState();
  updateUI();
  initMap();
}

/*************************
 * MODAL
 *************************/
function viewDetail(i){
  const wk = getCurrentWeek();
  const l = wk.loads[i];
  if (!l) return;

  document.getElementById('modal-content').innerHTML = `
    <div class="breakdown-row"><span>Gross:</span><span>${money(l.gross)}</span></div>
    <div class="breakdown-row"><span>Your Cut:</span><span class="pos">${money(l.details?.cut || (l.gross*(l.details?.split||getSpecs().split)))}</span></div>
    <div class="breakdown-row"><span>Fuel:</span><span class="neg">-${money(l.details?.fuel || 0)}</span></div>
    <div class="breakdown-row"><span>Fixed Share:</span><span class="neg">-${money(l.details?.fixed || 0)}</span></div>
    <div class="breakdown-row"><span>Maint:</span><span class="neg">-${money(l.details?.maint || 0)}</span></div>
    <div class="breakdown-row"><span>Tolls:</span><span class="neg">-${money(l.details?.tolls || 0)}</span></div>
    <div class="breakdown-row" style="font-weight:1100;font-size:18px;border-top:2px solid var(--accent);margin-top:10px;">
      <span>NET PROFIT:</span><span class="${(l.net||0)>=0?'pos':'neg'}">${money(l.net)}</span>
    </div>
    <div class="mini" style="margin-top:10px;">
      Miles: <b>${Number(l.miles||0).toLocaleString()}</b> ‚Ä¢ Gross RPM: <b>${money(l.miles>0 ? l.gross/l.miles : 0)}</b>
    </div>
  `;
  document.getElementById('modal').style.display='block';
  document.getElementById('overlay').style.display='block';
}
function closeModal(){
  document.getElementById('modal').style.display='none';
  document.getElementById('overlay').style.display='none';
}

/*************************
 * MAP
 *************************/
let map = null;
function initMap(){
  if (!map){
    map = L.map('map').setView([39.82,-98.58],4);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{ attribution:'¬© OpenStreetMap' }).addTo(map);
  }
  map.eachLayer(layer => { if (layer && layer.toGeoJSON) map.removeLayer(layer); });

  const wk = getCurrentWeek();
  const pts = [];
  wk.loads.forEach((l,i)=>{
    if (l.coords && l.coords.start && l.coords.end){
      const s = l.coords.start, e = l.coords.end;
      L.marker([s.lat,s.lon]).addTo(map).bindPopup(`<b>Load ${i+1} Pickup</b><br>${escapeHtml(l.origin)}`);
      L.marker([e.lat,e.lon]).addTo(map).bindPopup(`<b>Load ${i+1} Drop</b><br>${escapeHtml(l.dest)}`);
      pts.push([s.lat,s.lon],[e.lat,e.lon]);

      if (l.routeGeo?.coordinates?.length){
        const latlngs = l.routeGeo.coordinates.map(c=>[c[1],c[0]]);
        L.polyline(latlngs,{ color:'#38bdf8', weight:4, opacity:.70 }).addTo(map);
      } else {
        L.polyline([[s.lat,s.lon],[e.lat,e.lon]],{ color:'#38bdf8', weight:4, opacity:.55, dashArray:"6 8" }).addTo(map);
      }
    }
  });

  if (pts.length>0) map.fitBounds(pts,{ padding:[50,50] });
  map.invalidateSize();
}

/*************************
 * ROUTING + GEO (OSRM + NOMINATIM)
 *************************/
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
async function fetchWithTimeout(url, ms=12000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), ms);
  try { return await fetch(url, { signal: ctrl.signal }); }
  finally { clearTimeout(t); }
}
async function fetchRetry(url, tries=2, waitMs=700){
  let lastErr=null;
  for (let i=0;i<tries;i++){
    try{
      const res = await fetchWithTimeout(url, 15000);
      if (!res.ok){
        if ((res.status===429 || res.status>=500) && i<tries-1){ await sleep(waitMs*(i+1)); continue; }
        throw new Error(`HTTP ${res.status}`);
      }
      return res;
    } catch(e){
      lastErr=e;
      if (i<tries-1) await sleep(waitMs*(i+1));
    }
  }
  throw lastErr;
}
function loadGeoCache(){ return JSON.parse(localStorage.getItem(GEO_CACHE_KEY) || "{}"); }
function saveGeoCache(cache){ localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(cache)); }
function normalizeCity(q){ return String(q||"").trim().toLowerCase().replace(/\s+/g," "); }

async function getLoc(city){
  const q = normalizeCity(city);
  if (!q) return null;

  const cache = loadGeoCache();
  const hit = cache[q];
  const now = Date.now();
  const TTL = 1000*60*60*24*30;
  if (hit?.ts && (now-hit.ts)<TTL) return hit.data;

  const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=0&limit=1&q=${encodeURIComponent(city + ", USA")}`;
  const res = await fetchRetry(url, 2, 700);
  const data = await res.json();
  if (!data?.[0]) return null;

  cache[q] = { ts: now, data: data[0] };
  saveGeoCache(cache);
  return data[0];
}
async function osrmRouteMilesGeo(lon1, lat1, lon2, lat2){
  const url = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson&steps=false`;
  const res = await fetchRetry(url, 2, 700);
  const j = await res.json();
  if (!j?.routes?.[0]) throw new Error("Route not found");
  const r = j.routes[0];
  return { miles: Math.round(r.distance * 0.000621371), geo: r.geometry };
}
async function calcRoute(){
  const o = document.getElementById('origin').value;
  const d = document.getElementById('dest').value;
  if (!o || !d) return alert("Enter cities first");

  try{
    setStatus("Finding cities‚Ä¶", true);
    const locA = await getLoc(o);
    const locB = await getLoc(d);
    if (!locA || !locB){ setStatus("City not found (check spelling)", true); return; }

    const oLat = Number(locA.lat), oLon = Number(locA.lon);
    const dLat = Number(locB.lat), dLon = Number(locB.lon);

    document.getElementById('origin').dataset.lat = oLat;
    document.getElementById('origin').dataset.lon = oLon;
    document.getElementById('dest').dataset.lat = dLat;
    document.getElementById('dest').dataset.lon = dLon;

    setStatus("Calculating loaded route‚Ä¶", true);
    const loaded = await osrmRouteMilesGeo(oLon,oLat,dLon,dLat);
    document.getElementById('mi_load').value = loaded.miles;

    const wk = getCurrentWeek();
    if (wk.lastDropCoords?.lat && wk.lastDropCoords?.lon){
      setStatus("Calculating deadhead‚Ä¶", true);
      const dh = await osrmRouteMilesGeo(wk.lastDropCoords.lon, wk.lastDropCoords.lat, oLon, oLat);
      document.getElementById('mi_dh').value = dh.miles;
    } else {
      document.getElementById('mi_dh').value = 0;
    }

    document.getElementById('origin').dataset.routeGeo = JSON.stringify(loaded.geo || null);
    setStatus("", false);
    preview();
  } catch(e){
    console.error(e);
    setStatus("Routing failed (try again in 30s)", true);
    setTimeout(()=>setStatus("", false), 3500);
  }
}

/*************************
 * EXPORT + COPY
 *************************/
function downloadFile(filename, content, mime="text/plain"){
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
}

function exportCSV(scope="week"){
  const d = getDriver();
  if (scope === "week"){
    const wk = getCurrentWeek();
    const rows = [["Driver","Week","Pickup","Drop","Miles","Gross","Net","Fuel","Fixed","Maint","Tolls"]];
    wk.loads.forEach(l=>rows.push([
      d.name, wk.label, l.origin, l.dest,
      Number(l.miles||0),
      Number(l.gross||0).toFixed(2),
      Number(l.net||0).toFixed(2),
      Number(l.details?.fuel||0).toFixed(2),
      Number(l.details?.fixed||0).toFixed(2),
      Number(l.details?.maint||0).toFixed(2),
      Number(l.details?.tolls||0).toFixed(2)
    ]));
    const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
    downloadFile(`TagDriverPro_${d.name.replace(/\s+/g,'_')}_${d.currentWeekId}_Week.csv`, csv, "text/csv");
    return;
  }

  // YTD for selected driver
  const rows = [["Driver","Week","Pickup","Drop","Miles","Gross","Net","Fuel","Fixed","Maint","Tolls"]];
  const weekIds = Object.keys(d.weeks).sort();
  weekIds.forEach(id=>{
    const w = d.weeks[id];
    (w.loads||[]).forEach(l=>rows.push([
      d.name, w.label||id, l.origin, l.dest,
      Number(l.miles||0),
      Number(l.gross||0).toFixed(2),
      Number(l.net||0).toFixed(2),
      Number(l.details?.fuel||0).toFixed(2),
      Number(l.details?.fixed||0).toFixed(2),
      Number(l.details?.maint||0).toFixed(2),
      Number(l.details?.tolls||0).toFixed(2)
    ]));
  });
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  downloadFile(`TagDriverPro_${d.name.replace(/\s+/g,'_')}_YTD.csv`, csv, "text/csv");
}

async function copySummary(){
  const d = getDriver();
  const wk = getCurrentWeek();
  const s = getSpecs();
  const t = computeWeekTotals(wk);

  const best = wk.loads.length ? wk.loads.reduce((a,b)=>(a.net>b.net?a:b)) : null;
  const worst= wk.loads.length ? wk.loads.reduce((a,b)=>(a.net<b.net?a:b)) : null;

  const summary =
`TAG DRIVER PRO ‚Äî WEEK SUMMARY
Driver: ${d.name}
Week: ${wk.label}
Loads: ${wk.loads.length}
Gross: ${money(t.gross)}
Miles: ${t.miles.toLocaleString()}
Net:   ${money(t.net)}
Gross RPM: ${money(t.miles>0 ? t.gross/t.miles : 0)}
Target: ${money(s.targetNet)} (${t.net>=s.targetNet ? "MET ‚úÖ" : "SHORT ‚ùå by " + money(s.targetNet - t.net)})

Best load:  ${best ? `${best.origin} -> ${best.dest} | Net ${money(best.net)}` : "n/a"}
Worst load: ${worst? `${worst.origin} -> ${worst.dest} | Net ${money(worst.net)}` : "n/a"}`;

  try{
    await navigator.clipboard.writeText(summary);
    alert("Weekly summary copied to clipboard.");
  } catch(e){
    prompt("Copy this summary:", summary);
  }
}

/*************************
 * PRINTING
 * - Weekly summary + per-load breakdown underneath
 * - YTD driver print option
 *************************/
function printWeeklySummary(){
  const d = getDriver();
  const wk = getCurrentWeek();
  const s = getSpecs();
  const t = computeWeekTotals(wk);

  const beGross = (t.miles>0 && s.split>0) ? ((t.fuel + t.maint + t.fixed + t.tolls) / s.split) : 0;
  const beRpm = t.miles>0 ? beGross/t.miles : 0;

  const rows = wk.loads.map((l, idx)=>{
    const grossRpm = l.miles>0 ? (l.gross/l.miles) : 0;
    return `
      <tr>
        <td>${idx+1}</td>
        <td>${escapeHtml(l.origin)} ‚Üí ${escapeHtml(l.dest)}</td>
        <td class="right">${Number(l.miles||0).toLocaleString()}</td>
        <td class="right">${money(l.gross)}</td>
        <td class="right">${money(l.details?.cut||0)}</td>
        <td class="right">${money(l.details?.fuel||0)}</td>
        <td class="right">${money(l.details?.fixed||0)}</td>
        <td class="right">${money(l.details?.maint||0)}</td>
        <td class="right">${money(l.details?.tolls||0)}</td>
        <td class="right"><b>${money(l.net)}</b></td>
        <td class="right">${money(grossRpm)}</td>
      </tr>
    `;
  }).join("");

  const printHtml = `
    <div style="padding:18px;">
      <h1>Tag Driver Pro ‚Äî Weekly Summary</h1>
      <div style="margin-bottom:6px;"><b>Driver:</b> ${escapeHtml(d.name)}</div>
      <div style="margin-bottom:6px;"><b>Week:</b> ${escapeHtml(wk.label)} (${escapeHtml(d.currentWeekId)})</div>
      <div style="margin-bottom:10px;"><b>Printed:</b> ${escapeHtml(nowStamp())}</div>

      <div class="pGrid">
        <div class="pStat"><div style="font-size:11px;color:#333;text-transform:uppercase;font-weight:900;">Gross</div><div style="font-size:18px;font-weight:1000;">${money(t.gross)}</div></div>
        <div class="pStat"><div style="font-size:11px;color:#333;text-transform:uppercase;font-weight:900;">Miles</div><div style="font-size:18px;font-weight:1000;">${t.miles.toLocaleString()}</div></div>
        <div class="pStat"><div style="font-size:11px;color:#333;text-transform:uppercase;font-weight:900;">Net</div><div style="font-size:18px;font-weight:1000;">${money(t.net)}</div></div>
        <div class="pStat"><div style="font-size:11px;color:#333;text-transform:uppercase;font-weight:900;">Gross RPM</div><div style="font-size:18px;font-weight:1000;">${money(t.miles>0 ? t.gross/t.miles : 0)}</div></div>
      </div>

      <div class="pCard">
        <h3>Health Checks</h3>
        <div><b>Break-even RPM:</b> ${money(beRpm)}</div>
        <div><b>Target Net:</b> ${money(s.targetNet)} (${t.net>=s.targetNet ? "MET" : "SHORT by " + money(s.targetNet - t.net)})</div>
      </div>

      <div class="pCard">
        <h3>Per-Load Breakdown</h3>
        <table>
          <thead>
            <tr>
              <th>#</th><th>Route</th><th class="right">Miles</th><th class="right">Gross</th><th class="right">Cut</th>
              <th class="right">Fuel</th><th class="right">Fixed</th><th class="right">Maint</th><th class="right">Tolls</th>
              <th class="right">Net</th><th class="right">Gross RPM</th>
            </tr>
          </thead>
          <tbody>
            ${rows || `<tr><td colspan="11">No loads entered.</td></tr>`}
          </tbody>
        </table>
      </div>

      <div class="pCard">
        <h3>Notes</h3>
        <div style="font-size:12px;">
          This report is calculated using: Split ${Math.round(s.split*100)}%, Fuel $${Number(s.fuel).toFixed(2)}/gal, MPG ${Number(s.mpg).toFixed(1)},
          Maint $${Number(s.maint).toFixed(2)}/mi, Fixed costs split across ${s.loadsPerWeek} loads/week.
        </div>
      </div>
    </div>
  `;

  document.getElementById("printArea").innerHTML = printHtml;
  window.print();
  // keep print area populated (fine), or clear if you want:
  // document.getElementById("printArea").innerHTML = "";
}

function printDriverYTD(){
  const d = getDriver();
  const s = getSpecs();
  const weekIds = Object.keys(d.weeks).sort().reverse();

  let yGross=0,yMiles=0,yNet=0,yFuel=0,yMaint=0,yTolls=0;
  const rows = weekIds.map(id=>{
    const w = d.weeks[id];
    const t = computeWeekTotals(w);
    yGross += t.gross; yMiles += t.miles; yNet += t.net; yFuel += t.fuel; yMaint += t.maint; yTolls += t.tolls;
    const rpm = t.miles>0 ? t.gross/t.miles : 0;
    return `
      <tr>
        <td>${escapeHtml(w.label||id)}</td>
        <td class="right">${(w.loads||[]).length}</td>
        <td class="right">${t.miles.toLocaleString()}</td>
        <td class="right">${money(t.gross)}</td>
        <td class="right"><b>${money(t.net)}</b></td>
        <td class="right">${money(rpm)}</td>
      </tr>
    `;
  }).join("");

  const oer = yGross>0 ? Math.round(((yGross - yNet)/yGross)*100) : 0;

  const printHtml = `
    <div style="padding:18px;">
      <h1>Tag Driver Pro ‚Äî YTD Summary</h1>
      <div style="margin-bottom:6px;"><b>Driver:</b> ${escapeHtml(d.name)}</div>
      <div style="margin-bottom:10px;"><b>Printed:</b> ${escapeHtml(nowStamp())}</div>

      <div class="pGrid">
        <div class="pStat"><div style="font-size:11px;color:#333;text-transform:uppercase;font-weight:900;">YTD Gross</div><div style="font-size:18px;font-weight:1000;">${money(yGross)}</div></div>
        <div class="pStat"><div style="font-size:11px;color:#333;text-transform:uppercase;font-weight:900;">YTD Miles</div><div style="font-size:18px;font-weight:1000;">${yMiles.toLocaleString()}</div></div>
        <div class="pStat"><div style="font-size:11px;color:#333;text-transform:uppercase;font-weight:900;">YTD Net</div><div style="font-size:18px;font-weight:1000;">${money(yNet)}</div></div>
        <div class="pStat"><div style="font-size:11px;color:#333;text-transform:uppercase;font-weight:900;">Est. Tax</div><div style="font-size:18px;font-weight:1000;">${money(yNet * s.taxRate)}</div></div>
      </div>

      <div class="pCard">
        <h3>Health</h3>
        <div><b>Operating Expense Ratio:</b> ${oer}%</div>
        <div><b>Total Fuel:</b> ${money(yFuel)}</div>
        <div><b>Total Maint Saved:</b> ${money(yMaint)}</div>
        <div><b>Total Tolls:</b> ${money(yTolls)}</div>
      </div>

      <div class="pCard">
        <h3>Week History</h3>
        <table>
          <thead><tr><th>Week</th><th class="right">Loads</th><th class="right">Miles</th><th class="right">Gross</th><th class="right">Net</th><th class="right">Gross RPM</th></tr></thead>
          <tbody>${rows || `<tr><td colspan="6">No weeks found.</td></tr>`}</tbody>
        </table>
      </div>
    </div>
  `;
  document.getElementById("printArea").innerHTML = printHtml;
  window.print();
}

/*************************
 * SMALL TOOLS
 *************************/
function verifyMap(){
  const o = document.getElementById('origin').value;
  const d = document.getElementById('dest').value;
  if (o && d) window.open(`https://www.google.com/maps/dir/${encodeURIComponent(o)}/${encodeURIComponent(d)}`);
}
function checkTolls(){
  const o = document.getElementById('origin').value;
  const d = document.getElementById('dest').value;
  if (!o || !d) return;
  navigator.clipboard.writeText(o + " to " + d).then(()=>{
    alert("Copied route. Paste into TollGuru.");
    window.open('https://tollguru.com/toll-calculator');
  }).catch(()=>{
    alert("Could not copy automatically. Open TollGuru and paste route manually.");
    window.open('https://tollguru.com/toll-calculator');
  });
}
function swapCities(){
  const o = document.getElementById('origin');
  const d = document.getElementById('dest');
  const tmp = o.value; o.value = d.value; d.value = tmp;
  preview();
}

/*************************
 * UI RENDER
 *************************/
function updateUI(){
  const d = getDriver();
  const wk = getCurrentWeek();
  const loads = wk.loads;

  const s = getSpecs();
  const totals = computeWeekTotals(wk);

  document.getElementById('wk_gross').innerText = money(totals.gross);
  document.getElementById('wk_miles').innerText = totals.miles.toLocaleString();

  const wkProfitEl = document.getElementById('wk_profit');
  wkProfitEl.innerText = money(totals.net);
  wkProfitEl.className = "stat-val " + (totals.net>=0 ? "pos" : "neg");

  document.getElementById('wk_rpm').innerText = money(totals.rpm);

  const wkCosts = (totals.gross * s.split) - totals.net;
  const wkBreakEvenGross = s.split>0 ? (wkCosts / s.split) : 0;
  const wkBERpm = totals.miles>0 ? (wkBreakEvenGross / totals.miles) : 0;
  document.getElementById('wk_be_rpm').innerText = money(wkBERpm);

  document.getElementById('loadList').innerHTML = loads.map((l,i)=>{
    const grossRpm = l.miles>0 ? l.gross/l.miles : 0;
    return `
      <tr>
        <td style="font-weight:1000;font-size:12px;">${escapeHtml(l.origin)} <span style="color:var(--accent)">‚ûú</span> ${escapeHtml(l.dest)}</td>
        <td>${Number(l.miles||0).toLocaleString()}</td>
        <td>${money(l.gross)}</td>
        <td class="${(l.net||0)>=0?'pos':'neg'}">${money(l.net)}</td>
        <td>${money(grossRpm)}</td>
        <td>
          <button class="action-btn" onclick="viewDetail(${i})">Detail</button>
          <button class="action-btn delete-btn" onclick="delLoad(${i})">X</button>
        </td>
      </tr>
    `;
  }).join("");

  // Analytics: YTD for selected driver
  const weekIds = Object.keys(d.weeks).sort().reverse();
  let yGross=0,yMiles=0,yNet=0,yFuel=0,yMaint=0;
  let bestWeek=null,worstWeek=null;

  weekIds.forEach(id=>{
    const t = computeWeekTotals(d.weeks[id]);
    yGross += t.gross; yMiles += t.miles; yNet += t.net; yFuel += t.fuel; yMaint += t.maint;
    if (!bestWeek || t.net > bestWeek.net) bestWeek = { id, net: t.net };
    if (!worstWeek || t.net < worstWeek.net) worstWeek = { id, net: t.net };
  });

  document.getElementById('ytd_gross').innerText = money(yGross);
  document.getElementById('ytd_profit').innerText = money(yNet);
  document.getElementById('ytd_tax').innerText = money(yNet * s.taxRate);
  document.getElementById('oer_val').innerText = yGross>0 ? Math.round(((yGross - yNet)/yGross)*100)+'%' : '0%';
  document.getElementById('ytd_fuel').innerText = money(yFuel);
  document.getElementById('ytd_maint').innerText = money(yMaint);
  document.getElementById('best_week').innerText = bestWeek ? money(bestWeek.net) : money(0);
  document.getElementById('worst_week').innerText = worstWeek ? money(worstWeek.net) : money(0);

  document.getElementById('weekHistory').innerHTML = weekIds.map(id=>{
    const w = d.weeks[id];
    const t = computeWeekTotals(w);
    const rpm = t.miles>0 ? (t.gross/t.miles) : 0;
    return `
      <tr>
        <td style="font-weight:1000;">${escapeHtml(w.label || id)}</td>
        <td>${(w.loads||[]).length}</td>
        <td>${t.miles.toLocaleString()}</td>
        <td>${money(t.gross)}</td>
        <td class="${t.net>=0?'pos':'neg'}">${money(t.net)}</td>
        <td>${money(rpm)}</td>
      </tr>
    `;
  }).join("");

  updateWarnBanner();
  preview();
  renderDriverSelect();
  renderWeekSelect();
}

/*************************
 * RESET / FACTORY
 *************************/
function factoryReset(){
  if (!confirm("Factory reset clears ALL drivers + weeks + settings on this device. Continue?")) return;
  localStorage.removeItem(STORE_KEY);
  localStorage.removeItem(SETTINGS_KEY);
  localStorage.removeItem(GEO_CACHE_KEY);
  location.reload();
}

/*************************
 * INIT
 *************************/
function ensureCurrentDriverHasThisWeek(){
  const d = getDriver();
  const wk = startOfWeekMonday(new Date());
  const baseId = isoDate(wk);
  if (!d.weeks[baseId]) {
    d.weeks[baseId] = { start: baseId, label: fmtWeekLabel(wk), loads: [], lastDropCoords: null };
    saveState();
  }
}
function wireEntryKeyNav(){
  const ids = ["origin","dest","mi_load","mi_dh","cost_tolls","pay_gross"];
  ids.forEach((id, idx)=>{
    const el = document.getElementById(id);
    el.addEventListener("keydown",(e)=>{
      if (e.key === "Enter"){
        e.preventDefault();
        const next = document.getElementById(ids[idx+1] || "pay_gross");
        if (next) next.focus();
      }
    });
    el.addEventListener("input", preview);
  });
}

ensureCurrentDriverHasThisWeek();
bindSettingsToInputs();
wireEntryKeyNav();
renderDriverSelect();
renderWeekSelect();
updateUI();
setTimeout(initMap, 500);
</script>

</body>
</html>
