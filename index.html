<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
  <title>Tag Driver Pro ‚Ä¢ Command Center (Phase 1 Fixes)</title>

  <!-- Leaflet CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* ============================================================
       TAG DRIVER PRO ‚Äî SINGLE FILE
       Phase 1 fixes (P0/P1):
       - Split model clarified: before-expenses vs after-expenses (configurable scope)
       - Fixed cost allocation modes: expected vs actual (dynamic) vs rolling
       - Partial week fixed-cost proration (days worked)
       - Per-driver profiles + per-driver financial overrides
       - Week lifecycle: ACTIVE / CLOSED / LOCKED + gating edits
       - Data validation + outlier warnings
       - Trash (30-day) for deleted loads/weeks/drivers + restore
       - Multi-tab change detection (storage event) warning
       - Kept: endpoints + strict >=1.1s throttling, caching, Leaflet, notes, edit modal w/ reroute,
               undo delete (toast), backup/export/import JSON, search/sort/filter, theme toggle,
               sidebar nav, responsive layout, print-friendly styles.

       NOTE:
       - Place your provided logo image as "tag-trans-inc.png" next to this file (optional).
    ============================================================ */

    :root{
      --cyan:#38bdf8;
      --ember:#ff6a3d;

      --g950:#0a0a0a;
      --g920:#101114;
      --g900:#151515;
      --g850:#232323;
      --g780:#2d2b2b;
      --g700:#383736;
      --g600:#595857;
      --g400:#898988;
      --g100:#d3d3d3;

      --success:#22c55e;
      --danger:#ef4444;
      --warning:#f59e0b;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --r12:12px;
      --r14:14px;
      --r18:18px;

      --glass: rgba(20, 24, 32, .62);
      --glass2: rgba(26, 32, 44, .62);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.16);
      --shadow: 0 16px 60px rgba(0,0,0,.55);

      --bg: radial-gradient(1200px 900px at 10% 0%, rgba(56,189,248,.08), transparent 45%),
            radial-gradient(900px 700px at 90% 20%, rgba(255,106,61,.07), transparent 50%),
            linear-gradient(180deg, #090a0c, #0b0f17 60%, #07080a);
      --text:#f8fafc;
      --muted: rgba(248,250,252,.68);

      --control: rgba(2,6,23,.75);
      --controlStroke: rgba(255,255,255,.12);
      --focus: 0 0 0 3px rgba(56,189,248,.18);

      --sidebarW: 290px;
      --topH: 72px;
      --gap: 14px;

      --t: 160ms;
      --t2: 260ms;
    }

    body[data-theme="steel"]{
      --glass: rgba(30, 36, 48, .60);
      --glass2: rgba(34, 42, 58, .62);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.18);
      --bg: radial-gradient(1200px 900px at 12% 0%, rgba(56,189,248,.10), transparent 45%),
            radial-gradient(900px 700px at 90% 20%, rgba(255,106,61,.09), transparent 50%),
            linear-gradient(180deg, #0b0c10, #0d1220 60%, #090a0c);
    }

    @media (prefers-reduced-motion: reduce) {
      :root{ --t: 1ms; --t2: 1ms; }
      *{ scroll-behavior:auto !important; }
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background: var(--bg);
      overflow-x:hidden;
    }

    .app{
      display:grid;
      grid-template-columns: var(--sidebarW) 1fr;
      min-height:100vh;
    }

    /* Sidebar */
    .sidebar{
      position:sticky;
      top:0;
      height:100vh;
      padding:16px;
      border-right: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.10));
      backdrop-filter: blur(10px) saturate(1.2);
      -webkit-backdrop-filter: blur(10px) saturate(1.2);
      overflow:auto;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 12px;
      border-radius: var(--r18);
      background: rgba(255,255,255,.04);
      border: 1px solid var(--stroke);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .brand img{
      width:42px;height:42px;object-fit:contain;
      border-radius: 10px;
      background: rgba(0,0,0,.25);
      padding:6px;
      border: 1px solid rgba(255,255,255,.10);
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.55));
    }
    .brand .t1{ font-weight:1100; letter-spacing:-.02em; line-height:1.05; }
    .brand .t2{ font-size:12px; color: var(--muted); font-weight:900; margin-top:2px; }

    .nav{
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .nav button{
      all: unset;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 12px;
      border-radius: var(--r14);
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.06);
      transition: transform var(--t), background var(--t), border-color var(--t);
      color: rgba(248,250,252,.78);
      font-weight:1000;
    }
    .nav button:hover{
      transform: translateY(-1px);
      border-color: rgba(56,189,248,.28);
      background: rgba(56,189,248,.06);
    }
    .nav button.active{
      background: linear-gradient(90deg, rgba(56,189,248,.18), rgba(56,189,248,.06));
      border-color: rgba(56,189,248,.42);
      color: var(--text);
      box-shadow: 0 16px 50px rgba(56,189,248,.08);
    }
    .ico{
      width:30px;height:30px;border-radius:10px;
      display:grid;place-items:center;
      background: rgba(2,6,23,.55);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(248,250,252,.90);
      font-size:14px;
    }

    .sidebar .meta{
      margin-top:14px;
      padding:12px;
      border-radius: var(--r14);
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      color: rgba(248,250,252,.72);
      font-size:12px;
      line-height:1.35;
    }
    .chip{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border-radius: 999px;
      margin-top:10px;
      background: rgba(2,6,23,.55);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(248,250,252,.75);
      font-weight:1000;
      font-size:11px;
    }
    .dot{
      width:8px;height:8px;border-radius:99px;
      background: var(--success);
      box-shadow: 0 0 0 4px rgba(34,197,94,.12);
    }

    /* Main */
    .main{
      min-width:0;
      padding: 16px 18px 90px;
    }

    .topbar{
      height: var(--topH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 12px;
      border-radius: var(--r18);
      background: var(--glass);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px) saturate(1.2);
      -webkit-backdrop-filter: blur(14px) saturate(1.2);
      position:sticky;
      top: 12px;
      z-index: 40;
    }

    .topLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 240px;
    }

    .hamburger{
      display:none;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(2,6,23,.55);
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight:1100;
      color: rgba(248,250,252,.92);
    }

    .title{ display:flex; flex-direction:column; }
    .title .h{ font-weight:1200; letter-spacing:-.02em; line-height:1.05; }
    .title .s{ font-size:12px; color: var(--muted); font-weight:900; }

    .topControls{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    label{
      font-size:10px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(248,250,252,.65);
      font-weight:1100;
      display:block;
      margin-bottom:6px;
    }

    .control{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 220px;
      max-width: 74vw;
    }

    select,input,textarea{
      width:100%;
      border-radius: 12px;
      padding: 11px 12px;
      border: 1px solid var(--controlStroke);
      background: var(--control);
      color: var(--text);
      font-weight:1000;
      outline:none;
      transition: box-shadow var(--t), border-color var(--t), transform var(--t);
      font-family: var(--font);
    }
    textarea{ min-height: 84px; resize: vertical; font-weight:900; }
    select:focus,input:focus,textarea:focus{ border-color: rgba(56,189,248,.70); box-shadow: var(--focus); }

    .btn{
      border-radius: 14px;
      padding: 11px 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(2,6,23,.55);
      cursor:pointer;
      font-weight:1100;
      color: var(--text);
      transition: transform var(--t), border-color var(--t), background var(--t);
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(56,189,248,.45); background: rgba(56,189,248,.08); }
    .btn.primary{
      background: linear-gradient(90deg, rgba(56,189,248,.95), rgba(56,189,248,.65));
      color: #001018;
      border-color: rgba(56,189,248,.65);
    }
    .btn.primary:hover{ background: linear-gradient(90deg, rgba(56,189,248,1), rgba(56,189,248,.78)); }

    .btn.danger{ border-color: rgba(239,68,68,.75); color: #fecaca; background: rgba(239,68,68,.10); }
    .btn.danger:hover{ background: rgba(239,68,68,.18); border-color: rgba(239,68,68,1); }

    .btn.ghost{
      background: rgba(255,255,255,.03);
      border-color: rgba(255,255,255,.10);
    }

    .pill{
      display:inline-flex;
      gap:10px;
      align-items:center;
      font-size: 11px;
      font-weight: 1100;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(248,250,252,.72);
    }

    .pill.bad{
      border-color: rgba(239,68,68,.28);
      background: rgba(239,68,68,.10);
      color: rgba(254,202,202,.95);
    }
    .pill.warn{
      border-color: rgba(245,158,11,.26);
      background: rgba(245,158,11,.10);
      color: rgba(255,231,186,.95);
    }
    .pill.good{
      border-color: rgba(34,197,94,.22);
      background: rgba(34,197,94,.10);
      color: rgba(187,247,208,.95);
    }

    .status{
      display:none;
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(245,158,11,.12);
      border: 1px solid rgba(245,158,11,.25);
      color: rgba(255,231,186,.95);
      font-weight:1100;
      font-size:12px;
    }

    .warnBanner{
      display:none;
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 16px;
      background: rgba(239,68,68,.12);
      border: 1px solid rgba(239,68,68,.30);
      color: #fecaca;
      font-weight:1100;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
    }
    .warnBanner b{ color:#fff; }

    .syncBanner{
      display:none;
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 16px;
      background: rgba(56,189,248,.10);
      border: 1px solid rgba(56,189,248,.25);
      color: rgba(224,242,254,.95);
      font-weight:1100;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
    }

    /* Cards / layout */
    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 440px 1fr;
      gap: var(--gap);
      align-items:start;
    }
    @media (max-width: 1120px){
      .grid{ grid-template-columns: 1fr; }
      .topbar{ position:sticky; top:0; border-radius: 0; margin: -16px -18px 0; }
      .main{ padding-top: 0; }
    }

    .card{
      border-radius: var(--r18);
      background: var(--glass);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px) saturate(1.2);
      -webkit-backdrop-filter: blur(14px) saturate(1.2);
      overflow:hidden;
    }
    .card .head{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .card .head .k{
      font-size: 11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      font-weight:1200;
      color: rgba(56,189,248,.92);
    }
    .card .body{ padding: 14px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row .grow{ flex:1; min-width: 180px; }
    .muted{ color: rgba(248,250,252,.65); font-weight:900; }
    .mono{ font-family: var(--mono); }

    /* KPI strip */
    .kpis{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: var(--gap);
    }
    .kpi{
      border-radius: var(--r18);
      background: var(--glass2);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 14px 46px rgba(0,0,0,.40);
      padding: 14px;
    }
    .kpi .l{
      font-size: 11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      font-weight: 1100;
      color: rgba(248,250,252,.68);
    }
    .kpi .v{
      margin-top: 6px;
      font-size: 22px;
      font-weight: 1300;
      letter-spacing:-.02em;
    }
    .pos{ color: var(--success); }
    .neg{ color: var(--danger); }

    /* Map */
    #map{
      height: 560px;
      width: 100%;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
    }
    .mapWrap{ padding: 0; }
    .mapMeta{
      padding: 12px 14px;
      display:flex;
      gap: 10px;
      justify-content: space-between;
      align-items:center;
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      font-size: 12px;
      color: rgba(248,250,252,.70);
      font-weight:900;
      flex-wrap:wrap;
    }

    /* Table */
    .tableBar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
      justify-content:space-between;
      margin-bottom: 10px;
    }
    .tableBar .left, .tableBar .right{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .tableWrap{
      overflow:auto;
      border-radius: var(--r18);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    table{ width: 100%; border-collapse: collapse; min-width: 980px; }
    thead th{
      position: sticky;
      top: 0;
      z-index: 2;
      background: rgba(4,6,10,.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);

      font-size: 10px;
      letter-spacing: .14em;
      text-transform: uppercase;
      font-weight: 1200;
      color: rgba(248,250,252,.70);
      text-align: left;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      white-space: nowrap;
    }
    tbody td{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      font-size: 13px;
      font-weight: 900;
      color: rgba(248,250,252,.90);
      vertical-align: top;
    }
    tbody tr{ transition: background var(--t); }
    tbody tr:hover{ background: rgba(56,189,248,.06); }
    .routeArrow{ color: rgba(56,189,248,.95); font-weight: 1300; padding: 0 6px; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .miniBtn{
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(2,6,23,.55);
      cursor:pointer;
      font-weight: 1200;
      color: rgba(248,250,252,.92);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    .miniBtn:hover{ border-color: rgba(56,189,248,.45); background: rgba(56,189,248,.08); }
    .miniBtn.danger{ border-color: rgba(239,68,68,.75); color: #fecaca; background: rgba(239,68,68,.10); }
    .miniBtn.danger:hover{ background: rgba(239,68,68,.18); border-color: rgba(239,68,68,1); }

    /* Modal */
    .overlay{
      display:none;
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.72);
      z-index: 90;
    }
    .modal{
      display:none;
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: min(760px, 94vw);
      background: rgba(14,18,26,.88);
      border: 1px solid rgba(56,189,248,.45);
      border-radius: 18px;
      box-shadow: 0 30px 120px rgba(0,0,0,.70);
      z-index: 91;
      backdrop-filter: blur(16px) saturate(1.2);
      -webkit-backdrop-filter: blur(16px) saturate(1.2);
      overflow:hidden;
    }
    .modal .mHead{
      padding: 14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: rgba(255,255,255,.04);
      border-bottom: 1px solid rgba(255,255,255,.10);
      flex-wrap:wrap;
    }
    .modal .mHead .t{
      font-weight: 1300;
      letter-spacing: -.02em;
      color: rgba(56,189,248,.95);
    }
    .modal .mBody{ padding: 14px; }
    .kv{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,.10);
      font-weight: 1000;
    }
    .kv .k{
      color: rgba(248,250,252,.68);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .14em;
      font-weight:1200;
    }
    .kv .v{ font-family: var(--mono); font-weight:1100; }
    .modal .mFoot{
      padding: 14px;
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      flex-wrap:wrap;
    }

    /* Toast */
    .toastHost{
      position: fixed;
      left: 16px;
      right: 16px;
      bottom: 16px;
      z-index: 120;
      display:flex;
      justify-content: center;
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      display:none;
      gap: 12px;
      align-items:center;
      justify-content:space-between;
      width: min(860px, 96vw);
      border-radius: 16px;
      padding: 12px 14px;
      background: rgba(14,18,26,.92);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 20px 80px rgba(0,0,0,.60);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      font-weight: 1100;
      color: rgba(248,250,252,.92);
      flex-wrap:wrap;
    }
    .toast .msg{ font-size: 13px; color: rgba(248,250,252,.88); }

    /* Mobile sidebar */
    .sidebarOverlay{
      display:none;
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.62);
      z-index: 80;
    }
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{
        position: fixed;
        left: 0;
        top: 0;
        transform: translateX(-104%);
        transition: transform var(--t2);
        z-index: 81;
        width: min(var(--sidebarW), 88vw);
      }
      body[data-sidebar="open"] .sidebar{ transform: translateX(0); }
      body[data-sidebar="open"] .sidebarOverlay{ display:block; }
      .hamburger{ display:inline-flex; }
    }

    /* Print */
    #printArea{ display:none; }
    @media print{
      .sidebar, .sidebarOverlay, .topbar, .status, .warnBanner, .syncBanner, .noPrint, .toastHost { display:none !important; }
      body{ background:#fff !important; color:#000 !important; }
      .main{ padding: 0 !important; }
      #printArea{ display:block; padding: 22px; }
      #printArea *{ color:#000 !important; }
      #printArea h1, #printArea h2{ margin: 0 0 10px 0; }
      #printArea .pCard{ border: 1px solid #ccc; border-radius: 12px; padding: 12px; margin: 12px 0; }
      #printArea table{ width:100%; border-collapse: collapse; min-width: 0; }
      #printArea th, #printArea td{ border-bottom: 1px solid #ddd; padding: 8px; font-size: 11px; text-align:left; }
      #printArea .pGrid{ display:grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
      #printArea .pStat{ border: 1px solid #ddd; border-radius: 10px; padding: 10px; }
      #printArea .right{ text-align:right; }
    }
  </style>
</head>

<body data-theme="graphite" data-sidebar="closed">

  <div class="sidebarOverlay" onclick="toggleSidebar(false)"></div>

  <div id="overlay" class="overlay" onclick="closeAllModals()"></div>

  <!-- Detail modal -->
  <div id="detailModal" class="modal" role="dialog" aria-modal="true" aria-label="Load details">
    <div class="mHead">
      <div class="t">Load Details</div>
      <button class="btn" onclick="closeAllModals()">Close</button>
    </div>
    <div id="detailBody" class="mBody"></div>
    <div class="mFoot">
      <button class="btn" onclick="closeAllModals()">Close</button>
    </div>
  </div>

  <!-- Edit modal -->
  <div id="editModal" class="modal" role="dialog" aria-modal="true" aria-label="Edit load">
    <div class="mHead">
      <div class="t">Edit Load</div>
      <div class="row" style="gap:8px;align-items:center;">
        <span class="pill" id="editWeekLockPill" style="display:none;">Week Locked</span>
        <button class="btn" onclick="closeAllModals()">Close</button>
      </div>
    </div>

    <div class="mBody">
      <div class="row">
        <div class="grow">
          <label>Pickup</label>
          <input id="e_origin" />
        </div>
        <div class="grow">
          <label>Drop</label>
          <input id="e_dest" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="grow">
          <label>Loaded miles</label>
          <input id="e_mi_load" type="number" inputmode="numeric" min="0" step="1" />
        </div>
        <div class="grow">
          <label>Deadhead miles</label>
          <input id="e_mi_dh" type="number" inputmode="numeric" min="0" step="1" />
        </div>
        <div class="grow">
          <label>Tolls ($)</label>
          <input id="e_tolls" type="number" inputmode="decimal" min="0" step="0.01" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="grow">
          <label>Linehaul / Base pay ($)</label>
          <input id="e_basePay" type="number" inputmode="decimal" min="0" step="0.01" />
        </div>
        <div class="grow">
          <label>Fuel surcharge (FSC) ($)</label>
          <input id="e_fsc" type="number" inputmode="decimal" min="0" step="0.01" />
        </div>
        <div class="grow">
          <label>Accessorial pay ($)</label>
          <input id="e_accessorial" type="number" inputmode="decimal" min="0" step="0.01" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="grow">
          <label>Reimbursements (not revenue) ($)</label>
          <input id="e_reimb" type="number" inputmode="decimal" min="0" step="0.01" />
        </div>
        <div class="grow">
          <label>Notes</label>
          <input id="e_notes" placeholder="Broker, appointment, OS&D, etc." />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="grow" style="min-width: 250px;">
          <label>Split override (optional)</label>
          <input id="e_splitOverride" type="number" inputmode="decimal" min="0" max="1" step="0.01" placeholder="(blank = driver/global)" />
        </div>
        <div class="grow" style="min-width: 250px;">
          <label>Split model</label>
          <select id="e_splitModel">
            <option value="use_default">Use driver/global default</option>
            <option value="before_expenses">Split BEFORE expenses</option>
            <option value="after_expenses">Split AFTER expenses</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="grow" style="min-width: 300px;">
          <label>Re-route options</label>
          <div class="row" style="gap:10px;">
            <label style="display:flex;align-items:center;gap:8px;margin:0;text-transform:none;letter-spacing:0;font-size:12px;color:rgba(248,250,252,.80);font-weight:1000;">
              <input id="e_reroute" type="checkbox" style="width:18px;height:18px;accent-color: var(--cyan);" />
              Recalculate loaded miles & geometry via OSRM (throttled)
            </label>
            <label style="display:flex;align-items:center;gap:8px;margin:0;text-transform:none;letter-spacing:0;font-size:12px;color:rgba(248,250,252,.80);font-weight:1000;">
              <input id="e_regeocode" type="checkbox" style="width:18px;height:18px;accent-color: var(--cyan);" />
              Re-geocode pickup/drop via Nominatim (if rerouting)
            </label>
          </div>
          <div class="muted" style="margin-top:6px;font-size:12px;line-height:1.35;">
            Editing keeps stored rates/split unless you override them. Reroute is throttled and may fall back to estimated miles if APIs are down.
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div class="grow">
          <div class="pill" id="e_preview">Net (recalc): $0.00</div>
          <div class="muted" id="e_previewHint" style="margin-top:8px;font-size:12px;line-height:1.35;"></div>
        </div>
      </div>
    </div>

    <div class="mFoot">
      <button class="btn danger" onclick="deleteLoadFromEdit()">Delete</button>
      <button class="btn" onclick="closeAllModals()">Cancel</button>
      <button class="btn primary" onclick="saveEdit()">Save Changes</button>
    </div>
  </div>

  <!-- Trash modal -->
  <div id="trashModal" class="modal" role="dialog" aria-modal="true" aria-label="Trash">
    <div class="mHead">
      <div class="t">Trash (30-day)</div>
      <button class="btn" onclick="closeAllModals()">Close</button>
    </div>
    <div class="mBody">
      <div class="muted" style="font-size:12px;line-height:1.4;margin-bottom:10px;">
        Deleted loads/weeks/drivers are kept here for a limited time. Restoring may change IDs if conflicts exist.
      </div>
      <div class="tableWrap" style="min-height:120px;">
        <table style="min-width:860px;">
          <thead>
            <tr>
              <th>When</th>
              <th>Type</th>
              <th>Summary</th>
              <th>Restore</th>
              <th>Purge</th>
            </tr>
          </thead>
          <tbody id="trashList"></tbody>
        </table>
      </div>
      <div class="row noPrint" style="margin-top:10px;">
        <button class="btn danger" onclick="purgeTrash()">Purge all trash now</button>
        <button class="btn" onclick="closeAllModals()">Close</button>
      </div>
    </div>
  </div>

  <!-- Print-only -->
  <div id="printArea"></div>

  <!-- Toast -->
  <div class="toastHost">
    <div id="toast" class="toast">
      <div class="msg" id="toastMsg">Deleted.</div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <button class="btn" onclick="undoDelete()">Undo</button>
        <button class="btn" onclick="openTrash()">Open trash</button>
        <button class="btn" onclick="hideToast()">Dismiss</button>
      </div>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <img src="tag-trans-inc.png" alt="Company logo" onerror="this.style.display='none';" />
        <div>
          <div class="t1">TAG DRIVER PRO</div>
          <div class="t2">Dispatch + driver economics</div>
        </div>
      </div>

      <div class="nav" style="margin-top:12px;">
        <button class="active" data-tab="dashboard" onclick="showTab('dashboard', this)">
          <span class="ico">üß≠</span> Dashboard & Map
        </button>
        <button data-tab="analytics" onclick="showTab('analytics', this)">
          <span class="ico">üìà</span> Analytics
        </button>
        <button data-tab="companycut" onclick="showTab('companycut', this)">
          <span class="ico">üè¢</span> Company Cut
        </button>
        <button data-tab="settings" onclick="showTab('settings', this)">
          <span class="ico">‚öôÔ∏è</span> Settings
        </button>
      </div>

      <div class="meta">
        <div style="font-weight:1200;letter-spacing:.06em;">Local-first</div>
        <div style="margin-top:6px;">
          Data stays on this device. Use Backup + Trash to reduce risk.
        </div>
        <div class="chip"><span class="dot"></span> Ready</div>
      </div>

      <div class="meta">
        <div style="font-weight:1200;letter-spacing:.06em;">Week status</div>
        <div style="margin-top:6px;" id="sideWeekStatus" class="muted">‚Äî</div>
        <div class="row" style="margin-top:10px;">
          <button class="btn" style="width:100%;" onclick="closeWeek()">Close week</button>
          <button class="btn danger" style="width:100%;" onclick="lockWeek()">Lock week</button>
          <button class="btn" style="width:100%;" onclick="reopenWeek()">Reopen</button>
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn" style="width:100%;" onclick="openTrash()">Trash</button>
        </div>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="topLeft">
          <button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>
          <div class="title">
            <div class="h">Tag Driver Pro</div>
            <div class="s" id="subTitle">Modernized single-file command center</div>
          </div>
        </div>

        <div class="topControls">
          <div class="control" style="min-width:240px;">
            <label>Driver</label>
            <select id="driverSelect" onchange="onDriverChange()"></select>
          </div>

          <div class="control" style="min-width:240px;">
            <label>Week</label>
            <select id="weekSelect" onchange="onWeekChange()"></select>
          </div>

          <div class="row" style="gap:8px;align-items:center;">
            <span class="pill" id="weekStatusPill">WEEK: ‚Äî</span>
            <span class="pill" id="backupPill" style="display:none;">Backup recommended</span>
          </div>

          <button class="btn" onclick="addDriver()">‚ûï Driver</button>
          <button class="btn danger" onclick="removeDriver()">üóëÔ∏è Driver</button>

          <button class="btn" onclick="startNewWeek()">‚ûï Week</button>
          <button class="btn danger" onclick="resetCurrentWeek()">üßπ Clear</button>

          <button class="btn" onclick="toggleTheme()">üåì Theme</button>
        </div>
      </header>

      <div id="status" class="status">Processing‚Ä¶</div>
      <div id="warn" class="warnBanner"></div>
      <div id="syncWarn" class="syncBanner"></div>

      <!-- DASHBOARD -->
      <section id="dashboard" class="tab">
        <div class="kpis">
          <div class="kpi">
            <div class="l">Weekly revenue</div>
            <div class="v" id="wk_gross">$0.00</div>
          </div>
          <div class="kpi">
            <div class="l">Weekly miles</div>
            <div class="v" id="wk_miles">0</div>
          </div>
          <div class="kpi">
            <div class="l">Net profit (model)</div>
            <div class="v pos" id="wk_profit">$0.00</div>
          </div>
          <div class="kpi">
            <div class="l">Avg RPM (revenue)</div>
            <div class="v" id="wk_rpm">$0.00</div>
          </div>
          <div class="kpi">
            <div class="l">Break-even RPM</div>
            <div class="v" id="wk_be_rpm">$0.00</div>
          </div>
        </div>

        <div class="grid">
          <div>
            <div class="card noPrint">
              <div class="head">
                <div class="k">New trip entry</div>
                <div class="row" style="gap:8px;align-items:center;">
                  <span class="pill" id="modelPill">Split: ‚Äî</span>
                  <span class="pill" id="fixedModePill">Fixed: ‚Äî</span>
                </div>
              </div>
              <div class="body">
                <div class="row">
                  <div class="grow">
                    <label>Pickup</label>
                    <input id="origin" placeholder="City, State" autocomplete="off" />
                  </div>
                  <div class="grow">
                    <label>Drop</label>
                    <input id="dest" placeholder="City, State" autocomplete="off" />
                  </div>
                </div>

                <div class="row" style="margin-top:10px;">
                  <div class="grow">
                    <label>Recent routes</label>
                    <select id="routeTemplate" onchange="applyRouteTemplate()">
                      <option value="">(select a recent route)</option>
                    </select>
                  </div>
                </div>

                <div class="row" style="margin-top:10px;">
                  <button class="btn" onclick="calcRoute()">üì° Get miles</button>
                  <button class="btn" onclick="verifyMap()">üó∫Ô∏è Verify</button>
                  <button class="btn" onclick="checkTolls()">üí∞ Tolls</button>
                  <button class="btn" onclick="swapCities()">üîÅ Swap</button>
                </div>

                <div class="row" style="margin-top:10px;">
                  <div class="grow">
                    <label>Loaded mi</label>
                    <input id="mi_load" type="number" inputmode="numeric" min="0" step="1" oninput="preview()" />
                  </div>
                  <div class="grow">
                    <label>Deadhead</label>
                    <input id="mi_dh" type="number" inputmode="numeric" min="0" step="1" oninput="preview()" />
                  </div>
                  <div class="grow">
                    <label>Tolls ($)</label>
                    <input id="cost_tolls" type="number" inputmode="decimal" min="0" step="0.01" value="0" oninput="preview()" />
                  </div>
                </div>

                <div class="row" style="margin-top:10px;">
                  <div class="grow">
                    <label>Linehaul / Base pay ($)</label>
                    <input id="pay_base" type="number" inputmode="decimal" min="0" step="0.01" oninput="preview()" />
                  </div>
                  <div class="grow">
                    <label>Fuel surcharge (FSC) ($)</label>
                    <input id="pay_fsc" type="number" inputmode="decimal" min="0" step="0.01" value="0" oninput="preview()" />
                  </div>
                  <div class="grow">
                    <label>Accessorial pay ($)</label>
                    <input id="pay_accessorial" type="number" inputmode="decimal" min="0" step="0.01" value="0" oninput="preview()" />
                  </div>
                </div>

                <div class="row" style="margin-top:10px;">
                  <div class="grow">
                    <label>Reimbursements (not revenue) ($)</label>
                    <input id="pay_reimb" type="number" inputmode="decimal" min="0" step="0.01" value="0" oninput="preview()" />
                  </div>
                  <div class="grow">
                    <label>Notes</label>
                    <textarea id="notes" placeholder="Broker, appointment, detention notes, OS&D, etc."></textarea>
                  </div>
                </div>

                <div class="card" style="margin-top:10px;background: rgba(2,6,23,.55);border-color: rgba(255,255,255,.10);box-shadow:none;">
                  <div class="body" style="padding:12px;text-align:center;">
                    <div style="font-size:10px;color:rgba(248,250,252,.65);letter-spacing:.14em;text-transform:uppercase;font-weight:1200;">
                      Trip net preview
                    </div>
                    <div id="preview_net" style="margin-top:6px;font-size:22px;font-weight:1300;">$0.00</div>
                    <div id="preview_hint" class="muted" style="margin-top:6px;font-size:12px;line-height:1.35;"></div>
                    <div id="preview_warn" style="margin-top:8px;"></div>
                  </div>
                </div>

                <button class="btn primary" style="width:100%;margin-top:10px;" onclick="addLoad()">Add load to week</button>

                <div class="row" style="margin-top:10px;">
                  <button class="btn ghost" style="flex:1;" onclick="saveDraft()">Save draft</button>
                  <button class="btn ghost" style="flex:1;" onclick="clearDraft()">Clear draft</button>
                </div>

                <div class="muted" style="margin-top:10px;font-size:12px;line-height:1.35;">
                  P0/P1 safeguards: split model clarity, dynamic fixed allocations, week locking, data validation, trash restore.
                </div>
              </div>
            </div>

            <div class="card noPrint" style="margin-top:14px;">
              <div class="head"><div class="k">Quick actions</div></div>
              <div class="body">
                <div class="row">
                  <button class="btn" onclick="copySummary()">üìã Copy weekly summary</button>
                  <button class="btn" onclick="exportCSV('week')">‚¨áÔ∏è Export week CSV</button>
                  <button class="btn" onclick="printWeeklySummary()">üñ®Ô∏è Print week</button>
                </div>
                <div class="row" style="margin-top:10px;">
                  <button class="btn" onclick="closeWeek()">‚úÖ Close week</button>
                  <button class="btn danger" onclick="lockWeek()">üîí Lock week</button>
                  <button class="btn" onclick="reopenWeek()">‚Ü©Ô∏è Reopen</button>
                  <button class="btn" onclick="openTrash()">üóëÔ∏è Trash</button>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="head">
              <div class="k">Weekly route map</div>
              <div class="pill">Loaded cyan ‚Ä¢ Deadhead ember (dashed)</div>
            </div>
            <div class="mapWrap"><div id="map"></div></div>
            <div class="mapMeta">
              <div id="mapInfo">Hover rows to highlight routes</div>
              <div class="muted" id="mapCount">0 loads</div>
              <div class="pill" id="apiPill">API: OK</div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="head">
            <div class="k">Weekly load log</div>
            <div class="pill">Search ‚Ä¢ Sort ‚Ä¢ Filter ‚Ä¢ Edit ‚Ä¢ Restore via Trash</div>
          </div>
          <div class="body">
            <div class="tableBar noPrint">
              <div class="left">
                <div class="control" style="min-width:260px;">
                  <label>Search</label>
                  <input id="loadSearch" placeholder="Origin, destination, notes‚Ä¶" oninput="updateUI()" />
                </div>
                <div class="control" style="min-width:210px;">
                  <label>Sort</label>
                  <select id="loadSort" onchange="updateUI()">
                    <option value="date_desc">Date (newest)</option>
                    <option value="net_desc">Net (high ‚Üí low)</option>
                    <option value="rev_desc">Revenue (high ‚Üí low)</option>
                    <option value="miles_desc">Miles (high ‚Üí low)</option>
                    <option value="rpm_desc">RPM rev (high ‚Üí low)</option>
                  </select>
                </div>
                <div class="control" style="min-width:210px;">
                  <label>Filter</label>
                  <select id="loadFilter" onchange="updateUI()">
                    <option value="all">All loads</option>
                    <option value="profit">Net ‚â• 0</option>
                    <option value="loss">Net &lt; 0</option>
                    <option value="tonu">TONU / miles=0</option>
                  </select>
                </div>
              </div>
              <div class="right">
                <div class="pill" id="tableSummary">0 shown</div>
              </div>
            </div>

            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th>Route</th>
                    <th>Miles</th>
                    <th>Revenue</th>
                    <th>Net</th>
                    <th>RPM rev</th>
                    <th>FSC vs Fuel</th>
                    <th>Week status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="loadList"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- ANALYTICS -->
      <section id="analytics" class="tab" style="display:none;">
        <div class="kpis">
          <div class="kpi"><div class="l">Selected driver ‚Ä¢ YTD revenue</div><div class="v" id="ytd_gross">$0.00</div></div>
          <div class="kpi"><div class="l">Selected driver ‚Ä¢ YTD net</div><div class="v pos" id="ytd_profit">$0.00</div></div>
          <div class="kpi"><div class="l">Selected driver ‚Ä¢ Est. tax</div><div class="v neg" id="ytd_tax">$0.00</div></div>
          <div class="kpi"><div class="l">Selected driver ‚Ä¢ OER</div><div class="v" id="oer_val">0%</div></div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="head"><div class="k">Selected driver ‚Ä¢ business health</div></div>
          <div class="body">
            <div class="kv"><div class="k">Total fuel spend (YTD)</div><div class="v neg" id="ytd_fuel">$0.00</div></div>
            <div class="kv"><div class="k">Total maintenance (YTD)</div><div class="v neg" id="ytd_maint">$0.00</div></div>
            <div class="kv"><div class="k">Best week net</div><div class="v pos" id="best_week">$0.00</div></div>
            <div class="kv"><div class="k">Worst week net</div><div class="v neg" id="worst_week">$0.00</div></div>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="head"><div class="k">Selected driver ‚Ä¢ week history</div></div>
          <div class="body" style="padding:0;">
            <div class="tableWrap" style="border-radius:0;border:none;background:transparent;">
              <table style="min-width:760px;">
                <thead>
                  <tr>
                    <th>Week</th><th>Status</th><th>Days</th><th>Loads</th><th>Miles</th><th>Revenue</th><th>Net</th><th>RPM rev</th>
                  </tr>
                </thead>
                <tbody id="weekHistory"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="head"><div class="k">Fleet overview ‚Ä¢ active drivers</div></div>
          <div class="body" style="padding:0;">
            <div class="tableWrap" style="border-radius:0;border:none;background:transparent;">
              <table style="min-width:1080px;">
                <thead>
                  <tr>
                    <th>Driver</th><th>Status</th><th>Split</th>
                    <th>CW Rev</th><th>CW RPM</th><th>CW Net</th>
                    <th>MTD Rev</th><th>MTD RPM</th><th>MTD Net</th>
                    <th>YTD Rev</th><th>YTD RPM</th><th>YTD Net</th>
                    <th>Quick</th>
                  </tr>
                </thead>
                <tbody id="fleetTable"></tbody>
              </table>
            </div>
          </div>
          <div class="body">
            <div class="row noPrint" style="margin-top:10px;">
              <button class="btn" onclick="exportCSV('ytd')">‚¨áÔ∏è Export selected driver YTD CSV</button>
              <button class="btn" onclick="printDriverYTD()">üñ®Ô∏è Print selected driver YTD</button>
              <button class="btn danger" onclick="factoryReset()">Factory reset</button>
            </div>
          </div>
        </div>
      </section>

      <!-- COMPANY CUT -->
      <section id="companycut" class="tab" style="display:none;">
        <div class="kpis">
          <div class="kpi"><div class="l">Company cut ‚Ä¢ current week</div><div class="v" id="cut_cw">$0.00</div></div>
          <div class="kpi"><div class="l">Company cut ‚Ä¢ month-to-date</div><div class="v" id="cut_mtd">$0.00</div></div>
          <div class="kpi"><div class="l">Company cut ‚Ä¢ year-to-date</div><div class="v" id="cut_ytd">$0.00</div></div>
          <div class="kpi"><div class="l">Avg take rate (weighted)</div><div class="v" id="cut_take">0%</div></div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="head"><div class="k">Company cut ‚Ä¢ breakdown (active drivers)</div></div>
          <div class="body" style="padding:0;">
            <div class="tableWrap" style="border-radius:0;border:none;background:transparent;">
              <table style="min-width:860px;">
                <thead>
                  <tr>
                    <th>Driver</th><th>Status</th><th>Split</th>
                    <th>CW Rev</th><th>CW Company cut</th>
                    <th>MTD Rev</th><th>MTD Company cut</th>
                    <th>YTD Rev</th><th>YTD Company cut</th>
                  </tr>
                </thead>
                <tbody id="cutTable"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="head"><div class="k">Notes</div></div>
          <div class="body">
            <div class="muted" style="font-size:12px;line-height:1.45;">
              Company Cut uses each load‚Äôs stored split when available; otherwise it uses current driver/global split.
              Week status controls whether fixed costs can dynamically reallocate in ‚ÄúActual‚Äù mode.
            </div>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="settings" class="tab" style="display:none;">
        <div class="grid">
          <div class="card">
            <div class="head"><div class="k">Financial model (global defaults)</div></div>
            <div class="body">
              <div class="row">
                <div class="grow">
                  <label>Split model default</label>
                  <select id="set_split_model">
                    <option value="before_expenses">Split BEFORE expenses (legacy)</option>
                    <option value="after_expenses">Split AFTER expenses</option>
                  </select>
                </div>
                <div class="grow">
                  <label>Fixed cost mode</label>
                  <select id="set_fixed_mode">
                    <option value="expected">Expected loads per week (projection)</option>
                    <option value="actual">Actual loads this week (dynamic)</option>
                    <option value="rolling">Rolling avg loads (stable)</option>
                  </select>
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="grow">
                  <label>Rolling weeks (if rolling mode)</label>
                  <input id="set_rolling_weeks" type="number" inputmode="numeric" min="1" step="1" />
                </div>
                <div class="grow">
                  <label>Prorate fixed costs for partial weeks</label>
                  <select id="set_prorate_fixed">
                    <option value="0">No (always full weekly fixed)</option>
                    <option value="1">Yes (fixed √ó daysWorked/7)</option>
                  </select>
                </div>
              </div>

              <div class="card" style="margin-top:12px;background: rgba(2,6,23,.55);border-color: rgba(255,255,255,.10);box-shadow:none;">
                <div class="head">
                  <div class="k">After-expenses split scope</div>
                  <div class="pill">Included expenses reduce revenue before split</div>
                </div>
                <div class="body">
                  <div class="row" style="gap:12px;">
                    <label style="display:flex;gap:8px;align-items:center;margin:0;text-transform:none;letter-spacing:0;">
                      <input id="set_after_inc_fuel" type="checkbox" style="width:18px;height:18px;accent-color:var(--cyan);" />
                      Include fuel
                    </label>
                    <label style="display:flex;gap:8px;align-items:center;margin:0;text-transform:none;letter-spacing:0;">
                      <input id="set_after_inc_maint" type="checkbox" style="width:18px;height:18px;accent-color:var(--cyan);" />
                      Include maintenance
                    </label>
                    <label style="display:flex;gap:8px;align-items:center;margin:0;text-transform:none;letter-spacing:0;">
                      <input id="set_after_inc_fixed" type="checkbox" style="width:18px;height:18px;accent-color:var(--cyan);" />
                      Include fixed allocation
                    </label>
                    <label style="display:flex;gap:8px;align-items:center;margin:0;text-transform:none;letter-spacing:0;">
                      <input id="set_after_inc_tolls" type="checkbox" style="width:18px;height:18px;accent-color:var(--cyan);" />
                      Include tolls
                    </label>
                  </div>

                  <div class="muted" style="margin-top:10px;font-size:12px;line-height:1.35;">
                    If an expense is NOT included, it is subtracted after the split (still affects driver net).
                  </div>

                  <div class="pill" id="modelExamplePill" style="margin-top:10px;">Example: ‚Äî</div>
                </div>
              </div>

              <button class="btn primary noPrint" style="width:100%;margin-top:12px;" onclick="saveModelSettings()">Save model defaults</button>
            </div>
          </div>

          <div class="card">
            <div class="head"><div class="k">Global costs & specs</div></div>
            <div class="body">
              <div class="row"><div class="grow"><label>Truck pmt</label><input id="f_truck" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
              <div class="row"><div class="grow"><label>Trailer pmt</label><input id="f_trailer" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
              <div class="row"><div class="grow"><label>Insurance</label><input id="f_ins" type="number" inputmode="decimal" min="0" step="0.01"></div></div>

              <div class="row" style="margin-top:10px;"><div class="grow"><label>Advances</label><input id="f_adv" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
              <div class="row"><div class="grow"><label>Food/personal</label><input id="f_food" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
              <div class="row"><div class="grow"><label>Repairs (actual)</label><input id="f_rep" type="number" inputmode="decimal" min="0" step="0.01"></div></div>

              <div class="row" style="margin-top:10px;">
                <div class="grow"><label>Default split %</label><input id="s_split" type="number" inputmode="decimal" min="0" max="1" step="0.01"></div>
                <div class="grow"><label>Fuel price ($/gal)</label><input id="s_fuel" type="number" inputmode="decimal" min="0" step="0.01"></div>
              </div>
              <div class="row">
                <div class="grow"><label>MPG</label><input id="s_mpg" type="number" inputmode="decimal" min="0.1" step="0.1"></div>
                <div class="grow"><label>Maint ($/mi)</label><input id="s_maint" type="number" inputmode="decimal" min="0" step="0.01"></div>
              </div>
              <div class="row">
                <div class="grow"><label>Expected loads/week</label><input id="s_loads_per_week" type="number" inputmode="numeric" min="1" step="1"></div>
                <div class="grow"><label>Target net/week</label><input id="s_target_net" type="number" inputmode="decimal" min="0" step="0.01"></div>
              </div>
              <div class="row">
                <div class="grow"><label>Tax rate</label><input id="s_tax" type="number" inputmode="decimal" min="0" max="1" step="0.01"></div>
              </div>

              <button class="btn primary noPrint" style="width:100%;margin-top:12px;" onclick="saveGlobalSettings()">Save global settings</button>
              <div class="muted" style="margin-top:10px;font-size:12px;line-height:1.35;">
                Global defaults apply unless the selected driver has financial overrides enabled.
              </div>
            </div>
          </div>
        </div>

        <div class="grid" style="margin-top:14px;">
          <div class="card">
            <div class="head"><div class="k">Selected driver ‚Ä¢ profile</div></div>
            <div class="body">
              <div class="row">
                <div class="grow">
                  <label>Status</label>
                  <select id="d_status">
                    <option value="ACTIVE">ACTIVE</option>
                    <option value="INACTIVE">INACTIVE</option>
                    <option value="ARCHIVED">ARCHIVED</option>
                  </select>
                </div>
                <div class="grow">
                  <label>Truck #</label>
                  <input id="d_truckno" placeholder="(optional)" />
                </div>
              </div>
              <div class="row" style="margin-top:10px;">
                <div class="grow"><label>Phone</label><input id="d_phone" placeholder="(optional)" /></div>
                <div class="grow"><label>Email</label><input id="d_email" placeholder="(optional)" /></div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="grow">
                  <label>Home base (optional)</label>
                  <input id="d_home" placeholder="City, State" />
                </div>
                <div class="grow">
                  <label>Show inactive drivers in dropdown</label>
                  <select id="set_show_inactive">
                    <option value="0">No (ACTIVE only)</option>
                    <option value="1">Yes (ACTIVE+INACTIVE)</option>
                  </select>
                </div>
              </div>

              <button class="btn primary" style="width:100%;margin-top:12px;" onclick="saveDriverProfile()">Save driver profile</button>
            </div>
          </div>

          <div class="card">
            <div class="head"><div class="k">Selected driver ‚Ä¢ financial overrides</div></div>
            <div class="body">
              <div class="row">
                <div class="grow">
                  <label>Enable driver-specific financial settings</label>
                  <select id="d_use_fin">
                    <option value="0">No (use global defaults)</option>
                    <option value="1">Yes (override)</option>
                  </select>
                </div>
                <div class="grow">
                  <label>Driver split override (optional)</label>
                  <input id="d_split" type="number" inputmode="decimal" min="0" max="1" step="0.01" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="grow">
                  <label>Split model override</label>
                  <select id="d_split_model">
                    <option value="">(use global)</option>
                    <option value="before_expenses">Split BEFORE expenses</option>
                    <option value="after_expenses">Split AFTER expenses</option>
                  </select>
                </div>
                <div class="grow">
                  <label>Fixed cost mode override</label>
                  <select id="d_fixed_mode">
                    <option value="">(use global)</option>
                    <option value="expected">Expected</option>
                    <option value="actual">Actual (dynamic)</option>
                    <option value="rolling">Rolling</option>
                  </select>
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="grow"><label>MPG override</label><input id="d_mpg" type="number" inputmode="decimal" min="0.1" step="0.1" placeholder="(blank = global)" /></div>
                <div class="grow"><label>Fuel price override</label><input id="d_fuel" type="number" inputmode="decimal" min="0" step="0.01" placeholder="(blank = global)" /></div>
                <div class="grow"><label>Maint $/mi override</label><input id="d_maint" type="number" inputmode="decimal" min="0" step="0.01" placeholder="(blank = global)" /></div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="grow"><label>Truck pmt override</label><input id="d_f_truck" type="number" inputmode="decimal" min="0" step="0.01" placeholder="(blank = global)" /></div>
                <div class="grow"><label>Trailer pmt override</label><input id="d_f_trailer" type="number" inputmode="decimal" min="0" step="0.01" placeholder="(blank = global)" /></div>
                <div class="grow"><label>Insurance override</label><input id="d_f_ins" type="number" inputmode="decimal" min="0" step="0.01" placeholder="(blank = global)" /></div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="grow"><label>Expected loads/week override</label><input id="d_loads_per_week" type="number" inputmode="numeric" min="1" step="1" placeholder="(blank = global)" /></div>
                <div class="grow"><label>Target net/week override</label><input id="d_target_net" type="number" inputmode="decimal" min="0" step="0.01" placeholder="(blank = global)" /></div>
              </div>

              <button class="btn primary" style="width:100%;margin-top:12px;" onclick="saveDriverFinancialOverrides()">Save driver overrides</button>
              <div class="muted" style="margin-top:10px;font-size:12px;line-height:1.35;">
                Overrides only affect new loads and dynamic fixed allocations for ACTIVE weeks. Closed/locked weeks remain stable unless reopened.
              </div>
            </div>
          </div>
        </div>

        <div class="grid" style="margin-top:14px;">
          <div class="card">
            <div class="head"><div class="k">Endpoints & reliability</div></div>
            <div class="body">
              <div class="row">
                <div class="grow">
                  <label>Nominatim base URL</label>
                  <input id="endpoint_nominatim" placeholder="https://nominatim.openstreetmap.org" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="grow">
                  <label>OSRM base URL</label>
                  <input id="endpoint_osrm" placeholder="https://router.project-osrm.org" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="grow">
                  <label>Min interval per outbound request (ms)</label>
                  <input id="net_min_interval" type="number" inputmode="numeric" min="1100" step="100" />
                </div>
                <div class="grow">
                  <label>Geocode cache TTL (days)</label>
                  <input id="geo_ttl_days" type="number" inputmode="numeric" min="1" step="1" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="grow">
                  <label>Geocode cache max entries</label>
                  <input id="geo_cache_max" type="number" inputmode="numeric" min="50" step="50" />
                </div>
                <div class="grow">
                  <label>Country hint for geocoding</label>
                  <input id="geo_country" placeholder="USA" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <button class="btn primary" onclick="saveEndpointSettings()">Save endpoints</button>
                <button class="btn" onclick="testEndpoints()">Test</button>
                <button class="btn" onclick="openTrash()">Trash</button>
              </div>

              <div class="muted" style="margin-top:10px;font-size:12px;line-height:1.35;">
                If OSRM fails, the app can fall back to an estimated distance (Haversine √ó 1.2) for continuity.
              </div>
            </div>
          </div>

          <div class="card">
            <div class="head"><div class="k">Backup & restore</div></div>
            <div class="body">
              <div class="row">
                <button class="btn primary" onclick="downloadBackup()">‚¨áÔ∏è Download backup JSON</button>
                <button class="btn" onclick="copyBackupToClipboard()">üìã Copy backup JSON</button>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="grow">
                  <label>Import backup JSON</label>
                  <input id="backupFile" type="file" accept="application/json" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <button class="btn" onclick="importBackup('merge')">Import (merge)</button>
                <button class="btn danger" onclick="importBackup('replace')">Import (replace)</button>
              </div>

              <div class="muted" style="margin-top:10px;font-size:12px;line-height:1.35;">
                Backups reduce risk from clearing browser data or moving devices.
              </div>
            </div>
          </div>
        </div>

        <div class="muted" style="margin-top:14px;font-size:12px;">
          Privacy: localStorage is plaintext on this device. Use OS security (lock screen / user accounts) to protect sensitive data.
        </div>
      </section>
    </main>
  </div>

<script>
/* =========================================================
   STORAGE KEYS (PRESERVED)
========================================================= */
const STORE_KEY = "tagdriverpro_v3_state";
const SETTINGS_KEY = "tagdriverpro_v3_settings";
const GEO_CACHE_KEY = "tagdriverpro_v3_geo_cache";

/* New keys (safe additions) */
const TRASH_KEY = "tagdriverpro_v3_trash";
const DRAFT_KEY = "tagdriverpro_v3_draft";

/* =========================================================
   DEFAULT SETTINGS (EXTENDED)
========================================================= */
const defaultSettings = {
  // Global costs
  f_truck: 800, f_trailer: 400, f_ins: 350,
  f_adv: 0, f_food: 0, f_rep: 0,

  // Specs & goals
  s_split: 0.80,
  s_fuel: 3.25,
  s_mpg: 6.5,
  s_maint: 0.17,
  s_loads_per_week: 5,
  s_target_net: 1500,
  s_tax: 0.25,

  // Financial model defaults
  split_model: "before_expenses",           // before_expenses | after_expenses
  fixed_cost_mode: "expected",              // expected | actual | rolling
  rolling_weeks: 4,
  prorate_fixed_for_partial_week: 0,        // 0/1

  // After-expenses split: which expenses are included before split
  after_include_fuel: 1,
  after_include_maint: 1,
  after_include_fixed: 1,
  after_include_tolls: 1,

  // Driver selection / fleet
  show_inactive_drivers: 0,

  // Endpoints + network constraints
  endpoint_nominatim: "https://nominatim.openstreetmap.org",
  endpoint_osrm: "https://router.project-osrm.org",
  network_min_interval_ms: 1100,            // strict >= 1100ms
  geo_ttl_days: 30,
  geo_cache_max: 500,
  geo_country_hint: "USA",

  // UI
  ui_theme: "graphite",

  // Backup reminder
  last_backup_at: null,
  backup_reminder_days: 7,

  // Trash
  trash_ttl_days: 30
};

/* =========================================================
   HELPERS
========================================================= */
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
function money(v){
  const n = Number(v);
  const safe = Number.isFinite(n) ? n : 0;
  return "$" + safe.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function pct(v){ return (Number(v||0)*100).toFixed(1) + "%"; }
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function nowISO(){ return new Date().toISOString(); }
function uuid(){
  if (window.crypto?.randomUUID) return crypto.randomUUID();
  return "id_" + Date.now() + "_" + Math.random().toString(16).slice(2);
}
function clampNum(n, min, max, fallback=min){
  const x = Number(n);
  if (!Number.isFinite(x)) return fallback;
  return Math.min(max, Math.max(min, x));
}
function safeInt(n, fallback){
  const x = parseInt(n, 10);
  return Number.isFinite(x) ? x : fallback;
}
function safeFloat(n, fallback){
  const x = parseFloat(n);
  return Number.isFinite(x) ? x : fallback;
}

function startOfWeek(date=new Date(), weekStartDay=1){
  // 0=Sun .. 6=Sat. Default 1=Mon.
  const d = new Date(date);
  const day = d.getDay();
  // Compute diff from desired start day
  const diff = (day - weekStartDay + 7) % 7;
  d.setDate(d.getDate() - diff);
  d.setHours(0,0,0,0);
  return d;
}
function startOfWeekMonday(date=new Date()){
  return startOfWeek(date, 1);
}
function isoDate(d){
  const x = new Date(d);
  const yyyy = x.getFullYear();
  const mm = String(x.getMonth()+1).padStart(2,"0");
  const dd = String(x.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function fmtWeekLabel(dateObj){
  const d = new Date(dateObj);
  const m = d.toLocaleString(undefined, { month: "short" });
  return `Week of ${m} ${d.getDate()}, ${d.getFullYear()}`;
}
function setStatus(msg, show=true){
  const el = document.getElementById("status");
  el.textContent = msg;
  el.style.display = show ? "block" : "none";
}

/* =========================================================
   SETTINGS LOAD/SAVE
========================================================= */
function loadSettings(){
  const raw = localStorage.getItem(SETTINGS_KEY);
  let s = {};
  try { s = raw ? JSON.parse(raw) : {}; } catch(e){ s = {}; }
  const merged = { ...defaultSettings, ...s };

  merged.network_min_interval_ms = Math.max(1100, safeInt(merged.network_min_interval_ms, 1100));
  merged.geo_ttl_days = Math.max(1, safeInt(merged.geo_ttl_days, 30));
  merged.geo_cache_max = Math.max(50, safeInt(merged.geo_cache_max, 500));
  merged.rolling_weeks = Math.max(1, safeInt(merged.rolling_weeks, 4));
  merged.trash_ttl_days = Math.max(1, safeInt(merged.trash_ttl_days, 30));
  merged.ui_theme = (merged.ui_theme === "steel") ? "steel" : "graphite";

  merged.split_model = (merged.split_model === "after_expenses") ? "after_expenses" : "before_expenses";
  merged.fixed_cost_mode = ["expected","actual","rolling"].includes(merged.fixed_cost_mode) ? merged.fixed_cost_mode : "expected";

  ["after_include_fuel","after_include_maint","after_include_fixed","after_include_tolls","prorate_fixed_for_partial_week","show_inactive_drivers"].forEach(k=>{
    merged[k] = merged[k] ? 1 : 0;
  });

  return merged;
}
function persistSettings(s){
  try { localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }
  catch(e){
    alert("Could not save settings (storage quota?). Consider exporting a backup.");
  }
}

/* =========================================================
   TRASH (SOFT DELETE VAULT)
========================================================= */
function loadTrash(){
  const raw = localStorage.getItem(TRASH_KEY);
  try{
    const t = raw ? JSON.parse(raw) : { items: [] };
    if (!t.items) t.items = [];
    return t;
  } catch(e){
    return { items: [] };
  }
}
function saveTrash(trash){
  try { localStorage.setItem(TRASH_KEY, JSON.stringify(trash)); }
  catch(e){ /* ignore */ }
}
function pruneTrash(){
  const trash = loadTrash();
  const ttlMs = settings.trash_ttl_days * 24*60*60*1000;
  const now = Date.now();
  trash.items = (trash.items || []).filter(it => {
    const t = new Date(it.deletedAt || 0).getTime();
    return (now - t) <= ttlMs;
  });
  // Keep max 300
  trash.items.sort((a,b)=> new Date(b.deletedAt||0) - new Date(a.deletedAt||0));
  trash.items = trash.items.slice(0, 300);
  saveTrash(trash);
}
function pushTrash(type, summary, data, meta={}){
  const trash = loadTrash();
  trash.items = trash.items || [];
  trash.items.unshift({
    id: uuid(),
    type,
    summary,
    deletedAt: nowISO(),
    data,
    meta
  });
  saveTrash(trash);
  pruneTrash();
}
function removeTrashItem(trashId){
  const trash = loadTrash();
  trash.items = (trash.items||[]).filter(it => it.id !== trashId);
  saveTrash(trash);
}
function renderTrash(){
  pruneTrash();
  const trash = loadTrash();
  const body = document.getElementById("trashList");

  const rows = (trash.items||[]).slice(0, 120).map(it=>{
    const when = new Date(it.deletedAt).toLocaleString();
    const type = it.type;
    const summary = escapeHtml(it.summary || "");
    return `
      <tr>
        <td class="muted">${escapeHtml(when)}</td>
        <td>${escapeHtml(type)}</td>
        <td class="muted">${summary}</td>
        <td><button class="miniBtn" onclick="restoreTrash('${it.id}')">Restore</button></td>
        <td><button class="miniBtn danger" onclick="deleteTrash('${it.id}')">Purge</button></td>
      </tr>
    `;
  }).join("");

  body.innerHTML = rows || `<tr><td colspan="5" class="muted" style="padding:16px;">Trash is empty.</td></tr>`;
}
function openTrash(){
  renderTrash();
  document.getElementById("overlay").style.display = "block";
  document.getElementById("trashModal").style.display = "block";
}
function purgeTrash(){
  if (!confirm("Purge all trash now? This cannot be undone.")) return;
  saveTrash({ items: [] });
  renderTrash();
}
function deleteTrash(id){
  if (!confirm("Purge this item?")) return;
  removeTrashItem(id);
  renderTrash();
}
function restoreTrash(trashId){
  const trash = loadTrash();
  const it = (trash.items||[]).find(x=>x.id === trashId);
  if (!it) return;

  try{
    if (it.type === "load"){
      const { driverId, weekId, index } = it.meta || {};
      const d = state.drivers?.[driverId];
      if (!d) return alert("Cannot restore load: driver no longer exists. Restore the driver first (if available).");

      if (!d.weeks?.[weekId]){
        // recreate week
        d.weeks[weekId] = it.meta?.weekSnapshot || null;
        if (!d.weeks[weekId]){
          d.weeks[weekId] = { start: weekId.split("_")[0], label: fmtWeekLabel(new Date(weekId.split("_")[0]+"T00:00:00")), loads: [], lastDropCoords: null, status:"ACTIVE", daysWorked: 7, createdAt: nowISO(), lastModifiedAt: nowISO() };
        }
      }
      const wk = d.weeks[weekId];
      wk.loads = wk.loads || [];

      // Avoid duplicate restore
      if (wk.loads.some(l=>l.id === it.data?.id)){
        return alert("This load already exists in the target week.");
      }

      const insertAt = Number.isFinite(index) ? Math.min(Math.max(0, index), wk.loads.length) : wk.loads.length;
      wk.loads.splice(insertAt, 0, it.data);
      wk.lastModifiedAt = nowISO();

      saveState();
      removeTrashItem(trashId);
      renderTrash();
      updateUI();
      initMap(true);
      return;
    }

    if (it.type === "week"){
      const { driverId, weekId } = it.meta || {};
      const d = state.drivers?.[driverId];
      if (!d) return alert("Cannot restore week: driver no longer exists. Restore driver first.");

      if (d.weeks?.[weekId]){
        return alert("Cannot restore week: a week with this ID already exists.");
      }
      d.weeks[weekId] = it.data;
      d.weeks[weekId].lastModifiedAt = nowISO();

      saveState();
      removeTrashItem(trashId);
      renderTrash();
      renderWeekSelect();
      updateUI();
      return;
    }

    if (it.type === "driver"){
      const driverObj = it.data;
      let newId = it.meta?.driverId || driverObj?.id || `driver_${Date.now()}`;
      while (state.drivers[newId]) newId = newId + "_r" + Math.floor(Math.random()*9999);

      state.drivers[newId] = driverObj;
      if (!state.currentDriverId) state.currentDriverId = newId;

      saveState();
      removeTrashItem(trashId);
      renderTrash();
      renderDriverSelect();
      renderWeekSelect();
      updateUI();
      return;
    }

    alert("Unknown trash item type.");
  } catch(e){
    console.error(e);
    alert("Restore failed (corrupt item or incompatible schema).");
  }
}

/* =========================================================
   STATE CREATE/MIGRATE
========================================================= */
function normalizeDriver(d){
  if (!d || typeof d !== "object") d = {};
  if (!("splitOverride" in d)) d.splitOverride = null;
  if (!d.profile || typeof d.profile !== "object"){
    d.profile = { status:"ACTIVE", phone:"", email:"", truckNo:"", homeBase:"" };
  } else {
    d.profile.status = ["ACTIVE","INACTIVE","ARCHIVED"].includes(d.profile.status) ? d.profile.status : "ACTIVE";
    d.profile.phone = d.profile.phone || "";
    d.profile.email = d.profile.email || "";
    d.profile.truckNo = d.profile.truckNo || "";
    d.profile.homeBase = d.profile.homeBase || "";
  }

  if (!d.finance || typeof d.finance !== "object"){
    d.finance = {
      use: 0,
      split_model: "",
      fixed_cost_mode: "",
      s_mpg: null,
      s_fuel: null,
      s_maint: null,
      s_loads_per_week: null,
      s_target_net: null,
      f_truck: null,
      f_trailer: null,
      f_ins: null
    };
  } else {
    d.finance.use = d.finance.use ? 1 : 0;
    d.finance.split_model = d.finance.split_model || "";
    d.finance.fixed_cost_mode = d.finance.fixed_cost_mode || "";
  }

  if (!d.weeks || typeof d.weeks !== "object") d.weeks = {};
  return d;
}
function normalizeWeek(w, wkId){
  if (!w || typeof w !== "object") w = {};
  if (!w.loads) w.loads = [];
  if (!("lastDropCoords" in w)) w.lastDropCoords = null;

  const base = (w.start || wkId || "").split("_")[0] || isoDate(startOfWeekMonday(new Date()));
  if (!w.start) w.start = base;

  if (!w.label){
    const dt = new Date(base + "T00:00:00");
    w.label = fmtWeekLabel(dt) + (String(wkId||"").includes("_v") ? ` (${String(wkId).split("_v")[1]})` : "");
  }

  // lifecycle fields
  w.status = ["ACTIVE","CLOSED","LOCKED"].includes(w.status) ? w.status : "ACTIVE";
  w.daysWorked = clampNum(w.daysWorked ?? 7, 1, 7, 7);

  if (!w.createdAt) w.createdAt = nowISO();
  if (!w.lastModifiedAt) w.lastModifiedAt = nowISO();
  if (!w.closedAt) w.closedAt = null;

  // normalize loads
  w.loads = (w.loads || []).map(l => normalizeLoad(l, w));
  return w;
}
function normalizeLoad(l, week){
  if (!l || typeof l !== "object") l = {};
  if (!l.id) l.id = uuid();
  if (!l.createdAt){
    const base = week?.start ? new Date(week.start + "T00:00:00") : new Date();
    l.createdAt = base.toISOString();
  }
  if (!("notes" in l)) l.notes = "";
  if (!l.details || typeof l.details !== "object") l.details = {};

  // New pay breakdown (back-compat)
  if (!Number.isFinite(Number(l.details.basePay))) l.details.basePay = Number(l.gross || 0);
  if (!Number.isFinite(Number(l.details.fsc))) l.details.fsc = 0;
  if (!Number.isFinite(Number(l.details.accessorial))) l.details.accessorial = 0;
  if (!Number.isFinite(Number(l.details.reimb))) l.details.reimb = 0;

  // Split model storage
  if (!l.details.splitModel){
    // If not present, treat as legacy before-expenses
    l.details.splitModel = "before_expenses";
  } else if (!["before_expenses","after_expenses"].includes(l.details.splitModel)){
    l.details.splitModel = "before_expenses";
  }

  // miles decomposition (back-compat)
  if (!Number.isFinite(Number(l.details.mi_load))) l.details.mi_load = Number(l.miles || 0);
  if (!Number.isFinite(Number(l.details.mi_dh))) l.details.mi_dh = 0;

  return l;
}

function migrateOrCreateState(){
  const raw = localStorage.getItem(STORE_KEY);
  if (raw){
    try{
      const st = JSON.parse(raw);
      return migrateState(st);
    } catch(e){
      console.warn("State parse failed, recreating.", e);
    }
  }

  const wk = startOfWeekMonday(new Date());
  const baseId = isoDate(wk);

  const driverId = "driver_1";
  const state = {
    currentDriverId: driverId,
    drivers: {
      [driverId]: normalizeDriver({
        name: "Driver 1",
        splitOverride: null,
        currentWeekId: baseId,
        weeks: {
          [baseId]: normalizeWeek({ start: baseId, label: fmtWeekLabel(wk), loads: [], lastDropCoords: null, status:"ACTIVE", daysWorked: 7 }, baseId)
        }
      })
    }
  };
  localStorage.setItem(STORE_KEY, JSON.stringify(state));
  return state;
}

function migrateState(st){
  if (!st || typeof st !== "object") return migrateOrCreateState();
  if (!st.drivers || typeof st.drivers !== "object") st.drivers = {};

  // Ensure current driver
  if (!st.currentDriverId || !st.drivers[st.currentDriverId]){
    st.currentDriverId = Object.keys(st.drivers)[0] || null;
  }

  for (const did of Object.keys(st.drivers)){
    const d = normalizeDriver(st.drivers[did]);
    if (!d.weeks || typeof d.weeks !== "object") d.weeks = {};

    // Ensure current week
    if (!d.currentWeekId || !d.weeks[d.currentWeekId]){
      const wkIds = Object.keys(d.weeks).sort().reverse();
      d.currentWeekId = wkIds[0] || null;
    }

    for (const wkId of Object.keys(d.weeks)){
      d.weeks[wkId] = normalizeWeek(d.weeks[wkId], wkId);
    }

    // Ensure at least one week exists
    if (!Object.keys(d.weeks).length){
      const wk = startOfWeekMonday(new Date());
      const baseId = isoDate(wk);
      d.currentWeekId = baseId;
      d.weeks[baseId] = normalizeWeek({ start: baseId, label: fmtWeekLabel(wk), loads: [], lastDropCoords: null, status:"ACTIVE", daysWorked: 7 }, baseId);
    }

    st.drivers[did] = d;
  }

  // Ensure at least one driver exists
  if (!Object.keys(st.drivers).length){
    const wk = startOfWeekMonday(new Date());
    const baseId = isoDate(wk);
    const driverId = "driver_1";
    st.currentDriverId = driverId;
    st.drivers[driverId] = normalizeDriver({
      name: "Driver 1",
      splitOverride: null,
      currentWeekId: baseId,
      weeks: { [baseId]: normalizeWeek({ start: baseId, label: fmtWeekLabel(wk), loads: [], lastDropCoords: null, status:"ACTIVE", daysWorked: 7 }, baseId) }
    });
  }

  saveState(st);
  return st;
}

function saveState(st=state){
  try { localStorage.setItem(STORE_KEY, JSON.stringify(st)); }
  catch(e){
    alert("Could not save data (storage quota?). Export a backup from Settings.");
  }
}

/* =========================================================
   GLOBAL APP STATE
========================================================= */
let settings = loadSettings();
let state = migrateOrCreateState();

let ui = {
  activeTab: "dashboard",
  lastDelete: null,      // undo stack for last load delete
  editing: null,         // { driverId, weekId, loadId }
  apiOk: true,
  dirtyExternalChange: false
};

/* =========================================================
   RATE-LIMITED REQUEST QUEUE (>= 1.1s)
========================================================= */
function createRateLimitedQueue(minIntervalMs){
  let tail = Promise.resolve();
  let lastStart = 0;
  return function enqueue(task){
    return new Promise((resolve, reject) => {
      tail = tail.then(async () => {
        const now = Date.now();
        const wait = Math.max(0, (lastStart + minIntervalMs) - now);
        if (wait) await sleep(wait);
        lastStart = Date.now();
        try{
          const out = await task();
          resolve(out);
        } catch(e){
          reject(e);
        }
      }).catch(()=>{});
    });
  };
}
let enqueueNet = createRateLimitedQueue(settings.network_min_interval_ms);

async function fetchWithTimeout(url, ms=18000){
  if (window.AbortSignal && AbortSignal.timeout){
    return fetch(url, { signal: AbortSignal.timeout(ms), headers: { "Accept": "application/json" } });
  }
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), ms);
  try{
    return await fetch(url, { signal: ctrl.signal, headers: { "Accept": "application/json" } });
  } finally { clearTimeout(t); }
}
async function fetchRetryJson(url, tries=2, waitMs=850){
  let lastErr = null;
  for (let i=0;i<tries;i++){
    try{
      const res = await fetchWithTimeout(url, 18000);
      if (!res.ok){
        if ((res.status === 429 || res.status >= 500) && i < tries-1){
          await sleep(waitMs * (i+1));
          continue;
        }
        throw new Error(`HTTP ${res.status}`);
      }
      return await res.json();
    } catch(e){
      lastErr = e;
      if (i < tries-1) await sleep(waitMs * (i+1));
    }
  }
  throw lastErr;
}
async function queuedJson(url, tries=2){
  return enqueueNet(() => fetchRetryJson(url, tries, 850));
}

/* =========================================================
   GEO CACHE (WITH PRUNING)
========================================================= */
function loadGeoCache(){
  try { return JSON.parse(localStorage.getItem(GEO_CACHE_KEY) || "{}"); }
  catch(e){ return {}; }
}
function pruneGeoCache(cache){
  // Keep most recent N by ts
  const entries = Object.entries(cache || {});
  if (entries.length <= settings.geo_cache_max) return cache;

  entries.sort((a,b)=> (b[1]?.ts||0) - (a[1]?.ts||0));
  const keep = entries.slice(0, settings.geo_cache_max);
  const out = {};
  for (const [k,v] of keep) out[k] = v;
  return out;
}
function saveGeoCache(cache){
  try {
    const pruned = pruneGeoCache(cache);
    localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(pruned));
  } catch(e){ /* ignore */ }
}
function normalizeCity(q){
  return String(q||"").trim().toLowerCase().replace(/\s+/g," ");
}
async function getLoc(city){
  const q = normalizeCity(city);
  if (!q) return null;

  const cache = loadGeoCache();
  const now = Date.now();
  const TTL = 1000*60*60*24*settings.geo_ttl_days;
  const cacheKey = `${settings.endpoint_nominatim}|${settings.geo_country_hint}|${q}`;

  const hit = cache[cacheKey];
  if (hit?.ts && (now - hit.ts) < TTL) return hit.data;

  const base = settings.endpoint_nominatim.replace(/\/$/,"");
  const hint = String(settings.geo_country_hint || "").trim();
  const query = hint ? `${city}, ${hint}` : city;

  const url = `${base}/search?format=json&addressdetails=0&limit=1&q=${encodeURIComponent(query)}`;
  const data = await queuedJson(url, 2);
  if (!data?.[0]) return null;

  cache[cacheKey] = { ts: now, data: data[0] };
  saveGeoCache(cache);
  return data[0];
}

/* =========================================================
   OSRM ROUTING + ESTIMATE FALLBACK
========================================================= */
function haversineMiles(lat1, lon1, lat2, lon2){
  const R = 3958.8; // miles
  const toRad = (d) => d * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}
async function osrmRouteMilesGeo(lon1, lat1, lon2, lat2){
  const base = settings.endpoint_osrm.replace(/\/$/,"");
  const url = `${base}/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson&steps=false`;
  const j = await queuedJson(url, 2);
  if (!j?.routes?.[0]) throw new Error("Route not found");
  const r = j.routes[0];
  return { miles: Math.round(r.distance * 0.000621371), geo: r.geometry, estimated: false };
}
async function routeWithFallback(lon1, lat1, lon2, lat2){
  try{
    const r = await osrmRouteMilesGeo(lon1, lat1, lon2, lat2);
    ui.apiOk = true;
    return r;
  } catch(e){
    // fallback: haversine * 1.2 road factor
    const est = haversineMiles(lat1, lon1, lat2, lon2) * 1.2;
    ui.apiOk = false;
    return { miles: Math.max(0, Math.round(est)), geo: null, estimated: true };
  }
}

/* =========================================================
   DRIVER/WEEK GETTERS
========================================================= */
function getDriver(){
  const id = state.currentDriverId;
  if (!state.drivers[id]){
    const keys = Object.keys(state.drivers);
    state.currentDriverId = keys[0];
    saveState();
  }
  return state.drivers[state.currentDriverId];
}
function getCurrentWeek(){
  const d = getDriver();
  const wkId = d.currentWeekId;
  if (!d.weeks[wkId]){
    const base = wkId.split("_")[0];
    const dt = new Date(base + "T00:00:00");
    d.weeks[wkId] = normalizeWeek({ start: base, label: fmtWeekLabel(dt), loads: [], lastDropCoords: null }, wkId);
    saveState();
  }
  return d.weeks[d.currentWeekId];
}
function getWeekId(){
  return getDriver().currentWeekId;
}
function isDriverVisible(drv){
  const st = drv?.profile?.status || "ACTIVE";
  if (st === "ARCHIVED") return false;
  if (st === "INACTIVE") return settings.show_inactive_drivers ? true : false;
  return true;
}
function driverStatusLabel(drv){
  return drv?.profile?.status || "ACTIVE";
}

/* =========================================================
   EFFECTIVE CONFIG (GLOBAL + DRIVER OVERRIDES)
========================================================= */
function getGlobalDraftFromInputs(){
  // Read global inputs (exist in DOM always)
  const fixedWeekly = ["f_truck","f_trailer","f_ins","f_adv","f_food","f_rep"]
    .reduce((sum,id)=> sum + (safeFloat(document.getElementById(id).value, 0) || 0), 0);

  return {
    // costs
    fixedWeekly,
    // specs
    split: clampNum(safeFloat(document.getElementById("s_split").value, settings.s_split), 0.01, 1, settings.s_split),
    fuel: clampNum(safeFloat(document.getElementById("s_fuel").value, settings.s_fuel), 0, 25, settings.s_fuel),
    mpg: clampNum(safeFloat(document.getElementById("s_mpg").value, settings.s_mpg), 0.1, 25, settings.s_mpg),
    maint: clampNum(safeFloat(document.getElementById("s_maint").value, settings.s_maint), 0, 5, settings.s_maint),
    loadsPerWeek: Math.max(1, safeInt(document.getElementById("s_loads_per_week").value, settings.s_loads_per_week)),
    targetNet: clampNum(safeFloat(document.getElementById("s_target_net").value, settings.s_target_net), 0, 1e9, settings.s_target_net),
    taxRate: clampNum(safeFloat(document.getElementById("s_tax").value, settings.s_tax), 0, 1, settings.s_tax),

    // model
    splitModel: settings.split_model,
    fixedMode: settings.fixed_cost_mode,
    rollingWeeks: settings.rolling_weeks,
    prorateFixed: settings.prorate_fixed_for_partial_week ? 1 : 0,

    afterScope: {
      fuel: settings.after_include_fuel ? 1 : 0,
      maint: settings.after_include_maint ? 1 : 0,
      fixed: settings.after_include_fixed ? 1 : 0,
      tolls: settings.after_include_tolls ? 1 : 0
    }
  };
}
function getEffectiveConfig(driver, week){
  const g = getGlobalDraftFromInputs();

  // Driver splitOverride (legacy field) always applies if set
  let split = g.split;
  const legacySplit = Number(driver?.splitOverride);
  if (Number.isFinite(legacySplit) && legacySplit > 0 && legacySplit < 1.00001){
    split = legacySplit;
  }

  // Driver financial overrides
  const fin = driver?.finance;
  if (fin?.use){
    const o = fin;

    const oMpg = safeFloat(o.s_mpg, NaN);
    const oFuel = safeFloat(o.s_fuel, NaN);
    const oMaint = safeFloat(o.s_maint, NaN);
    const oLoads = safeInt(o.s_loads_per_week, NaN);
    const oTarget = safeFloat(o.s_target_net, NaN);

    const fixedWeeklyOverride =
      (Number.isFinite(safeFloat(o.f_truck, NaN)) ? safeFloat(o.f_truck, 0) : safeFloat(document.getElementById("f_truck").value, 0)) +
      (Number.isFinite(safeFloat(o.f_trailer, NaN)) ? safeFloat(o.f_trailer, 0) : safeFloat(document.getElementById("f_trailer").value, 0)) +
      (Number.isFinite(safeFloat(o.f_ins, NaN)) ? safeFloat(o.f_ins, 0) : safeFloat(document.getElementById("f_ins").value, 0)) +
      safeFloat(document.getElementById("f_adv").value, 0) +
      safeFloat(document.getElementById("f_food").value, 0) +
      safeFloat(document.getElementById("f_rep").value, 0);

    g.fixedWeekly = fixedWeeklyOverride;

    if (Number.isFinite(oMpg)) g.mpg = clampNum(oMpg, 0.1, 25, g.mpg);
    if (Number.isFinite(oFuel)) g.fuel = clampNum(oFuel, 0, 25, g.fuel);
    if (Number.isFinite(oMaint)) g.maint = clampNum(oMaint, 0, 5, g.maint);
    if (Number.isFinite(oLoads)) g.loadsPerWeek = Math.max(1, oLoads);
    if (Number.isFinite(oTarget)) g.targetNet = clampNum(oTarget, 0, 1e9, g.targetNet);

    if (o.split_model && ["before_expenses","after_expenses"].includes(o.split_model)) g.splitModel = o.split_model;
    if (o.fixed_cost_mode && ["expected","actual","rolling"].includes(o.fixed_cost_mode)) g.fixedMode = o.fixed_cost_mode;
  }

  // Week proration
  const daysWorked = clampNum(week?.daysWorked ?? 7, 1, 7, 7);
  let fixedWeekly = g.fixedWeekly;
  if (g.prorateFixed){
    fixedWeekly = fixedWeekly * (daysWorked / 7);
  }

  return {
    ...g,
    fixedWeekly,
    split,
    daysWorked
  };
}

/* =========================================================
   FIXED COST ALLOCATION MODES
========================================================= */
function computeRollingLoadsDenom(driver, rollingWeeks){
  // Only consider CLOSED/LOCKED weeks (stable)
  const wkIds = Object.keys(driver.weeks||{}).sort().reverse();
  const eligible = [];
  for (const id of wkIds){
    const w = driver.weeks[id];
    if (!w) continue;
    if (w.status === "CLOSED" || w.status === "LOCKED"){
      eligible.push(w);
      if (eligible.length >= rollingWeeks) break;
    }
  }
  if (!eligible.length) return null;
  const avg = eligible.reduce((s,w)=> s + ((w.loads||[]).length), 0) / eligible.length;
  return Math.max(1, Math.round(avg));
}

function fixedDenomForWeek(driver, week, cfg){
  if (cfg.fixedMode === "expected") return Math.max(1, cfg.loadsPerWeek);
  if (cfg.fixedMode === "rolling"){
    const denom = computeRollingLoadsDenom(driver, cfg.rollingWeeks || 4);
    return denom || Math.max(1, cfg.loadsPerWeek);
  }
  // actual
  return Math.max(1, (week.loads||[]).length || 1);
}

function reconcileWeekFixedAllocations(driver, week){
  // Only dynamic in ACTIVE weeks and only if fixedMode is actual
  const cfg = getEffectiveConfig(driver, week);
  if (cfg.fixedMode !== "actual") return;
  if (week.status !== "ACTIVE") return;

  const denom = fixedDenomForWeek(driver, week, cfg);
  const fixedPerLoad = cfg.fixedWeekly / denom;

  // Recompute each load with new fixed allocation, keeping each load's stored rates/split model
  for (const l of (week.loads||[])){
    if (!l.details) l.details = {};

    // preserve per-load split/model if stored; otherwise use current effective model
    if (!l.details.splitModel) l.details.splitModel = cfg.splitModel;

    l.details.fixed = fixedPerLoad;
    l.details.fixedAllocMode = "actual";
    l.details.fixedAllocDenom = denom;
    l.details.fixedWeekly = cfg.fixedWeekly;

    // Ensure mpg/fuel/maint stored or default to cfg
    if (!Number.isFinite(Number(l.details.mpg))) l.details.mpg = cfg.mpg;
    if (!Number.isFinite(Number(l.details.fuelPrice))) l.details.fuelPrice = cfg.fuel;
    if (!Number.isFinite(Number(l.details.maintRate))) l.details.maintRate = cfg.maint;

    // Recompute economics
    computeLoadEconomicsInPlace(l, cfg, { forceSplit: Number.isFinite(Number(l.details.split)) ? Number(l.details.split) : cfg.split });
  }

  week.lastModifiedAt = nowISO();
  saveState();
}

/* =========================================================
   ECONOMICS ENGINE (SPLIT MODEL FIX)
========================================================= */
function calcExpenses(load){
  const miles = Number(load?.miles || 0);
  const tolls = Number(load?.details?.tolls || 0);
  const mpg = Number(load?.details?.mpg || 0);
  const fuelPrice = Number(load?.details?.fuelPrice || 0);
  const maintRate = Number(load?.details?.maintRate || 0);
  const fixed = Number(load?.details?.fixed || 0);

  const fuel = (mpg > 0) ? (miles / mpg) * fuelPrice : 0;
  const maint = miles * maintRate;

  return { fuel, maint, fixed, tolls };
}

function revenueForLoad(load){
  // Revenue excludes reimbursements (pass-through)
  const basePay = Number(load?.details?.basePay || 0);
  const fsc = Number(load?.details?.fsc || 0);
  const accessorial = Number(load?.details?.accessorial || 0);
  return basePay + fsc + accessorial;
}

function splitScopeFromSettings(){
  return {
    fuel: settings.after_include_fuel ? 1 : 0,
    maint: settings.after_include_maint ? 1 : 0,
    fixed: settings.after_include_fixed ? 1 : 0,
    tolls: settings.after_include_tolls ? 1 : 0
  };
}

function computeLoadEconomicsInPlace(load, cfg, opt={}){
  // cfg is effective config at time of computation
  // opt.forceSplit can override split for this calc
  const split = clampNum(opt.forceSplit ?? cfg.split, 0.01, 1, cfg.split);

  const rev = revenueForLoad(load);
  const { fuel, maint, fixed, tolls } = calcExpenses(load);

  const scope = cfg.afterScope || splitScopeFromSettings();

  const expIncluded =
    (scope.fuel ? fuel : 0) +
    (scope.maint ? maint : 0) +
    (scope.fixed ? fixed : 0) +
    (scope.tolls ? tolls : 0);

  const expExcluded =
    (!scope.fuel ? fuel : 0) +
    (!scope.maint ? maint : 0) +
    (!scope.fixed ? fixed : 0) +
    (!scope.tolls ? tolls : 0);

  const splitModel = (load.details?.splitModel && ["before_expenses","after_expenses"].includes(load.details.splitModel))
    ? load.details.splitModel
    : cfg.splitModel;

  let cut = 0;
  let net = 0;
  let profitBeforeSplit = 0;

  if (splitModel === "before_expenses"){
    cut = rev * split;
    net = cut - (fuel + maint + fixed + tolls);
    profitBeforeSplit = rev - (fuel + maint + fixed + tolls);
  } else {
    profitBeforeSplit = rev - expIncluded;
    cut = profitBeforeSplit * split;
    net = cut - expExcluded;
  }

  // Store
  load.gross = rev;
  load.details.split = split;
  load.details.cut = cut;

  load.details.fuel = fuel;
  load.details.maint = maint;
  load.details.fixed = fixed;
  load.details.tolls = tolls;

  load.details.model = splitModel;
  load.details.profitBeforeSplit = profitBeforeSplit;
  load.net = net;

  return load;
}

function computeWeekTotals(week){
  const loads = week.loads || [];
  const gross = loads.reduce((s,l) => s + (Number(l.gross)||0), 0);
  const miles = loads.reduce((s,l) => s + (Number(l.miles)||0), 0);
  const net   = loads.reduce((s,l) => s + (Number(l.net)||0), 0);
  const fuel  = loads.reduce((s,l)=> s + (Number(l.details?.fuel)||0), 0);
  const maint = loads.reduce((s,l)=> s + (Number(l.details?.maint)||0), 0);
  const tolls = loads.reduce((s,l)=> s + (Number(l.details?.tolls)||0), 0);
  const fixed = loads.reduce((s,l)=> s + (Number(l.details?.fixed)||0), 0);
  const rpm   = miles>0 ? gross/miles : 0;
  return { gross,miles,net,fuel,maint,tolls,fixed,rpm };
}

function loadDateFallback(load, week){
  if (load?.createdAt){
    const d = new Date(load.createdAt);
    if (!isNaN(d)) return d;
  }
  if (week?.start){
    const d = new Date(week.start + "T00:00:00");
    if (!isNaN(d)) return d;
  }
  return new Date(0);
}

function totalsForDriverInRange(driver, startDate, endDate){
  let gross=0,miles=0,net=0,fuel=0,maint=0,tolls=0,fixed=0,companyCut=0;
  const start = new Date(startDate); const end = new Date(endDate);

  for (const wkId of Object.keys(driver.weeks||{})){
    const w = driver.weeks[wkId];
    const loads = w.loads || [];
    for (const l of loads){
      const dt = loadDateFallback(l, w);
      if (dt >= start && dt <= end){
        gross += (Number(l.gross)||0);
        miles += (Number(l.miles)||0);
        net   += (Number(l.net)||0);
        fuel  += (Number(l.details?.fuel)||0);
        maint += (Number(l.details?.maint)||0);
        tolls += (Number(l.details?.tolls)||0);
        fixed += (Number(l.details?.fixed)||0);

        const splitUsed = Number.isFinite(Number(l.details?.split)) ? Number(l.details.split) : getEffectiveConfig(driver, w).split;
        companyCut += (Number(l.gross)||0) * (1 - splitUsed);
      }
    }
  }
  const rpm = miles>0 ? gross/miles : 0;
  return { gross,miles,net,fuel,maint,tolls,fixed,rpm,companyCut };
}

/* =========================================================
   WEEK LIFECYCLE (ACTIVE/CLOSED/LOCKED)
========================================================= */
function weekStatusPillClass(status){
  if (status === "ACTIVE") return "good";
  if (status === "CLOSED") return "warn";
  if (status === "LOCKED") return "bad";
  return "";
}
function setWeekStatusPills(){
  const wk = getCurrentWeek();
  const st = wk.status || "ACTIVE";
  const pill = document.getElementById("weekStatusPill");
  pill.textContent = `WEEK: ${st}`;
  pill.className = `pill ${weekStatusPillClass(st)}`;

  const side = document.getElementById("sideWeekStatus");
  side.innerHTML = `${escapeHtml(wk.label)}<br/><span class="muted">Status:</span> <b>${escapeHtml(st)}</b> ‚Ä¢ <span class="muted">Days:</span> <b>${wk.daysWorked || 7}/7</b>`;
}
function ensureWeekEditableOrExplain(){
  const wk = getCurrentWeek();
  if (wk.status === "ACTIVE") return true;

  if (wk.status === "CLOSED"){
    return confirm("This week is CLOSED. Reopen it to edit loads?") ? (reopenWeek(true), true) : false;
  }
  // LOCKED
  return confirm("This week is LOCKED. Unlock (reopen) it to edit loads?") ? (reopenWeek(true), true) : false;
}

function closeWeek(){
  const d = getDriver();
  const wk = getCurrentWeek();
  if (wk.status === "CLOSED" || wk.status === "LOCKED"){
    alert("Week is already closed/locked.");
    return;
  }
  if (!confirm("Close this week? This freezes dynamic fixed allocations and sets status CLOSED.")) return;

  // If dynamic fixed mode, finalize a last reconciliation
  reconcileWeekFixedAllocations(d, wk);

  wk.status = "CLOSED";
  wk.closedAt = nowISO();
  wk.lastModifiedAt = nowISO();
  saveState();
  updateUI();
}
function lockWeek(){
  const d = getDriver();
  const wk = getCurrentWeek();
  if (wk.status === "LOCKED"){
    alert("Week is already locked.");
    return;
  }
  if (!confirm("Lock this week? This is a stronger freeze than CLOSED.")) return;

  reconcileWeekFixedAllocations(d, wk);

  wk.status = "LOCKED";
  wk.closedAt = wk.closedAt || nowISO();
  wk.lastModifiedAt = nowISO();
  saveState();
  updateUI();
}
function reopenWeek(silent=false){
  const wk = getCurrentWeek();
  if (wk.status === "ACTIVE"){
    if (!silent) alert("Week is already active.");
    return;
  }
  if (!silent && !confirm("Reopen this week (set status ACTIVE)? Editing may change totals.")) return;
  wk.status = "ACTIVE";
  wk.lastModifiedAt = nowISO();
  saveState();
  updateUI();
}

/* =========================================================
   NAV + SIDEBAR
========================================================= */
function toggleSidebar(force){
  const open = (typeof force === "boolean") ? force : (document.body.dataset.sidebar !== "open");
  document.body.dataset.sidebar = open ? "open" : "closed";
}
function showTab(id, btn){
  ui.activeTab = id;
  document.querySelectorAll(".tab").forEach(t => t.style.display = "none");
  const el = document.getElementById(id);
  if (el) el.style.display = "block";

  document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active"));
  if (btn) btn.classList.add("active");
  else {
    const b = document.querySelector(`.nav button[data-tab="${id}"]`);
    if (b) b.classList.add("active");
  }

  toggleSidebar(false);

  if (id === "dashboard") setTimeout(()=>initMap(true), 160);
}

/* =========================================================
   DRIVER MENU
========================================================= */
function renderDriverSelect(){
  const sel = document.getElementById("driverSelect");
  const ids = Object.keys(state.drivers);

  const visible = ids.filter(id => isDriverVisible(state.drivers[id]));
  if (!visible.includes(state.currentDriverId)){
    state.currentDriverId = visible[0] || ids[0];
    saveState();
  }

  const list = (settings.show_inactive_drivers ? ids : visible);

  sel.innerHTML = list
    .filter(id => {
      const st = driverStatusLabel(state.drivers[id]);
      if (st === "ARCHIVED") return false;
      if (st === "INACTIVE") return settings.show_inactive_drivers ? true : false;
      return true;
    })
    .map(id => {
      const d = state.drivers[id];
      const selected = (id === state.currentDriverId) ? "selected" : "";
      const st = driverStatusLabel(d);
      return `<option value="${id}" ${selected}>${escapeHtml(d.name)}${st!=="ACTIVE" ? " ["+st+"]" : ""}</option>`;
    }).join("");
}
function onDriverChange(){
  const sel = document.getElementById("driverSelect");
  state.currentDriverId = sel.value;
  saveState();
  renderWeekSelect();
  bindDriverInputs();
  updateUI();
  setTimeout(()=>initMap(true), 120);
}
function addDriver(){
  const name = prompt("Driver name (ex: John Smith):");
  if (!name) return;

  const wk = startOfWeekMonday(new Date());
  const baseId = isoDate(wk);

  const id = `driver_${Date.now()}`;
  state.drivers[id] = normalizeDriver({
    name: name.trim(),
    splitOverride: null,
    currentWeekId: baseId,
    weeks: { [baseId]: normalizeWeek({ start: baseId, label: fmtWeekLabel(wk), loads: [], lastDropCoords: null, status:"ACTIVE", daysWorked:7 }, baseId) }
  });

  state.currentDriverId = id;
  saveState();
  renderDriverSelect();
  renderWeekSelect();
  bindDriverInputs();
  updateUI();
  setTimeout(()=>initMap(true), 120);
}
function removeDriver(){
  const d = getDriver();
  const ids = Object.keys(state.drivers);
  if (ids.length <= 1) return alert("You must keep at least one driver.");

  if (!confirm(`Delete driver "${d.name}"? This moves them to Trash for restore.`)) return;

  // Move to trash
  pushTrash("driver", `Driver: ${d.name}`, d, { driverId: state.currentDriverId });

  delete state.drivers[state.currentDriverId];

  const remaining = Object.keys(state.drivers).filter(id => isDriverVisible(state.drivers[id]));
  state.currentDriverId = remaining[0] || Object.keys(state.drivers)[0];
  saveState();

  renderDriverSelect();
  renderWeekSelect();
  bindDriverInputs();
  updateUI();
  setTimeout(()=>initMap(true), 120);
}

/* =========================================================
   WEEK MENU
========================================================= */
function renderWeekSelect(){
  const sel = document.getElementById("weekSelect");
  const d = getDriver();
  const ids = Object.keys(d.weeks).sort().reverse();
  sel.innerHTML = ids.map(id => {
    const w = d.weeks[id];
    const selected = (id === d.currentWeekId) ? "selected" : "";
    const st = w.status || "ACTIVE";
    return `<option value="${id}" ${selected}>${escapeHtml(w.label || id)}${st!=="ACTIVE" ? " ["+st+"]" : ""}</option>`;
  }).join("");
}
function onWeekChange(){
  const sel = document.getElementById("weekSelect");
  const id = sel.value;
  const d = getDriver();
  if (!d.weeks[id]) return;
  d.currentWeekId = id;
  saveState();
  bindDriverInputs();
  updateUI();
  setTimeout(()=>initMap(true), 120);
}
function startNewWeek(){
  if (!confirm("Start a new week for this driver? Current week will remain saved.")) return;

  const d = getDriver();
  const base = startOfWeekMonday(new Date());
  const baseId = isoDate(base);
  let id = baseId;

  let counter = 1;
  while (d.weeks[id]){ counter++; id = baseId + "_v" + counter; }

  d.weeks[id] = normalizeWeek({
    start: baseId,
    label: fmtWeekLabel(base) + (counter>1?` (${counter})`:""),
    loads: [],
    lastDropCoords: null,
    status: "ACTIVE",
    daysWorked: 7,
    createdAt: nowISO(),
    lastModifiedAt: nowISO()
  }, id);

  d.currentWeekId = id;
  saveState();
  renderWeekSelect();
  updateUI();
  setTimeout(()=>initMap(true), 120);
}
function resetCurrentWeek(){
  const d = getDriver();
  const wk = getCurrentWeek();
  if (!ensureWeekEditableOrExplain()) return;
  if (!confirm("Clear all loads for this week? This moves the week snapshot to Trash for restore.")) return;

  // Save snapshot
  const snapshot = JSON.parse(JSON.stringify(wk));
  pushTrash("week", `Week cleared: ${d.name} ‚Ä¢ ${wk.label}`, snapshot, { driverId: state.currentDriverId, weekId: d.currentWeekId });

  wk.loads = [];
  wk.lastDropCoords = null;
  wk.lastModifiedAt = nowISO();
  saveState();
  updateUI();
  initMap(true);
}

/* =========================================================
   SETTINGS BIND + SAVE
========================================================= */
function bindSettingsToInputs(){
  // model defaults
  document.getElementById("set_split_model").value = settings.split_model;
  document.getElementById("set_fixed_mode").value = settings.fixed_cost_mode;
  document.getElementById("set_rolling_weeks").value = settings.rolling_weeks;
  document.getElementById("set_prorate_fixed").value = settings.prorate_fixed_for_partial_week ? "1" : "0";

  document.getElementById("set_after_inc_fuel").checked = !!settings.after_include_fuel;
  document.getElementById("set_after_inc_maint").checked = !!settings.after_include_maint;
  document.getElementById("set_after_inc_fixed").checked = !!settings.after_include_fixed;
  document.getElementById("set_after_inc_tolls").checked = !!settings.after_include_tolls;

  // global costs/specs
  document.getElementById("f_truck").value = settings.f_truck;
  document.getElementById("f_trailer").value = settings.f_trailer;
  document.getElementById("f_ins").value = settings.f_ins;
  document.getElementById("f_adv").value = settings.f_adv;
  document.getElementById("f_food").value = settings.f_food;
  document.getElementById("f_rep").value = settings.f_rep;

  document.getElementById("s_split").value = settings.s_split;
  document.getElementById("s_fuel").value = settings.s_fuel;
  document.getElementById("s_mpg").value = settings.s_mpg;
  document.getElementById("s_maint").value = settings.s_maint;
  document.getElementById("s_loads_per_week").value = settings.s_loads_per_week;
  document.getElementById("s_target_net").value = settings.s_target_net;
  document.getElementById("s_tax").value = settings.s_tax;

  // driver selection
  document.getElementById("set_show_inactive").value = settings.show_inactive_drivers ? "1" : "0";

  // endpoints
  document.getElementById("endpoint_nominatim").value = settings.endpoint_nominatim;
  document.getElementById("endpoint_osrm").value = settings.endpoint_osrm;
  document.getElementById("net_min_interval").value = settings.network_min_interval_ms;
  document.getElementById("geo_ttl_days").value = settings.geo_ttl_days;
  document.getElementById("geo_cache_max").value = settings.geo_cache_max;
  document.getElementById("geo_country").value = settings.geo_country_hint;

  // Live example update
  updateModelExample();

  // Live preview updates
  [
    "set_split_model","set_fixed_mode","set_rolling_weeks","set_prorate_fixed",
    "set_after_inc_fuel","set_after_inc_maint","set_after_inc_fixed","set_after_inc_tolls"
  ].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener("input", ()=>{ updateModelExample(); updateUI(); });
    el.addEventListener("change", ()=>{ updateModelExample(); updateUI(); });
  });

  [
    "f_truck","f_trailer","f_ins","f_adv","f_food","f_rep",
    "s_split","s_fuel","s_mpg","s_maint","s_loads_per_week","s_target_net","s_tax",
    "set_show_inactive"
  ].forEach(id=>{
    document.getElementById(id).addEventListener("input", ()=>{ preview(); updateUI(); });
  });
}

function updateModelExample(){
  // example: gross 2000, fuel 500, maint 100, fixed 200, tolls 50, split 0.7
  const splitModel = document.getElementById("set_split_model").value;
  const scope = {
    fuel: document.getElementById("set_after_inc_fuel").checked ? 1 : 0,
    maint: document.getElementById("set_after_inc_maint").checked ? 1 : 0,
    fixed: document.getElementById("set_after_inc_fixed").checked ? 1 : 0,
    tolls: document.getElementById("set_after_inc_tolls").checked ? 1 : 0
  };

  const rev = 2000;
  const split = 0.70;
  const fuel = 500, maint = 100, fixed = 200, tolls = 50;
  const expIncluded = (scope.fuel?fuel:0)+(scope.maint?maint:0)+(scope.fixed?fixed:0)+(scope.tolls?tolls:0);
  const expExcluded = (!scope.fuel?fuel:0)+(!scope.maint?maint:0)+(!scope.fixed?fixed:0)+(!scope.tolls?tolls:0);

  let net=0;
  if (splitModel === "before_expenses"){
    net = (rev*split) - (fuel+maint+fixed+tolls);
  } else {
    net = ((rev-expIncluded)*split) - expExcluded;
  }
  document.getElementById("modelExamplePill").textContent =
    `Example (rev $2,000, split 70%): net = ${money(net)} (${splitModel==="before_expenses" ? "before-expenses" : "after-expenses"})`;
}

function saveModelSettings(){
  settings.split_model = document.getElementById("set_split_model").value === "after_expenses" ? "after_expenses" : "before_expenses";
  settings.fixed_cost_mode = ["expected","actual","rolling"].includes(document.getElementById("set_fixed_mode").value)
    ? document.getElementById("set_fixed_mode").value : "expected";
  settings.rolling_weeks = Math.max(1, safeInt(document.getElementById("set_rolling_weeks").value, 4));
  settings.prorate_fixed_for_partial_week = document.getElementById("set_prorate_fixed").value === "1" ? 1 : 0;

  settings.after_include_fuel = document.getElementById("set_after_inc_fuel").checked ? 1 : 0;
  settings.after_include_maint = document.getElementById("set_after_inc_maint").checked ? 1 : 0;
  settings.after_include_fixed = document.getElementById("set_after_inc_fixed").checked ? 1 : 0;
  settings.after_include_tolls = document.getElementById("set_after_inc_tolls").checked ? 1 : 0;

  settings.show_inactive_drivers = document.getElementById("set_show_inactive").value === "1" ? 1 : 0;

  persistSettings(settings);
  alert("Model defaults saved.");
  updateUI();
}

function saveGlobalSettings(){
  const s = {
    // costs
    f_truck: safeFloat(document.getElementById("f_truck").value, 0),
    f_trailer: safeFloat(document.getElementById("f_trailer").value, 0),
    f_ins: safeFloat(document.getElementById("f_ins").value, 0),
    f_adv: safeFloat(document.getElementById("f_adv").value, 0),
    f_food: safeFloat(document.getElementById("f_food").value, 0),
    f_rep: safeFloat(document.getElementById("f_rep").value, 0),

    // specs
    s_split: clampNum(safeFloat(document.getElementById("s_split").value, 0.8), 0.01, 1, 0.8),
    s_fuel: clampNum(safeFloat(document.getElementById("s_fuel").value, 3.25), 0, 25, 3.25),
    s_mpg: clampNum(safeFloat(document.getElementById("s_mpg").value, 6.5), 0.1, 25, 6.5),
    s_maint: clampNum(safeFloat(document.getElementById("s_maint").value, 0.17), 0, 5, 0.17),
    s_loads_per_week: Math.max(1, safeInt(document.getElementById("s_loads_per_week").value, 5)),
    s_target_net: clampNum(safeFloat(document.getElementById("s_target_net").value, 1500), 0, 1e9, 1500),
    s_tax: clampNum(safeFloat(document.getElementById("s_tax").value, 0.25), 0, 1, 0.25),
  };

  Object.assign(settings, s);
  persistSettings(settings);
  alert("Global settings saved.");
  updateUI();
}

function bindDriverInputs(){
  const d = getDriver();

  // profile
  document.getElementById("d_status").value = d.profile.status || "ACTIVE";
  document.getElementById("d_truckno").value = d.profile.truckNo || "";
  document.getElementById("d_phone").value = d.profile.phone || "";
  document.getElementById("d_email").value = d.profile.email || "";
  document.getElementById("d_home").value = d.profile.homeBase || "";

  // finance overrides
  document.getElementById("d_use_fin").value = d.finance.use ? "1" : "0";

  // split override is stored separately as legacy splitOverride as well (keep consistent)
  const legacySplit = Number(d.splitOverride);
  document.getElementById("d_split").value = Number.isFinite(legacySplit) ? legacySplit : (getGlobalDraftFromInputs().split);

  document.getElementById("d_split_model").value = d.finance.split_model || "";
  document.getElementById("d_fixed_mode").value = d.finance.fixed_cost_mode || "";

  document.getElementById("d_mpg").value = (d.finance.s_mpg ?? "") === null ? "" : (d.finance.s_mpg ?? "");
  document.getElementById("d_fuel").value = (d.finance.s_fuel ?? "") === null ? "" : (d.finance.s_fuel ?? "");
  document.getElementById("d_maint").value = (d.finance.s_maint ?? "") === null ? "" : (d.finance.s_maint ?? "");

  document.getElementById("d_f_truck").value = (d.finance.f_truck ?? "") === null ? "" : (d.finance.f_truck ?? "");
  document.getElementById("d_f_trailer").value = (d.finance.f_trailer ?? "") === null ? "" : (d.finance.f_trailer ?? "");
  document.getElementById("d_f_ins").value = (d.finance.f_ins ?? "") === null ? "" : (d.finance.f_ins ?? "");

  document.getElementById("d_loads_per_week").value = (d.finance.s_loads_per_week ?? "") === null ? "" : (d.finance.s_loads_per_week ?? "");
  document.getElementById("d_target_net").value = (d.finance.s_target_net ?? "") === null ? "" : (d.finance.s_target_net ?? "");

  // show inactive setting already bound globally
}

function saveDriverProfile(){
  const d = getDriver();

  d.profile.status = document.getElementById("d_status").value;
  d.profile.truckNo = (document.getElementById("d_truckno").value || "").trim();
  d.profile.phone = (document.getElementById("d_phone").value || "").trim();
  d.profile.email = (document.getElementById("d_email").value || "").trim();
  d.profile.homeBase = (document.getElementById("d_home").value || "").trim();

  settings.show_inactive_drivers = document.getElementById("set_show_inactive").value === "1" ? 1 : 0;
  persistSettings(settings);

  saveState();
  renderDriverSelect();
  updateUI();
  alert("Driver profile saved.");
}

function saveDriverFinancialOverrides(){
  const d = getDriver();
  d.finance.use = document.getElementById("d_use_fin").value === "1" ? 1 : 0;

  const splitOverride = safeFloat(document.getElementById("d_split").value, NaN);
  if (Number.isFinite(splitOverride) && splitOverride > 0 && splitOverride <= 1.00001){
    d.splitOverride = splitOverride;
  } else {
    d.splitOverride = null;
  }

  d.finance.split_model = document.getElementById("d_split_model").value || "";
  d.finance.fixed_cost_mode = document.getElementById("d_fixed_mode").value || "";

  const maybe = (id) => {
    const v = (document.getElementById(id).value || "").trim();
    if (v === "") return null;
    const n = parseFloat(v);
    return Number.isFinite(n) ? n : null;
  };
  const maybeInt = (id) => {
    const v = (document.getElementById(id).value || "").trim();
    if (v === "") return null;
    const n = parseInt(v, 10);
    return Number.isFinite(n) ? n : null;
  };

  d.finance.s_mpg = maybe("d_mpg");
  d.finance.s_fuel = maybe("d_fuel");
  d.finance.s_maint = maybe("d_maint");

  d.finance.f_truck = maybe("d_f_truck");
  d.finance.f_trailer = maybe("d_f_trailer");
  d.finance.f_ins = maybe("d_f_ins");

  d.finance.s_loads_per_week = maybeInt("d_loads_per_week");
  d.finance.s_target_net = maybe("d_target_net");

  saveState();
  alert("Driver overrides saved.");
  updateUI();
}

/* Endpoint settings */
function saveEndpointSettings(){
  const nom = (document.getElementById("endpoint_nominatim").value || "").trim();
  const osrm = (document.getElementById("endpoint_osrm").value || "").trim();
  const minMs = Math.max(1100, safeInt(document.getElementById("net_min_interval").value, 1100));
  const ttl = Math.max(1, safeInt(document.getElementById("geo_ttl_days").value, 30));
  const maxCache = Math.max(50, safeInt(document.getElementById("geo_cache_max").value, 500));
  const hint = (document.getElementById("geo_country").value || "").trim() || "USA";

  if (!nom.startsWith("http")) return alert("Enter a valid Nominatim URL (https://...)");
  if (!osrm.startsWith("http")) return alert("Enter a valid OSRM URL (https://...)");

  settings.endpoint_nominatim = nom.replace(/\/$/,"");
  settings.endpoint_osrm = osrm.replace(/\/$/,"");
  settings.network_min_interval_ms = minMs;
  settings.geo_ttl_days = ttl;
  settings.geo_cache_max = maxCache;
  settings.geo_country_hint = hint;

  enqueueNet = createRateLimitedQueue(settings.network_min_interval_ms);
  persistSettings(settings);
  alert("Endpoints saved.");
}

async function testEndpoints(){
  try{
    setStatus("Testing endpoints (throttled)‚Ä¶", true);
    const loc = await getLoc("Kansas City, MO");
    if (!loc?.lat) throw new Error("Nominatim test failed.");
    const lat1 = Number(loc.lat), lon1 = Number(loc.lon);
    const lat2 = lat1 + 0.04, lon2 = lon1 + 0.04;
    const r = await routeWithFallback(lon1, lat1, lon2, lat2);
    if (!Number.isFinite(r.miles)) throw new Error("OSRM test failed.");
    setStatus("Endpoints OK ‚úÖ", true);
    setTimeout(()=>setStatus("", false), 2500);
  } catch(e){
    console.error(e);
    setStatus("Endpoint test failed. Check URLs, CORS, or rate limits.", true);
    setTimeout(()=>setStatus("", false), 4500);
  }
}

/* =========================================================
   DRAFT AUTOSAVE
========================================================= */
function getEntryDraft(){
  return {
    origin: document.getElementById("origin").value || "",
    dest: document.getElementById("dest").value || "",
    mi_load: document.getElementById("mi_load").value || "",
    mi_dh: document.getElementById("mi_dh").value || "",
    tolls: document.getElementById("cost_tolls").value || "",
    base: document.getElementById("pay_base").value || "",
    fsc: document.getElementById("pay_fsc").value || "",
    acc: document.getElementById("pay_accessorial").value || "",
    reimb: document.getElementById("pay_reimb").value || "",
    notes: document.getElementById("notes").value || ""
  };
}
function saveDraft(){
  try{
    localStorage.setItem(DRAFT_KEY, JSON.stringify({ ts: nowISO(), data: getEntryDraft() }));
    alert("Draft saved.");
  } catch(e){
    alert("Could not save draft (storage quota?).");
  }
}
function clearDraft(){
  localStorage.removeItem(DRAFT_KEY);
  alert("Draft cleared.");
}
function maybeRestoreDraft(){
  const raw = localStorage.getItem(DRAFT_KEY);
  if (!raw) return;
  try{
    const obj = JSON.parse(raw);
    const d = obj?.data || {};
    const anyFilled = ["origin","dest","mi_load","mi_dh","tolls","base","fsc","acc","reimb","notes"].some(k => {
      const el = document.getElementById(k==="base"?"pay_base":k==="fsc"?"pay_fsc":k==="acc"?"pay_accessorial":k==="reimb"?"pay_reimb":k);
      return el && String(el.value||"").trim() !== "";
    });
    if (anyFilled) return;

    if (!confirm("You have an unsaved draft load. Restore it?")) return;

    document.getElementById("origin").value = d.origin || "";
    document.getElementById("dest").value = d.dest || "";
    document.getElementById("mi_load").value = d.mi_load || "";
    document.getElementById("mi_dh").value = d.mi_dh || "";
    document.getElementById("cost_tolls").value = d.tolls || "";
    document.getElementById("pay_base").value = d.base || "";
    document.getElementById("pay_fsc").value = d.fsc || "0";
    document.getElementById("pay_accessorial").value = d.acc || "0";
    document.getElementById("pay_reimb").value = d.reimb || "0";
    document.getElementById("notes").value = d.notes || "";

    preview();
  } catch(e){ /* ignore */ }
}

/* =========================================================
   PREVIEW + VALIDATION
========================================================= */
function classifyOutliers(o){
  const warnings = [];

  if (o.rev > 15000) warnings.push(`Revenue ${money(o.rev)} is unusually high.`);
  if (o.miles > 3000) warnings.push(`Miles (${Math.round(o.miles).toLocaleString()}) is unusually high.`);
  if (o.miles === 0 && o.rev > 0) warnings.push(`TONU / zero-mile load detected. Confirm this is intentional.`);
  if (o.rpm > 10) warnings.push(`RPM (${money(o.rpm)}) is unusually high (possible typo).`);
  if (o.rpm > 0 && o.rpm < 0.5 && o.miles > 0) warnings.push(`RPM (${money(o.rpm)}) is unusually low (possible typo).`);
  if (o.fuelPrice < 1 && o.miles > 0) warnings.push(`Fuel price (${money(o.fuelPrice)}) seems low.`);
  if (o.fuelPrice > 9) warnings.push(`Fuel price (${money(o.fuelPrice)}) seems high.`);
  if (o.mpg < 3) warnings.push(`MPG (${o.mpg.toFixed(1)}) seems low.`);
  if (o.mpg > 12) warnings.push(`MPG (${o.mpg.toFixed(1)}) seems high.`);
  return warnings;
}

function preview(){
  const driver = getDriver();
  const wk = getCurrentWeek();
  const cfg = getEffectiveConfig(driver, wk);

  const origin = document.getElementById("origin").value.trim();
  const dest = document.getElementById("dest").value.trim();

  const miLoad = Math.max(0, safeFloat(document.getElementById("mi_load").value, 0));
  const miDh   = Math.max(0, safeFloat(document.getElementById("mi_dh").value, 0));
  const miles = miLoad + miDh;

  const tolls = Math.max(0, safeFloat(document.getElementById("cost_tolls").value, 0));

  const basePay = Math.max(0, safeFloat(document.getElementById("pay_base").value, 0));
  const fsc = Math.max(0, safeFloat(document.getElementById("pay_fsc").value, 0));
  const accessorial = Math.max(0, safeFloat(document.getElementById("pay_accessorial").value, 0));
  const reimb = Math.max(0, safeFloat(document.getElementById("pay_reimb").value, 0));
  const rev = basePay + fsc + accessorial;

  // fixed allocation preview depends on mode
  const denomNow = fixedDenomForWeek(driver, wk, cfg);
  const denomAfterAdd = cfg.fixedMode === "actual" ? Math.max(1, (wk.loads||[]).length + 1) : denomNow;

  const fixedPerLoadNow = cfg.fixedWeekly / denomNow;
  const fixedPerLoadAfter = cfg.fixedWeekly / denomAfterAdd;

  // For preview, use "after add" allocation if mode=actual, because it will reallocate across week post-insert.
  const fixedForPreview = (cfg.fixedMode === "actual") ? fixedPerLoadAfter : fixedPerLoadNow;

  // Build a synthetic load for economics
  const temp = normalizeLoad({
    id: "temp",
    origin, dest,
    miles,
    createdAt: nowISO(),
    details: {
      basePay, fsc, accessorial, reimb,
      tolls,
      splitModel: cfg.splitModel,
      mpg: cfg.mpg,
      fuelPrice: cfg.fuel,
      maintRate: cfg.maint,
      fixed: fixedForPreview,
      mi_load: miLoad,
      mi_dh: miDh
    }
  }, wk);

  computeLoadEconomicsInPlace(temp, cfg, { forceSplit: cfg.split });

  const el = document.getElementById("preview_net");
  el.textContent = money(temp.net);
  el.className = temp.net >= 0 ? "pos" : "neg";

  const rpm = miles>0 ? (rev/miles) : 0;

  // break-even
  const costAll = Number(temp.details?.fuel||0) + Number(temp.details?.maint||0) + Number(temp.details?.fixed||0) + Number(temp.details?.tolls||0);
  const split = cfg.split;
  const beRev = (cfg.splitModel === "before_expenses")
    ? (split>0 ? costAll / split : 0)
    : (split>0 ? costAll : 0); // after-expenses break-even is stricter; approximation

  const beRpm = miles>0 ? (beRev/miles) : 0;

  // FSC vs fuel insight
  const fscFuelDelta = fsc - Number(temp.details.fuel||0);
  const fscMsg = fsc > 0 ? `FSC ${money(fsc)} vs fuel ${money(temp.details.fuel||0)} ‚Üí ${fscFuelDelta>=0?"+":"-"}${money(Math.abs(fscFuelDelta))}` : `Fuel ${money(temp.details.fuel||0)}`;

  const fixedMsg = (cfg.fixedMode === "actual")
    ? `Fixed/Load: now ${money(fixedPerLoadNow)} (loads=${(wk.loads||[]).length||0}), after add ${money(fixedPerLoadAfter)} (loads=${(wk.loads||[]).length+1})`
    : `Fixed/Load: ${money(fixedPerLoadNow)} (mode=${cfg.fixedMode})`;

  document.getElementById("preview_hint").textContent =
    `Revenue: ${money(rev)} (reimb ${money(reimb)} not counted) ‚Ä¢ Miles: ${Math.round(miles).toLocaleString()} ‚Ä¢ RPM: ${money(rpm)} ‚Ä¢ BE RPM: ${money(beRpm)} ‚Ä¢ ${fscMsg} ‚Ä¢ ${fixedMsg}`;

  // Model pills
  document.getElementById("modelPill").textContent = `Split: ${(cfg.split*100).toFixed(0)}% ‚Ä¢ ${cfg.splitModel==="before_expenses" ? "BEFORE exp" : "AFTER exp"}`;
  document.getElementById("fixedModePill").textContent = `Fixed: ${cfg.fixedMode}${cfg.prorateFixed ? " (prorated)" : ""}`;

  // Outlier warnings
  const warnings = classifyOutliers({
    rev, miles, rpm,
    fuelPrice: cfg.fuel,
    mpg: cfg.mpg
  });

  const warnEl = document.getElementById("preview_warn");
  if (warnings.length){
    warnEl.innerHTML = `<div class="pill warn" style="display:inline-flex;flex-wrap:wrap;gap:8px;line-height:1.35;">‚ö†Ô∏è ${escapeHtml(warnings[0])}${warnings.length>1 ? ` (+${warnings.length-1} more)` : ""}</div>`;
  } else {
    warnEl.innerHTML = "";
  }
}

function validateLoadBeforeCommit(payload){
  // payload: {origin,dest,rev,miles,rpm}
  const warnings = classifyOutliers(payload);
  if (warnings.length){
    return confirm("This entry looks unusual:\n\n- " + warnings.join("\n- ") + "\n\nContinue anyway?");
  }
  return true;
}

/* =========================================================
   LOAD CRUD (ADD / EDIT / DELETE / UNDO)
========================================================= */
function addLoad(){
  if (!ensureWeekEditableOrExplain()) return;

  const driver = getDriver();
  const wk = getCurrentWeek();
  const cfg = getEffectiveConfig(driver, wk);

  const originEl = document.getElementById("origin");
  const destEl = document.getElementById("dest");

  const origin = originEl.value.trim();
  const dest = destEl.value.trim();
  const notes = (document.getElementById("notes").value || "").trim();

  const miLoad = Math.max(0, safeFloat(document.getElementById("mi_load").value, 0));
  const miDh   = Math.max(0, safeFloat(document.getElementById("mi_dh").value, 0));
  const miles = miLoad + miDh;
  const tolls = Math.max(0, safeFloat(document.getElementById("cost_tolls").value, 0));

  const basePay = Math.max(0, safeFloat(document.getElementById("pay_base").value, 0));
  const fsc = Math.max(0, safeFloat(document.getElementById("pay_fsc").value, 0));
  const accessorial = Math.max(0, safeFloat(document.getElementById("pay_accessorial").value, 0));
  const reimb = Math.max(0, safeFloat(document.getElementById("pay_reimb").value, 0));

  const rev = basePay + fsc + accessorial;

  if (!origin || !dest) return alert("Enter pickup & drop first.");
  if (rev <= 0) return alert("Enter revenue (base pay or add-ons). Miles can be 0 for TONU.");

  const rpm = miles>0 ? (rev/miles) : 0;
  if (!validateLoadBeforeCommit({ rev, miles, rpm, fuelPrice: cfg.fuel, mpg: cfg.mpg })) return;

  // Coordinates + geometry from calcRoute (optional)
  const oLat = Number(originEl.dataset.lat);
  const oLon = Number(originEl.dataset.lon);
  const dLat = Number(destEl.dataset.lat);
  const dLon = Number(destEl.dataset.lon);

  let routeGeo = null;
  let dhGeo = null;
  try { routeGeo = JSON.parse(originEl.dataset.routeGeo || "null"); } catch(e){ routeGeo=null; }
  try { dhGeo = JSON.parse(originEl.dataset.dhGeo || "null"); } catch(e){ dhGeo=null; }

  // Fixed allocation at creation
  const denom = (cfg.fixedMode === "actual")
    ? Math.max(1, (wk.loads||[]).length + 1) // preview "after add" denom; then reallocate across week
    : fixedDenomForWeek(driver, wk, cfg);

  const fixedPerLoad = cfg.fixedWeekly / denom;

  const load = normalizeLoad({
    id: uuid(),
    origin, dest,
    notes,
    miles,
    createdAt: nowISO(),
    details: {
      basePay, fsc, accessorial, reimb,
      tolls,
      split: cfg.split,
      splitModel: cfg.splitModel,
      mpg: cfg.mpg,
      fuelPrice: cfg.fuel,
      maintRate: cfg.maint,
      fixed: fixedPerLoad,
      fixedAllocMode: cfg.fixedMode,
      fixedAllocDenom: denom,
      fixedWeekly: cfg.fixedWeekly,
      mi_load: miLoad,
      mi_dh: miDh
    },
    coords: (Number.isFinite(oLat) && Number.isFinite(dLat)) ? { start:{lat:oLat, lon:oLon}, end:{lat:dLat, lon:dLon} } : null,
    routeGeo,
    dhGeo
  }, wk);

  computeLoadEconomicsInPlace(load, cfg, { forceSplit: cfg.split });

  wk.loads.push(load);

  if (Number.isFinite(dLat) && Number.isFinite(dLon)) wk.lastDropCoords = { lat: dLat, lon: dLon };
  else wk.lastDropCoords = null;

  wk.lastModifiedAt = nowISO();
  saveState();

  // Dynamic mode: reallocate
  reconcileWeekFixedAllocations(driver, wk);

  updateUI();
  initMap(true);

  // Reset fields
  ["origin","dest","mi_load","mi_dh","cost_tolls","pay_base","pay_fsc","pay_accessorial","pay_reimb","notes"].forEach(i => {
    const el = document.getElementById(i);
    if (!el) return;
    if (["pay_fsc","pay_accessorial","pay_reimb","cost_tolls"].includes(i)) el.value = "0";
    else el.value = "";
  });
  originEl.dataset.lat=""; originEl.dataset.lon=""; originEl.dataset.routeGeo=""; originEl.dataset.dhGeo="";
  destEl.dataset.lat=""; destEl.dataset.lon="";
  preview();

  // Update route templates
  updateRouteTemplates();
}

function getLoadIndexById(week, loadId){
  return (week.loads || []).findIndex(l => l.id === loadId);
}

function pushLoadToTrash(driverId, weekId, load, index){
  const d = state.drivers[driverId];
  const wk = d?.weeks?.[weekId];
  pushTrash(
    "load",
    `Load: ${d?.name || driverId} ‚Ä¢ ${wk?.label || weekId} ‚Ä¢ ${load?.origin || ""} ‚Üí ${load?.dest || ""}`,
    load,
    { driverId, weekId, index, weekSnapshot: wk ? { start:wk.start, label:wk.label, status:wk.status, daysWorked:wk.daysWorked, createdAt:wk.createdAt, closedAt:wk.closedAt, lastModifiedAt:wk.lastModifiedAt, loads:[], lastDropCoords:null } : null }
  );
}

function delLoadByIndex(index){
  if (!ensureWeekEditableOrExplain()) return;

  const wk = getCurrentWeek();
  const d = getDriver();

  const load = wk.loads[index];
  if (!load) return;

  // Remove from week
  wk.loads.splice(index, 1);

  // Update lastDropCoords
  if (wk.loads.length === 0){
    wk.lastDropCoords = null;
  } else {
    const last = wk.loads[wk.loads.length - 1];
    if (last?.coords?.end?.lat && last?.coords?.end?.lon) wk.lastDropCoords = { lat:last.coords.end.lat, lon:last.coords.end.lon };
    else wk.lastDropCoords = null;
  }

  wk.lastModifiedAt = nowISO();

  // Trash record
  pushLoadToTrash(state.currentDriverId, d.currentWeekId, load, index);

  saveState();

  // Dynamic mode: reallocate
  reconcileWeekFixedAllocations(d, wk);

  updateUI();
  initMap(true);

  // Undo (8 seconds)
  if (ui.lastDelete?.timeoutId) clearTimeout(ui.lastDelete.timeoutId);
  const timeoutId = setTimeout(() => {
    ui.lastDelete = null;
    hideToast();
  }, 8000);

  ui.lastDelete = { driverId: state.currentDriverId, weekId: d.currentWeekId, load, index, timeoutId };

  showToast(`Deleted load: ${load.origin} ‚Üí ${load.dest}.`);
}
function delLoad(id){
  const wk = getCurrentWeek();
  const idx = getLoadIndexById(wk, id);
  if (idx < 0) return;
  if (!confirm("Delete this load? (It will be in Trash for restore)")) return;
  delLoadByIndex(idx);
}

function undoDelete(){
  const pack = ui.lastDelete;
  if (!pack) return;

  const d = state.drivers[pack.driverId];
  if (!d) return hideToast();
  const wk = d.weeks[pack.weekId];
  if (!wk) return hideToast();

  wk.loads.splice(pack.index, 0, pack.load);
  wk.lastModifiedAt = nowISO();

  const last = wk.loads[wk.loads.length - 1];
  if (last?.coords?.end?.lat && last?.coords?.end?.lon) wk.lastDropCoords = { lat:last.coords.end.lat, lon:last.coords.end.lon };
  else wk.lastDropCoords = null;

  // Attempt to remove the most recent matching trash load entry (best-effort)
  const trash = loadTrash();
  const idxTrash = (trash.items||[]).findIndex(it => it.type==="load" && it.data?.id === pack.load?.id);
  if (idxTrash >= 0){
    trash.items.splice(idxTrash, 1);
    saveTrash(trash);
  }

  saveState();
  reconcileWeekFixedAllocations(d, wk);

  ui.lastDelete = null;
  hideToast();
  updateUI();
  initMap(true);
}
function showToast(msg){
  document.getElementById("toastMsg").textContent = msg;
  document.getElementById("toast").style.display = "flex";
}
function hideToast(){
  document.getElementById("toast").style.display = "none";
}

/* =========================================================
   MODALS
========================================================= */
function closeAllModals(){
  document.getElementById("overlay").style.display = "none";
  document.getElementById("detailModal").style.display = "none";
  document.getElementById("editModal").style.display = "none";
  document.getElementById("trashModal").style.display = "none";
  ui.editing = null;
}
function viewDetail(id){
  const d = getDriver();
  const wk = getCurrentWeek();
  const idx = getLoadIndexById(wk, id);
  const l = wk.loads[idx];
  if (!l) return;

  const splitUsed = Number.isFinite(Number(l.details?.split)) ? Number(l.details.split) : getEffectiveConfig(d, wk).split;
  const miLoad = Number(l.details?.mi_load) || 0;
  const miDh = Number(l.details?.mi_dh) || 0;

  const basePay = Number(l.details?.basePay||0);
  const fsc = Number(l.details?.fsc||0);
  const accessorial = Number(l.details?.accessorial||0);
  const reimb = Number(l.details?.reimb||0);

  const model = l.details?.splitModel || "before_expenses";
  const fixedMode = l.details?.fixedAllocMode || "‚Äî";

  document.getElementById("detailBody").innerHTML = `
    <div class="kv"><div class="k">Route</div><div class="v">${escapeHtml(l.origin)} ‚Üí ${escapeHtml(l.dest)}</div></div>
    <div class="kv"><div class="k">Created</div><div class="v">${escapeHtml(new Date(l.createdAt).toLocaleString())}</div></div>

    <div class="kv"><div class="k">Base / FSC / Accessorial</div><div class="v">${money(basePay)} + ${money(fsc)} + ${money(accessorial)}</div></div>
    <div class="kv"><div class="k">Reimbursements</div><div class="v">${money(reimb)} (not revenue)</div></div>

    <div class="kv"><div class="k">Revenue</div><div class="v">${money(l.gross)}</div></div>
    <div class="kv"><div class="k">Split used</div><div class="v">${(splitUsed*100).toFixed(0)}% ‚Ä¢ <span class="mono">${escapeHtml(model)}</span></div></div>

    <div class="kv"><div class="k">Fuel</div><div class="v neg">-${money(l.details?.fuel || 0)}</div></div>
    <div class="kv"><div class="k">Fixed allocation</div><div class="v neg">-${money(l.details?.fixed || 0)} <span class="muted">(mode ${escapeHtml(String(fixedMode))})</span></div></div>
    <div class="kv"><div class="k">Maint</div><div class="v neg">-${money(l.details?.maint || 0)}</div></div>
    <div class="kv"><div class="k">Tolls</div><div class="v neg">-${money(l.details?.tolls || 0)}</div></div>

    <div class="kv"><div class="k">Miles</div><div class="v">${Number(l.miles||0).toLocaleString()} <span class="muted">(loaded ${miLoad.toLocaleString()} + dh ${miDh.toLocaleString()})</span></div></div>

    <div class="kv" style="border-bottom:none;font-size:18px;font-weight:1300;">
      <div class="k">Net profit</div>
      <div class="v ${(l.net||0)>=0 ? "pos" : "neg"}">${money(l.net)}</div>
    </div>
    <div class="muted" style="margin-top:10px;line-height:1.35;">
      Notes: <b>${escapeHtml(l.notes || "‚Äî")}</b>
    </div>
    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
      <button class="btn" onclick="openEdit('${l.id}')">Edit</button>
      <button class="btn danger" onclick="delLoad('${l.id}')">Delete</button>
    </div>
  `;

  document.getElementById("overlay").style.display = "block";
  document.getElementById("detailModal").style.display = "block";
}

function openEdit(id){
  const d = getDriver();
  const wk = getCurrentWeek();

  const locked = wk.status !== "ACTIVE";
  document.getElementById("editWeekLockPill").style.display = locked ? "inline-flex" : "none";
  if (locked){
    // allow view, but saving will prompt reopen
  }

  const idx = getLoadIndexById(wk, id);
  const l = wk.loads[idx];
  if (!l) return;

  ui.editing = { driverId: state.currentDriverId, weekId: d.currentWeekId, loadId: id };

  document.getElementById("e_origin").value = l.origin || "";
  document.getElementById("e_dest").value = l.dest || "";
  document.getElementById("e_notes").value = l.notes || "";

  const miLoad = Number.isFinite(Number(l.details?.mi_load)) ? Number(l.details.mi_load) : (Number(l.miles)||0);
  const miDh = Number.isFinite(Number(l.details?.mi_dh)) ? Number(l.details.mi_dh) : 0;

  document.getElementById("e_mi_load").value = miLoad;
  document.getElementById("e_mi_dh").value = miDh;

  document.getElementById("e_tolls").value = Number(l.details?.tolls || 0);

  document.getElementById("e_basePay").value = Number(l.details?.basePay || 0);
  document.getElementById("e_fsc").value = Number(l.details?.fsc || 0);
  document.getElementById("e_accessorial").value = Number(l.details?.accessorial || 0);
  document.getElementById("e_reimb").value = Number(l.details?.reimb || 0);

  document.getElementById("e_splitOverride").value = "";
  document.getElementById("e_splitModel").value = "use_default";

  document.getElementById("e_reroute").checked = false;
  document.getElementById("e_regeocode").checked = false;

  ["e_origin","e_dest","e_notes","e_mi_load","e_mi_dh","e_tolls","e_basePay","e_fsc","e_accessorial","e_reimb","e_splitOverride","e_splitModel","e_reroute","e_regeocode"].forEach(id2=>{
    const el = document.getElementById(id2);
    el.oninput = updateEditPreview;
    el.onchange = updateEditPreview;
  });
  updateEditPreview();

  document.getElementById("detailModal").style.display = "none";
  document.getElementById("overlay").style.display = "block";
  document.getElementById("editModal").style.display = "block";
}

function updateEditPreview(){
  const e = ui.editing;
  if (!e) return;

  const d = state.drivers[e.driverId];
  const wk = d?.weeks?.[e.weekId];
  if (!wk) return;

  const idx = getLoadIndexById(wk, e.loadId);
  const baseLoad = wk.loads[idx];
  if (!baseLoad) return;

  const cfg = getEffectiveConfig(d, wk);

  const miLoad = Math.max(0, safeFloat(document.getElementById("e_mi_load").value, 0));
  const miDh   = Math.max(0, safeFloat(document.getElementById("e_mi_dh").value, 0));
  const miles  = miLoad + miDh;

  const tolls = Math.max(0, safeFloat(document.getElementById("e_tolls").value, 0));

  const basePay = Math.max(0, safeFloat(document.getElementById("e_basePay").value, 0));
  const fsc = Math.max(0, safeFloat(document.getElementById("e_fsc").value, 0));
  const accessorial = Math.max(0, safeFloat(document.getElementById("e_accessorial").value, 0));
  const reimb = Math.max(0, safeFloat(document.getElementById("e_reimb").value, 0));
  const rev = basePay + fsc + accessorial;

  // Split override
  let split = Number.isFinite(Number(baseLoad.details?.split)) ? Number(baseLoad.details.split) : cfg.split;
  const override = (document.getElementById("e_splitOverride").value || "").trim();
  if (override !== ""){
    const ov = safeFloat(override, NaN);
    if (Number.isFinite(ov) && ov > 0 && ov <= 1.00001) split = ov;
  }

  // Split model override
  let model = baseLoad.details?.splitModel || cfg.splitModel;
  const modelSel = document.getElementById("e_splitModel").value;
  if (modelSel === "before_expenses") model = "before_expenses";
  if (modelSel === "after_expenses") model = "after_expenses";

  // Fixed allocation snapshot (do not reallocate on preview; use stored)
  const fixed = Number(baseLoad.details?.fixed || 0);

  const tmp = normalizeLoad({
    id: "edit_tmp",
    origin: document.getElementById("e_origin").value.trim(),
    dest: document.getElementById("e_dest").value.trim(),
    miles,
    createdAt: baseLoad.createdAt,
    details: {
      basePay, fsc, accessorial, reimb,
      tolls,
      splitModel: model,
      mpg: Number(baseLoad.details?.mpg || cfg.mpg),
      fuelPrice: Number(baseLoad.details?.fuelPrice || cfg.fuel),
      maintRate: Number(baseLoad.details?.maintRate || cfg.maint),
      fixed,
      mi_load: miLoad,
      mi_dh: miDh
    }
  }, wk);

  computeLoadEconomicsInPlace(tmp, cfg, { forceSplit: split });

  document.getElementById("e_preview").textContent = `Net (recalc): ${money(tmp.net)}`;
  document.getElementById("e_preview").className = `pill ${tmp.net>=0 ? "good" : "bad"}`;

  const fscFuelDelta = fsc - Number(tmp.details.fuel||0);
  document.getElementById("e_previewHint").textContent =
    `Revenue ${money(rev)} (reimb ${money(reimb)} not revenue) ‚Ä¢ Miles ${Math.round(miles).toLocaleString()} ‚Ä¢ ` +
    `Split ${(split*100).toFixed(0)}% (${model}) ‚Ä¢ ` +
    `FSC vs Fuel: ${fsc>0 ? (fscFuelDelta>=0?"+":"-")+money(Math.abs(fscFuelDelta)) : "‚Äî"} ‚Ä¢ Fixed ${money(fixed)}`;
}

async function saveEdit(){
  const e = ui.editing;
  if (!e) return;

  const d = state.drivers[e.driverId];
  const wk = d?.weeks?.[e.weekId];
  if (!wk) return;

  if (!ensureWeekEditableOrExplain()) return;

  const idx = getLoadIndexById(wk, e.loadId);
  const l = wk.loads[idx];
  if (!l) return;

  const newOrigin = document.getElementById("e_origin").value.trim();
  const newDest = document.getElementById("e_dest").value.trim();
  const newNotes = document.getElementById("e_notes").value.trim();

  const miLoad = Math.max(0, safeFloat(document.getElementById("e_mi_load").value, 0));
  const miDh   = Math.max(0, safeFloat(document.getElementById("e_mi_dh").value, 0));
  const miles  = miLoad + miDh;

  const tolls = Math.max(0, safeFloat(document.getElementById("e_tolls").value, 0));

  const basePay = Math.max(0, safeFloat(document.getElementById("e_basePay").value, 0));
  const fsc = Math.max(0, safeFloat(document.getElementById("e_fsc").value, 0));
  const accessorial = Math.max(0, safeFloat(document.getElementById("e_accessorial").value, 0));
  const reimb = Math.max(0, safeFloat(document.getElementById("e_reimb").value, 0));
  const rev = basePay + fsc + accessorial;

  if (!newOrigin || !newDest) return alert("Pickup and drop are required.");
  if (rev <= 0) return alert("Revenue must be > 0. Miles may be 0 for TONU.");

  const rpm = miles>0 ? (rev/miles) : 0;
  if (!validateLoadBeforeCommit({ rev, miles, rpm, fuelPrice: Number(l.details?.fuelPrice||settings.s_fuel), mpg: Number(l.details?.mpg||settings.s_mpg) })) return;

  // Split override
  const cfg = getEffectiveConfig(d, wk);
  let split = Number.isFinite(Number(l.details?.split)) ? Number(l.details.split) : cfg.split;
  const override = (document.getElementById("e_splitOverride").value || "").trim();
  if (override !== ""){
    const ov = safeFloat(override, NaN);
    if (Number.isFinite(ov) && ov > 0 && ov <= 1.00001) split = ov;
  }

  // Split model override
  let splitModel = l.details?.splitModel || cfg.splitModel;
  const modelSel = document.getElementById("e_splitModel").value;
  if (modelSel === "before_expenses") splitModel = "before_expenses";
  if (modelSel === "after_expenses") splitModel = "after_expenses";
  // if use_default: keep stored

  const doReroute = document.getElementById("e_reroute").checked;
  const doRegeocode = document.getElementById("e_regeocode").checked;

  try{
    if (doReroute){
      setStatus("Re-routing (throttled)‚Ä¶", true);

      let oLat, oLon, dLat, dLon;
      if (!doRegeocode && l.coords?.start?.lat && l.coords?.end?.lat){
        oLat = l.coords.start.lat; oLon = l.coords.start.lon;
        dLat = l.coords.end.lat;   dLon = l.coords.end.lon;
      } else {
        const locA = await getLoc(newOrigin);
        const locB = await getLoc(newDest);
        if (!locA || !locB) throw new Error("Geocode failed (check spelling).");

        oLat = Number(locA.lat); oLon = Number(locA.lon);
        dLat = Number(locB.lat); dLon = Number(locB.lon);
      }

      const r = await routeWithFallback(oLon,oLat,dLon,dLat);

      // Update only loaded portion + geometry
      l.details.mi_load = r.miles;
      l.details.mi_dh = miDh;
      l.miles = r.miles + miDh;

      l.coords = { start:{lat:oLat, lon:oLon}, end:{lat:dLat, lon:dLon} };
      l.routeGeo = r.geo || null;

      setStatus("", false);
    } else {
      l.details.mi_load = miLoad;
      l.details.mi_dh = miDh;
      l.miles = miles;
    }

    l.origin = newOrigin;
    l.dest = newDest;
    l.notes = newNotes;

    l.details.basePay = basePay;
    l.details.fsc = fsc;
    l.details.accessorial = accessorial;
    l.details.reimb = reimb;

    l.details.tolls = tolls;
    l.details.splitModel = splitModel;
    l.details.split = split;

    // Keep stored mpg/fuel/maint unless missing; if missing, inherit cfg
    if (!Number.isFinite(Number(l.details.mpg))) l.details.mpg = cfg.mpg;
    if (!Number.isFinite(Number(l.details.fuelPrice))) l.details.fuelPrice = cfg.fuel;
    if (!Number.isFinite(Number(l.details.maintRate))) l.details.maintRate = cfg.maint;

    // Recompute economics using stored fixed allocation (dynamic mode may reallocate below)
    computeLoadEconomicsInPlace(l, cfg, { forceSplit: split });

    wk.lastModifiedAt = nowISO();
    saveState();

    // Dynamic mode: reallocate
    reconcileWeekFixedAllocations(d, wk);

    updateUI();
    initMap(true);
    closeAllModals();

  } catch(err){
    console.error(err);
    setStatus("Edit save failed (try again).", true);
    setTimeout(()=>setStatus("", false), 3500);
  }
}

function deleteLoadFromEdit(){
  const e = ui.editing;
  if (!e) return;

  const wk = getCurrentWeek();
  const idx = getLoadIndexById(wk, e.loadId);
  if (idx < 0) return;
  if (!confirm("Delete this load?")) return;
  closeAllModals();
  delLoadByIndex(idx);
}

/* =========================================================
   MAP (LEAFLET) + LAYER MANAGEMENT
========================================================= */
let map = null;
let baseLayer = null;
let markersGroup = null;
let loadedGroup = null;
let deadheadGroup = null;
let byLoadLine = new Map();

function initMap(forceInvalidate=false){
  if (!map){
    map = L.map("map", { zoomControl: true }).setView([39.82,-98.58], 4);

    baseLayer = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{
      maxZoom: 19,
      attribution: 'Map tiles by CARTO, under CC BY 3.0. Data by OpenStreetMap, under ODbL.'
    }).addTo(map);

    markersGroup = L.featureGroup().addTo(map);
    loadedGroup = L.featureGroup().addTo(map);
    deadheadGroup = L.featureGroup().addTo(map);

    L.control.layers(
      { "Dark Matter": baseLayer },
      { "Markers": markersGroup, "Loaded routes": loadedGroup, "Deadhead": deadheadGroup },
      { collapsed: true }
    ).addTo(map);
  }

  markersGroup.clearLayers();
  loadedGroup.clearLayers();
  deadheadGroup.clearLayers();
  byLoadLine.clear();

  const wk = getCurrentWeek();
  const pts = [];

  (wk.loads || []).forEach((l, i) => {
    if (l.coords?.start?.lat && l.coords?.end?.lat){
      const s = l.coords.start, e = l.coords.end;
      const id = l.id;

      const m1 = L.marker([s.lat, s.lon]).bindPopup(`<b>Load ${i+1} Pickup</b><br>${escapeHtml(l.origin)}`);
      const m2 = L.marker([e.lat, e.lon]).bindPopup(`<b>Load ${i+1} Drop</b><br>${escapeHtml(l.dest)}`);
      markersGroup.addLayer(m1);
      markersGroup.addLayer(m2);

      pts.push([s.lat, s.lon], [e.lat, e.lon]);

      let loadedLine;
      if (l.routeGeo?.coordinates?.length){
        const latlngs = l.routeGeo.coordinates.map(c=>[c[1], c[0]]);
        loadedLine = L.polyline(latlngs, { color: "#38bdf8", weight: 4, opacity: .75 });
      } else {
        loadedLine = L.polyline([[s.lat,s.lon],[e.lat,e.lon]], { color: "#38bdf8", weight: 4, opacity: .55, dashArray: "6 8" });
      }
      loadedLine.addTo(loadedGroup);

      let dhLine = null;
      if (l.dhGeo?.coordinates?.length){
        const latlngs = l.dhGeo.coordinates.map(c=>[c[1], c[0]]);
        dhLine = L.polyline(latlngs, { color: "#ff6a3d", weight: 3, opacity: .70, dashArray: "3 8" });
        dhLine.addTo(deadheadGroup);
      }
      byLoadLine.set(id, { loadedLine, dhLine });
    }
  });

  document.getElementById("mapCount").textContent = `${(wk.loads||[]).length} loads`;
  document.getElementById("apiPill").textContent = `API: ${ui.apiOk ? "OK" : "EST"}`;
  document.getElementById("apiPill").className = `pill ${ui.apiOk ? "good" : "warn"}`;

  if (pts.length > 0) map.fitBounds(pts, { padding: [50,50] });
  if (forceInvalidate) setTimeout(()=>map.invalidateSize(), 60);
}

function highlightLoadOnMap(loadId, on){
  const pack = byLoadLine.get(loadId);
  if (!pack) return;
  const emphasize = (line) => {
    if (!line) return;
    line.setStyle({ weight: on ? 6 : 4, opacity: on ? .95 : .75 });
  };
  emphasize(pack.loadedLine);
  if (pack.dhLine){
    pack.dhLine.setStyle({ weight: on ? 5 : 3, opacity: on ? .90 : .70 });
  }
}

/* =========================================================
   ROUTING WORKFLOW
========================================================= */
async function calcRoute(){
  if (!ensureWeekEditableOrExplain()) return;

  const o = document.getElementById("origin").value;
  const d = document.getElementById("dest").value;
  if (!o || !d) return alert("Enter cities first");

  try{
    setStatus("Finding cities‚Ä¶ (throttled)", true);
    const locA = await getLoc(o);
    const locB = await getLoc(d);
    if (!locA || !locB){
      setStatus("City not found (check spelling)", true);
      setTimeout(()=>setStatus("", false), 3200);
      return;
    }

    const oLat = Number(locA.lat), oLon = Number(locA.lon);
    const dLat = Number(locB.lat), dLon = Number(locB.lon);

    const originEl = document.getElementById("origin");
    const destEl = document.getElementById("dest");
    originEl.dataset.lat = oLat;
    originEl.dataset.lon = oLon;
    destEl.dataset.lat = dLat;
    destEl.dataset.lon = dLon;

    setStatus("Calculating loaded route‚Ä¶ (throttled)", true);
    const loaded = await routeWithFallback(oLon,oLat,dLon,dLat);
    document.getElementById("mi_load").value = loaded.miles;

    const wk = getCurrentWeek();
    if (wk.lastDropCoords?.lat && wk.lastDropCoords?.lon){
      setStatus("Calculating deadhead‚Ä¶ (throttled)", true);
      const dh = await routeWithFallback(wk.lastDropCoords.lon, wk.lastDropCoords.lat, oLon, oLat);
      document.getElementById("mi_dh").value = dh.miles;
      originEl.dataset.dhGeo = JSON.stringify(dh.geo || null);
    } else {
      document.getElementById("mi_dh").value = 0;
      originEl.dataset.dhGeo = JSON.stringify(null);
    }

    originEl.dataset.routeGeo = JSON.stringify(loaded.geo || null);

    setStatus("", false);
    preview();
  } catch(e){
    console.error(e);
    setStatus("Routing failed (try again in 30s)", true);
    setTimeout(()=>setStatus("", false), 3500);
  }
}

/* Tools */
function verifyMap(){
  const o = document.getElementById("origin").value;
  const d = document.getElementById("dest").value;
  if (o && d) window.open(`https://www.google.com/maps/dir/${encodeURIComponent(o)}/${encodeURIComponent(d)}`);
}
function checkTolls(){
  const o = document.getElementById("origin").value;
  const d = document.getElementById("dest").value;
  if (!o || !d) return;
  navigator.clipboard?.writeText?.(o + " to " + d).then(()=>{
    alert("Copied route. Paste into TollGuru.");
    window.open("https://tollguru.com/toll-calculator");
  }).catch(()=>{
    alert("Could not copy automatically. Open TollGuru and paste route manually.");
    window.open("https://tollguru.com/toll-calculator");
  });
}
function swapCities(){
  const o = document.getElementById("origin");
  const d = document.getElementById("dest");
  const tmp = o.value; o.value = d.value; d.value = tmp;
  preview();
}

/* =========================================================
   ROUTE TEMPLATES (LAST 12 UNIQUE)
========================================================= */
function updateRouteTemplates(){
  const d = getDriver();
  const wk = getCurrentWeek();

  const pairs = [];
  // Gather from current driver recent loads across weeks
  const wkIds = Object.keys(d.weeks||{}).sort().reverse();
  for (const id of wkIds){
    const w = d.weeks[id];
    for (const l of (w.loads||[])){
      const key = `${(l.origin||"").trim()} ‚Üí ${(l.dest||"").trim()}`;
      if (!pairs.some(p=>p.key===key)){
        pairs.push({ key, origin:l.origin, dest:l.dest });
      }
      if (pairs.length >= 12) break;
    }
    if (pairs.length >= 12) break;
  }

  const sel = document.getElementById("routeTemplate");
  const current = sel.value || "";
  sel.innerHTML = `<option value="">(select a recent route)</option>` + pairs.map((p,i)=>`<option value="${i}">${escapeHtml(p.key)}</option>`).join("");
  sel.value = ""; // reset on update
  sel.dataset.list = JSON.stringify(pairs);
}
function applyRouteTemplate(){
  const sel = document.getElementById("routeTemplate");
  const idx = safeInt(sel.value, -1);
  if (idx < 0) return;
  let list = [];
  try { list = JSON.parse(sel.dataset.list || "[]"); } catch(e){ list=[]; }
  const item = list[idx];
  if (!item) return;
  document.getElementById("origin").value = item.origin || "";
  document.getElementById("dest").value = item.dest || "";
  preview();
}

/* =========================================================
   EXPORT / COPY / PRINT + BACKUP
========================================================= */
async function copySummary(){
  const d = getDriver();
  const wk = getCurrentWeek();
  const cfg = getEffectiveConfig(d, wk);
  const t = computeWeekTotals(wk);

  const summary =
`TAG DRIVER PRO ‚Äî WEEK SUMMARY
Driver: ${d.name}
Week: ${wk.label}
Status: ${wk.status}
Days Worked: ${wk.daysWorked}/7
Split: ${(cfg.split*100).toFixed(0)}% (${cfg.splitModel})
Fixed Mode: ${cfg.fixedMode}${cfg.prorateFixed ? " (prorated)" : ""}
Loads: ${wk.loads.length}
Revenue: ${money(t.gross)}
Miles: ${t.miles.toLocaleString()}
Net:   ${money(t.net)}
RPM:   ${money(t.rpm)}`;

  try{
    if (!navigator.clipboard?.writeText) throw new Error("Clipboard unsupported");
    await navigator.clipboard.writeText(summary);
    alert("Weekly summary copied.");
  } catch(e){
    prompt("Copy this summary:", summary);
  }
}

function downloadsFile(filename, content, type="text/plain"){
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
}
function safeFileDate(s){ return String(s||"").replace(/[^0-9\-]/g,""); }
function csvEscape(v){
  const s = (v === null || v === undefined) ? "" : String(v);
  if (/[,"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}

function flattenLoad(l){
  const miles = Number(l.miles||0);
  const rev = Number(l.gross||0);
  const miLoad = Number(l.details?.mi_load||0);
  const miDh = Number(l.details?.mi_dh||0);

  const basePay = Number(l.details?.basePay||0);
  const fsc = Number(l.details?.fsc||0);
  const accessorial = Number(l.details?.accessorial||0);
  const reimb = Number(l.details?.reimb||0);

  return {
    createdAt: l.createdAt ? new Date(l.createdAt).toLocaleString() : "",
    origin: l.origin || "",
    dest: l.dest || "",
    notes: l.notes || "",
    status_week: getCurrentWeek().status || "",
    miles: miles,
    mi_load: miLoad,
    mi_dh: miDh,
    basePay,
    fsc,
    accessorial,
    reimb,
    revenue: rev,
    net: Number(l.net||0),
    split: Number(l.details?.split||0),
    splitModel: l.details?.splitModel || "",
    fixedAllocMode: l.details?.fixedAllocMode || "",
    fixed: Number(l.details?.fixed||0),
    tolls: Number(l.details?.tolls||0),
    fuel: Number(l.details?.fuel||0),
    maint: Number(l.details?.maint||0),
    rpm_rev: miles>0 ? (rev/miles).toFixed(4) : "0"
  };
}

function exportCSV(scope="week"){
  const d = getDriver();
  const wk = getCurrentWeek();

  const now = new Date();
  const yearStart = new Date(now.getFullYear(), 0, 1, 0,0,0,0);

  let rows = [];
  if (scope === "week"){
    rows = (wk.loads||[]).map(l => ({ driver: d.name, week: wk.label, weekStatus: wk.status, ...flattenLoad(l) }));
  } else if (scope === "ytd"){
    rows = [];
    for (const wkId of Object.keys(d.weeks||{})){
      const w = d.weeks[wkId];
      for (const l of (w.loads||[])){
        const dt = loadDateFallback(l, w);
        if (dt >= yearStart && dt <= now){
          rows.push({ driver: d.name, week: (w.label||wkId), weekStatus: w.status, ...flattenLoad(l) });
        }
      }
    }
  } else return alert("Unknown CSV scope.");

  const headers = Object.keys(rows[0] || {});

  const csv = [
    headers.join(","),
    ...rows.map(r => headers.map(h => csvEscape(r[h])).join(","))
  ].join("\n");

  const fname = (scope === "week")
    ? `tagdriverpro_week_${safeFileDate(wk.start)}.csv`
    : `tagdriverpro_ytd_${safeFileDate(isoDate(now))}.csv`;

  downloadsFile(fname, csv, "text/csv");
}

function printWeeklySummary(){
  const d = getDriver();
  const wk = getCurrentWeek();
  const cfg = getEffectiveConfig(d, wk);
  const t = computeWeekTotals(wk);

  const html = `
    <h1>TAG DRIVER PRO ‚Äî Weekly Summary</h1>
    <div class="pCard">
      <div><b>Driver:</b> ${escapeHtml(d.name)}</div>
      <div><b>Status:</b> ${escapeHtml(d.profile.status || "ACTIVE")} ‚Ä¢ <b>Truck #:</b> ${escapeHtml(d.profile.truckNo || "‚Äî")}</div>
      <div><b>Contact:</b> ${escapeHtml(d.profile.phone || "‚Äî")} ‚Ä¢ ${escapeHtml(d.profile.email || "‚Äî")}</div>
      <div><b>Week:</b> ${escapeHtml(wk.label)} ‚Ä¢ <b>Week status:</b> ${escapeHtml(wk.status)} ‚Ä¢ <b>Days:</b> ${wk.daysWorked}/7</div>
      <div><b>Split:</b> ${(cfg.split*100).toFixed(0)}% (${escapeHtml(cfg.splitModel)}) ‚Ä¢ <b>Fixed:</b> ${escapeHtml(cfg.fixedMode)}${cfg.prorateFixed?" (prorated)":""}</div>
    </div>

    <div class="pCard">
      <div class="pGrid">
        <div class="pStat"><b>Revenue</b><div class="right">${money(t.gross)}</div></div>
        <div class="pStat"><b>Miles</b><div class="right">${t.miles.toLocaleString()}</div></div>
        <div class="pStat"><b>Net</b><div class="right">${money(t.net)}</div></div>
        <div class="pStat"><b>RPM</b><div class="right">${money(t.rpm)}</div></div>
      </div>
    </div>

    <div class="pCard">
      <h2>Loads</h2>
      <table>
        <thead><tr><th>Date</th><th>Route</th><th>Miles</th><th>Revenue</th><th>Net</th><th>Notes</th></tr></thead>
        <tbody>
          ${(wk.loads||[]).map(l => `
            <tr>
              <td>${escapeHtml(l.createdAt ? new Date(l.createdAt).toLocaleDateString() : "")}</td>
              <td>${escapeHtml(l.origin)} ‚Üí ${escapeHtml(l.dest)}</td>
              <td>${Number(l.miles||0).toLocaleString()}</td>
              <td>${money(l.gross)}</td>
              <td>${money(l.net)}</td>
              <td>${escapeHtml(l.notes||"")}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;
  document.getElementById("printArea").innerHTML = html;
  window.print();
}

function printDriverYTD(){
  const d = getDriver();
  const now = new Date();
  const yearStart = new Date(now.getFullYear(), 0, 1, 0,0,0,0);
  const ytd = totalsForDriverInRange(d, yearStart, now);
  const taxRate = clampNum(safeFloat(document.getElementById("s_tax").value, settings.s_tax), 0, 1, settings.s_tax);

  const html = `
    <h1>TAG DRIVER PRO ‚Äî Driver YTD Report</h1>
    <div class="pCard">
      <div><b>Driver:</b> ${escapeHtml(d.name)}</div>
      <div><b>Status:</b> ${escapeHtml(d.profile.status || "ACTIVE")} ‚Ä¢ <b>Truck #:</b> ${escapeHtml(d.profile.truckNo || "‚Äî")}</div>
      <div><b>As of:</b> ${escapeHtml(now.toLocaleString())}</div>
    </div>

    <div class="pCard">
      <div class="pGrid">
        <div class="pStat"><b>YTD Revenue</b><div class="right">${money(ytd.gross)}</div></div>
        <div class="pStat"><b>YTD Miles</b><div class="right">${ytd.miles.toLocaleString()}</div></div>
        <div class="pStat"><b>YTD Net</b><div class="right">${money(ytd.net)}</div></div>
        <div class="pStat"><b>Est. Tax</b><div class="right">${money(ytd.net * taxRate)}</div></div>
      </div>
      <div style="margin-top:10px;"><b>OER:</b> ${ytd.gross>0 ? Math.round(((ytd.gross - ytd.net)/ytd.gross)*100)+'%' : '0%'}</div>
    </div>
  `;
  document.getElementById("printArea").innerHTML = html;
  window.print();
}

/* Backup */
function buildBackup(){
  return {
    app: "tagdriverpro",
    version: "v3-phase1",
    exportedAt: nowISO(),
    state,
    settings
  };
}
function downloadBackup(){
  const json = JSON.stringify(buildBackup(), null, 2);
  downloadsFile(`tagdriverpro_backup_${safeFileDate(isoDate(new Date()))}.json`, json, "application/json");
  settings.last_backup_at = nowISO();
  persistSettings(settings);
  updateBackupPill();
}
async function copyBackupToClipboard(){
  const json = JSON.stringify(buildBackup(), null, 2);
  try{
    if (!navigator.clipboard?.writeText) throw new Error("Clipboard unsupported");
    await navigator.clipboard.writeText(json);
    alert("Backup JSON copied.");
    settings.last_backup_at = nowISO();
    persistSettings(settings);
    updateBackupPill();
  } catch(e){
    prompt("Copy backup JSON:", json);
  }
}
function validateBackup(obj){
  if (!obj || typeof obj !== "object") return false;
  if (!obj.state || !obj.state.drivers) return false;
  return true;
}
function importBackup(mode="merge"){
  const file = document.getElementById("backupFile").files?.[0];
  if (!file) return alert("Choose a backup JSON file first.");

  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(String(reader.result || ""));
      if (!validateBackup(obj)) return alert("Invalid backup JSON.");

      if (mode === "replace"){
        if (!confirm("Replace ALL local data with this backup?")) return;

        state = migrateState(obj.state);
        settings = { ...defaultSettings, ...(obj.settings || {}) };
        persistSettings(settings);
        localStorage.setItem(STORE_KEY, JSON.stringify(state));
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      } else {
        const incoming = migrateState(obj.state);
        for (const [did, drv] of Object.entries(incoming.drivers || {})){
          let targetId = did;
          while (state.drivers[targetId]) targetId = did + "_i" + Math.floor(Math.random()*9999);
          state.drivers[targetId] = drv;
        }
        saveState();
      }

      settings = loadSettings();
      document.body.dataset.theme = settings.ui_theme;
      enqueueNet = createRateLimitedQueue(settings.network_min_interval_ms);

      bindSettingsToInputs();
      renderDriverSelect();
      renderWeekSelect();
      bindDriverInputs();
      updateUI();
      initMap(true);

      alert("Import complete.");
    } catch(e){
      console.error(e);
      alert("Import failed: invalid JSON or corrupted backup.");
    }
  };
  reader.readAsText(file);
}

/* =========================================================
   FLEET + COMPANY CUT TABLES
========================================================= */
function setCurrentDriverFromFleet(driverId){
  state.currentDriverId = driverId;
  saveState();
  renderDriverSelect();
  renderWeekSelect();
  bindDriverInputs();
  updateUI();
  setTimeout(()=>initMap(true), 120);
}
function updateFleetTables(){
  const now = new Date();
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1, 0,0,0,0);
  const yearStart  = new Date(now.getFullYear(), 0, 1, 0,0,0,0);

  const fleetBody = document.getElementById("fleetTable");
  const cutBody   = document.getElementById("cutTable");

  let fleetRows = [];
  let cutRows = [];

  let fleetCutCW=0, fleetCutMTD=0, fleetCutYTD=0, fleetGrossYTD=0;

  for (const id of Object.keys(state.drivers)){
    const d = state.drivers[id];
    const st = driverStatusLabel(d);
    if (st === "ARCHIVED") continue;

    // Fleet tables: show ACTIVE only, unless show_inactive enabled
    if (st === "INACTIVE" && !settings.show_inactive_drivers) continue;

    const wk = d.weeks[d.currentWeekId] || { loads: [] };
    const cw = computeWeekTotals(wk);

    const mtd = totalsForDriverInRange(d, monthStart, now);
    const ytd = totalsForDriverInRange(d, yearStart, now);

    const cfg = getEffectiveConfig(d, wk);

    fleetRows.push(`
      <tr>
        <td style="font-weight:1200;">${escapeHtml(d.name)}</td>
        <td class="muted">${escapeHtml(st)}</td>
        <td>${pct(cfg.split)}</td>

        <td>${money(cw.gross)}</td>
        <td>${money(cw.rpm)}</td>
        <td class="${cw.net>=0?'pos':'neg'}">${money(cw.net)}</td>

        <td>${money(mtd.gross)}</td>
        <td>${money(mtd.rpm)}</td>
        <td class="${mtd.net>=0?'pos':'neg'}">${money(mtd.net)}</td>

        <td>${money(ytd.gross)}</td>
        <td>${money(ytd.rpm)}</td>
        <td class="${ytd.net>=0?'pos':'neg'}">${money(ytd.net)}</td>

        <td><button class="miniBtn" onclick="setCurrentDriverFromFleet('${id}')">Open</button></td>
      </tr>
    `);

    const cwCut = cw.gross * (1 - cfg.split);
    cutRows.push(`
      <tr>
        <td style="font-weight:1200;">${escapeHtml(d.name)}</td>
        <td class="muted">${escapeHtml(st)}</td>
        <td>${pct(cfg.split)}</td>
        <td>${money(cw.gross)}</td>
        <td>${money(cwCut)}</td>
        <td>${money(mtd.gross)}</td>
        <td>${money(mtd.companyCut)}</td>
        <td>${money(ytd.gross)}</td>
        <td>${money(ytd.companyCut)}</td>
      </tr>
    `);

    fleetCutCW += cwCut;
    fleetCutMTD += mtd.companyCut;
    fleetCutYTD += ytd.companyCut;
    fleetGrossYTD += ytd.gross;
  }

  fleetBody.innerHTML = fleetRows.join("") || `<tr><td colspan="13" class="muted" style="padding:16px;">No drivers found.</td></tr>`;
  cutBody.innerHTML = cutRows.join("") || `<tr><td colspan="9" class="muted" style="padding:16px;">No drivers found.</td></tr>`;

  document.getElementById("cut_cw").textContent = money(fleetCutCW);
  document.getElementById("cut_mtd").textContent = money(fleetCutMTD);
  document.getElementById("cut_ytd").textContent = money(fleetCutYTD);

  const weightedTake = fleetGrossYTD > 0 ? (fleetCutYTD / fleetGrossYTD) : 0;
  document.getElementById("cut_take").textContent = pct(weightedTake);
}

/* =========================================================
   WARNINGS / BACKUP REMINDER / CONCURRENCY
========================================================= */
function updateWarnBanner(){
  const d = getDriver();
  const wk = getCurrentWeek();
  const cfg = getEffectiveConfig(d, wk);
  const t = computeWeekTotals(wk);

  const warn = document.getElementById("warn");
  const msgs = [];

  if (wk.loads.length > 0 && t.net < cfg.targetNet){
    const gap = cfg.targetNet - t.net;
    msgs.push(`Target not met for <b>${escapeHtml(d.name)}</b>: goal <b>${money(cfg.targetNet)}</b> ‚Ä¢ currently <b>${money(t.net)}</b> ‚Ä¢ gap <b>${money(gap)}</b>.`);
  }

  // Fixed cost model mismatch insight
  if (cfg.fixedMode === "expected" && wk.loads.length > 0 && wk.loads.length !== cfg.loadsPerWeek){
    const denomExpected = Math.max(1, cfg.loadsPerWeek);
    const denomActual = Math.max(1, wk.loads.length);
    const fixedExpected = cfg.fixedWeekly / denomExpected;
    const fixedActual = cfg.fixedWeekly / denomActual;
    const delta = fixedActual - fixedExpected;
    msgs.push(`Fixed costs are budgeted for <b>${denomExpected}</b> loads/week but you have <b>${denomActual}</b> loads ‚Üí fixed per load is ${money(fixedActual)} (variance ${delta>=0?"+":"-"}${money(Math.abs(delta))}).`);
  }

  if (wk.status !== "ACTIVE"){
    msgs.push(`Week is <b>${escapeHtml(wk.status)}</b>. You must reopen it to add/edit loads.`);
  }

  if (msgs.length){
    warn.style.display = "block";
    warn.innerHTML = `‚ö†Ô∏è ${msgs.join("<br/>")}`;
  } else {
    warn.style.display = "none";
    warn.innerHTML = "";
  }
}

function updateBackupPill(){
  const pill = document.getElementById("backupPill");
  const days = Math.max(1, settings.backup_reminder_days || 7);
  if (!settings.last_backup_at){
    pill.style.display = "inline-flex";
    return;
  }
  const last = new Date(settings.last_backup_at).getTime();
  if (!last || isNaN(last)){
    pill.style.display = "inline-flex";
    return;
  }
  const ageDays = (Date.now() - last) / (1000*60*60*24);
  pill.style.display = ageDays >= days ? "inline-flex" : "none";
}

function showSyncWarning(msg){
  const el = document.getElementById("syncWarn");
  el.style.display = "block";
  el.innerHTML = `üîÑ ${escapeHtml(msg)} <button class="btn" style="margin-left:10px;" onclick="location.reload()">Reload</button>`;
}
window.addEventListener("storage", (e) => {
  if (e.key === STORE_KEY || e.key === SETTINGS_KEY){
    // Another tab updated data. Warn to avoid overwrites.
    showSyncWarning("Data changed in another tab. Reload to avoid overwriting.");
  }
});

/* =========================================================
   UI RENDER (TABLE SEARCH/SORT/FILTER + MAP HOVER)
========================================================= */
function updateUI(){
  const d = getDriver();
  const wk = getCurrentWeek();

  // Update week pills
  setWeekStatusPills();

  // Ensure route templates in UI
  updateRouteTemplates();

  const cfg = getEffectiveConfig(d, wk);

  // Ensure dynamic week allocations are current (only if ACTIVE+actual)
  reconcileWeekFixedAllocations(d, wk);

  const totals = computeWeekTotals(wk);

  document.getElementById("wk_gross").textContent = money(totals.gross);
  document.getElementById("wk_miles").textContent = totals.miles.toLocaleString();

  const wkProfitEl = document.getElementById("wk_profit");
  wkProfitEl.textContent = money(totals.net);
  wkProfitEl.className = "v " + (totals.net>=0 ? "pos" : "neg");

  document.getElementById("wk_rpm").textContent = money(totals.rpm);

  // Break-even RPM (approx)
  const split = cfg.split;
  const wkCostsAll = totals.fuel + totals.maint + totals.fixed + totals.tolls;
  const wkBreakEvenRev = (cfg.splitModel === "before_expenses") ? (split>0 ? wkCostsAll / split : 0) : wkCostsAll;
  const wkBERpm = totals.miles>0 ? (wkBreakEvenRev / totals.miles) : 0;
  document.getElementById("wk_be_rpm").textContent = money(wkBERpm);

  // Subtitle
  document.getElementById("subTitle").textContent =
    `${d.name} ‚Ä¢ ${wk.label} ‚Ä¢ ${wk.status} ‚Ä¢ ${wk.daysWorked}/7 days ‚Ä¢ Split ${(cfg.split*100).toFixed(0)}% (${cfg.splitModel}) ‚Ä¢ Fixed ${cfg.fixedMode}${cfg.prorateFixed?" (prorated)":""
    }`;

  // Table search/sort/filter
  const loads = wk.loads || [];
  const search = (document.getElementById("loadSearch")?.value || "").trim().toLowerCase();
  const sort = (document.getElementById("loadSort")?.value || "date_desc");
  const filter = (document.getElementById("loadFilter")?.value || "all");

  let visible = loads.slice();

  if (search){
    visible = visible.filter(l => {
      const hay = `${l.origin||""} ${l.dest||""} ${l.notes||""}`.toLowerCase();
      return hay.includes(search);
    });
  }

  if (filter === "profit") visible = visible.filter(l => (Number(l.net)||0) >= 0);
  if (filter === "loss") visible = visible.filter(l => (Number(l.net)||0) < 0);
  if (filter === "tonu") visible = visible.filter(l => (Number(l.miles)||0) === 0 && (Number(l.gross)||0) > 0);

  visible.sort((a,b) => {
    if (sort === "net_desc") return (Number(b.net)||0) - (Number(a.net)||0);
    if (sort === "rev_desc") return (Number(b.gross)||0) - (Number(a.gross)||0);
    if (sort === "miles_desc") return (Number(b.miles)||0) - (Number(a.miles)||0);
    if (sort === "rpm_desc"){
      const ar = (Number(a.miles)||0) > 0 ? (Number(a.gross)||0)/(Number(a.miles)||0) : 0;
      const br = (Number(b.miles)||0) > 0 ? (Number(b.gross)||0)/(Number(b.miles)||0) : 0;
      return br - ar;
    }
    return new Date(b.createdAt||0) - new Date(a.createdAt||0);
  });

  document.getElementById("tableSummary").textContent = `${visible.length} shown ‚Ä¢ ${loads.length} total`;

  const listHtml = visible.map(l => {
    const miles = Number(l.miles||0);
    const rev = Number(l.gross||0);
    const rpm = miles>0 ? rev/miles : 0;

    const fsc = Number(l.details?.fsc||0);
    const fuel = Number(l.details?.fuel||0);
    const fscDelta = fsc - fuel;
    const fscCell = fsc > 0 ? `${money(fsc)} vs ${money(fuel)} <span class="muted">(${fscDelta>=0?"+":"-"}${money(Math.abs(fscDelta))})</span>` : `<span class="muted">‚Äî</span>`;

    const stPill = (wk.status === "ACTIVE")
      ? `<span class="pill good">ACTIVE</span>`
      : (wk.status === "CLOSED")
        ? `<span class="pill warn">CLOSED</span>`
        : `<span class="pill bad">LOCKED</span>`;

    return `
      <tr data-id="${l.id}">
        <td style="font-weight:1200;">
          ${escapeHtml(l.origin)} <span class="routeArrow">‚ûú</span> ${escapeHtml(l.dest)}
          <div class="muted" style="margin-top:4px;font-size:12px;">
            ${escapeHtml(l.createdAt ? new Date(l.createdAt).toLocaleString() : "")} ‚Ä¢
            Model: <span class="mono">${escapeHtml(l.details?.splitModel || cfg.splitModel)}</span>
          </div>
          ${l.notes ? `<div class="muted" style="margin-top:4px;font-size:12px;">${escapeHtml(l.notes.slice(0,120))}${l.notes.length>120?"‚Ä¶":""}</div>` : ``}
        </td>
        <td>${miles.toLocaleString()}</td>
        <td>${money(rev)}</td>
        <td class="${(l.net||0)>=0?'pos':'neg'}">${money(l.net)}</td>
        <td>${money(rpm)}</td>
        <td>${fscCell}</td>
        <td>${stPill}</td>
        <td>
          <div class="actions">
            <button class="miniBtn" onclick="viewDetail('${l.id}')">Detail</button>
            <button class="miniBtn" onclick="openEdit('${l.id}')">Edit</button>
            <button class="miniBtn danger" onclick="delLoad('${l.id}')">X</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");

  document.getElementById("loadList").innerHTML = listHtml || `<tr><td colspan="8" class="muted" style="padding:20px;">No loads in this view.</td></tr>`;

  // Selected driver YTD
  const now = new Date();
  const yearStart  = new Date(now.getFullYear(), 0, 1, 0,0,0,0);
  const ytd = totalsForDriverInRange(d, yearStart, now);

  document.getElementById("ytd_gross").textContent = money(ytd.gross);
  document.getElementById("ytd_profit").textContent = money(ytd.net);
  document.getElementById("ytd_tax").textContent = money(ytd.net * cfg.taxRate);

  document.getElementById("oer_val").textContent = ytd.gross>0 ? Math.round(((ytd.gross - ytd.net)/ytd.gross)*100)+'%' : '0%';
  document.getElementById("ytd_fuel").textContent = money(ytd.fuel);
  document.getElementById("ytd_maint").textContent = money(ytd.maint);

  // Best/Worst week net
  let best=null,worst=null;
  for (const wkId of Object.keys(d.weeks||{})){
    const t = computeWeekTotals(d.weeks[wkId]);
    if (!best || t.net > best.net) best = { net: t.net };
    if (!worst || t.net < worst.net) worst = { net: t.net };
  }
  document.getElementById("best_week").textContent = money(best?.net || 0);
  document.getElementById("worst_week").textContent = money(worst?.net || 0);

  // Week history table
  const weekIds = Object.keys(d.weeks||{}).sort().reverse();
  document.getElementById("weekHistory").innerHTML = weekIds.map(id => {
    const w = d.weeks[id];
    const t = computeWeekTotals(w);
    const rpm2 = t.miles>0 ? (t.gross/t.miles) : 0;
    return `
      <tr>
        <td style="font-weight:1200;">${escapeHtml(w.label || id)}</td>
        <td>${escapeHtml(w.status || "ACTIVE")}</td>
        <td>${(w.daysWorked||7)}/7</td>
        <td>${(w.loads||[]).length}</td>
        <td>${t.miles.toLocaleString()}</td>
        <td>${money(t.gross)}</td>
        <td class="${t.net>=0?'pos':'neg'}">${money(t.net)}</td>
        <td>${money(rpm2)}</td>
      </tr>
    `;
  }).join("");

  updateWarnBanner();

  renderDriverSelect();
  renderWeekSelect();

  updateFleetTables();
  updateBackupPill();

  // Update preview pills/hints
  preview();
}

document.getElementById("loadList").addEventListener("mouseover", (e) => {
  const tr = e.target.closest("tr[data-id]");
  if (!tr) return;
  highlightLoadOnMap(tr.dataset.id, true);
});
document.getElementById("loadList").addEventListener("mouseout", (e) => {
  const tr = e.target.closest("tr[data-id]");
  if (!tr) return;
  highlightLoadOnMap(tr.dataset.id, false);
});

/* =========================================================
   THEME TOGGLE
========================================================= */
function toggleTheme(){
  const next = (settings.ui_theme === "graphite") ? "steel" : "graphite";
  settings.ui_theme = next;
  document.body.dataset.theme = next;
  persistSettings(settings);
}

/* =========================================================
   FACTORY RESET
========================================================= */
function factoryReset(){
  if (!confirm("Factory reset clears ALL drivers + weeks + loads + settings + trash on this device. Continue?")) return;
  localStorage.removeItem(STORE_KEY);
  localStorage.removeItem(SETTINGS_KEY);
  localStorage.removeItem(GEO_CACHE_KEY);
  localStorage.removeItem(TRASH_KEY);
  localStorage.removeItem(DRAFT_KEY);
  location.reload();
}

/* =========================================================
   INIT + KEY NAV
========================================================= */
function wireEntryKeyNav(){
  const ids = ["origin","dest","mi_load","mi_dh","cost_tolls","pay_base","pay_fsc","pay_accessorial","pay_reimb"];
  ids.forEach((id, idx)=>{
    const el = document.getElementById(id);
    el.addEventListener("keydown",(e)=>{
      if (e.key === "Enter"){
        e.preventDefault();
        const next = document.getElementById(ids[idx+1] || "notes");
        if (next) next.focus();
      }
    });
    el.addEventListener("input", preview);
  });
  document.getElementById("notes").addEventListener("input", ()=>{ /* draft left manual */ });
}

(function boot(){
  document.body.dataset.theme = settings.ui_theme;

  pruneTrash();

  // Bind settings
  bindSettingsToInputs();

  // Ensure current driver has "this week" seeded
  const d = getDriver();
  const wk = startOfWeekMonday(new Date());
  const baseId = isoDate(wk);
  if (!d.weeks[baseId]){
    d.weeks[baseId] = normalizeWeek({ start: baseId, label: fmtWeekLabel(wk), loads: [], lastDropCoords: null, status:"ACTIVE", daysWorked:7 }, baseId);
    saveState();
  }

  // Bind driver UI
  renderDriverSelect();
  renderWeekSelect();
  bindDriverInputs();

  // Wire inputs
  wireEntryKeyNav();

  // Restore draft if any
  maybeRestoreDraft();

  // Initial render
  updateUI();
  setTimeout(()=>initMap(true), 420);
})();
</script>
</body>
</html>
