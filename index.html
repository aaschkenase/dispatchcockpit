<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
  <title>Tag Driver Pro ‚Ä¢ Command Center</title>

  <!-- Leaflet CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /*
      Tag Driver Pro ‚Äî Modernized v3.x
      - Single file (HTML/CSS/JS)
      - Preserves localStorage keys + core data model
      - Adds strict >= 1.1s request queue throttling + configurable endpoints
      - Adds operator features: notes, edit+reroute, undo delete, backup/restore, search/sort/filter, theme toggle, sidebar, responsive, print-friendly
    */

    /* =========================
       THEME TOKENS (DEFAULT)
    ========================== */
    :root{
      /* Brand accents (given + reasonable default) */
      --cyan:#38bdf8;
      --ember:#ff6a3d;

      /* Graphite/steel palette (derived from provided image dominant grays; exact palette unspecified) */
      --g950:#0a0a0a;
      --g900:#151515;
      --g850:#232323;
      --g700:#383736;
      --g600:#595857;
      --g400:#898988;
      --g100:#d3d3d3;

      /* Semantic colors */
      --success:#22c55e;
      --danger:#ef4444;
      --warning:#f59e0b;

      /* Typography */
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      /* Radii */
      --r12:12px;
      --r14:14px;
      --r18:18px;
      --r22:22px;

      /* Elevation / glass */
      --glass: rgba(20, 24, 32, .62);
      --glass2: rgba(26, 32, 44, .62);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.16);
      --shadow: 0 16px 60px rgba(0,0,0,.55);

      /* Surfaces */
      --bg: radial-gradient(1200px 900px at 10% 0%, rgba(56,189,248,.08), transparent 45%),
            radial-gradient(900px 700px at 90% 20%, rgba(255,106,61,.07), transparent 50%),
            linear-gradient(180deg, #090a0c, #0b0f17 60%, #07080a);
      --text:#f8fafc;
      --muted: rgba(248,250,252,.68);

      /* Controls */
      --control: rgba(2,6,23,.75);
      --controlStroke: rgba(255,255,255,.12);
      --focus: 0 0 0 3px rgba(56,189,248,.18);

      /* Layout */
      --sidebarW: 280px;
      --topH: 68px;
      --gap: 14px;

      /* Motion */
      --t: 160ms;
      --t2: 260ms;
    }

    /* Alternate theme: ‚ÄúSteel‚Äù (slightly brighter surfaces) */
    body[data-theme="steel"]{
      --glass: rgba(30, 36, 48, .60);
      --glass2: rgba(34, 42, 58, .62);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.18);
      --bg: radial-gradient(1200px 900px at 12% 0%, rgba(56,189,248,.10), transparent 45%),
            radial-gradient(900px 700px at 90% 20%, rgba(255,106,61,.09), transparent 50%),
            linear-gradient(180deg, #0b0c10, #0d1220 60%, #090a0c);
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      :root{ --t: 1ms; --t2: 1ms; }
      *{ scroll-behavior:auto !important; }
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background: var(--bg);
      overflow-x:hidden;
    }

    a{ color: inherit; }

    /* =========================
       APP SHELL
    ========================== */
    .app{
      display:grid;
      grid-template-columns: var(--sidebarW) 1fr;
      min-height:100vh;
    }

    /* Sidebar */
    .sidebar{
      position:sticky;
      top:0;
      height:100vh;
      padding:16px;
      border-right: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.10));
      backdrop-filter: blur(10px) saturate(1.2);
      -webkit-backdrop-filter: blur(10px) saturate(1.2);
      overflow:auto;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 12px;
      border-radius: var(--r18);
      background: rgba(255,255,255,.04);
      border: 1px solid var(--stroke);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .brand img{
      width:40px;
      height:40px;
      object-fit:contain;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.55));
      border-radius: 10px;
      background: rgba(0,0,0,.25);
      padding:6px;
      border: 1px solid rgba(255,255,255,.10);
    }
    .brand .t1{ font-weight:1000; letter-spacing:-.02em; line-height:1.05; }
    .brand .t2{ font-size:12px; color: var(--muted); font-weight:800; margin-top:2px; }

    .nav{
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .nav button{
      all: unset;
      cursor:pointer;
      user-select:none;

      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 12px;
      border-radius: var(--r14);

      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.06);
      transition: transform var(--t), background var(--t), border-color var(--t);
      color: rgba(248,250,252,.78);
      font-weight:900;
    }
    .nav button:hover{
      transform: translateY(-1px);
      border-color: rgba(56,189,248,.28);
      background: rgba(56,189,248,.06);
    }
    .nav button.active{
      background: linear-gradient(90deg, rgba(56,189,248,.18), rgba(56,189,248,.06));
      border-color: rgba(56,189,248,.42);
      color: var(--text);
      box-shadow: 0 16px 50px rgba(56,189,248,.08);
    }
    .ico{
      width:30px;height:30px;border-radius:10px;
      display:grid;place-items:center;
      background: rgba(2,6,23,.55);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(248,250,252,.90);
      font-size:14px;
    }

    .sidebar .meta{
      margin-top:14px;
      padding:12px;
      border-radius: var(--r14);
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      color: rgba(248,250,252,.72);
      font-size:12px;
      line-height:1.35;
    }
    .chip{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border-radius: 999px;
      margin-top:10px;
      background: rgba(2,6,23,.55);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(248,250,252,.75);
      font-weight:900;
      font-size:11px;
    }
    .dot{
      width:8px;height:8px;border-radius:99px;
      background: var(--success);
      box-shadow: 0 0 0 4px rgba(34,197,94,.12);
    }

    /* Main */
    .main{
      min-width:0;
      padding: 16px 18px 90px;
    }

    .topbar{
      height: var(--topH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 12px;
      border-radius: var(--r18);
      background: var(--glass);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px) saturate(1.2);
      -webkit-backdrop-filter: blur(14px) saturate(1.2);
      position:sticky;
      top: 12px;
      z-index: 40;
    }

    .topLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 260px;
    }

    .hamburger{
      display:none;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(2,6,23,.55);
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight:1000;
    }

    .title{
      display:flex; flex-direction:column;
    }
    .title .h{
      font-weight:1100;
      letter-spacing:-.02em;
      line-height:1.05;
    }
    .title .s{
      font-size:12px;
      color: var(--muted);
      font-weight:900;
    }

    .topControls{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    label{
      font-size:10px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(248,250,252,.65);
      font-weight:1000;
      display:block;
      margin-bottom:6px;
    }

    .control{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 220px;
      max-width: 74vw;
    }

    select,input,textarea{
      width:100%;
      border-radius: 12px;
      padding: 11px 12px;
      border: 1px solid var(--controlStroke);
      background: var(--control);
      color: var(--text);
      font-weight:900;
      outline:none;
      transition: box-shadow var(--t), border-color var(--t), transform var(--t);
      font-family: var(--font);
    }
    textarea{ min-height: 84px; resize: vertical; font-weight:800; }
    select:focus,input:focus,textarea:focus{ border-color: rgba(56,189,248,.70); box-shadow: var(--focus); }

    .btn{
      border-radius: 14px;
      padding: 11px 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(2,6,23,.55);
      cursor:pointer;
      font-weight:1000;
      color: var(--text);
      transition: transform var(--t), border-color var(--t), background var(--t);
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(56,189,248,.45); background: rgba(56,189,248,.08); }
    .btn.primary{
      background: linear-gradient(90deg, rgba(56,189,248,.95), rgba(56,189,248,.65));
      color: #001018;
      border-color: rgba(56,189,248,.65);
    }
    .btn.primary:hover{ background: linear-gradient(90deg, rgba(56,189,248,1), rgba(56,189,248,.78)); }
    .btn.danger{ border-color: rgba(239,68,68,.75); color: #fecaca; background: rgba(239,68,68,.10); }
    .btn.danger:hover{ background: rgba(239,68,68,.18); border-color: rgba(239,68,68,1); }

    .pill{
      display:inline-flex;
      gap:10px;
      align-items:center;
      font-size: 11px;
      font-weight: 1000;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(248,250,252,.72);
    }

    .status{
      display:none;
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(245,158,11,.12);
      border: 1px solid rgba(245,158,11,.25);
      color: rgba(255,231,186,.95);
      font-weight:1000;
      font-size:12px;
    }

    .warn{
      display:none;
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 16px;
      background: rgba(239,68,68,.12);
      border: 1px solid rgba(239,68,68,.30);
      color: #fecaca;
      font-weight:1000;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
    }
    .warn b{ color:#fff; }

    /* Cards / layout */
    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap: var(--gap);
      align-items:start;
    }
    @media (max-width: 1120px){
      .grid{ grid-template-columns: 1fr; }
      .topbar{ position:sticky; top:0; border-radius: 0; margin: -16px -18px 0; }
      .main{ padding-top: 0; }
    }

    .card{
      border-radius: var(--r18);
      background: var(--glass);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px) saturate(1.2);
      -webkit-backdrop-filter: blur(14px) saturate(1.2);
      overflow:hidden;
    }
    .card .head{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .card .head .k{
      font-size: 11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      font-weight:1100;
      color: rgba(56,189,248,.92);
    }
    .card .body{ padding: 14px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row .grow{ flex:1; min-width: 180px; }

    /* KPI strip */
    .kpis{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: var(--gap);
    }
    .kpi{
      border-radius: var(--r18);
      background: var(--glass2);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 14px 46px rgba(0,0,0,.40);
      padding: 14px;
    }
    .kpi .l{
      font-size: 11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      font-weight: 1000;
      color: rgba(248,250,252,.68);
    }
    .kpi .v{
      margin-top: 6px;
      font-size: 22px;
      font-weight: 1200;
      letter-spacing:-.02em;
    }
    .pos{ color: var(--success); }
    .neg{ color: var(--danger); }

    /* Map */
    #map{
      height: 560px;
      width: 100%;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
    }
    .mapWrap{ padding: 0; }
    .mapMeta{
      padding: 12px 14px;
      display:flex;
      gap: 10px;
      justify-content: space-between;
      align-items:center;
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      font-size: 12px;
      color: rgba(248,250,252,.70);
      font-weight:900;
    }

    /* Table */
    .tableBar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
      justify-content:space-between;
      margin-bottom: 10px;
    }
    .tableBar .left, .tableBar .right{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .tableWrap{
      overflow:auto;
      border-radius: var(--r18);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    table{ width: 100%; border-collapse: collapse; min-width: 860px; }
    thead th{
      position: sticky;
      top: 0;
      z-index: 2;
      background: rgba(4,6,10,.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);

      font-size: 10px;
      letter-spacing: .14em;
      text-transform: uppercase;
      font-weight: 1100;
      color: rgba(248,250,252,.70);
      text-align: left;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    tbody td{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      font-size: 13px;
      font-weight: 800;
      color: rgba(248,250,252,.90);
      vertical-align: top;
    }
    tbody tr{
      transition: background var(--t);
    }
    tbody tr:hover{
      background: rgba(56,189,248,.06);
    }
    .muted{ color: rgba(248,250,252,.65); font-weight:800; }
    .routeArrow{ color: rgba(56,189,248,.95); font-weight: 1200; padding: 0 6px; }
    .actions{ display:flex; gap:8px; }
    .miniBtn{
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(2,6,23,.55);
      cursor:pointer;
      font-weight: 1100;
      color: rgba(248,250,252,.92);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    .miniBtn:hover{ border-color: rgba(56,189,248,.45); background: rgba(56,189,248,.08); }
    .miniBtn.danger{ border-color: rgba(239,68,68,.75); color: #fecaca; background: rgba(239,68,68,.10); }
    .miniBtn.danger:hover{ background: rgba(239,68,68,.18); border-color: rgba(239,68,68,1); }

    /* Modal */
    .overlay{
      display:none;
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.72);
      z-index: 90;
    }
    .modal{
      display:none;
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: min(720px, 94vw);
      background: rgba(14,18,26,.88);
      border: 1px solid rgba(56,189,248,.45);
      border-radius: 18px;
      box-shadow: 0 30px 120px rgba(0,0,0,.70);
      z-index: 91;
      backdrop-filter: blur(16px) saturate(1.2);
      -webkit-backdrop-filter: blur(16px) saturate(1.2);
      overflow:hidden;
    }
    .modal .mHead{
      padding: 14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: rgba(255,255,255,.04);
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .modal .mHead .t{
      font-weight: 1200;
      letter-spacing: -.02em;
      color: rgba(56,189,248,.95);
    }
    .modal .mBody{ padding: 14px; }
    .kv{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,.10);
      font-weight: 900;
    }
    .kv .k{ color: rgba(248,250,252,.68); font-size: 12px; text-transform: uppercase; letter-spacing: .14em; }
    .kv .v{ font-family: var(--mono); }
    .modal .mFoot{
      padding: 14px;
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      flex-wrap:wrap;
    }

    /* Toast */
    .toastHost{
      position: fixed;
      left: 16px;
      right: 16px;
      bottom: 16px;
      z-index: 120;
      display:flex;
      justify-content: center;
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      display:none;
      gap: 12px;
      align-items:center;
      justify-content:space-between;
      width: min(760px, 96vw);
      border-radius: 16px;
      padding: 12px 14px;
      background: rgba(14,18,26,.92);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 20px 80px rgba(0,0,0,.60);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      font-weight: 1000;
      color: rgba(248,250,252,.92);
    }
    .toast .msg{
      font-size: 13px;
      color: rgba(248,250,252,.88);
    }

    /* Mobile sidebar overlay */
    .sidebarOverlay{
      display:none;
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.62);
      z-index: 80;
    }

    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{
        position: fixed;
        left: 0;
        top: 0;
        transform: translateX(-104%);
        transition: transform var(--t2);
        z-index: 81;
        width: min(var(--sidebarW), 88vw);
      }
      body[data-sidebar="open"] .sidebar{ transform: translateX(0); }
      body[data-sidebar="open"] .sidebarOverlay{ display:block; }
      .hamburger{ display:inline-flex; }
    }

    /* =========================
       PRINT STYLES
    ========================== */
    #printArea{ display:none; }

    @media print{
      .sidebar, .sidebarOverlay, .topbar, .status, .warn, .noPrint, .toastHost { display:none !important; }
      body{ background:#fff !important; color:#000 !important; }
      .main{ padding: 0 !important; }
      #printArea{ display:block; padding: 22px; }
      #printArea *{ color:#000 !important; }
      #printArea h1, #printArea h2{ margin: 0 0 10px 0; }
      #printArea .pCard{ border: 1px solid #ccc; border-radius: 12px; padding: 12px; margin: 12px 0; }
      #printArea table{ width:100%; border-collapse: collapse; min-width: 0; }
      #printArea th, #printArea td{ border-bottom: 1px solid #ddd; padding: 8px; font-size: 11px; text-align:left; }
      #printArea .pGrid{ display:grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
      #printArea .pStat{ border: 1px solid #ddd; border-radius: 10px; padding: 10px; }
      #printArea .right{ text-align:right; }
    }
  </style>
</head>

<body data-theme="graphite" data-sidebar="closed">

  <!-- Mobile sidebar overlay -->
  <div class="sidebarOverlay" onclick="toggleSidebar(false)"></div>

  <!-- Modal overlay -->
  <div id="overlay" class="overlay" onclick="closeAllModals()"></div>

  <!-- Detail modal -->
  <div id="detailModal" class="modal" role="dialog" aria-modal="true" aria-label="Load details">
    <div class="mHead">
      <div class="t">Load Details</div>
      <button class="btn" onclick="closeAllModals()">Close</button>
    </div>
    <div id="detailBody" class="mBody"></div>
    <div class="mFoot">
      <button class="btn" onclick="closeAllModals()">Close</button>
    </div>
  </div>

  <!-- Edit modal -->
  <div id="editModal" class="modal" role="dialog" aria-modal="true" aria-label="Edit load">
    <div class="mHead">
      <div class="t">Edit Load</div>
      <button class="btn" onclick="closeAllModals()">Close</button>
    </div>

    <div class="mBody">
      <div class="row">
        <div class="grow">
          <label>Pickup</label>
          <input id="e_origin" />
        </div>
        <div class="grow">
          <label>Drop</label>
          <input id="e_dest" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="grow">
          <label>Loaded miles</label>
          <input id="e_mi_load" type="number" inputmode="numeric" min="0" step="1" />
        </div>
        <div class="grow">
          <label>Deadhead miles</label>
          <input id="e_mi_dh" type="number" inputmode="numeric" min="0" step="1" />
        </div>
        <div class="grow">
          <label>Tolls ($)</label>
          <input id="e_tolls" type="number" inputmode="decimal" min="0" step="0.01" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="grow">
          <label>Gross pay ($)</label>
          <input id="e_gross" type="number" inputmode="decimal" min="0" step="0.01" />
        </div>
        <div class="grow">
          <label>Notes</label>
          <input id="e_notes" placeholder="Broker, appointment, OS&D, etc." />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="grow" style="min-width: 260px;">
          <label>Re-route options</label>
          <div class="row" style="gap:10px;">
            <label style="display:flex;align-items:center;gap:8px;margin:0;text-transform:none;letter-spacing:0;font-size:12px;color:rgba(248,250,252,.80);font-weight:900;">
              <input id="e_reroute" type="checkbox" style="width:18px;height:18px;accent-color: var(--cyan);" />
              Recalculate loaded miles & geometry via OSRM (throttled)
            </label>
            <label style="display:flex;align-items:center;gap:8px;margin:0;text-transform:none;letter-spacing:0;font-size:12px;color:rgba(248,250,252,.80);font-weight:900;">
              <input id="e_regeocode" type="checkbox" style="width:18px;height:18px;accent-color: var(--cyan);" />
              Re-geocode pickup/drop via Nominatim (if rerouting)
            </label>
          </div>
          <div class="muted" style="margin-top:6px;font-size:12px;line-height:1.35;">
            Tip: Editing keeps historical math stable by default. Use reroute only when you need to correct miles/geometry.
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div class="grow">
          <div class="pill" id="e_preview">Net (recalc): $0.00</div>
        </div>
      </div>
    </div>

    <div class="mFoot">
      <button class="btn danger" onclick="deleteLoadFromEdit()">Delete</button>
      <button class="btn" onclick="closeAllModals()">Cancel</button>
      <button class="btn primary" onclick="saveEdit()">Save Changes</button>
    </div>
  </div>

  <!-- Print-only -->
  <div id="printArea"></div>

  <!-- Toast -->
  <div class="toastHost">
    <div id="toast" class="toast">
      <div class="msg" id="toastMsg">Deleted.</div>
      <div style="display:flex;gap:10px;align-items:center;">
        <button class="btn" onclick="undoDelete()">Undo</button>
        <button class="btn" onclick="hideToast()">Dismiss</button>
      </div>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <img src="tag-trans-inc.png" alt="Company logo" onerror="this.style.display='none';" />
        <div>
          <div class="t1">TAG DRIVER PRO</div>
          <div class="t2">Brand-driven command center</div>
        </div>
      </div>

      <div class="nav" style="margin-top:12px;">
        <button class="active" data-tab="dashboard" onclick="showTab('dashboard', this)">
          <span class="ico">üß≠</span> Dashboard & Map
        </button>
        <button data-tab="analytics" onclick="showTab('analytics', this)">
          <span class="ico">üìà</span> Analytics
        </button>
        <button data-tab="companycut" onclick="showTab('companycut', this)">
          <span class="ico">üè¢</span> Company Cut
        </button>
        <button data-tab="settings" onclick="showTab('settings', this)">
          <span class="ico">‚öôÔ∏è</span> Settings
        </button>
      </div>

      <div class="meta">
        <div style="font-weight:1100;letter-spacing:.06em;">Local-first</div>
        <div style="margin-top:6px;">
          Data stays on this device (localStorage). Use Backup in Settings for portability.
        </div>
        <div class="chip"><span class="dot"></span> Ready</div>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="topLeft">
          <button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>
          <div class="title">
            <div class="h">Tag Driver Pro</div>
            <div class="s">Modernized single-file dashboard</div>
          </div>
        </div>

        <div class="topControls">
          <div class="control" style="min-width:240px;">
            <label>Driver</label>
            <select id="driverSelect" onchange="onDriverChange()"></select>
          </div>

          <div class="control" style="min-width:240px;">
            <label>Week</label>
            <select id="weekSelect" onchange="onWeekChange()"></select>
          </div>

          <button class="btn" onclick="addDriver()">‚ûï Driver</button>
          <button class="btn danger" onclick="removeDriver()">üóëÔ∏è Driver</button>

          <button class="btn" onclick="startNewWeek()">‚ûï Week</button>
          <button class="btn danger" onclick="resetCurrentWeek()">üßπ Clear week</button>

          <button class="btn" onclick="toggleTheme()">üåì Theme</button>
        </div>
      </header>

      <div id="status" class="status">Processing‚Ä¶</div>
      <div id="warn" class="warn"></div>

      <!-- DASHBOARD -->
      <section id="dashboard" class="tab">
        <div class="kpis">
          <div class="kpi">
            <div class="l">Weekly gross</div>
            <div class="v" id="wk_gross">$0.00</div>
          </div>
          <div class="kpi">
            <div class="l">Weekly miles</div>
            <div class="v" id="wk_miles">0</div>
          </div>
          <div class="kpi">
            <div class="l">Net profit</div>
            <div class="v pos" id="wk_profit">$0.00</div>
          </div>
          <div class="kpi">
            <div class="l">Avg RPM (gross)</div>
            <div class="v" id="wk_rpm">$0.00</div>
          </div>
          <div class="kpi">
            <div class="l">Break-even RPM</div>
            <div class="v" id="wk_be_rpm">$0.00</div>
          </div>
        </div>

        <div class="grid">
          <div>
            <div class="card noPrint">
              <div class="head">
                <div class="k">New trip entry</div>
                <div class="pill">Split + rates stored per load</div>
              </div>
              <div class="body">
                <div class="row">
                  <div class="grow">
                    <label>Pickup</label>
                    <input id="origin" placeholder="City, State" autocomplete="off" />
                  </div>
                  <div class="grow">
                    <label>Drop</label>
                    <input id="dest" placeholder="City, State" autocomplete="off" />
                  </div>
                </div>

                <div class="row" style="margin-top:10px;">
                  <button class="btn" onclick="calcRoute()">üì° Get miles</button>
                  <button class="btn" onclick="verifyMap()">üó∫Ô∏è Verify</button>
                  <button class="btn" onclick="checkTolls()">üí∞ Tolls</button>
                  <button class="btn" onclick="swapCities()">üîÅ Swap</button>
                </div>

                <div class="row" style="margin-top:10px;">
                  <div class="grow">
                    <label>Loaded mi</label>
                    <input id="mi_load" type="number" inputmode="numeric" min="0" step="1" oninput="preview()" />
                  </div>
                  <div class="grow">
                    <label>Deadhead</label>
                    <input id="mi_dh" type="number" inputmode="numeric" min="0" step="1" oninput="preview()" />
                  </div>
                  <div class="grow">
                    <label>Tolls ($)</label>
                    <input id="cost_tolls" type="number" inputmode="decimal" min="0" step="0.01" value="0" oninput="preview()" />
                  </div>
                </div>

                <div class="row" style="margin-top:10px;">
                  <div class="grow">
                    <label>Gross pay ($)</label>
                    <input id="pay_gross" type="number" inputmode="decimal" min="0" step="0.01" oninput="preview()" />
                  </div>
                </div>

                <div class="row" style="margin-top:10px;">
                  <div class="grow">
                    <label>Load notes</label>
                    <textarea id="notes" placeholder="Broker, appointment times, detention, OS&D, etc."></textarea>
                  </div>
                </div>

                <div class="card" style="margin-top:10px;background: rgba(2,6,23,.55);border-color: rgba(255,255,255,.10);box-shadow:none;">
                  <div class="body" style="padding:12px;text-align:center;">
                    <div style="font-size:10px;color:rgba(248,250,252,.65);letter-spacing:.14em;text-transform:uppercase;font-weight:1100;">
                      Trip net preview
                    </div>
                    <div id="preview_net" style="margin-top:6px;font-size:22px;font-weight:1200;">$0.00</div>
                    <div id="preview_hint" class="muted" style="margin-top:6px;font-size:12px;"></div>
                  </div>
                </div>

                <button class="btn primary" style="width:100%;margin-top:10px;" onclick="addLoad()">Add load to week</button>

                <div class="muted" style="margin-top:10px;font-size:12px;line-height:1.35;">
                  Tip: Each driver can have their own split override in Settings ‚Üí Driver Overrides.
                </div>
              </div>
            </div>

            <div class="card noPrint" style="margin-top:14px;">
              <div class="head"><div class="k">Quick actions</div></div>
              <div class="body">
                <div class="row">
                  <button class="btn" onclick="copySummary()">üìã Copy weekly summary</button>
                  <button class="btn" onclick="exportCSV('week')">‚¨áÔ∏è Export week CSV</button>
                  <button class="btn" onclick="printWeeklySummary()">üñ®Ô∏è Print week</button>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="head">
              <div class="k">Weekly route map</div>
              <div class="pill">Hover rows to highlight routes</div>
            </div>
            <div class="mapWrap">
              <div id="map"></div>
            </div>
            <div class="mapMeta">
              <div id="mapInfo">Loaded routes in cyan ‚Ä¢ Deadhead in ember (dashed)</div>
              <div class="muted" id="mapCount">0 loads</div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="head">
            <div class="k">Weekly load log</div>
            <div class="pill">Search ‚Ä¢ Sort ‚Ä¢ Filter ‚Ä¢ Edit</div>
          </div>
          <div class="body">

            <div class="tableBar noPrint">
              <div class="left">
                <div class="control" style="min-width:260px;">
                  <label>Search</label>
                  <input id="loadSearch" placeholder="Origin, destination, notes‚Ä¶" oninput="updateUI()" />
                </div>
                <div class="control" style="min-width:210px;">
                  <label>Sort</label>
                  <select id="loadSort" onchange="updateUI()">
                    <option value="date_desc">Date (newest)</option>
                    <option value="net_desc">Net (high ‚Üí low)</option>
                    <option value="gross_desc">Gross (high ‚Üí low)</option>
                    <option value="miles_desc">Miles (high ‚Üí low)</option>
                    <option value="rpm_desc">RPM gross (high ‚Üí low)</option>
                  </select>
                </div>
                <div class="control" style="min-width:210px;">
                  <label>Filter</label>
                  <select id="loadFilter" onchange="updateUI()">
                    <option value="all">All loads</option>
                    <option value="profit">Net ‚â• 0</option>
                    <option value="loss">Net &lt; 0</option>
                  </select>
                </div>
              </div>

              <div class="right">
                <div class="pill" id="tableSummary">0 shown</div>
              </div>
            </div>

            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th>Route</th>
                    <th>Miles</th>
                    <th>Gross</th>
                    <th>Net</th>
                    <th>Gross RPM</th>
                    <th>Notes</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="loadList"></tbody>
              </table>
            </div>

          </div>
        </div>
      </section>

      <!-- ANALYTICS -->
      <section id="analytics" class="tab" style="display:none;">
        <div class="kpis">
          <div class="kpi">
            <div class="l">Selected driver ‚Ä¢ YTD gross</div>
            <div class="v" id="ytd_gross">$0.00</div>
          </div>
          <div class="kpi">
            <div class="l">Selected driver ‚Ä¢ YTD net</div>
            <div class="v pos" id="ytd_profit">$0.00</div>
          </div>
          <div class="kpi">
            <div class="l">Selected driver ‚Ä¢ Est. tax</div>
            <div class="v neg" id="ytd_tax">$0.00</div>
          </div>
          <div class="kpi">
            <div class="l">Selected driver ‚Ä¢ OER</div>
            <div class="v" id="oer_val">0%</div>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="head"><div class="k">Selected driver ‚Ä¢ business health</div></div>
          <div class="body">
            <div class="kv"><div class="k">Total fuel spend (YTD)</div><div class="v neg" id="ytd_fuel">$0.00</div></div>
            <div class="kv"><div class="k">Total maintenance saved (YTD)</div><div class="v pos" id="ytd_maint">$0.00</div></div>
            <div class="kv"><div class="k">Best week net</div><div class="v pos" id="best_week">$0.00</div></div>
            <div class="kv"><div class="k">Worst week net</div><div class="v neg" id="worst_week">$0.00</div></div>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="head"><div class="k">Selected driver ‚Ä¢ week history</div></div>
          <div class="body" style="padding:0;">
            <div class="tableWrap" style="border-radius:0;border:none;background:transparent;">
              <table style="min-width:760px;">
                <thead>
                  <tr>
                    <th>Week</th><th>Loads</th><th>Miles</th><th>Gross</th><th>Net</th><th>Gross RPM</th>
                  </tr>
                </thead>
                <tbody id="weekHistory"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="head"><div class="k">Fleet overview ‚Ä¢ all drivers</div></div>
          <div class="body" style="padding:0;">
            <div class="tableWrap" style="border-radius:0;border:none;background:transparent;">
              <table style="min-width:1080px;">
                <thead>
                  <tr>
                    <th>Driver</th><th>Split</th>
                    <th>CW Gross</th><th>CW RPM</th><th>CW Net</th>
                    <th>MTD Gross</th><th>MTD RPM</th><th>MTD Net</th>
                    <th>YTD Gross</th><th>YTD RPM</th><th>YTD Net</th>
                    <th>Quick</th>
                  </tr>
                </thead>
                <tbody id="fleetTable"></tbody>
              </table>
            </div>
          </div>
          <div class="body">
            <div class="muted" style="font-size:12px;line-height:1.35;">
              MTD/YTD are based on each load‚Äôs timestamp; older loads may fall back to week start.
            </div>
            <div class="row noPrint" style="margin-top:10px;">
              <button class="btn" onclick="exportCSV('ytd')">‚¨áÔ∏è Export selected driver YTD CSV</button>
              <button class="btn" onclick="printDriverYTD()">üñ®Ô∏è Print selected driver YTD</button>
              <button class="btn danger" onclick="factoryReset()">Factory reset</button>
            </div>
          </div>
        </div>
      </section>

      <!-- COMPANY CUT -->
      <section id="companycut" class="tab" style="display:none;">
        <div class="kpis">
          <div class="kpi"><div class="l">Company cut ‚Ä¢ current week</div><div class="v" id="cut_cw">$0.00</div></div>
          <div class="kpi"><div class="l">Company cut ‚Ä¢ month-to-date</div><div class="v" id="cut_mtd">$0.00</div></div>
          <div class="kpi"><div class="l">Company cut ‚Ä¢ year-to-date</div><div class="v" id="cut_ytd">$0.00</div></div>
          <div class="kpi"><div class="l">Avg take rate (weighted)</div><div class="v" id="cut_take">0%</div></div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="head"><div class="k">Company cut ‚Ä¢ breakdown</div></div>
          <div class="body" style="padding:0;">
            <div class="tableWrap" style="border-radius:0;border:none;background:transparent;">
              <table style="min-width:860px;">
                <thead>
                  <tr>
                    <th>Driver</th><th>Split</th>
                    <th>CW Gross</th><th>CW Company cut</th>
                    <th>MTD Gross</th><th>MTD Company cut</th>
                    <th>YTD Gross</th><th>YTD Company cut</th>
                  </tr>
                </thead>
                <tbody id="cutTable"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="head"><div class="k">Notes</div></div>
          <div class="body">
            <div class="muted" style="font-size:12px;line-height:1.45;">
              ‚ÄúCompany Cut‚Äù is calculated as <b>Gross √ó (1 ‚àí Split)</b>. Example: split 80% ‚Üí company cut 20%.<br/>
              If a load has a stored split, we use that. If not, we use that driver‚Äôs split override; if none, we use the global default split in Settings.
            </div>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="settings" class="tab" style="display:none;">
        <div class="grid">
          <div class="card">
            <div class="head"><div class="k">Fixed weekly costs</div></div>
            <div class="body">
              <div class="row"><div class="grow"><label>Truck pmt</label><input id="f_truck" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
              <div class="row"><div class="grow"><label>Trailer pmt</label><input id="f_trailer" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
              <div class="row"><div class="grow"><label>Insurance</label><input id="f_ins" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
              <div class="muted" style="margin-top:10px;font-size:12px;">Fixed costs are split across loads using ‚ÄúLoads per week‚Äù.</div>
            </div>
          </div>

          <div class="card">
            <div class="head"><div class="k">Variable weekly deductions</div></div>
            <div class="body">
              <div class="row"><div class="grow"><label>Advances</label><input id="f_adv" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
              <div class="row"><div class="grow"><label>Food/personal</label><input id="f_food" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
              <div class="row"><div class="grow"><label>Repairs (actual)</label><input id="f_rep" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
              <div class="muted" style="margin-top:10px;font-size:12px;">Keep ‚ÄúRepairs‚Äù for true out-of-pocket repairs; maintenance savings is calculated per mile.</div>
            </div>
          </div>

          <div>
            <div class="card">
              <div class="head"><div class="k">Specs, rates & goals</div></div>
              <div class="body">
                <div class="row"><div class="grow"><label>Default split % (0.80)</label><input id="s_split" type="number" inputmode="decimal" min="0" max="1" step="0.01"></div></div>
                <div class="row"><div class="grow"><label>Fuel price ($/gal)</label><input id="s_fuel" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
                <div class="row"><div class="grow"><label>MPG</label><input id="s_mpg" type="number" inputmode="decimal" min="0.1" step="0.1"></div></div>
                <div class="row"><div class="grow"><label>Maint ($/mi)</label><input id="s_maint" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
                <div class="row"><div class="grow"><label>Loads per week</label><input id="s_loads_per_week" type="number" inputmode="numeric" min="1" step="1"></div></div>
                <div class="row"><div class="grow"><label>Target net / week</label><input id="s_target_net" type="number" inputmode="decimal" min="0" step="0.01"></div></div>
                <div class="row"><div class="grow"><label>Tax rate (0.25)</label><input id="s_tax" type="number" inputmode="decimal" min="0" max="1" step="0.01"></div></div>

                <button class="btn primary noPrint" style="width:100%;margin-top:10px;" onclick="saveSettings()">Save global settings</button>

                <div class="muted" style="margin-top:10px;font-size:12px;">
                  Global split is the default. You can override split per driver below.
                </div>
              </div>
            </div>

            <div class="card" style="margin-top:14px;">
              <div class="head"><div class="k">Driver overrides (selected driver)</div></div>
              <div class="body">
                <div class="row">
                  <div class="grow">
                    <label>Split % for this driver</label>
                    <input id="d_split" type="number" inputmode="decimal" min="0" max="1" step="0.01" />
                  </div>
                </div>
                <button class="btn primary noPrint" style="width:100%;margin-top:10px;" onclick="saveDriverOverrides()">Save driver override</button>
                <div class="muted" style="margin-top:10px;font-size:12px;">
                  Example: 0.80 (80%), 0.88 (88%). Existing loads keep their stored split.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="grid" style="margin-top:14px;">
          <div class="card">
            <div class="head"><div class="k">Endpoints & rate limiting</div></div>
            <div class="body">
              <div class="row">
                <div class="grow">
                  <label>Nominatim base URL</label>
                  <input id="endpoint_nominatim" placeholder="https://nominatim.openstreetmap.org" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="grow">
                  <label>OSRM base URL</label>
                  <input id="endpoint_osrm" placeholder="https://router.project-osrm.org" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="grow">
                  <label>Min interval per outbound request (ms)</label>
                  <input id="net_min_interval" type="number" inputmode="numeric" min="1100" step="100" />
                </div>
                <div class="grow">
                  <label>Geocode cache TTL (days)</label>
                  <input id="geo_ttl_days" type="number" inputmode="numeric" min="1" step="1" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="grow">
                  <label>Country hint for geocoding</label>
                  <input id="geo_country" placeholder="USA" />
                </div>
                <div class="grow">
                  <label>Theme mode</label>
                  <select id="ui_theme">
                    <option value="graphite">Graphite</option>
                    <option value="steel">Steel</option>
                  </select>
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <button class="btn primary" onclick="saveEndpointSettings()">Save endpoints</button>
                <button class="btn" onclick="testEndpoints()">Test</button>
              </div>

              <div class="muted" style="margin-top:10px;font-size:12px;line-height:1.35;">
                Recommendation: serve this file via a local HTTP server (not file://) so requests include a Referer header.
                Public services may block unidentified or heavy usage.
              </div>
            </div>
          </div>

          <div class="card">
            <div class="head"><div class="k">Backup & restore</div></div>
            <div class="body">
              <div class="row">
                <button class="btn primary" onclick="downloadBackup()">‚¨áÔ∏è Download backup JSON</button>
                <button class="btn" onclick="copyBackupToClipboard()">üìã Copy backup JSON</button>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="grow">
                  <label>Import backup JSON</label>
                  <input id="backupFile" type="file" accept="application/json" />
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <button class="btn" onclick="importBackup('merge')">Import (merge)</button>
                <button class="btn danger" onclick="importBackup('replace')">Import (replace)</button>
              </div>

              <div class="muted" style="margin-top:10px;font-size:12px;line-height:1.35;">
                Use backup to migrate between devices and mitigate browser storage quotas.
              </div>
            </div>
          </div>
        </div>

        <div class="muted" style="margin-top:14px;font-size:12px;">
          Privacy: this tool stores data in your browser (local). Use Factory Reset if you‚Äôre switching devices.
        </div>
      </section>
    </main>
  </div>

<script>
/* =========================================================
   STORAGE KEYS (PRESERVED)
========================================================= */
const STORE_KEY = "tagdriverpro_v3_state";
const SETTINGS_KEY = "tagdriverpro_v3_settings";
const GEO_CACHE_KEY = "tagdriverpro_v3_geo_cache";

/* =========================================================
   DEFAULT SETTINGS (EXTENDED)
========================================================= */
const defaultSettings = {
  // Costs
  f_truck: 800, f_trailer: 400, f_ins: 350,
  f_adv: 0, f_food: 0, f_rep: 0,

  // Specs & goals
  s_split: 0.80, s_fuel: 3.25, s_mpg: 6.5, s_maint: 0.17,
  s_loads_per_week: 5, s_target_net: 1500, s_tax: 0.25,

  // Endpoints + network constraints
  endpoint_nominatim: "https://nominatim.openstreetmap.org",
  endpoint_osrm: "https://router.project-osrm.org",
  network_min_interval_ms: 1100,     // strict >= 1100ms (>= 1.1s)
  geo_ttl_days: 30,
  geo_country_hint: "USA",

  // UI
  ui_theme: "graphite"
};

function startOfWeekMonday(date = new Date()){
  const d = new Date(date);
  const day = d.getDay();
  const diff = (day === 0 ? -6 : 1 - day);
  d.setDate(d.getDate() + diff);
  d.setHours(0,0,0,0);
  return d;
}
function isoDate(d){
  const x = new Date(d);
  const yyyy = x.getFullYear();
  const mm = String(x.getMonth()+1).padStart(2,"0");
  const dd = String(x.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function fmtWeekLabel(dateObj){
  const d = new Date(dateObj);
  const m = d.toLocaleString(undefined, { month: "short" });
  return `Week of ${m} ${d.getDate()}, ${d.getFullYear()}`;
}
function nowStamp(){ return new Date().toLocaleString(); }

function money(v){
  const n = Number(v);
  const safe = Number.isFinite(n) ? n : 0;
  return "$" + safe.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function pct(v){ return (Number(v||0)*100).toFixed(1) + "%"; }
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
function uuid(){
  if (window.crypto?.randomUUID) return crypto.randomUUID();
  return "id_" + Date.now() + "_" + Math.random().toString(16).slice(2);
}
function clamp(n, min, max){
  const x = Number(n);
  if (!Number.isFinite(x)) return min;
  return Math.min(max, Math.max(min, x));
}

/* =========================================================
   SETTINGS LOAD/SAVE
========================================================= */
function loadSettings(){
  const raw = localStorage.getItem(SETTINGS_KEY);
  let s = {};
  try { s = raw ? JSON.parse(raw) : {}; } catch(e){ s = {}; }
  const merged = { ...defaultSettings, ...s };

  // Enforce strict minimum >= 1100ms
  merged.network_min_interval_ms = Math.max(1100, parseInt(merged.network_min_interval_ms || "1100", 10));
  merged.geo_ttl_days = Math.max(1, parseInt(merged.geo_ttl_days || "30", 10));
  merged.ui_theme = (merged.ui_theme === "steel") ? "steel" : "graphite";
  return merged;
}
function persistSettings(s){
  try { localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }
  catch(e){
    alert("Could not save settings (storage quota?). Consider exporting a backup.");
  }
}

/* =========================================================
   STATE CREATE/MIGRATE (PRESERVED MODEL)
========================================================= */
function migrateOrCreateState(){
  const raw = localStorage.getItem(STORE_KEY);
  if (raw){
    try{
      const st = JSON.parse(raw);
      return migrateState(st);
    } catch(e){
      console.warn("State parse failed, recreating.", e);
    }
  }

  // Create new state (same as original behavior)
  const wk = startOfWeekMonday(new Date());
  const baseId = isoDate(wk);
  const driverId = "driver_1";
  const state = {
    currentDriverId: driverId,
    drivers: {
      [driverId]: {
        name: "Driver 1",
        splitOverride: null,
        currentWeekId: baseId,
        weeks: {
          [baseId]: { start: baseId, label: fmtWeekLabel(wk), loads: [], lastDropCoords: null }
        }
      }
    }
  };
  localStorage.setItem(STORE_KEY, JSON.stringify(state));
  return state;
}

function migrateState(st){
  // Non-destructive normalization
  if (!st || typeof st !== "object") return migrateOrCreateState();
  if (!st.drivers || typeof st.drivers !== "object") st.drivers = {};
  const driverIds = Object.keys(st.drivers);
  if (!st.currentDriverId || !st.drivers[st.currentDriverId]){
    st.currentDriverId = driverIds[0] || null;
  }

  for (const did of Object.keys(st.drivers)){
    const d = st.drivers[did] || {};
    if (!d.weeks || typeof d.weeks !== "object") d.weeks = {};
    if (!("splitOverride" in d)) d.splitOverride = null;

    // Ensure currentWeekId points to a real week
    if (!d.currentWeekId || !d.weeks[d.currentWeekId]){
      const wkIds = Object.keys(d.weeks).sort().reverse();
      d.currentWeekId = wkIds[0] || null;
    }

    for (const wkId of Object.keys(d.weeks)){
      const w = d.weeks[wkId] || {};
      if (!w.loads) w.loads = [];
      if (!("lastDropCoords" in w)) w.lastDropCoords = null;

      // Ensure week.start and label exist
      if (!w.start){
        const base = wkId.split("_")[0];
        w.start = base;
      }
      if (!w.label){
        const dt = new Date((w.start || wkId.split("_")[0]) + "T00:00:00");
        w.label = fmtWeekLabel(dt) + (wkId.includes("_v") ? ` (${wkId.split("_v")[1]})` : "");
      }

      // Ensure each load has required fields + backward compatible additions
      w.loads = (w.loads || []).map(l => normalizeLoad(l, w));
    }
    st.drivers[did] = d;
  }

  // Ensure at least one driver exists
  if (!Object.keys(st.drivers).length){
    const wk = startOfWeekMonday(new Date());
    const baseId = isoDate(wk);
    const driverId = "driver_1";
    st.currentDriverId = driverId;
    st.drivers[driverId] = {
      name: "Driver 1",
      splitOverride: null,
      currentWeekId: baseId,
      weeks: { [baseId]: { start: baseId, label: fmtWeekLabel(wk), loads: [], lastDropCoords: null } }
    };
  }

  // Persist migrated state
  saveState();
  return st;
}

function normalizeLoad(l, week){
  if (!l || typeof l !== "object") l = {};
  if (!l.id) l.id = uuid();
  if (!l.createdAt){
    // Prefer week-start fallback
    const base = week?.start ? new Date(week.start + "T00:00:00") : new Date();
    l.createdAt = base.toISOString();
  }
  if (!("notes" in l)) l.notes = "";
  if (!l.details || typeof l.details !== "object") l.details = {};
  // Optional decomposition (for edit/reroute)
  if (!Number.isFinite(Number(l.details.mi_load))) l.details.mi_load = Number(l.miles || 0);
  if (!Number.isFinite(Number(l.details.mi_dh))) l.details.mi_dh = 0;

  return l;
}

function saveState(){
  try { localStorage.setItem(STORE_KEY, JSON.stringify(state)); }
  catch(e){
    alert("Could not save data (storage quota?). Export a backup from Settings.");
  }
}

/* =========================================================
   GLOBAL APP STATE
========================================================= */
let settings = loadSettings();
let state = migrateOrCreateState();

let ui = {
  activeTab: "dashboard",
  lastDelete: null,         // { weekId, driverId, load, index, timeoutId }
  editing: null,            // { weekId, driverId, loadId }
};

function setStatus(msg, show=true){
  const el = document.getElementById("status");
  el.textContent = msg;
  el.style.display = show ? "block" : "none";
}

/* =========================================================
   REQUEST QUEUE + RATE LIMITING (>= 1.1s)
========================================================= */
function createRateLimitedQueue(minIntervalMs){
  let tail = Promise.resolve();
  let lastStart = 0;

  return function enqueue(task){
    return new Promise((resolve, reject) => {
      tail = tail.then(async () => {
        const now = Date.now();
        const wait = Math.max(0, (lastStart + minIntervalMs) - now);
        if (wait) await sleep(wait);
        lastStart = Date.now();
        try{
          const out = await task();
          resolve(out);
        } catch(e){
          reject(e);
        }
      }).catch(() => {
        // keep queue alive
      });
    });
  };
}

let enqueueNet = createRateLimitedQueue(settings.network_min_interval_ms);

async function fetchWithTimeout(url, ms=15000){
  // Use AbortSignal.timeout if available; fallback to AbortController.
  if (window.AbortSignal && AbortSignal.timeout){
    return fetch(url, { signal: AbortSignal.timeout(ms), headers: { "Accept": "application/json" } });
  }
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), ms);
  try{
    return await fetch(url, { signal: ctrl.signal, headers: { "Accept": "application/json" } });
  } finally {
    clearTimeout(t);
  }
}

async function fetchRetryJson(url, tries=2, waitMs=800){
  let lastErr = null;
  for (let i=0;i<tries;i++){
    try{
      const res = await fetchWithTimeout(url, 18000);
      if (!res.ok){
        if ((res.status === 429 || res.status >= 500) && i < tries-1){
          await sleep(waitMs * (i+1));
          continue;
        }
        throw new Error(`HTTP ${res.status}`);
      }
      return await res.json();
    } catch(e){
      lastErr = e;
      if (i < tries-1) await sleep(waitMs * (i+1));
    }
  }
  throw lastErr;
}

async function queuedJson(url, tries=2){
  return enqueueNet(() => fetchRetryJson(url, tries, 800));
}

/* =========================================================
   GEO CACHE
========================================================= */
function loadGeoCache(){
  try { return JSON.parse(localStorage.getItem(GEO_CACHE_KEY) || "{}"); }
  catch(e){ return {}; }
}
function saveGeoCache(cache){
  try { localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(cache)); }
  catch(e){ /* ignore */ }
}
function normalizeCity(q){
  return String(q||"").trim().toLowerCase().replace(/\s+/g," ");
}

async function getLoc(city){
  const q = normalizeCity(city);
  if (!q) return null;

  const cache = loadGeoCache();
  const now = Date.now();
  const TTL = 1000*60*60*24*settings.geo_ttl_days;
  const cacheKey = `${settings.endpoint_nominatim}|${settings.geo_country_hint}|${q}`;

  const hit = cache[cacheKey];
  if (hit?.ts && (now - hit.ts) < TTL) return hit.data;

  const base = settings.endpoint_nominatim.replace(/\/$/,"");
  const hint = String(settings.geo_country_hint || "").trim();
  const query = hint ? `${city}, ${hint}` : city;

  const url = `${base}/search?format=json&addressdetails=0&limit=1&q=${encodeURIComponent(query)}`;
  const data = await queuedJson(url, 2);
  if (!data?.[0]) return null;

  cache[cacheKey] = { ts: now, data: data[0] };
  saveGeoCache(cache);
  return data[0];
}

/* =========================================================
   OSRM ROUTING
========================================================= */
async function osrmRouteMilesGeo(lon1, lat1, lon2, lat2){
  const base = settings.endpoint_osrm.replace(/\/$/,"");
  const url = `${base}/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson&steps=false`;
  const j = await queuedJson(url, 2);
  if (!j?.routes?.[0]) throw new Error("Route not found");
  const r = j.routes[0];
  return { miles: Math.round(r.distance * 0.000621371), geo: r.geometry };
}

/* =========================================================
   DRIVER/WEEK GETTERS (PRESERVED)
========================================================= */
function getDriver(){
  const id = state.currentDriverId;
  if (!state.drivers[id]){
    const keys = Object.keys(state.drivers);
    state.currentDriverId = keys[0];
    saveState();
  }
  return state.drivers[state.currentDriverId];
}
function getCurrentWeek(){
  const d = getDriver();
  const wkId = d.currentWeekId;
  if (!d.weeks[wkId]){
    const base = wkId.split("_")[0];
    const dt = new Date(base + "T00:00:00");
    d.weeks[wkId] = { start: base, label: fmtWeekLabel(dt), loads: [], lastDropCoords: null };
    saveState();
  }
  return d.weeks[d.currentWeekId];
}
function getDriverSplit(driver){
  const s = getSpecs();
  const ov = Number(driver?.splitOverride);
  if (Number.isFinite(ov) && ov > 0 && ov < 1.00001) return ov;
  return s.split;
}

/* =========================================================
   NAV
========================================================= */
function toggleSidebar(force){
  const open = (typeof force === "boolean") ? force : (document.body.dataset.sidebar !== "open");
  document.body.dataset.sidebar = open ? "open" : "closed";
}
function showTab(id, btn){
  ui.activeTab = id;

  document.querySelectorAll(".tab").forEach(t => t.style.display = "none");
  const el = document.getElementById(id);
  if (el) el.style.display = "block";

  document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active"));
  if (btn) btn.classList.add("active");
  else {
    const b = document.querySelector(`.nav button[data-tab="${id}"]`);
    if (b) b.classList.add("active");
  }

  toggleSidebar(false);

  if (id === "dashboard"){
    setTimeout(()=>{ initMap(true); }, 160);
  }
}

/* =========================================================
   DRIVER MENU
========================================================= */
function renderDriverSelect(){
  const sel = document.getElementById("driverSelect");
  const ids = Object.keys(state.drivers);
  sel.innerHTML = ids.map(id => {
    const d = state.drivers[id];
    const selected = (id === state.currentDriverId) ? "selected" : "";
    return `<option value="${id}" ${selected}>${escapeHtml(d.name)}</option>`;
  }).join("");
}
function onDriverChange(){
  const sel = document.getElementById("driverSelect");
  state.currentDriverId = sel.value;
  saveState();
  renderWeekSelect();
  bindDriverOverridesToInputs();
  updateUI();
  setTimeout(()=>initMap(true), 120);
}
function addDriver(){
  const name = prompt("Driver name (ex: John Smith):");
  if (!name) return;

  const wk = startOfWeekMonday(new Date());
  const baseId = isoDate(wk);

  const id = `driver_${Date.now()}`;
  state.drivers[id] = {
    name: name.trim(),
    splitOverride: null,
    currentWeekId: baseId,
    weeks: { [baseId]: { start: baseId, label: fmtWeekLabel(wk), loads: [], lastDropCoords: null } }
  };
  state.currentDriverId = id;
  saveState();
  renderDriverSelect();
  renderWeekSelect();
  bindDriverOverridesToInputs();
  updateUI();
  setTimeout(()=>initMap(true), 120);
}
function removeDriver(){
  const d = getDriver();
  if (!confirm(`Remove driver "${d.name}" and all their data on THIS device?`)) return;
  const ids = Object.keys(state.drivers);
  if (ids.length <= 1) return alert("You must keep at least one driver.");

  delete state.drivers[state.currentDriverId];
  state.currentDriverId = Object.keys(state.drivers)[0];
  saveState();
  renderDriverSelect();
  renderWeekSelect();
  bindDriverOverridesToInputs();
  updateUI();
  setTimeout(()=>initMap(true), 120);
}

/* =========================================================
   WEEK MENU
========================================================= */
function renderWeekSelect(){
  const sel = document.getElementById("weekSelect");
  const d = getDriver();
  const ids = Object.keys(d.weeks).sort().reverse();
  sel.innerHTML = ids.map(id => {
    const w = d.weeks[id];
    const selected = (id === d.currentWeekId) ? "selected" : "";
    return `<option value="${id}" ${selected}>${escapeHtml(w.label || id)}</option>`;
  }).join("");
}
function onWeekChange(){
  const sel = document.getElementById("weekSelect");
  const id = sel.value;
  const d = getDriver();
  if (!d.weeks[id]) return;
  d.currentWeekId = id;
  saveState();
  updateUI();
  setTimeout(()=>initMap(true), 120);
}
function startNewWeek(){
  if (!confirm("Start a new week for this driver? Current week will remain saved.")) return;

  const d = getDriver();
  const base = startOfWeekMonday(new Date());
  const baseId = isoDate(base);
  let id = baseId;

  let counter = 1;
  while (d.weeks[id]){ counter++; id = baseId + "_v" + counter; }

  d.weeks[id] = { start: baseId, label: fmtWeekLabel(base) + (counter>1?` (${counter})`:""), loads: [], lastDropCoords: null };
  d.currentWeekId = id;
  saveState();
  renderWeekSelect();
  updateUI();
  setTimeout(()=>initMap(true), 120);
}
function resetCurrentWeek(){
  const wk = getCurrentWeek();
  if (!confirm("Clear all loads for this week?")) return;
  wk.loads = [];
  wk.lastDropCoords = null;
  saveState();
  updateUI();
  initMap(true);
}

/* =========================================================
   SETTINGS + SPECS (PRESERVED)
========================================================= */
function bindSettingsToInputs(){
  const s = settings;

  // Costs
  document.getElementById("f_truck").value = s.f_truck;
  document.getElementById("f_trailer").value = s.f_trailer;
  document.getElementById("f_ins").value = s.f_ins;
  document.getElementById("f_adv").value = s.f_adv;
  document.getElementById("f_food").value = s.f_food;
  document.getElementById("f_rep").value = s.f_rep;

  // Specs/goals
  document.getElementById("s_split").value = s.s_split;
  document.getElementById("s_fuel").value = s.s_fuel;
  document.getElementById("s_mpg").value = s.s_mpg;
  document.getElementById("s_maint").value = s.s_maint;
  document.getElementById("s_loads_per_week").value = s.s_loads_per_week;
  document.getElementById("s_target_net").value = s.s_target_net;
  document.getElementById("s_tax").value = s.s_tax;

  // Endpoint settings
  document.getElementById("endpoint_nominatim").value = s.endpoint_nominatim;
  document.getElementById("endpoint_osrm").value = s.endpoint_osrm;
  document.getElementById("net_min_interval").value = s.network_min_interval_ms;
  document.getElementById("geo_ttl_days").value = s.geo_ttl_days;
  document.getElementById("geo_country").value = s.geo_country_hint;
  document.getElementById("ui_theme").value = s.ui_theme;

  // Live preview updates
  document.querySelectorAll("#settings input, #settings select").forEach(inp => {
    inp.addEventListener("input", () => { preview(); updateUI(); });
  });
}

function getSpecs(){
  const split = parseFloat(document.getElementById("s_split").value);
  const fuel  = parseFloat(document.getElementById("s_fuel").value);
  const mpg   = parseFloat(document.getElementById("s_mpg").value);
  const maint = parseFloat(document.getElementById("s_maint").value);
  const loadsPerWeek = Math.max(1, parseInt(document.getElementById("s_loads_per_week").value || "5", 10));
  const targetNet = parseFloat(document.getElementById("s_target_net").value);
  const taxRate = parseFloat(document.getElementById("s_tax").value);

  const fixedWeekly = ["f_truck","f_trailer","f_ins","f_adv","f_food","f_rep"]
    .reduce((sum,id)=> sum + (parseFloat(document.getElementById(id).value)||0), 0);

  return {
    split: Number.isFinite(split) ? split : 0.80,
    fuel: Number.isFinite(fuel) ? fuel : 3.25,
    mpg: (Number.isFinite(mpg) && mpg>0) ? mpg : 6.5,
    maint: Number.isFinite(maint) ? maint : 0.17,
    fixedWeekly,
    loadsPerWeek,
    fixedPerLoad: fixedWeekly / loadsPerWeek,
    targetNet: Number.isFinite(targetNet) ? targetNet : 1500,
    taxRate: Number.isFinite(taxRate) ? taxRate : 0.25
  };
}

function saveSettings(){
  const s = {
    f_truck: parseFloat(document.getElementById("f_truck").value) || 0,
    f_trailer: parseFloat(document.getElementById("f_trailer").value) || 0,
    f_ins: parseFloat(document.getElementById("f_ins").value) || 0,
    f_adv: parseFloat(document.getElementById("f_adv").value) || 0,
    f_food: parseFloat(document.getElementById("f_food").value) || 0,
    f_rep: parseFloat(document.getElementById("f_rep").value) || 0,
    s_split: parseFloat(document.getElementById("s_split").value) || 0.8,
    s_fuel: parseFloat(document.getElementById("s_fuel").value) || 3.25,
    s_mpg: parseFloat(document.getElementById("s_mpg").value) || 6.5,
    s_maint: parseFloat(document.getElementById("s_maint").value) || 0.17,
    s_loads_per_week: Math.max(1, parseInt(document.getElementById("s_loads_per_week").value || "5", 10)),
    s_target_net: parseFloat(document.getElementById("s_target_net").value) || 1500,
    s_tax: parseFloat(document.getElementById("s_tax").value) || 0.25
  };
  settings = { ...settings, ...s };
  persistSettings(settings);
  alert("Global settings saved on this device.");
  updateUI();
}

function bindDriverOverridesToInputs(){
  const d = getDriver();
  const el = document.getElementById("d_split");
  const val = Number(d.splitOverride);
  el.value = (Number.isFinite(val) ? val : getSpecs().split);
}
function saveDriverOverrides(){
  const d = getDriver();
  const v = parseFloat(document.getElementById("d_split").value);
  if (!(Number.isFinite(v) && v > 0 && v < 1.00001)) return alert("Enter a valid split like 0.80 or 0.88.");
  d.splitOverride = v;
  saveState();
  alert("Driver split override saved.");
  updateUI();
}

/* Endpoint settings save */
function saveEndpointSettings(){
  const nom = (document.getElementById("endpoint_nominatim").value || "").trim();
  const osrm = (document.getElementById("endpoint_osrm").value || "").trim();
  const minMs = Math.max(1100, parseInt(document.getElementById("net_min_interval").value || "1100", 10));
  const ttl = Math.max(1, parseInt(document.getElementById("geo_ttl_days").value || "30", 10));
  const hint = (document.getElementById("geo_country").value || "").trim() || "USA";
  const theme = document.getElementById("ui_theme").value === "steel" ? "steel" : "graphite";

  if (!nom.startsWith("http")) return alert("Enter a valid Nominatim URL (https://...)");
  if (!osrm.startsWith("http")) return alert("Enter a valid OSRM URL (https://...)");

  settings.endpoint_nominatim = nom.replace(/\/$/,"");
  settings.endpoint_osrm = osrm.replace(/\/$/,"");
  settings.network_min_interval_ms = minMs;
  settings.geo_ttl_days = ttl;
  settings.geo_country_hint = hint;
  settings.ui_theme = theme;

  // Apply theme immediately
  document.body.dataset.theme = theme;

  // Rebuild queue with updated min interval
  enqueueNet = createRateLimitedQueue(settings.network_min_interval_ms);

  persistSettings(settings);
  alert("Endpoints + rate limiting saved.");
}

async function testEndpoints(){
  try{
    setStatus("Testing endpoints (throttled)‚Ä¶", true);

    // Nominatim test
    const loc = await getLoc("Kansas City, MO");
    if (!loc?.lat) throw new Error("Nominatim test failed.");

    // OSRM test using loc (route to nearby coordinate)
    const lat1 = Number(loc.lat), lon1 = Number(loc.lon);
    const lat2 = lat1 + 0.04, lon2 = lon1 + 0.04;
    const r = await osrmRouteMilesGeo(lon1, lat1, lon2, lat2);
    if (!Number.isFinite(r.miles)) throw new Error("OSRM test failed.");

    setStatus("Endpoints OK ‚úÖ", true);
    setTimeout(()=>setStatus("", false), 2500);
  } catch(e){
    console.error(e);
    setStatus("Endpoint test failed. Check URLs, CORS, or rate limits.", true);
    setTimeout(()=>setStatus("", false), 4500);
  }
}

/* =========================================================
   CALCS + AGGREGATIONS (PRESERVED)
========================================================= */
function computeWeekTotals(week){
  const loads = week.loads || [];
  const gross = loads.reduce((s,l) => s + (Number(l.gross)||0), 0);
  const miles = loads.reduce((s,l) => s + (Number(l.miles)||0), 0);
  const net   = loads.reduce((s,l) => s + (Number(l.net)||0), 0);
  const fuel  = loads.reduce((s,l)=> s + (Number(l.details?.fuel)||0), 0);
  const maint = loads.reduce((s,l)=> s + (Number(l.details?.maint)||0), 0);
  const tolls = loads.reduce((s,l)=> s + (Number(l.details?.tolls)||0), 0);
  const fixed = loads.reduce((s,l)=> s + (Number(l.details?.fixed)||0), 0);
  const rpm   = miles>0 ? gross/miles : 0;
  return { gross,miles,net,fuel,maint,tolls,fixed,rpm };
}

function loadDateFallback(load, week){
  if (load?.createdAt){
    const d = new Date(load.createdAt);
    if (!isNaN(d)) return d;
  }
  if (week?.start){
    const d = new Date(week.start + "T00:00:00");
    if (!isNaN(d)) return d;
  }
  return new Date(0);
}

function totalsForDriverInRange(driver, startDate, endDate){
  let gross=0,miles=0,net=0,fuel=0,maint=0,tolls=0,fixed=0,companyCut=0;
  const start = new Date(startDate); const end = new Date(endDate);

  for (const wkId of Object.keys(driver.weeks||{})){
    const w = driver.weeks[wkId];
    const loads = w.loads || [];
    for (const l of loads){
      const dt = loadDateFallback(l, w);
      if (dt >= start && dt <= end){
        gross += (Number(l.gross)||0);
        miles += (Number(l.miles)||0);
        net   += (Number(l.net)||0);
        fuel  += (Number(l.details?.fuel)||0);
        maint += (Number(l.details?.maint)||0);
        tolls += (Number(l.details?.tolls)||0);
        fixed += (Number(l.details?.fixed)||0);

        const splitUsed =
          Number.isFinite(Number(l.details?.split)) ? Number(l.details.split) :
          getDriverSplit(driver);
        companyCut += (Number(l.gross)||0) * (1 - splitUsed);
      }
    }
  }
  const rpm = miles>0 ? gross/miles : 0;
  return { gross,miles,net,fuel,maint,tolls,fixed,rpm,companyCut };
}

/* =========================================================
   PREVIEW + WARN
========================================================= */
function preview(){
  const s = getSpecs();
  const driver = getDriver();
  const split = getDriverSplit(driver);

  const gross = parseFloat(document.getElementById("pay_gross").value) || 0;
  const miLoad = parseFloat(document.getElementById("mi_load").value) || 0;
  const miDh   = parseFloat(document.getElementById("mi_dh").value) || 0;
  const miles = miLoad + miDh;
  const tolls = parseFloat(document.getElementById("cost_tolls").value) || 0;

  const fuel = (miles / s.mpg) * s.fuel;
  const maint = miles * s.maint;
  const fixed = s.fixedPerLoad;
  const net = (gross * split) - fuel - maint - fixed - tolls;

  const el = document.getElementById("preview_net");
  el.textContent = money(net);
  el.className = (net >= 0) ? "pos" : "neg";

  const grossRpm = miles>0 ? gross/miles : 0;
  const beGross = miles>0 ? ((fuel + maint + fixed + tolls) / split) : 0;
  const beRpm = miles>0 ? (beGross/miles) : 0;

  document.getElementById("preview_hint").textContent =
    miles>0 ? `Split: ${(split*100).toFixed(0)}% ‚Ä¢ Gross RPM: ${money(grossRpm)} ‚Ä¢ Break-even RPM: ${money(beRpm)}` : "";
}

function updateWarnBanner(){
  const s = getSpecs();
  const wk = getCurrentWeek();
  const t = computeWeekTotals(wk);

  const warn = document.getElementById("warn");
  if (wk.loads.length > 0 && t.net < s.targetNet){
    const gap = s.targetNet - t.net;
    warn.style.display = "block";
    warn.innerHTML = `‚ö†Ô∏è Target not met for <b>${escapeHtml(getDriver().name)}</b>: goal <b>${money(s.targetNet)}</b> ‚Ä¢ currently <b>${money(t.net)}</b> ‚Ä¢ gap <b>${money(gap)}</b>.`;
  } else {
    warn.style.display = "none";
    warn.innerHTML = "";
  }
}

/* =========================================================
   LOAD CRUD (ADD / EDIT / DELETE / UNDO)
========================================================= */
function calcLoadNetUsingDetails(load){
  // Preserve historical contract: stored per-load rates/split drive net.
  const miles = Number(load.miles) || 0;
  const gross = Number(load.gross) || 0;

  const split = Number.isFinite(Number(load.details?.split)) ? Number(load.details.split) : getDriverSplit(getDriver());
  const mpg = Number(load.details?.mpg) || getSpecs().mpg;
  const fuelPrice = Number(load.details?.fuelPrice) || getSpecs().fuel;
  const maintRate = Number(load.details?.maintRate) || getSpecs().maint;
  const loadsPerWeek = Math.max(1, Number(load.details?.loadsPerWeek) || getSpecs().loadsPerWeek);

  const fixedWeekly = getSpecs().fixedWeekly;
  const fixed = fixedWeekly / loadsPerWeek;

  const tolls = Number(load.details?.tolls) || 0;
  const fuel = (miles / mpg) * fuelPrice;
  const maint = miles * maintRate;

  const cut = gross * split;
  const net = cut - fuel - maint - fixed - tolls;

  load.details.fuel = fuel;
  load.details.maint = maint;
  load.details.fixed = fixed;
  load.details.cut = cut;

  load.net = net;
  return load;
}

function addLoad(){
  const originEl = document.getElementById("origin");
  const destEl = document.getElementById("dest");

  const origin = originEl.value.trim();
  const dest = destEl.value.trim();
  const notes = (document.getElementById("notes").value || "").trim();

  const gross = parseFloat(document.getElementById("pay_gross").value) || 0;
  const miLoad = parseFloat(document.getElementById("mi_load").value) || 0;
  const miDh   = parseFloat(document.getElementById("mi_dh").value) || 0;
  const miles = miLoad + miDh;
  const tolls = parseFloat(document.getElementById("cost_tolls").value) || 0;

  if (!origin || !dest) return alert("Enter pickup & drop first.");
  if (gross <= 0 || miles <= 0) return alert("Enter miles and gross pay.");

  // Coordinates + geometry from calcRoute (optional)
  const oLat = Number(originEl.dataset.lat);
  const oLon = Number(originEl.dataset.lon);
  const dLat = Number(destEl.dataset.lat);
  const dLon = Number(destEl.dataset.lon);

  const s = getSpecs();
  const driver = getDriver();
  const split = getDriverSplit(driver);

  const fuel = (miles / s.mpg) * s.fuel;
  const maint = miles * s.maint;
  const fixed = s.fixedPerLoad;
  const cut = gross * split;
  const net = cut - fuel - maint - fixed - tolls;

  let routeGeo = null;
  try { routeGeo = JSON.parse(originEl.dataset.routeGeo || "null"); } catch(e){ routeGeo=null; }

  let dhGeo = null;
  try { dhGeo = JSON.parse(originEl.dataset.dhGeo || "null"); } catch(e){ dhGeo=null; }

  const wk = getCurrentWeek();
  const load = {
    id: uuid(),
    origin, dest,
    notes,
    gross, miles, net,
    createdAt: new Date().toISOString(),
    details: {
      fuel, maint, fixed, tolls,
      cut,
      split,
      mpg: s.mpg,
      fuelPrice: s.fuel,
      maintRate: s.maint,
      loadsPerWeek: s.loadsPerWeek,
      mi_load: miLoad,
      mi_dh: miDh
    },
    coords: (Number.isFinite(oLat) && Number.isFinite(dLat)) ? { start:{lat:oLat, lon:oLon}, end:{lat:dLat, lon:dLon} } : null,
    routeGeo,
    dhGeo
  };

  wk.loads.push(load);

  if (Number.isFinite(dLat) && Number.isFinite(dLon)) wk.lastDropCoords = { lat: dLat, lon: dLon };
  else wk.lastDropCoords = null;

  saveState();
  updateUI();
  initMap(true);

  // reset fields
  ["origin","dest","mi_load","mi_dh","cost_tolls","pay_gross","notes"].forEach(i => document.getElementById(i).value="");
  originEl.dataset.lat=""; originEl.dataset.lon=""; originEl.dataset.routeGeo=""; originEl.dataset.dhGeo="";
  destEl.dataset.lat=""; destEl.dataset.lon="";
  document.getElementById("preview_net").textContent = "$0.00";
  document.getElementById("preview_hint").textContent = "";
}

function getLoadIndexById(week, loadId){
  return (week.loads || []).findIndex(l => l.id === loadId);
}

function delLoadByIndex(index){
  const wk = getCurrentWeek();
  const d = getDriver();

  const load = wk.loads[index];
  if (!load) return;

  // Remove
  wk.loads.splice(index, 1);

  // Fix lastDropCoords
  if (wk.loads.length === 0) wk.lastDropCoords = null;
  else {
    const last = wk.loads[wk.loads.length - 1];
    if (last?.coords?.end?.lat && last?.coords?.end?.lon) wk.lastDropCoords = { lat:last.coords.end.lat, lon:last.coords.end.lon };
    else wk.lastDropCoords = null;
  }

  saveState();
  updateUI();
  initMap(true);

  // Undo stack
  if (ui.lastDelete?.timeoutId) clearTimeout(ui.lastDelete.timeoutId);
  const timeoutId = setTimeout(() => {
    ui.lastDelete = null;
    hideToast();
  }, 8000);

  ui.lastDelete = {
    driverId: state.currentDriverId,
    weekId: d.currentWeekId,
    load,
    index,
    timeoutId
  };

  showToast(`Deleted load: ${load.origin} ‚Üí ${load.dest}.`);
}

function delLoad(id){
  const wk = getCurrentWeek();
  const idx = getLoadIndexById(wk, id);
  if (idx < 0) return;
  if (!confirm("Delete this load?")) return;
  delLoadByIndex(idx);
}

function undoDelete(){
  const pack = ui.lastDelete;
  if (!pack) return;

  const d = state.drivers[pack.driverId];
  if (!d) return hideToast();

  const wk = d.weeks[pack.weekId];
  if (!wk) return hideToast();

  wk.loads.splice(pack.index, 0, pack.load);

  // Recompute lastDropCoords based on last load in week
  const last = wk.loads[wk.loads.length - 1];
  if (last?.coords?.end?.lat && last?.coords?.end?.lon) wk.lastDropCoords = { lat:last.coords.end.lat, lon:last.coords.end.lon };
  else wk.lastDropCoords = null;

  saveState();
  ui.lastDelete = null;
  hideToast();
  updateUI();
  initMap(true);
}

function showToast(msg){
  document.getElementById("toastMsg").textContent = msg;
  document.getElementById("toast").style.display = "flex";
}
function hideToast(){
  document.getElementById("toast").style.display = "none";
}

/* =========================================================
   MODALS (DETAIL + EDIT)
========================================================= */
function closeAllModals(){
  document.getElementById("overlay").style.display = "none";
  document.getElementById("detailModal").style.display = "none";
  document.getElementById("editModal").style.display = "none";
  ui.editing = null;
}

function viewDetail(id){
  const wk = getCurrentWeek();
  const idx = getLoadIndexById(wk, id);
  const l = wk.loads[idx];
  if (!l) return;

  const splitUsed = Number.isFinite(Number(l.details?.split)) ? Number(l.details.split) : getDriverSplit(getDriver());
  const miLoad = Number(l.details?.mi_load) || 0;
  const miDh = Number(l.details?.mi_dh) || 0;

  document.getElementById("detailBody").innerHTML = `
    <div class="kv"><div class="k">Route</div><div class="v">${escapeHtml(l.origin)} ‚Üí ${escapeHtml(l.dest)}</div></div>
    <div class="kv"><div class="k">Created</div><div class="v">${escapeHtml(new Date(l.createdAt).toLocaleString())}</div></div>
    <div class="kv"><div class="k">Gross</div><div class="v">${money(l.gross)}</div></div>
    <div class="kv"><div class="k">Split used</div><div class="v">${(splitUsed*100).toFixed(0)}%</div></div>
    <div class="kv"><div class="k">Your cut</div><div class="v pos">${money(l.details?.cut || (l.gross*splitUsed))}</div></div>
    <div class="kv"><div class="k">Fuel</div><div class="v neg">-${money(l.details?.fuel || 0)}</div></div>
    <div class="kv"><div class="k">Fixed share</div><div class="v neg">-${money(l.details?.fixed || 0)}</div></div>
    <div class="kv"><div class="k">Maint</div><div class="v neg">-${money(l.details?.maint || 0)}</div></div>
    <div class="kv"><div class="k">Tolls</div><div class="v neg">-${money(l.details?.tolls || 0)}</div></div>
    <div class="kv"><div class="k">Miles</div><div class="v">${Number(l.miles||0).toLocaleString()} <span class="muted">(loaded ${miLoad.toLocaleString()} + dh ${miDh.toLocaleString()})</span></div></div>
    <div class="kv" style="border-bottom:none;font-size:18px;font-weight:1200;">
      <div class="k">Net profit</div>
      <div class="v ${(l.net||0)>=0 ? "pos" : "neg"}">${money(l.net)}</div>
    </div>
    <div class="muted" style="margin-top:10px;line-height:1.35;">
      Notes: <b>${escapeHtml(l.notes || "‚Äî")}</b><br/>
      Gross RPM: <b>${money(l.miles>0 ? l.gross/l.miles : 0)}</b>
    </div>
    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
      <button class="btn" onclick="openEdit('${l.id}')">Edit</button>
      <button class="btn danger" onclick="delLoad('${l.id}')">Delete</button>
    </div>
  `;

  document.getElementById("overlay").style.display = "block";
  document.getElementById("detailModal").style.display = "block";
}

function openEdit(id){
  const wk = getCurrentWeek();
  const idx = getLoadIndexById(wk, id);
  const l = wk.loads[idx];
  if (!l) return;

  ui.editing = { driverId: state.currentDriverId, weekId: getDriver().currentWeekId, loadId: id };

  document.getElementById("e_origin").value = l.origin || "";
  document.getElementById("e_dest").value = l.dest || "";
  document.getElementById("e_notes").value = l.notes || "";

  // Prefer decomposed miles
  const miLoad = Number.isFinite(Number(l.details?.mi_load)) ? Number(l.details.mi_load) : (Number(l.miles)||0);
  const miDh = Number.isFinite(Number(l.details?.mi_dh)) ? Number(l.details.mi_dh) : 0;
  document.getElementById("e_mi_load").value = miLoad;
  document.getElementById("e_mi_dh").value = miDh;

  document.getElementById("e_tolls").value = Number(l.details?.tolls || 0);
  document.getElementById("e_gross").value = Number(l.gross || 0);

  document.getElementById("e_reroute").checked = false;
  document.getElementById("e_regeocode").checked = false;

  // Live preview for edit
  ["e_origin","e_dest","e_notes","e_mi_load","e_mi_dh","e_tolls","e_gross","e_reroute","e_regeocode"].forEach(id2 => {
    const el = document.getElementById(id2);
    el.oninput = updateEditPreview;
    el.onchange = updateEditPreview;
  });
  updateEditPreview();

  document.getElementById("overlay").style.display = "block";
  document.getElementById("editModal").style.display = "block";
  document.getElementById("detailModal").style.display = "none";
}

function updateEditPreview(){
  const wk = getCurrentWeek();
  const e = ui.editing;
  if (!e) return;

  const idx = getLoadIndexById(wk, e.loadId);
  const base = wk.loads[idx];
  if (!base) return;

  // Compute using BASE load's stored rates (preserve historical behavior)
  const miLoad = parseFloat(document.getElementById("e_mi_load").value) || 0;
  const miDh = parseFloat(document.getElementById("e_mi_dh").value) || 0;
  const miles = miLoad + miDh;
  const gross = parseFloat(document.getElementById("e_gross").value) || 0;
  const tolls = parseFloat(document.getElementById("e_tolls").value) || 0;

  const split = Number(base.details?.split) || getDriverSplit(getDriver());
  const mpg = Number(base.details?.mpg) || getSpecs().mpg;
  const fuelPrice = Number(base.details?.fuelPrice) || getSpecs().fuel;
  const maintRate = Number(base.details?.maintRate) || getSpecs().maint;
  const loadsPerWeek = Math.max(1, Number(base.details?.loadsPerWeek) || getSpecs().loadsPerWeek);
  const fixed = getSpecs().fixedWeekly / loadsPerWeek;

  const fuel = (miles / mpg) * fuelPrice;
  const maint = miles * maintRate;
  const cut = gross * split;
  const net = cut - fuel - maint - fixed - tolls;

  const el = document.getElementById("e_preview");
  el.textContent = `Net (recalc): ${money(net)}`;
  el.style.borderColor = (net >= 0) ? "rgba(34,197,94,.45)" : "rgba(239,68,68,.45)";
}

async function saveEdit(){
  const e = ui.editing;
  if (!e) return;

  const d = state.drivers[e.driverId];
  const wk = d?.weeks?.[e.weekId];
  if (!wk) return;

  const idx = getLoadIndexById(wk, e.loadId);
  const l = wk.loads[idx];
  if (!l) return;

  const newOrigin = document.getElementById("e_origin").value.trim();
  const newDest = document.getElementById("e_dest").value.trim();
  const newNotes = document.getElementById("e_notes").value.trim();

  const miLoad = parseFloat(document.getElementById("e_mi_load").value) || 0;
  const miDh = parseFloat(document.getElementById("e_mi_dh").value) || 0;
  const miles = miLoad + miDh;

  const gross = parseFloat(document.getElementById("e_gross").value) || 0;
  const tolls = parseFloat(document.getElementById("e_tolls").value) || 0;

  if (!newOrigin || !newDest) return alert("Pickup and drop are required.");
  if (gross <= 0 || miles <= 0) return alert("Enter gross and miles.");

  const doReroute = document.getElementById("e_reroute").checked;
  const doRegeocode = document.getElementById("e_regeocode").checked;

  try{
    if (doReroute){
      setStatus("Re-routing (throttled)‚Ä¶", true);

      let oLat, oLon, dLat, dLon;
      if (!doRegeocode && l.coords?.start?.lat && l.coords?.end?.lat){
        oLat = l.coords.start.lat; oLon = l.coords.start.lon;
        dLat = l.coords.end.lat;   dLon = l.coords.end.lon;
      } else {
        const locA = await getLoc(newOrigin);
        const locB = await getLoc(newDest);
        if (!locA || !locB) throw new Error("Geocode failed (check spelling).");

        oLat = Number(locA.lat); oLon = Number(locA.lon);
        dLat = Number(locB.lat); dLon = Number(locB.lon);
      }

      const r = await osrmRouteMilesGeo(oLon,oLat,dLon,dLat);

      // Update only loaded portion + geometry
      l.details.mi_load = r.miles;
      l.details.mi_dh = miDh; // keep dh as user-specified
      l.miles = r.miles + miDh;

      l.coords = { start:{lat:oLat, lon:oLon}, end:{lat:dLat, lon:dLon} };
      l.routeGeo = r.geo || null;

      setStatus("", false);
    } else {
      l.details.mi_load = miLoad;
      l.details.mi_dh = miDh;
      l.miles = miles;
    }

    // Update core fields
    l.origin = newOrigin;
    l.dest = newDest;
    l.notes = newNotes;
    l.gross = gross;
    l.details.tolls = tolls;

    // Recalculate net using stored rates/split
    calcLoadNetUsingDetails(l);

    saveState();
    updateUI();
    initMap(true);
    closeAllModals();

  } catch(err){
    console.error(err);
    setStatus("Edit save failed (try again).", true);
    setTimeout(()=>setStatus("", false), 3500);
  }
}

function deleteLoadFromEdit(){
  const e = ui.editing;
  if (!e) return;
  const wk = getCurrentWeek();
  const idx = getLoadIndexById(wk, e.loadId);
  if (idx < 0) return;
  if (!confirm("Delete this load?")) return;
  closeAllModals();
  delLoadByIndex(idx);
}

/* =========================================================
   MAP (LEAFLET) + LAYER MANAGEMENT
========================================================= */
let map = null;
let baseLayer = null;
let markersGroup = null;
let loadedGroup = null;
let deadheadGroup = null;
let byLoadLine = new Map();   // loadId -> { loadedLine, dhLine }

function initMap(forceInvalidate=false){
  if (!map){
    map = L.map("map", { zoomControl: true }).setView([39.82,-98.58], 4);

    // CARTO Dark Matter tiles (keep same aesthetic, but with correct attribution text)
    baseLayer = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{
      maxZoom: 19,
      attribution: 'Map tiles by CARTO, under CC BY 3.0. Data by OpenStreetMap, under ODbL.'
    }).addTo(map);

    markersGroup = L.featureGroup().addTo(map);
    loadedGroup = L.featureGroup().addTo(map);
    deadheadGroup = L.featureGroup().addTo(map);

    // Optional layer control
    L.control.layers(
      { "Dark Matter": baseLayer },
      { "Markers": markersGroup, "Loaded routes": loadedGroup, "Deadhead": deadheadGroup },
      { collapsed: true }
    ).addTo(map);
  }

  // Clear feature groups
  markersGroup.clearLayers();
  loadedGroup.clearLayers();
  deadheadGroup.clearLayers();
  byLoadLine.clear();

  const wk = getCurrentWeek();
  const pts = [];

  (wk.loads || []).forEach((l, i) => {
    if (l.coords?.start?.lat && l.coords?.end?.lat){
      const s = l.coords.start, e = l.coords.end;
      const id = l.id;

      const m1 = L.marker([s.lat, s.lon]).bindPopup(`<b>Load ${i+1} Pickup</b><br>${escapeHtml(l.origin)}`);
      const m2 = L.marker([e.lat, e.lon]).bindPopup(`<b>Load ${i+1} Drop</b><br>${escapeHtml(l.dest)}`);
      markersGroup.addLayer(m1);
      markersGroup.addLayer(m2);

      pts.push([s.lat, s.lon], [e.lat, e.lon]);

      // Loaded route polyline
      let loadedLine;
      if (l.routeGeo?.coordinates?.length){
        const latlngs = l.routeGeo.coordinates.map(c=>[c[1], c[0]]);
        loadedLine = L.polyline(latlngs, { color: "#38bdf8", weight: 4, opacity: .75 });
      } else {
        loadedLine = L.polyline([[s.lat,s.lon],[e.lat,e.lon]], { color: "#38bdf8", weight: 4, opacity: .55, dashArray: "6 8" });
      }
      loadedLine.addTo(loadedGroup);

      // Optional deadhead geometry (stored when calcRoute computed it)
      let dhLine = null;
      if (l.dhGeo?.coordinates?.length){
        const latlngs = l.dhGeo.coordinates.map(c=>[c[1], c[0]]);
        dhLine = L.polyline(latlngs, { color: "#ff6a3d", weight: 3, opacity: .70, dashArray: "3 8" });
        dhLine.addTo(deadheadGroup);
      }

      byLoadLine.set(id, { loadedLine, dhLine });
    }
  });

  document.getElementById("mapCount").textContent = `${(wk.loads||[]).length} loads`;

  if (pts.length > 0) map.fitBounds(pts, { padding: [50,50] });
  if (forceInvalidate) setTimeout(()=>map.invalidateSize(), 60);
}

function highlightLoadOnMap(loadId, on){
  const pack = byLoadLine.get(loadId);
  if (!pack) return;

  const emphasize = (line) => {
    if (!line) return;
    line.setStyle({ weight: on ? 6 : 4, opacity: on ? .95 : .75 });
  };
  emphasize(pack.loadedLine);
  if (pack.dhLine){
    pack.dhLine.setStyle({ weight: on ? 5 : 3, opacity: on ? .90 : .70 });
  }
}

/* =========================================================
   ROUTING WORKFLOW (ENTRY)
========================================================= */
async function calcRoute(){
  const o = document.getElementById("origin").value;
  const d = document.getElementById("dest").value;
  if (!o || !d) return alert("Enter cities first");

  try{
    setStatus("Finding cities‚Ä¶ (throttled)", true);
    const locA = await getLoc(o);
    const locB = await getLoc(d);
    if (!locA || !locB){
      setStatus("City not found (check spelling)", true);
      setTimeout(()=>setStatus("", false), 3200);
      return;
    }

    const oLat = Number(locA.lat), oLon = Number(locA.lon);
    const dLat = Number(locB.lat), dLon = Number(locB.lon);

    const originEl = document.getElementById("origin");
    const destEl = document.getElementById("dest");
    originEl.dataset.lat = oLat;
    originEl.dataset.lon = oLon;
    destEl.dataset.lat = dLat;
    destEl.dataset.lon = dLon;

    setStatus("Calculating loaded route‚Ä¶ (throttled)", true);
    const loaded = await osrmRouteMilesGeo(oLon,oLat,dLon,dLat);
    document.getElementById("mi_load").value = loaded.miles;

    // Deadhead: from prior drop to this pickup (if exists)
    const wk = getCurrentWeek();
    if (wk.lastDropCoords?.lat && wk.lastDropCoords?.lon){
      setStatus("Calculating deadhead‚Ä¶ (throttled)", true);
      const dh = await osrmRouteMilesGeo(wk.lastDropCoords.lon, wk.lastDropCoords.lat, oLon, oLat);
      document.getElementById("mi_dh").value = dh.miles;

      // Store dh geometry temporarily for addLoad
      originEl.dataset.dhGeo = JSON.stringify(dh.geo || null);
    } else {
      document.getElementById("mi_dh").value = 0;
      originEl.dataset.dhGeo = JSON.stringify(null);
    }

    originEl.dataset.routeGeo = JSON.stringify(loaded.geo || null);

    setStatus("", false);
    preview();
  } catch(e){
    console.error(e);
    setStatus("Routing failed (try again in 30s)", true);
    setTimeout(()=>setStatus("", false), 3500);
  }
}

/* Tools */
function verifyMap(){
  const o = document.getElementById("origin").value;
  const d = document.getElementById("dest").value;
  if (o && d) window.open(`https://www.google.com/maps/dir/${encodeURIComponent(o)}/${encodeURIComponent(d)}`);
}
function checkTolls(){
  const o = document.getElementById("origin").value;
  const d = document.getElementById("dest").value;
  if (!o || !d) return;
  navigator.clipboard?.writeText?.(o + " to " + d).then(()=>{
    alert("Copied route. Paste into TollGuru.");
    window.open("https://tollguru.com/toll-calculator");
  }).catch(()=>{
    alert("Could not copy automatically. Open TollGuru and paste route manually.");
    window.open("https://tollguru.com/toll-calculator");
  });
}
function swapCities(){
  const o = document.getElementById("origin");
  const d = document.getElementById("dest");
  const tmp = o.value; o.value = d.value; d.value = tmp;
  preview();
}

/* =========================================================
   EXPORT / COPY / PRINT
========================================================= */
async function copySummary(){
  const d = getDriver();
  const wk = getCurrentWeek();
  const s = getSpecs();
  const t = computeWeekTotals(wk);
  const split = getDriverSplit(d);

  const summary =
`TAG DRIVER PRO ‚Äî WEEK SUMMARY
Driver: ${d.name}
Week: ${wk.label}
Split: ${(split*100).toFixed(0)}%
Loads: ${wk.loads.length}
Gross: ${money(t.gross)}
Miles: ${t.miles.toLocaleString()}
Net:   ${money(t.net)}
Gross RPM: ${money(t.miles>0 ? t.gross/t.miles : 0)}
Target: ${money(s.targetNet)} (${t.net>=s.targetNet ? "MET ‚úÖ" : "SHORT ‚ùå by " + money(s.targetNet - t.net)})`;

  try{
    if (!navigator.clipboard?.writeText) throw new Error("Clipboard unsupported");
    await navigator.clipboard.writeText(summary);
    alert("Weekly summary copied.");
  } catch(e){
    prompt("Copy this summary:", summary);
  }
}

function downloadsFile(filename, content, type="text/plain"){
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
}

function exportCSV(scope="week"){
  const d = getDriver();
  const wk = getCurrentWeek();

  const now = new Date();
  const yearStart = new Date(now.getFullYear(), 0, 1, 0,0,0,0);

  let rows = [];
  if (scope === "week"){
    rows = (wk.loads||[]).map(l => ({ driver: d.name, week: wk.label, ...flattenLoad(l) }));
  } else if (scope === "ytd"){
    // YTD for selected driver
    rows = [];
    for (const wkId of Object.keys(d.weeks||{})){
      const w = d.weeks[wkId];
      for (const l of (w.loads||[])){
        const dt = loadDateFallback(l, w);
        if (dt >= yearStart && dt <= now){
          rows.push({ driver: d.name, week: (w.label||wkId), ...flattenLoad(l) });
        }
      }
    }
  } else {
    return alert("Unknown CSV scope.");
  }

  const headers = Object.keys(rows[0] || {
    driver:"", week:"", createdAt:"", origin:"", dest:"", notes:"",
    miles:"", mi_load:"", mi_dh:"", gross:"", net:"",
    split:"", tolls:"", fuel:"", maint:"", fixed:"", rpm_gross:""
  });

  const csv = [
    headers.join(","),
    ...rows.map(r => headers.map(h => csvEscape(r[h])).join(","))
  ].join("\n");

  const fname = (scope === "week")
    ? `tagdriverpro_week_${safeFileDate(wk.start)}.csv`
    : `tagdriverpro_ytd_${safeFileDate(isoDate(now))}.csv`;

  downloadsFile(fname, csv, "text/csv");
}

function safeFileDate(s){
  return String(s||"").replace(/[^0-9\-]/g,"");
}
function csvEscape(v){
  const s = (v === null || v === undefined) ? "" : String(v);
  if (/[,"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}
function flattenLoad(l){
  const miles = Number(l.miles||0);
  const gross = Number(l.gross||0);
  const miLoad = Number(l.details?.mi_load||0);
  const miDh = Number(l.details?.mi_dh||0);
  return {
    createdAt: l.createdAt ? new Date(l.createdAt).toLocaleString() : "",
    origin: l.origin || "",
    dest: l.dest || "",
    notes: l.notes || "",
    miles: miles,
    mi_load: miLoad,
    mi_dh: miDh,
    gross: gross,
    net: Number(l.net||0),
    split: Number(l.details?.split||0),
    tolls: Number(l.details?.tolls||0),
    fuel: Number(l.details?.fuel||0),
    maint: Number(l.details?.maint||0),
    fixed: Number(l.details?.fixed||0),
    rpm_gross: miles>0 ? (gross/miles).toFixed(4) : "0"
  };
}

function printWeeklySummary(){
  const d = getDriver();
  const wk = getCurrentWeek();

  const t = computeWeekTotals(wk);
  const s = getSpecs();
  const split = getDriverSplit(d);

  const html = `
    <h1>TAG DRIVER PRO ‚Äî Weekly Summary</h1>
    <div class="pCard">
      <div><b>Driver:</b> ${escapeHtml(d.name)}</div>
      <div><b>Week:</b> ${escapeHtml(wk.label)}</div>
      <div><b>Split:</b> ${(split*100).toFixed(0)}%</div>
    </div>

    <div class="pCard">
      <div class="pGrid">
        <div class="pStat"><b>Gross</b><div class="right">${money(t.gross)}</div></div>
        <div class="pStat"><b>Miles</b><div class="right">${t.miles.toLocaleString()}</div></div>
        <div class="pStat"><b>Net</b><div class="right">${money(t.net)}</div></div>
        <div class="pStat"><b>Gross RPM</b><div class="right">${money(t.rpm)}</div></div>
      </div>
      <div style="margin-top:10px;"><b>Goal:</b> ${money(s.targetNet)} ‚Ä¢ <b>Status:</b> ${t.net>=s.targetNet ? "MET" : "SHORT by " + money(s.targetNet - t.net)}</div>
    </div>

    <div class="pCard">
      <h2>Loads</h2>
      <table>
        <thead><tr><th>Date</th><th>Route</th><th>Miles</th><th>Gross</th><th>Net</th><th>Notes</th></tr></thead>
        <tbody>
          ${(wk.loads||[]).map(l => `
            <tr>
              <td>${escapeHtml(l.createdAt ? new Date(l.createdAt).toLocaleDateString() : "")}</td>
              <td>${escapeHtml(l.origin)} ‚Üí ${escapeHtml(l.dest)}</td>
              <td>${Number(l.miles||0).toLocaleString()}</td>
              <td>${money(l.gross)}</td>
              <td>${money(l.net)}</td>
              <td>${escapeHtml(l.notes||"")}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;

  document.getElementById("printArea").innerHTML = html;
  window.print();
}

function printDriverYTD(){
  const d = getDriver();
  const now = new Date();
  const yearStart = new Date(now.getFullYear(), 0, 1, 0,0,0,0);
  const s = getSpecs();
  const ytd = totalsForDriverInRange(d, yearStart, now);

  const html = `
    <h1>TAG DRIVER PRO ‚Äî Driver YTD Report</h1>
    <div class="pCard">
      <div><b>Driver:</b> ${escapeHtml(d.name)}</div>
      <div><b>As of:</b> ${escapeHtml(now.toLocaleString())}</div>
    </div>

    <div class="pCard">
      <div class="pGrid">
        <div class="pStat"><b>YTD Gross</b><div class="right">${money(ytd.gross)}</div></div>
        <div class="pStat"><b>YTD Miles</b><div class="right">${ytd.miles.toLocaleString()}</div></div>
        <div class="pStat"><b>YTD Net</b><div class="right">${money(ytd.net)}</div></div>
        <div class="pStat"><b>Est. Tax</b><div class="right">${money(ytd.net * s.taxRate)}</div></div>
      </div>
      <div style="margin-top:10px;"><b>OER:</b> ${ytd.gross>0 ? Math.round(((ytd.gross - ytd.net)/ytd.gross)*100)+'%' : '0%'}</div>
    </div>
  `;

  document.getElementById("printArea").innerHTML = html;
  window.print();
}

/* =========================================================
   BACKUP / RESTORE (JSON)
========================================================= */
function buildBackup(){
  return {
    app: "tagdriverpro",
    version: "v3-modern",
    exportedAt: new Date().toISOString(),
    state,
    settings
  };
}

function downloadBackup(){
  const json = JSON.stringify(buildBackup(), null, 2);
  downloadsFile(`tagdriverpro_backup_${safeFileDate(isoDate(new Date()))}.json`, json, "application/json");
}

async function copyBackupToClipboard(){
  const json = JSON.stringify(buildBackup(), null, 2);
  try{
    if (!navigator.clipboard?.writeText) throw new Error("Clipboard unsupported");
    await navigator.clipboard.writeText(json);
    alert("Backup JSON copied.");
  } catch(e){
    prompt("Copy backup JSON:", json);
  }
}

function validateBackup(obj){
  if (!obj || typeof obj !== "object") return false;
  if (!obj.state || !obj.state.drivers) return false;
  return true;
}

function importBackup(mode="merge"){
  const file = document.getElementById("backupFile").files?.[0];
  if (!file) return alert("Choose a backup JSON file first.");

  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(String(reader.result || ""));
      if (!validateBackup(obj)) return alert("Invalid backup JSON.");

      if (mode === "replace"){
        if (!confirm("Replace ALL local data with this backup?")) return;

        state = migrateState(obj.state);
        settings = { ...defaultSettings, ...(obj.settings || {}) };
        persistSettings(settings);
        localStorage.setItem(STORE_KEY, JSON.stringify(state));
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      } else {
        // Merge: import drivers by ID; if conflict, suffix
        const incoming = migrateState(obj.state);
        for (const [did, drv] of Object.entries(incoming.drivers || {})){
          let targetId = did;
          while (state.drivers[targetId]){
            targetId = did + "_i" + Math.floor(Math.random()*9999);
          }
          state.drivers[targetId] = drv;
        }
        // Keep current driver; save
        saveState();
      }

      // Rebind UI
      settings = loadSettings();
      bindSettingsToInputs();
      document.body.dataset.theme = settings.ui_theme;
      enqueueNet = createRateLimitedQueue(settings.network_min_interval_ms);

      renderDriverSelect();
      renderWeekSelect();
      bindDriverOverridesToInputs();
      updateUI();
      initMap(true);

      alert("Import complete.");
    } catch(e){
      console.error(e);
      alert("Import failed: invalid JSON or corrupted backup.");
    }
  };
  reader.readAsText(file);
}

/* =========================================================
   FLEET + COMPANY CUT TABLES
========================================================= */
function setCurrentDriverFromFleet(driverId){
  state.currentDriverId = driverId;
  saveState();
  renderDriverSelect();
  renderWeekSelect();
  bindDriverOverridesToInputs();
  updateUI();
  setTimeout(()=>initMap(true), 120);
}

function updateFleetTables(){
  const now = new Date();
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1, 0,0,0,0);
  const yearStart  = new Date(now.getFullYear(), 0, 1, 0,0,0,0);

  const fleetBody = document.getElementById("fleetTable");
  const cutBody   = document.getElementById("cutTable");

  let fleetRows = [];
  let cutRows = [];

  let fleetCutCW=0, fleetCutMTD=0, fleetCutYTD=0, fleetGrossYTD=0;

  for (const id of Object.keys(state.drivers)){
    const d = state.drivers[id];
    const split = getDriverSplit(d);

    const wk = d.weeks[d.currentWeekId] || { loads: [] };
    const cw = computeWeekTotals(wk);

    const mtd = totalsForDriverInRange(d, monthStart, now);
    const ytd = totalsForDriverInRange(d, yearStart, now);

    fleetRows.push(`
      <tr>
        <td style="font-weight:1100;">${escapeHtml(d.name)}</td>
        <td>${pct(split)}</td>

        <td>${money(cw.gross)}</td>
        <td>${money(cw.rpm)}</td>
        <td class="${cw.net>=0?'pos':'neg'}">${money(cw.net)}</td>

        <td>${money(mtd.gross)}</td>
        <td>${money(mtd.rpm)}</td>
        <td class="${mtd.net>=0?'pos':'neg'}">${money(mtd.net)}</td>

        <td>${money(ytd.gross)}</td>
        <td>${money(ytd.rpm)}</td>
        <td class="${ytd.net>=0?'pos':'neg'}">${money(ytd.net)}</td>

        <td><button class="miniBtn" onclick="setCurrentDriverFromFleet('${id}')">Open</button></td>
      </tr>
    `);

    const cwCut = cw.gross * (1 - split);
    cutRows.push(`
      <tr>
        <td style="font-weight:1100;">${escapeHtml(d.name)}</td>
        <td>${pct(split)}</td>
        <td>${money(cw.gross)}</td>
        <td>${money(cwCut)}</td>
        <td>${money(mtd.gross)}</td>
        <td>${money(mtd.companyCut)}</td>
        <td>${money(ytd.gross)}</td>
        <td>${money(ytd.companyCut)}</td>
      </tr>
    `);

    fleetCutCW += cwCut;
    fleetCutMTD += mtd.companyCut;
    fleetCutYTD += ytd.companyCut;
    fleetGrossYTD += ytd.gross;
  }

  fleetBody.innerHTML = fleetRows.join("") || `<tr><td colspan="12">No drivers found.</td></tr>`;
  cutBody.innerHTML = cutRows.join("") || `<tr><td colspan="8">No drivers found.</td></tr>`;

  document.getElementById("cut_cw").textContent = money(fleetCutCW);
  document.getElementById("cut_mtd").textContent = money(fleetCutMTD);
  document.getElementById("cut_ytd").textContent = money(fleetCutYTD);

  const weightedTake = fleetGrossYTD > 0 ? (fleetCutYTD / fleetGrossYTD) : 0;
  document.getElementById("cut_take").textContent = pct(weightedTake);
}

/* =========================================================
   UI RENDER (TABLE SEARCH/SORT/FILTER + MAP HOVER)
========================================================= */
function updateUI(){
  const d = getDriver();
  const wk = getCurrentWeek();
  const loads = wk.loads || [];
  const s = getSpecs();
  const totals = computeWeekTotals(wk);

  document.getElementById("wk_gross").textContent = money(totals.gross);
  document.getElementById("wk_miles").textContent = totals.miles.toLocaleString();

  const wkProfitEl = document.getElementById("wk_profit");
  wkProfitEl.textContent = money(totals.net);
  wkProfitEl.className = "v " + (totals.net>=0 ? "pos" : "neg");

  document.getElementById("wk_rpm").textContent = money(totals.rpm);

  const split = getDriverSplit(d);
  const wkCosts = (totals.gross * split) - totals.net;
  const wkBreakEvenGross = split>0 ? (wkCosts / split) : 0;
  const wkBERpm = totals.miles>0 ? (wkBreakEvenGross / totals.miles) : 0;
  document.getElementById("wk_be_rpm").textContent = money(wkBERpm);

  // Table search/sort/filter
  const search = (document.getElementById("loadSearch")?.value || "").trim().toLowerCase();
  const sort = (document.getElementById("loadSort")?.value || "date_desc");
  const filter = (document.getElementById("loadFilter")?.value || "all");

  let visible = loads.slice();

  if (search){
    visible = visible.filter(l => {
      const hay = `${l.origin||""} ${l.dest||""} ${l.notes||""}`.toLowerCase();
      return hay.includes(search);
    });
  }

  if (filter === "profit") visible = visible.filter(l => (Number(l.net)||0) >= 0);
  if (filter === "loss") visible = visible.filter(l => (Number(l.net)||0) < 0);

  visible.sort((a,b) => {
    if (sort === "net_desc") return (Number(b.net)||0) - (Number(a.net)||0);
    if (sort === "gross_desc") return (Number(b.gross)||0) - (Number(a.gross)||0);
    if (sort === "miles_desc") return (Number(b.miles)||0) - (Number(a.miles)||0);
    if (sort === "rpm_desc"){
      const ar = (Number(a.miles)||0) > 0 ? (Number(a.gross)||0)/(Number(a.miles)||0) : 0;
      const br = (Number(b.miles)||0) > 0 ? (Number(b.gross)||0)/(Number(b.miles)||0) : 0;
      return br - ar;
    }
    // date desc
    return new Date(b.createdAt||0) - new Date(a.createdAt||0);
  });

  document.getElementById("tableSummary").textContent =
    `${visible.length} shown ‚Ä¢ ${loads.length} total`;

  document.getElementById("loadList").innerHTML = visible.map(l => {
    const grossRpm = (Number(l.miles)||0) > 0 ? (Number(l.gross)||0) / (Number(l.miles)||0) : 0;
    return `
      <tr data-id="${l.id}">
        <td style="font-weight:1100;">
          ${escapeHtml(l.origin)} <span class="routeArrow">‚ûú</span> ${escapeHtml(l.dest)}
          <div class="muted" style="margin-top:4px;font-size:12px;">
            ${escapeHtml(l.createdAt ? new Date(l.createdAt).toLocaleString() : "")}
          </div>
        </td>
        <td>${Number(l.miles||0).toLocaleString()}</td>
        <td>${money(l.gross)}</td>
        <td class="${(l.net||0)>=0?'pos':'neg'}">${money(l.net)}</td>
        <td>${money(grossRpm)}</td>
        <td class="muted">${escapeHtml((l.notes||"").slice(0, 70))}${(l.notes||"").length>70 ? "‚Ä¶" : ""}</td>
        <td>
          <div class="actions">
            <button class="miniBtn" onclick="viewDetail('${l.id}')">Detail</button>
            <button class="miniBtn" onclick="openEdit('${l.id}')">Edit</button>
            <button class="miniBtn danger" onclick="delLoad('${l.id}')">X</button>
          </div>
        </td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="7" class="muted" style="padding:20px;">No loads in this view.</td></tr>`;

  // Selected driver YTD
  const now = new Date();
  const yearStart  = new Date(now.getFullYear(), 0, 1, 0,0,0,0);
  const ytd = totalsForDriverInRange(d, yearStart, now);

  document.getElementById("ytd_gross").textContent = money(ytd.gross);
  document.getElementById("ytd_profit").textContent = money(ytd.net);
  document.getElementById("ytd_tax").textContent = money(ytd.net * s.taxRate);
  document.getElementById("oer_val").textContent = ytd.gross>0 ? Math.round(((ytd.gross - ytd.net)/ytd.gross)*100)+'%' : '0%';
  document.getElementById("ytd_fuel").textContent = money(ytd.fuel);
  document.getElementById("ytd_maint").textContent = money(ytd.maint);

  // Best/Worst week net
  let best=null, worst=null;
  for (const wkId of Object.keys(d.weeks||{})){
    const t = computeWeekTotals(d.weeks[wkId]);
    if (!best || t.net > best.net) best = { net: t.net };
    if (!worst || t.net < worst.net) worst = { net: t.net };
  }
  document.getElementById("best_week").textContent = money(best?.net || 0);
  document.getElementById("worst_week").textContent = money(worst?.net || 0);

  // Week history
  const weekIds = Object.keys(d.weeks).sort().reverse();
  document.getElementById("weekHistory").innerHTML = weekIds.map(id => {
    const w = d.weeks[id];
    const t = computeWeekTotals(w);
    const rpm = t.miles>0 ? (t.gross/t.miles) : 0;
    return `
      <tr>
        <td style="font-weight:1100;">${escapeHtml(w.label || id)}</td>
        <td>${(w.loads||[]).length}</td>
        <td>${t.miles.toLocaleString()}</td>
        <td>${money(t.gross)}</td>
        <td class="${t.net>=0?'pos':'neg'}">${money(t.net)}</td>
        <td>${money(rpm)}</td>
      </tr>
    `;
  }).join("");

  updateWarnBanner();
  preview();

  renderDriverSelect();
  renderWeekSelect();
  bindDriverOverridesToInputs();
  updateFleetTables();
}

document.getElementById("loadList").addEventListener("mouseover", (e) => {
  const tr = e.target.closest("tr[data-id]");
  if (!tr) return;
  highlightLoadOnMap(tr.dataset.id, true);
});
document.getElementById("loadList").addEventListener("mouseout", (e) => {
  const tr = e.target.closest("tr[data-id]");
  if (!tr) return;
  highlightLoadOnMap(tr.dataset.id, false);
});

/* =========================================================
   THEME TOGGLE
========================================================= */
function toggleTheme(){
  const next = (settings.ui_theme === "graphite") ? "steel" : "graphite";
  settings.ui_theme = next;
  document.body.dataset.theme = next;
  persistSettings(settings);
  document.getElementById("ui_theme").value = next;
}

/* =========================================================
   FACTORY RESET
========================================================= */
function factoryReset(){
  if (!confirm("Factory reset clears ALL drivers + weeks + loads + settings on this device. Continue?")) return;
  localStorage.removeItem(STORE_KEY);
  localStorage.removeItem(SETTINGS_KEY);
  localStorage.removeItem(GEO_CACHE_KEY);
  location.reload();
}

/* =========================================================
   INIT
========================================================= */
function ensureCurrentDriverHasThisWeek(){
  const d = getDriver();
  const wk = startOfWeekMonday(new Date());
  const baseId = isoDate(wk);
  if (!d.weeks[baseId]){
    d.weeks[baseId] = { start: baseId, label: fmtWeekLabel(wk), loads: [], lastDropCoords: null };
    saveState();
  }
}
function wireEntryKeyNav(){
  const ids = ["origin","dest","mi_load","mi_dh","cost_tolls","pay_gross","notes"];
  ids.forEach((id, idx)=>{
    const el = document.getElementById(id);
    el.addEventListener("keydown",(e)=>{
      if (e.key === "Enter" && id !== "notes"){
        e.preventDefault();
        const next = document.getElementById(ids[idx+1] || "pay_gross");
        if (next) next.focus();
      }
    });
    el.addEventListener("input", preview);
  });
}

/* Run init now */
(function boot(){
  // Apply theme
  document.body.dataset.theme = settings.ui_theme;

  ensureCurrentDriverHasThisWeek();
  bindSettingsToInputs();
  wireEntryKeyNav();

  renderDriverSelect();
  renderWeekSelect();
  bindDriverOverridesToInputs();
  updateUI();

  setTimeout(()=>initMap(true), 420);
})();
</script>
</body>
</html>
