<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
<title>Dispatch Command Center</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg-primary: #0a0e17;
  --bg-secondary: #131820;
  --bg-elevated: #1a2029;
  --chrome-light: #e8eef5;
  --chrome-dark: #8b97a8;
  --chrome-accent: #c5d0df;
  --accent-blue: #00b4ff;
  --accent-cyan: #00e5ff;
  --success: #00ff88;
  --warning: #ffb800;
  --danger: #ff3366;
  --border-subtle: rgba(200,210,220,0.08);
  --border-medium: rgba(200,210,220,0.15);
  --glow-blue: rgba(0,180,255,0.4);
  --glow-cyan: rgba(0,229,255,0.3);
  --text-primary: #f0f4f8;
  --text-secondary: #a8b5c7;
  --text-muted: #6b7a8f;
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
  --shadow-glow: 0 0 20px var(--glow-blue);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Rajdhani', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  overflow-x: hidden;
  position: relative;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    radial-gradient(circle at 20% 30%, rgba(0,180,255,0.03) 0%, transparent 50%),
    radial-gradient(circle at 80% 70%, rgba(0,229,255,0.03) 0%, transparent 50%),
    repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,0.01) 2px, rgba(255,255,255,0.01) 4px);
  pointer-events: none;
  z-index: 0;
}

.container {
  max-width: 1600px;
  margin: 0 auto;
  padding: 20px;
  position: relative;
  z-index: 1;
}

/* ========== HEADER ========== */
.main-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 20px;
  margin-bottom: 30px;
  padding: 25px 30px;
  background: linear-gradient(135deg, var(--bg-elevated) 0%, var(--bg-secondary) 100%);
  border: 1px solid var(--border-medium);
  border-radius: 16px;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
  animation: slideDown 0.6s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.main-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, 
    transparent 0%, 
    var(--accent-blue) 30%, 
    var(--accent-cyan) 70%, 
    transparent 100%);
  opacity: 0.6;
}

.brand-logo {
  display: flex;
  align-items: center;
  gap: 15px;
}

.shield-icon {
  width: 50px;
  height: 50px;
  background: linear-gradient(135deg, var(--chrome-light) 0%, var(--chrome-dark) 100%);
  clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  box-shadow: 0 4px 12px rgba(0,180,255,0.3);
  animation: pulse 3s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% {
    box-shadow: 0 4px 12px rgba(0,180,255,0.3);
  }
  50% {
    box-shadow: 0 4px 20px rgba(0,229,255,0.5);
  }
}

.shield-icon::after {
  content: '';
  position: absolute;
  width: 70%;
  height: 70%;
  background: var(--bg-elevated);
  clip-path: polygon(50% 5%, 95% 27%, 95% 73%, 50% 95%, 5% 73%, 5% 27%);
}

.brand-text {
  display: flex;
  flex-direction: column;
}

.brand-main {
  font-family: 'Orbitron', sans-serif;
  font-size: 28px;
  font-weight: 900;
  letter-spacing: 2px;
  background: linear-gradient(135deg, var(--chrome-light) 0%, var(--accent-cyan) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-shadow: 0 0 30px rgba(0,229,255,0.3);
}

.brand-sub {
  font-size: 11px;
  letter-spacing: 3px;
  color: var(--text-muted);
  font-weight: 600;
  text-transform: uppercase;
}

.header-controls {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
}

.driver-selector, .week-selector {
  display: flex;
  flex-direction: column;
  gap: 6px;
  min-width: 200px;
}

.selector-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-muted);
  font-weight: 700;
}

select {
  background: var(--bg-primary);
  border: 1px solid var(--border-medium);
  color: var(--text-primary);
  padding: 12px 16px;
  border-radius: 10px;
  font-family: 'Rajdhani', sans-serif;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: var(--shadow-sm);
}

select:hover {
  border-color: var(--accent-blue);
  box-shadow: 0 0 15px var(--glow-blue);
}

select:focus {
  outline: none;
  border-color: var(--accent-cyan);
  box-shadow: 0 0 20px var(--glow-cyan);
}

.btn-icon {
  background: var(--bg-primary);
  border: 1px solid var(--border-medium);
  color: var(--text-primary);
  padding: 12px 18px;
  border-radius: 10px;
  font-family: 'Rajdhani', sans-serif;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
}

.btn-icon:hover {
  border-color: var(--accent-blue);
  background: linear-gradient(135deg, var(--bg-elevated), var(--bg-secondary));
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,180,255,0.3);
}

.btn-icon.danger {
  border-color: rgba(255,51,102,0.3);
  color: var(--danger);
}

.btn-icon.danger:hover {
  border-color: var(--danger);
  box-shadow: 0 4px 12px rgba(255,51,102,0.3);
}

.status-pill {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  background: rgba(0,180,255,0.1);
  border: 1px solid rgba(0,180,255,0.3);
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--accent-cyan);
}

.status-pill::before {
  content: '';
  width: 6px;
  height: 6px;
  background: var(--accent-cyan);
  border-radius: 50%;
  box-shadow: 0 0 8px var(--accent-cyan);
  animation: blink 2s ease-in-out infinite;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

/* ========== WARNING BANNER ========== */
.warn-banner {
  display: none;
  margin-bottom: 20px;
  padding: 16px 20px;
  background: linear-gradient(135deg, rgba(255,184,0,0.1) 0%, rgba(255,51,102,0.1) 100%);
  border: 1px solid rgba(255,184,0,0.3);
  border-left: 4px solid var(--warning);
  border-radius: 12px;
  font-weight: 600;
  color: var(--text-primary);
  animation: slideDown 0.4s ease-out;
}

.warn-banner b {
  color: var(--warning);
}

/* ========== NAVIGATION ========== */
.main-nav {
  display: flex;
  gap: 8px;
  margin-bottom: 30px;
  padding: 8px;
  background: var(--bg-secondary);
  border-radius: 14px;
  border: 1px solid var(--border-subtle);
  box-shadow: var(--shadow-md);
  overflow-x: auto;
  animation: slideDown 0.7s ease-out;
}

.nav-tab {
  padding: 14px 24px;
  background: transparent;
  border: none;
  color: var(--text-secondary);
  font-family: 'Rajdhani', sans-serif;
  font-size: 14px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  cursor: pointer;
  border-radius: 10px;
  transition: all 0.3s ease;
  position: relative;
  white-space: nowrap;
}

.nav-tab::before {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  width: 0;
  height: 2px;
  background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
  transition: all 0.3s ease;
  transform: translateX(-50%);
}

.nav-tab:hover {
  color: var(--text-primary);
  background: rgba(255,255,255,0.05);
}

.nav-tab.active {
  background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-cyan) 100%);
  color: var(--bg-primary);
  box-shadow: 0 4px 16px rgba(0,180,255,0.4);
}

.tab-content {
  display: none;
  animation: fadeIn 0.5s ease-out;
}

.tab-content.active {
  display: block;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ========== STATS BAR ========== */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
  margin-bottom: 30px;
}

.stat-card {
  background: linear-gradient(135deg, var(--bg-elevated) 0%, var(--bg-secondary) 100%);
  border: 1px solid var(--border-medium);
  border-radius: 14px;
  padding: 20px;
  position: relative;
  overflow: hidden;
  box-shadow: var(--shadow-md);
  transition: all 0.3s ease;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
  opacity: 0;
  transition: opacity 0.3s ease;
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg), 0 0 20px var(--glow-blue);
  border-color: var(--accent-blue);
}

.stat-card:hover::before {
  opacity: 1;
}

.stat-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-muted);
  font-weight: 700;
  margin-bottom: 8px;
}

.stat-value {
  font-family: 'Orbitron', sans-serif;
  font-size: 32px;
  font-weight: 800;
  background: linear-gradient(135deg, var(--chrome-light) 0%, var(--chrome-accent) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.stat-value.positive {
  background: linear-gradient(135deg, var(--success) 0%, #00cc77 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.stat-value.negative {
  background: linear-gradient(135deg, var(--danger) 0%, #ff1a4d 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* Color classes for financial data */
.positive {
  color: var(--success) !important;
}

.negative {
  color: var(--danger) !important;
}

/* ========== CARDS ========== */
.card {
  background: linear-gradient(135deg, var(--bg-elevated) 0%, var(--bg-secondary) 100%);
  border: 1px solid var(--border-medium);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: var(--shadow-md);
  margin-bottom: 24px;
}

.card-header {
  background: linear-gradient(135deg, rgba(0,180,255,0.1) 0%, rgba(0,229,255,0.1) 100%);
  padding: 16px 24px;
  border-bottom: 1px solid var(--border-medium);
  font-family: 'Orbitron', sans-serif;
  font-size: 13px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--accent-cyan);
  display: flex;
  align-items: center;
  gap: 10px;
}

.card-header::before {
  content: '‚ñ∂';
  font-size: 10px;
  color: var(--accent-blue);
}

.card-body {
  padding: 24px;
}

/* ========== DASHBOARD GRID ========== */
.dash-grid {
  display: grid;
  grid-template-columns: 450px 1fr;
  gap: 24px;
  margin-bottom: 30px;
}

@media (max-width: 1200px) {
  .dash-grid {
    grid-template-columns: 1fr;
  }
}

/* ========== FORM INPUTS ========== */
.input-row {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
}

.input-group {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-muted);
  font-weight: 700;
}

input {
  width: 100%;
  background: var(--bg-primary);
  border: 1px solid var(--border-medium);
  color: var(--text-primary);
  padding: 12px 16px;
  border-radius: 10px;
  font-family: 'Rajdhani', sans-serif;
  font-size: 15px;
  font-weight: 600;
  transition: all 0.3s ease;
}

input:focus {
  outline: none;
  border-color: var(--accent-cyan);
  box-shadow: 0 0 15px var(--glow-cyan);
}

input::placeholder {
  color: var(--text-muted);
  opacity: 0.5;
}

/* ========== TOOL BUTTONS ========== */
.tool-buttons {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}

.btn-tool {
  background: rgba(0,180,255,0.1);
  border: 1px solid rgba(0,180,255,0.3);
  color: var(--accent-cyan);
  padding: 10px 16px;
  border-radius: 10px;
  font-family: 'Rajdhani', sans-serif;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.btn-tool:hover {
  background: rgba(0,180,255,0.2);
  border-color: var(--accent-cyan);
  box-shadow: 0 0 15px var(--glow-cyan);
  transform: translateY(-2px);
}

/* ========== PREVIEW BOX ========== */
.preview-box {
  background: var(--bg-primary);
  border: 1px solid var(--border-medium);
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  margin-bottom: 16px;
  position: relative;
  overflow: hidden;
}

.preview-box::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--accent-blue), transparent);
}

.preview-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-muted);
  font-weight: 700;
  margin-bottom: 8px;
}

.preview-value {
  font-family: 'Orbitron', sans-serif;
  font-size: 36px;
  font-weight: 800;
  background: linear-gradient(135deg, var(--chrome-light) 0%, var(--chrome-accent) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 8px;
}

.preview-hint {
  font-size: 12px;
  color: var(--text-secondary);
  font-weight: 500;
}

/* ========== PRIMARY BUTTON ========== */
.btn-primary {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-cyan) 100%);
  border: none;
  border-radius: 12px;
  color: var(--bg-primary);
  font-family: 'Rajdhani', sans-serif;
  font-size: 16px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 1px;
  cursor: pointer;
  box-shadow: 0 4px 16px rgba(0,180,255,0.4);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.btn-primary::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255,255,255,0.3);
  transition: width 0.4s, height 0.4s, top 0.4s, left 0.4s;
  transform: translate(-50%, -50%);
}

.btn-primary:hover::before {
  width: 300%;
  height: 300%;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 24px rgba(0,180,255,0.6);
}

.btn-primary:active {
  transform: translateY(0);
}

/* ========== MAP ========== */
#map, .dispatch-map {
  height: 520px;
  width: 100%;
  border-radius: 14px;
  border: 1px solid var(--border-medium);
  box-shadow: var(--shadow-lg);
  overflow: hidden;
}

/* ========== TABLE ========== */
.table-wrapper {
  overflow-x: auto;
  border-radius: 14px;
  border: 1px solid var(--border-medium);
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

thead {
  background: rgba(0,180,255,0.05);
  border-bottom: 2px solid var(--border-medium);
}

th {
  text-align: left;
  padding: 14px 16px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-muted);
  font-weight: 800;
}

tbody tr {
  border-bottom: 1px solid var(--border-subtle);
  transition: all 0.2s ease;
}

tbody tr:hover {
  background: rgba(0,180,255,0.05);
}

td {
  padding: 14px 16px;
  color: var(--text-secondary);
  font-weight: 500;
}

.action-btn {
  background: rgba(0,180,255,0.1);
  border: 1px solid rgba(0,180,255,0.3);
  color: var(--accent-cyan);
  padding: 6px 12px;
  border-radius: 8px;
  font-family: 'Rajdhani', sans-serif;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.action-btn:hover {
  background: rgba(0,180,255,0.2);
  border-color: var(--accent-cyan);
  box-shadow: 0 0 12px var(--glow-cyan);
}

.action-btn.delete {
  background: rgba(255,51,102,0.1);
  border-color: rgba(255,51,102,0.3);
  color: var(--danger);
}

.action-btn.delete:hover {
  background: rgba(255,51,102,0.2);
  border-color: var(--danger);
  box-shadow: 0 0 12px rgba(255,51,102,0.3);
}

/* ========== MODAL ========== */
#overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(4px);
  z-index: 998;
}

#modal {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: linear-gradient(135deg, var(--bg-elevated) 0%, var(--bg-secondary) 100%);
  border: 1px solid var(--accent-blue);
  box-shadow: 0 0 60px rgba(0,180,255,0.5), var(--shadow-lg);
  padding: 30px;
  border-radius: 16px;
  z-index: 999;
  width: 92%;
  max-width: 500px;
}

#modal h3 {
  font-family: 'Orbitron', sans-serif;
  font-size: 20px;
  font-weight: 800;
  margin-bottom: 20px;
  background: linear-gradient(135deg, var(--chrome-light) 0%, var(--accent-cyan) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.breakdown-row {
  display: flex;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid var(--border-subtle);
  font-size: 14px;
  font-weight: 600;
}

.breakdown-row span:first-child {
  color: var(--text-secondary);
}

.breakdown-row span:last-child {
  font-family: 'Orbitron', sans-serif;
  font-weight: 700;
}

.breakdown-row.total {
  border-top: 2px solid var(--accent-blue);
  border-bottom: none;
  margin-top: 10px;
  padding-top: 16px;
  font-size: 16px;
  font-weight: 800;
}

/* ========== DISPATCH VIEW ========== */
.driver-card {
  background: linear-gradient(135deg, var(--bg-elevated) 0%, var(--bg-secondary) 100%);
  border: 1px solid var(--border-medium);
  border-radius: 14px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-md);
  transition: all 0.3s ease;
}

.driver-card:hover {
  border-color: var(--accent-blue);
  box-shadow: var(--shadow-lg), 0 0 20px var(--glow-blue);
  transform: translateY(-2px);
}

.driver-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border-subtle);
}

.driver-name {
  font-family: 'Orbitron', sans-serif;
  font-size: 20px;
  font-weight: 800;
  background: linear-gradient(135deg, var(--chrome-light) 0%, var(--accent-cyan) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.driver-status {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.driver-status.active {
  background: rgba(0,255,136,0.15);
  border: 1px solid rgba(0,255,136,0.3);
  color: var(--success);
}

.driver-status.active::before {
  content: '';
  width: 6px;
  height: 6px;
  background: var(--success);
  border-radius: 50%;
  box-shadow: 0 0 8px var(--success);
}

.driver-metrics {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 12px;
  margin-bottom: 16px;
}

.driver-metric {
  background: var(--bg-primary);
  border: 1px solid var(--border-subtle);
  border-radius: 10px;
  padding: 12px;
}

.driver-metric-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  font-weight: 700;
  margin-bottom: 6px;
}

.driver-metric-value {
  font-family: 'Orbitron', sans-serif;
  font-size: 18px;
  font-weight: 800;
  color: var(--text-primary);
}

.current-route {
  background: rgba(0,180,255,0.05);
  border: 1px solid var(--border-medium);
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 12px;
}

.route-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  font-weight: 700;
  margin-bottom: 8px;
}

.route-display {
  font-size: 14px;
  font-weight: 700;
  color: var(--text-primary);
}

.route-arrow {
  color: var(--accent-cyan);
  margin: 0 8px;
}

.driver-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.dispatch-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
  gap: 24px;
}

@media (max-width: 768px) {
  .dispatch-grid {
    grid-template-columns: 1fr;
  }
}

/* ========== CHART CONTAINER ========== */
.chart-container {
  position: relative;
  height: 300px;
  margin: 20px 0;
}

/* ========== QUICK ACTIONS ========== */
.quick-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

/* ========== HINT TEXT ========== */
.hint-text {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 12px;
  font-weight: 500;
  line-height: 1.5;
}

/* ========== MOBILE STICKY ADD ========== */
.sticky-add {
  display: none;
  position: fixed;
  bottom: 16px;
  left: 16px;
  right: 16px;
  z-index: 997;
  background: linear-gradient(135deg, var(--bg-elevated) 0%, var(--bg-secondary) 100%);
  border: 1px solid var(--accent-blue);
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 8px 32px rgba(0,180,255,0.4), var(--shadow-lg);
}

.sticky-add-content {
  display: flex;
  gap: 16px;
  align-items: center;
  justify-content: space-between;
}

.sticky-preview {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.sticky-preview-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  font-weight: 700;
}

.sticky-preview-value {
  font-family: 'Orbitron', sans-serif;
  font-size: 24px;
  font-weight: 800;
}

@media (max-width: 1200px) {
  .sticky-add {
    display: block;
  }
  body {
    padding-bottom: 120px;
  }
}

/* ========== PRINT STYLES ========== */
#printArea {
  display: none;
}

@media print {
  nav, .no-print, .sticky-add, #status, .warn-banner {
    display: none !important;
  }
  body {
    background: #fff;
    color: #000;
  }
  body::before {
    display: none;
  }
  .container {
    max-width: none;
  }
  #map, .dispatch-map {
    display: none !important;
  }
  #printArea {
    display: block;
  }
  #printArea * {
    color: #000 !important;
  }
}

/* ========== LOADING SPINNER ========== */
.spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid var(--border-medium);
  border-top-color: var(--accent-cyan);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ========== RESPONSIVE ========== */
@media (max-width: 768px) {
  .main-header {
    flex-direction: column;
    align-items: stretch;
  }
  
  .header-controls {
    flex-direction: column;
  }
  
  .driver-selector, .week-selector {
    min-width: 100%;
  }
  
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .brand-main {
    font-size: 22px;
  }
}

/* Status message */
.status-msg {
  font-size: 12px;
  color: var(--warning);
  display: none;
  font-weight: 700;
  background: rgba(255,184,0,0.1);
  padding: 10px 16px;
  border-radius: 10px;
  border: 1px solid rgba(255,184,0,0.3);
}
</style>

<!-- Firebase SDK for Authentication & Cloud Storage -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// Firebase Configuration - YOUR PROJECT
const firebaseConfig = {
  apiKey: "AIzaSyCVhCWUXS-3I_HBfwPIaLufqgBAfMY75pc",
  authDomain: "dispatch-command-center-951c9.firebaseapp.com",
  projectId: "dispatch-command-center-951c9",
  storageBucket: "dispatch-command-center-951c9.firebasestorage.app",
  messagingSenderId: "673111932676",
  appId: "1:673111932676:web:9d7b1171a1a9f3dd11da51"
};

// Initialize Firebase
let app, auth, db, currentUser = null;
try {
  app = firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.firestore();
  console.log("‚úÖ Firebase initialized successfully");
} catch (error) {
  console.error("Firebase initialization error:", error);
}
</script>

<style>
/* Auth screen styles */
#authScreen {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  background: var(--bg-primary);
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 10000;
}
#authScreen.hidden { display: none; }
.auth-box {
  background: linear-gradient(135deg, var(--bg-elevated) 0%, var(--bg-secondary) 100%);
  border: 1px solid var(--border-medium);
  border-radius: 20px;
  padding: 50px 40px;
  max-width: 450px;
  width: 90%;
  box-shadow: var(--shadow-lg), 0 0 60px rgba(0,180,255,0.2);
}
.auth-shield {
  width: 80px;
  height: 80px;
  background: linear-gradient(135deg, var(--chrome-light) 0%, var(--chrome-dark) 100%);
  clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
  margin: 0 auto 20px;
  position: relative;
  box-shadow: 0 8px 24px rgba(0,180,255,0.4);
}
.auth-shield::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 70%;
  height: 70%;
  background: var(--bg-elevated);
  clip-path: polygon(50% 5%, 95% 27%, 95% 73%, 50% 95%, 5% 73%, 5% 27%);
}
.auth-title {
  text-align: center;
  font-family: 'Orbitron', sans-serif;
  font-size: 32px;
  font-weight: 900;
  letter-spacing: 2px;
  background: linear-gradient(135deg, var(--chrome-light) 0%, var(--accent-cyan) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 8px;
}
.auth-subtitle {
  text-align: center;
  font-size: 13px;
  letter-spacing: 2px;
  color: var(--text-muted);
  font-weight: 600;
  text-transform: uppercase;
  margin-bottom: 40px;
}
.auth-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 30px;
  background: var(--bg-primary);
  padding: 6px;
  border-radius: 12px;
}
.auth-tab {
  flex: 1;
  padding: 12px;
  background: transparent;
  border: none;
  color: var(--text-secondary);
  font-family: 'Rajdhani', sans-serif;
  font-size: 14px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  cursor: pointer;
  border-radius: 8px;
  transition: all 0.3s ease;
}
.auth-tab.active {
  background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-cyan) 100%);
  color: var(--bg-primary);
  box-shadow: 0 4px 12px rgba(0,180,255,0.4);
}
.auth-form {
  display: none;
}
.auth-form.active {
  display: block;
}
.form-group {
  margin-bottom: 20px;
}
.form-label {
  display: block;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-muted);
  font-weight: 700;
  margin-bottom: 8px;
}
.form-input {
  width: 100%;
  background: var(--bg-primary);
  border: 1px solid var(--border-medium);
  color: var(--text-primary);
  padding: 14px 16px;
  border-radius: 10px;
  font-family: 'Rajdhani', sans-serif;
  font-size: 15px;
  font-weight: 600;
  transition: all 0.3s ease;
}
.form-input:focus {
  outline: none;
  border-color: var(--accent-cyan);
  box-shadow: 0 0 15px var(--glow-cyan);
}
.auth-button {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-cyan) 100%);
  border: none;
  border-radius: 12px;
  color: var(--bg-primary);
  font-family: 'Rajdhani', sans-serif;
  font-size: 16px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 1px;
  cursor: pointer;
  box-shadow: 0 4px 16px rgba(0,180,255,0.4);
  transition: all 0.3s ease;
  margin-top: 10px;
}
.auth-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 24px rgba(0,180,255,0.6);
}
.auth-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.auth-error {
  background: rgba(255,51,102,0.1);
  border: 1px solid rgba(255,51,102,0.3);
  color: var(--danger);
  padding: 12px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  margin-top: 15px;
  display: none;
}
.auth-error.show {
  display: block;
}
.demo-note {
  background: rgba(0,180,255,0.1);
  border: 1px solid rgba(0,180,255,0.3);
  border-radius: 10px;
  padding: 15px;
  margin-top: 20px;
  font-size: 12px;
  line-height: 1.6;
  color: var(--text-secondary);
}
.demo-note strong {
  color: var(--accent-cyan);
  display: block;
  margin-bottom: 8px;
}
#appContent {
  display: none;
}
#appContent.show {
  display: block;
}
.user-badge {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  background: rgba(0,255,136,0.1);
  border: 1px solid rgba(0,255,136,0.3);
  border-radius: 10px;
  font-size: 12px;
  font-weight: 700;
  color: var(--success);
}
</style>
</head>
<body>

<!-- Authentication Screen -->
<div id="authScreen">
  <div class="auth-box">
    <div style="text-align: center;">
      <div class="auth-shield"></div>
      <div class="auth-title">DISPATCH</div>
      <div class="auth-subtitle">Command Center</div>
    </div>

    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')" id="loginTab">Login</button>
      <button class="auth-tab" onclick="switchAuthTab('signup')" id="signupTab">Sign Up</button>
    </div>

    <!-- Login Form -->
    <div id="loginForm" class="auth-form active">
      <div class="form-group">
        <label class="form-label">Email Address</label>
        <input type="email" class="form-input" id="loginEmail" placeholder="driver@dispatch.com" required>
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" class="form-input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
      </div>
      <button class="auth-button" onclick="handleLogin()" id="loginBtn">
        Login to Command Center
      </button>
      <div id="loginError" class="auth-error"></div>
    </div>

    <!-- Signup Form -->
    <div id="signupForm" class="auth-form">
      <div class="form-group">
        <label class="form-label">Email Address</label>
        <input type="email" class="form-input" id="signupEmail" placeholder="driver@dispatch.com" required>
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" class="form-input" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6" required>
      </div>
      <div class="form-group">
        <label class="form-label">Confirm Password</label>
        <input type="password" class="form-input" id="signupPasswordConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6" required>
      </div>
      <button class="auth-button" onclick="handleSignup()" id="signupBtn">
        Create Account
      </button>
      <div id="signupError" class="auth-error"></div>
    </div>

    <div class="demo-note">
      <strong>üîí Cloud Sync Enabled</strong>
      Your data will be securely stored in the cloud and accessible from any device. Create an account to get started!
    </div>
  </div>
</div>

<!-- App Content (hidden until logged in) -->
<div id="appContent">



<div id="overlay" onclick="closeModal()"></div>
<div id="modal" role="dialog" aria-modal="true" aria-label="Trip Financials">
  <h3>TRIP FINANCIALS</h3>
  <div id="modal-content"></div>
  <button class="btn-primary" onclick="closeModal()">Close</button>
</div>

<div id="printArea"></div>

<div class="container">
  <!-- HEADER -->
  <header class="main-header">
    <div class="brand-logo">
      <div class="shield-icon"></div>
      <div class="brand-text">
        <div class="brand-main">DISPATCH</div>
        <div class="brand-sub">Command Center</div>
      </div>
    </div>
    
    <div class="header-controls">
      <div class="driver-selector">
        <div class="selector-label">Active Driver</div>
        <select id="driverSelect" onchange="onDriverChange()"></select>
      </div>
      
      <button class="btn-icon" onclick="addDriver()">
        <span>‚ûï</span> Add Driver
      </button>
      
      <button class="btn-icon danger" onclick="removeDriver()">
        <span>üóëÔ∏è</span> Remove
      </button>
      
      <div class="week-selector">
        <div class="selector-label">Active Week</div>
        <select id="weekSelect" onchange="onWeekChange()"></select>
      </div>
      
      <button class="btn-icon" onclick="startNewWeek()">
        <span>‚ûï</span> New Week
      </button>
      
      <button class="btn-icon danger" onclick="resetCurrentWeek()">
        <span>üßπ</span> Clear Week
      </button>
      
      <div class="status-pill no-print">
        <span>Local Storage</span>
      </div>
    </div>
    
    <div id="status" class="status-msg">Processing...</div>
  </header>

  <div id="warn" class="warn-banner"></div>

  <!-- NAVIGATION -->
  <nav class="main-nav no-print">
    <button class="nav-tab" onclick="showTab('dispatch', this)">Dispatch View</button>
    <button class="nav-tab active" onclick="showTab('dashboard', this)">Dashboard</button>
    <button class="nav-tab" onclick="showTab('analytics', this)">Analytics</button>
    <button class="nav-tab" onclick="showTab('companycut', this)">Company Cut</button>
    <button class="nav-tab" onclick="showTab('settings', this)">Settings</button>
  </nav>

  <!-- DISPATCH VIEW TAB (NEW) -->
  <div id="dispatch" class="tab-content">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Fleet Drivers</div>
        <div class="stat-value" id="fleet_count">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Active Loads This Week</div>
        <div class="stat-value" id="fleet_loads">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Fleet Weekly Gross</div>
        <div class="stat-value positive" id="fleet_gross">$0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Fleet Weekly Net</div>
        <div class="stat-value positive" id="fleet_net">$0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Fleet Avg RPM</div>
        <div class="stat-value" id="fleet_rpm">$0.00</div>
      </div>
    </div>

    <!-- Combined Fleet Map -->
    <div class="card">
      <div class="card-header">Fleet Map - All Current Week Routes</div>
      <div class="card-body" style="padding: 0;">
        <div id="dispatchMap" class="dispatch-map"></div>
      </div>
    </div>

    <!-- Driver Cards -->
    <div class="dispatch-grid" id="driverCards"></div>
  </div>

  <!-- DASHBOARD TAB -->
  <div id="dashboard" class="tab-content active">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Weekly Gross</div>
        <div class="stat-value" id="wk_gross">$0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Weekly Miles</div>
        <div class="stat-value" id="wk_miles">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Net Profit</div>
        <div class="stat-value positive" id="wk_profit">$0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Avg RPM (Gross)</div>
        <div class="stat-value" id="wk_rpm">$0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Break-even RPM</div>
        <div class="stat-value" id="wk_be_rpm">$0.00</div>
      </div>
    </div>

    <div class="dash-grid">
      <div>
        <!-- NEW TRIP ENTRY -->
        <div class="card no-print">
          <div class="card-header">New Trip Entry</div>
          <div class="card-body">
            <div class="input-row">
              <div class="input-group">
                <label>Pickup Location</label>
                <input id="origin" placeholder="City, State" autocomplete="off" />
              </div>
              <div class="input-group">
                <label>Drop Location</label>
                <input id="dest" placeholder="City, State" autocomplete="off" />
              </div>
            </div>

            <div class="tool-buttons">
              <button class="btn-tool" onclick="calcRoute()">üì° Get Miles</button>
              <button class="btn-tool" onclick="verifyMap()">üó∫Ô∏è Verify</button>
              <button class="btn-tool" onclick="checkTolls()">üí∞ Tolls</button>
              <button class="btn-tool" onclick="swapCities()">üîÅ Swap</button>
            </div>

            <div class="input-row">
              <div class="input-group">
                <label>Loaded Miles</label>
                <input id="mi_load" type="number" inputmode="numeric" min="0" step="1" oninput="preview()">
              </div>
              <div class="input-group">
                <label>Deadhead Miles</label>
                <input id="mi_dh" type="number" inputmode="numeric" min="0" step="1" oninput="preview()">
              </div>
              <div class="input-group">
                <label>Tolls ($)</label>
                <input id="cost_tolls" type="number" inputmode="decimal" min="0" step="0.01" value="0" oninput="preview()">
              </div>
            </div>

            <div class="input-row">
              <div class="input-group">
                <label>Gross Pay ($)</label>
                <input id="pay_gross" type="number" inputmode="decimal" min="0" step="0.01" oninput="preview()">
              </div>
            </div>

            <div class="preview-box">
              <div class="preview-label">Trip Net Preview</div>
              <div class="preview-value" id="preview_net">$0.00</div>
              <div class="preview-hint" id="preview_hint"></div>
            </div>

            <button class="btn-primary" onclick="addLoad()">Add Load to Week</button>

            <div class="hint-text">
              Tip: Each driver can have their own split % configured in Settings ‚Üí Driver Overrides
            </div>
          </div>
        </div>

        <!-- QUICK ACTIONS -->
        <div class="card no-print">
          <div class="card-header">Quick Actions</div>
          <div class="card-body quick-actions">
            <button class="btn-icon" onclick="copySummary()">üìã Copy Summary</button>
            <button class="btn-icon" onclick="exportCSV('week')">‚¨áÔ∏è Export CSV</button>
            <button class="btn-icon" onclick="printWeeklySummary()">üñ®Ô∏è Print</button>
          </div>
        </div>
      </div>

      <div>
        <!-- MAP -->
        <div class="card">
          <div class="card-header">Weekly Route Map</div>
          <div class="card-body" style="padding: 0;">
            <div id="map"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- LOAD LOG TABLE -->
    <div class="card">
      <div class="card-header">Weekly Load Log</div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Route</th>
              <th>Miles</th>
              <th>Gross</th>
              <th>Net</th>
              <th>Gross RPM</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="loadList"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ANALYTICS TAB -->
  <div id="analytics" class="tab-content">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">YTD Gross</div>
        <div class="stat-value" id="ytd_gross">$0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">YTD Net Profit</div>
        <div class="stat-value positive" id="ytd_profit">$0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Est. Tax Liability</div>
        <div class="stat-value negative" id="ytd_tax">$0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Operating Expense Ratio</div>
        <div class="stat-value" id="oer_val">0%</div>
      </div>
    </div>

    <!-- WEEKLY TREND CHART -->
    <div class="card">
      <div class="card-header">Weekly Net Profit Trend</div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="weeklyChart"></canvas>
        </div>
      </div>
    </div>

    <!-- BUSINESS HEALTH -->
    <div class="card">
      <div class="card-header">Business Health</div>
      <div class="card-body">
        <div class="breakdown-row">
          <span>Total Fuel Spend (YTD):</span>
          <span id="ytd_fuel" class="negative">$0.00</span>
        </div>
        <div class="breakdown-row">
          <span>Total Maintenance Saved (YTD):</span>
          <span id="ytd_maint" class="positive">$0.00</span>
        </div>
        <div class="breakdown-row">
          <span>Best Week Net:</span>
          <span id="best_week" class="positive">$0.00</span>
        </div>
        <div class="breakdown-row">
          <span>Worst Week Net:</span>
          <span id="worst_week" class="negative">$0.00</span>
        </div>
      </div>
    </div>

    <!-- WEEK HISTORY -->
    <div class="card">
      <div class="card-header">Week History</div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Week</th>
              <th>Loads</th>
              <th>Miles</th>
              <th>Gross</th>
              <th>Net</th>
              <th>Gross RPM</th>
            </tr>
          </thead>
          <tbody id="weekHistory"></tbody>
        </table>
      </div>
    </div>

    <!-- FLEET OVERVIEW -->
    <div class="card">
      <div class="card-header">Fleet Overview</div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Driver</th>
              <th>Split</th>
              <th>CW Gross</th>
              <th>CW RPM</th>
              <th>CW Net</th>
              <th>MTD Gross</th>
              <th>MTD RPM</th>
              <th>MTD Net</th>
              <th>YTD Gross</th>
              <th>YTD RPM</th>
              <th>YTD Net</th>
              <th>Quick</th>
            </tr>
          </thead>
          <tbody id="fleetTable"></tbody>
        </table>
      </div>
      <div class="card-body">
        <div class="hint-text">
          MTD/YTD are based on each load's timestamp. CW = Current Week.
        </div>
      </div>
    </div>

    <div class="quick-actions no-print" style="margin-top: 20px;">
      <button class="btn-icon" onclick="exportCSV('ytd')">‚¨áÔ∏è Export YTD CSV</button>
      <button class="btn-icon" onclick="printDriverYTD()">üñ®Ô∏è Print YTD</button>
      <button class="btn-icon danger" onclick="factoryReset()">üî• Factory Reset</button>
    </div>
  </div>

  <!-- COMPANY CUT TAB -->
  <div id="companycut" class="tab-content">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Company Cut ‚Ä¢ Current Week</div>
        <div class="stat-value" id="cut_cw">$0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Company Cut ‚Ä¢ Month-to-Date</div>
        <div class="stat-value" id="cut_mtd">$0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Company Cut ‚Ä¢ Year-to-Date</div>
        <div class="stat-value" id="cut_ytd">$0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Avg Take Rate (Weighted)</div>
        <div class="stat-value" id="cut_take">0%</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Company Cut Breakdown</div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Driver</th>
              <th>Split</th>
              <th>CW Gross</th>
              <th>CW Company Cut</th>
              <th>MTD Gross</th>
              <th>MTD Company Cut</th>
              <th>YTD Gross</th>
              <th>YTD Company Cut</th>
            </tr>
          </thead>
          <tbody id="cutTable"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Notes</div>
      <div class="card-body">
        <div class="hint-text">
          "Company Cut" is calculated as <strong>Gross √ó (1 ‚àí Split)</strong>. Example: split 80% ‚Üí company cut 20%.<br/>
          If a load has a stored split, we use that. If not, we use that driver's split override; if none, we use the global default split in Settings.
        </div>
      </div>
    </div>
  </div>

  <!-- SETTINGS TAB -->
  <div id="settings" class="tab-content">
    <div class="dash-grid">
      <div>
        <div class="card">
          <div class="card-header">Fixed Weekly Costs</div>
          <div class="card-body">
            <div class="input-row">
              <div class="input-group">
                <label>Truck Payment</label>
                <input id="f_truck" type="number" inputmode="decimal" min="0" step="0.01">
              </div>
            </div>
            <div class="input-row">
              <div class="input-group">
                <label>Trailer Payment</label>
                <input id="f_trailer" type="number" inputmode="decimal" min="0" step="0.01">
              </div>
            </div>
            <div class="input-row">
              <div class="input-group">
                <label>Insurance</label>
                <input id="f_ins" type="number" inputmode="decimal" min="0" step="0.01">
              </div>
            </div>
            <div class="hint-text">
              Fixed costs are split across loads using "Loads per week" below.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">Variable Weekly Deductions</div>
          <div class="card-body">
            <div class="input-row">
              <div class="input-group">
                <label>Advances</label>
                <input id="f_adv" type="number" inputmode="decimal" min="0" step="0.01">
              </div>
            </div>
            <div class="input-row">
              <div class="input-group">
                <label>Food/Personal</label>
                <input id="f_food" type="number" inputmode="decimal" min="0" step="0.01">
              </div>
            </div>
            <div class="input-row">
              <div class="input-group">
                <label>Repairs (Actual)</label>
                <input id="f_rep" type="number" inputmode="decimal" min="0" step="0.01">
              </div>
            </div>
            <div class="hint-text">
              Tip: keep "Repairs" for true out-of-pocket repairs; maintenance savings is calculated per mile.
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="card">
          <div class="card-header">Global Defaults</div>
          <div class="card-body">
            <div class="input-row">
              <div class="input-group">
                <label>Default Split % (0.80)</label>
                <input id="s_split" type="number" inputmode="decimal" min="0" max="1" step="0.01">
              </div>
            </div>
            <div class="input-row">
              <div class="input-group">
                <label>Fuel Price ($/gal)</label>
                <input id="s_fuel" type="number" inputmode="decimal" min="0" step="0.01">
              </div>
            </div>
            <div class="input-row">
              <div class="input-group">
                <label>MPG</label>
                <input id="s_mpg" type="number" inputmode="decimal" min="0.1" step="0.1">
              </div>
            </div>
            <div class="input-row">
              <div class="input-group">
                <label>Maintenance ($/mi)</label>
                <input id="s_maint" type="number" inputmode="decimal" min="0" step="0.01">
              </div>
            </div>
            <div class="input-row">
              <div class="input-group">
                <label>Loads per Week</label>
                <input id="s_loads_per_week" type="number" inputmode="numeric" min="1" step="1">
              </div>
            </div>
            <div class="input-row">
              <div class="input-group">
                <label>Target Net / Week</label>
                <input id="s_target_net" type="number" inputmode="decimal" min="0" step="0.01">
              </div>
            </div>
            <div class="input-row">
              <div class="input-group">
                <label>Tax Rate (0.25)</label>
                <input id="s_tax" type="number" inputmode="decimal" min="0" max="1" step="0.01">
              </div>
            </div>
            <button class="btn-primary no-print" onclick="saveSettings()">Save Global Settings</button>
            <div class="hint-text">
              Global split is the default. You can override split per driver below.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">Driver Overrides (Selected Driver)</div>
          <div class="card-body">
            <div class="input-row">
              <div class="input-group">
                <label>Split % for this driver</label>
                <input id="d_split" type="number" inputmode="decimal" min="0" max="1" step="0.01" />
              </div>
            </div>
            <button class="btn-primary no-print" onclick="saveDriverOverrides()">Save Driver Override</button>
            <div class="hint-text">
              Example: 0.80 (80%), 0.88 (88%). This affects new loads + company cut analytics. Existing loads keep their saved split.
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="hint-text" style="margin-top: 20px;">
      Privacy: this tool stores data in your browser (local). Use "Factory Reset" if you're switching phones/devices.
    </div>
  </div>
</div>

<!-- MOBILE STICKY ADD -->
<div class="sticky-add no-print">
  <div class="sticky-add-content">
    <div class="sticky-preview">
      <div class="sticky-preview-label">Trip Preview</div>
      <div class="sticky-preview-value" id="sticky_preview">$0.00</div>
    </div>
    <button class="btn-icon" onclick="addLoad()">Add Load</button>
  </div>
</div>

<script>
/************************* 
 * STORAGE 
 *************************/
const STORE_KEY = "tagdriverpro_v3_state";
const SETTINGS_KEY = "tagdriverpro_v3_settings";
const GEO_CACHE_KEY = "tagdriverpro_v3_geo_cache";

const defaultSettings = {
  f_truck: 800,
  f_trailer: 400,
  f_ins: 350,
  f_adv: 0,
  f_food: 0,
  f_rep: 0,
  s_split: 0.80,
  s_fuel: 3.25,
  s_mpg: 6.5,
  s_maint: 0.17,
  s_loads_per_week: 5,
  s_target_net: 1500,
  s_tax: 0.25
};

function startOfWeekMonday(date = new Date()){
  const d = new Date(date);
  const day = d.getDay();
  const diff = (day === 0 ? -6 : 1 - day);
  d.setDate(d.getDate() + diff);
  d.setHours(0,0,0,0);
  return d;
}

function isoDate(d){
  const x = new Date(d);
  const yyyy = x.getFullYear();
  const mm = String(x.getMonth()+1).padStart(2,"0");
  const dd = String(x.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}

function fmtWeekLabel(dateObj){
  const d = new Date(dateObj);
  const m = d.toLocaleString(undefined, { month: "short" });
  return `Week of ${m} ${d.getDate()}, ${d.getFullYear()}`;
}

function nowStamp(){
  return new Date().toLocaleString();
}

function loadSettings(){
  const raw = localStorage.getItem(SETTINGS_KEY);
  const s = raw ? JSON.parse(raw) : {};
  return { ...defaultSettings, ...s };
}

function persistSettings(s){
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
}

function migrateOrCreateState(){
  const raw = localStorage.getItem(STORE_KEY);
  if (raw) return JSON.parse(raw);
  
  const wk = startOfWeekMonday(new Date());
  const baseId = isoDate(wk);
  const driverId = "driver_1";
  
  const state = {
    currentDriverId: driverId,
    drivers: {
      [driverId]: {
        name: "Driver 1",
        splitOverride: null,
        currentWeekId: baseId,
        weeks: {
          [baseId]: {
            start: baseId,
            label: fmtWeekLabel(wk),
            loads: [],
            lastDropCoords: null
          }
        }
      }
    }
  };
  
  localStorage.setItem(STORE_KEY, JSON.stringify(state));
  return state;
}

let state = migrateOrCreateState();
let settings = loadSettings();

/************************* 
 * BASIC HELPERS 
 *************************/
function saveState(){
  localStorage.setItem(STORE_KEY, JSON.stringify(state));
}

function money(v){
  const n = Number(v);
  const safe = Number.isFinite(n) ? n : 0;
  return "$" + safe.toLocaleString(undefined, { 
    minimumFractionDigits: 2, 
    maximumFractionDigits: 2 
  });
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}

function setStatus(msg, show=true){
  const el = document.getElementById("status");
  el.innerText = msg;
  el.style.display = show ? "block" : "none";
}

/************************* 
 * DRIVER/WEEK GETTERS 
 *************************/
function getDriver(){
  const id = state.currentDriverId;
  if (!state.drivers[id]) {
    const keys = Object.keys(state.drivers);
    state.currentDriverId = keys[0];
    saveState();
  }
  return state.drivers[state.currentDriverId];
}

function getCurrentWeek(){
  const d = getDriver();
  const wkId = d.currentWeekId;
  if (!d.weeks[wkId]) {
    const base = wkId.split("_")[0];
    const dt = new Date(base + "T00:00:00");
    d.weeks[wkId] = {
      start: base,
      label: fmtWeekLabel(dt),
      loads: [],
      lastDropCoords: null
    };
    saveState();
  }
  return d.weeks[d.currentWeekId];
}

function getDriverSplit(driver){
  const s = getSpecs();
  const ov = Number(driver?.splitOverride);
  if (Number.isFinite(ov) && ov > 0 && ov < 1.00001) return ov;
  return s.split;
}

/************************* 
 * NAV 
 *************************/
function showTab(id, btn){
  document.querySelectorAll('.tab-content').forEach(d=>d.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
  
  if (id === "dashboard") setTimeout(initMap, 200);
  if (id === "analytics") setTimeout(renderWeeklyChart, 200);
  if (id === "dispatch") setTimeout(()=>{ renderDispatchView(); initDispatchMap(); }, 200);
}

/************************* 
 * DRIVER MENU 
 *************************/
function renderDriverSelect(){
  const sel = document.getElementById("driverSelect");
  const ids = Object.keys(state.drivers);
  sel.innerHTML = ids.map(id => {
    const d = state.drivers[id];
    const selected = (id === state.currentDriverId) ? "selected" : "";
    return `<option value="${id}" ${selected}>${escapeHtml(d.name)}</option>`;
  }).join("");
}

function onDriverChange(){
  const sel = document.getElementById("driverSelect");
  state.currentDriverId = sel.value;
  saveState();
  renderWeekSelect();
  bindDriverOverridesToInputs();
  updateUI();
  setTimeout(initMap, 150);
}

function addDriver(){
  const name = prompt("Driver name (ex: John Smith):");
  if (!name) return;
  
  const wk = startOfWeekMonday(new Date());
  const baseId = isoDate(wk);
  const id = `driver_${Date.now()}`;
  
  state.drivers[id] = {
    name: name.trim(),
    splitOverride: null,
    currentWeekId: baseId,
    weeks: {
      [baseId]: {
        start: baseId,
        label: fmtWeekLabel(wk),
        loads: [],
        lastDropCoords: null
      }
    }
  };
  
  state.currentDriverId = id;
  saveState();
  renderDriverSelect();
  renderWeekSelect();
  bindDriverOverridesToInputs();
  updateUI();
  setTimeout(initMap, 150);
}

function removeDriver(){
  const d = getDriver();
  if (!confirm(`Remove driver "${d.name}" and all their data on THIS device?`)) return;
  
  const ids = Object.keys(state.drivers);
  if (ids.length <= 1) return alert("You must keep at least one driver.");
  
  delete state.drivers[state.currentDriverId];
  const remaining = Object.keys(state.drivers);
  state.currentDriverId = remaining[0];
  
  saveState();
  renderDriverSelect();
  renderWeekSelect();
  bindDriverOverridesToInputs();
  updateUI();
  setTimeout(initMap, 150);
}

/************************* 
 * WEEK MENU 
 *************************/
function renderWeekSelect(){
  const sel = document.getElementById("weekSelect");
  const d = getDriver();
  const ids = Object.keys(d.weeks).sort().reverse();
  sel.innerHTML = ids.map(id=>{
    const w = d.weeks[id];
    const selected = (id === d.currentWeekId) ? "selected" : "";
    return `<option value="${id}" ${selected}>${escapeHtml(w.label || id)}</option>`;
  }).join("");
}

function onWeekChange(){
  const sel = document.getElementById("weekSelect");
  const id = sel.value;
  const d = getDriver();
  if (!d.weeks[id]) return;
  
  d.currentWeekId = id;
  saveState();
  updateUI();
  setTimeout(initMap, 150);
}

function startNewWeek(){
  if (!confirm("Start a new week for this driver? Current week will remain saved.")) return;
  
  const d = getDriver();
  const base = startOfWeekMonday(new Date());
  const baseId = isoDate(base);
  let id = baseId;
  let counter = 1;
  
  while (d.weeks[id]) {
    counter++;
    id = baseId + "_v" + counter;
  }
  
  d.weeks[id] = {
    start: baseId,
    label: fmtWeekLabel(base) + (counter > 1 ? ` (${counter})` : ""),
    loads: [],
    lastDropCoords: null
  };
  
  d.currentWeekId = id;
  saveState();
  renderWeekSelect();
  updateUI();
  setTimeout(initMap, 150);
}

function resetCurrentWeek(){
  const wk = getCurrentWeek();
  if (!confirm("Clear all loads for this week?")) return;
  
  wk.loads = [];
  wk.lastDropCoords = null;
  saveState();
  updateUI();
  initMap();
}

/************************* 
 * SETTINGS 
 *************************/
function getSpecs(){
  const split = parseFloat(document.getElementById('s_split').value);
  const fuel = parseFloat(document.getElementById('s_fuel').value);
  const mpg = parseFloat(document.getElementById('s_mpg').value);
  const maint = parseFloat(document.getElementById('s_maint').value);
  const loadsPerWeek = Math.max(1, parseInt(document.getElementById('s_loads_per_week').value || "5", 10));
  const targetNet = parseFloat(document.getElementById('s_target_net').value);
  const taxRate = parseFloat(document.getElementById('s_tax').value);
  
  const fixedWeekly = ['f_truck','f_trailer','f_ins','f_adv','f_food','f_rep']
    .reduce((sum,id)=> sum + (parseFloat(document.getElementById(id).value)||0), 0);
  
  return {
    split: Number.isFinite(split) ? split : 0.80,
    fuel: Number.isFinite(fuel) ? fuel : 3.25,
    mpg: (Number.isFinite(mpg) && mpg>0) ? mpg : 6.5,
    maint: Number.isFinite(maint) ? maint : 0.17,
    fixedWeekly,
    loadsPerWeek,
    fixedPerLoad: fixedWeekly / loadsPerWeek,
    targetNet: Number.isFinite(targetNet) ? targetNet : 1500,
    taxRate: Number.isFinite(taxRate) ? taxRate : 0.25
  };
}

function bindSettingsToInputs(){
  const s = settings;
  document.getElementById('f_truck').value = s.f_truck;
  document.getElementById('f_trailer').value = s.f_trailer;
  document.getElementById('f_ins').value = s.f_ins;
  document.getElementById('f_adv').value = s.f_adv;
  document.getElementById('f_food').value = s.f_food;
  document.getElementById('f_rep').value = s.f_rep;
  document.getElementById('s_split').value = s.s_split;
  document.getElementById('s_fuel').value = s.s_fuel;
  document.getElementById('s_mpg').value = s.s_mpg;
  document.getElementById('s_maint').value = s.s_maint;
  document.getElementById('s_loads_per_week').value = s.s_loads_per_week;
  document.getElementById('s_target_net').value = s.s_target_net;
  document.getElementById('s_tax').value = s.s_tax;
  
  document.querySelectorAll("#settings input").forEach(inp => 
    inp.addEventListener("input", ()=>{ 
      preview(); 
      updateUI(); 
    })
  );
}

function saveSettings(){
  const s = {
    f_truck: parseFloat(document.getElementById('f_truck').value) || 0,
    f_trailer: parseFloat(document.getElementById('f_trailer').value) || 0,
    f_ins: parseFloat(document.getElementById('f_ins').value) || 0,
    f_adv: parseFloat(document.getElementById('f_adv').value) || 0,
    f_food: parseFloat(document.getElementById('f_food').value) || 0,
    f_rep: parseFloat(document.getElementById('f_rep').value) || 0,
    s_split: parseFloat(document.getElementById('s_split').value) || 0.8,
    s_fuel: parseFloat(document.getElementById('s_fuel').value) || 3.25,
    s_mpg: parseFloat(document.getElementById('s_mpg').value) || 6.5,
    s_maint: parseFloat(document.getElementById('s_maint').value) || 0.17,
    s_loads_per_week: Math.max(1, parseInt(document.getElementById('s_loads_per_week').value || "5", 10)),
    s_target_net: parseFloat(document.getElementById('s_target_net').value) || 1500,
    s_tax: parseFloat(document.getElementById('s_tax').value) || 0.25
  };
  
  settings = { ...defaultSettings, ...s };
  persistSettings(settings);
  alert("Global settings saved on this device.");
  updateUI();
}

function bindDriverOverridesToInputs(){
  const d = getDriver();
  const el = document.getElementById("d_split");
  const val = Number(d.splitOverride);
  el.value = (Number.isFinite(val) ? val : getSpecs().split);
}

function saveDriverOverrides(){
  const d = getDriver();
  const v = parseFloat(document.getElementById("d_split").value);
  if (!(Number.isFinite(v) && v > 0 && v < 1.00001)) 
    return alert("Enter a valid split like 0.80 or 0.88.");
  
  d.splitOverride = v;
  saveState();
  alert("Driver split override saved.");
  updateUI();
}

/************************* 
 * CALCS + DATE RANGE TOTALS 
 *************************/
function computeWeekTotals(week){
  const loads = week.loads || [];
  const gross = loads.reduce((s,l) => s + (Number(l.gross)||0), 0);
  const miles = loads.reduce((s,l) => s + (Number(l.miles)||0), 0);
  const net = loads.reduce((s,l) => s + (Number(l.net)||0), 0);
  const fuel = loads.reduce((s,l)=> s + (Number(l.details?.fuel)||0), 0);
  const maint = loads.reduce((s,l)=> s + (Number(l.details?.maint)||0), 0);
  const tolls = loads.reduce((s,l)=> s + (Number(l.details?.tolls)||0), 0);
  const fixed = loads.reduce((s,l)=> s + (Number(l.details?.fixed)||0), 0);
  const rpm = miles>0 ? gross/miles : 0;
  return { gross,miles,net,fuel,maint,tolls,fixed,rpm };
}

function loadDateFallback(load, week){
  if (load?.createdAt) {
    const d = new Date(load.createdAt);
    if (!isNaN(d)) return d;
  }
  if (week?.start) {
    const d = new Date(week.start + "T00:00:00");
    if (!isNaN(d)) return d;
  }
  return new Date(0);
}

function totalsForDriverInRange(driver, startDate, endDate){
  let gross=0,miles=0,net=0,fuel=0,maint=0,tolls=0,fixed=0,companyCut=0;
  const start = new Date(startDate);
  const end = new Date(endDate);
  
  for (const wkId of Object.keys(driver.weeks||{})){
    const w = driver.weeks[wkId];
    const loads = w.loads || [];
    for (const l of loads){
      const dt = loadDateFallback(l, w);
      if (dt >= start && dt <= end){
        gross += (Number(l.gross)||0);
        miles += (Number(l.miles)||0);
        net += (Number(l.net)||0);
        fuel += (Number(l.details?.fuel)||0);
        maint += (Number(l.details?.maint)||0);
        tolls += (Number(l.details?.tolls)||0);
        fixed += (Number(l.details?.fixed)||0);
        
        const splitUsed = Number.isFinite(Number(l.details?.split)) 
          ? Number(l.details.split) 
          : getDriverSplit(driver);
        companyCut += (Number(l.gross)||0) * (1 - splitUsed);
      }
    }
  }
  
  const rpm = miles>0 ? gross/miles : 0;
  return { gross,miles,net,fuel,maint,tolls,fixed,rpm,companyCut };
}

/************************* 
 * PREVIEW + WARN 
 *************************/
function preview(){
  const s = getSpecs();
  const driver = getDriver();
  const split = getDriverSplit(driver);
  
  const gross = parseFloat(document.getElementById('pay_gross').value) || 0;
  const miles = (parseFloat(document.getElementById('mi_load').value)||0) 
    + (parseFloat(document.getElementById('mi_dh').value)||0);
  const tolls = parseFloat(document.getElementById('cost_tolls').value) || 0;
  
  const fuel = (miles / s.mpg) * s.fuel;
  const maint = miles * s.maint;
  const fixed = s.fixedPerLoad;
  const net = (gross * split) - fuel - maint - fixed - tolls;
  
  const el = document.getElementById('preview_net');
  el.innerText = money(net);
  el.className = 'preview-value ' + (net >= 0 ? 'positive' : 'negative');
  
  const grossRpm = miles>0 ? gross/miles : 0;
  const beGross = miles>0 ? ((fuel + maint + fixed + tolls) / split) : 0;
  const beRpm = miles>0 ? (beGross/miles) : 0;
  
  document.getElementById('preview_hint').innerText = miles>0 
    ? `Split: ${(split*100).toFixed(0)}% ‚Ä¢ Gross RPM: ${money(grossRpm)} ‚Ä¢ Break-even RPM: ${money(beRpm)}`
    : "";
  
  const stickyEl = document.getElementById('sticky_preview');
  stickyEl.innerText = money(net);
  stickyEl.className = 'sticky-preview-value ' + (net >= 0 ? 'positive' : 'negative');
}

function updateWarnBanner(){
  const s = getSpecs();
  const wk = getCurrentWeek();
  const t = computeWeekTotals(wk);
  const warn = document.getElementById("warn");
  
  if (wk.loads.length > 0 && t.net < s.targetNet) {
    const gap = s.targetNet - t.net;
    warn.style.display = "block";
    warn.innerHTML = `‚ö†Ô∏è Target not met for <b>${escapeHtml(getDriver().name)}</b>: goal <b>${money(s.targetNet)}</b> ‚Ä¢ currently <b>${money(t.net)}</b> ‚Ä¢ gap <b>${money(gap)}</b>.`;
  } else {
    warn.style.display = "none";
    warn.innerHTML = "";
  }
}

/************************* 
 * LOAD CRUD 
 *************************/
function addLoad(){
  const originEl = document.getElementById('origin');
  const destEl = document.getElementById('dest');
  const origin = originEl.value.trim();
  const dest = destEl.value.trim();
  const gross = parseFloat(document.getElementById('pay_gross').value) || 0;
  const miles = (parseFloat(document.getElementById('mi_load').value)||0) 
    + (parseFloat(document.getElementById('mi_dh').value)||0);
  const tolls = parseFloat(document.getElementById('cost_tolls').value) || 0;
  
  if (!origin || !dest) return alert("Enter pickup & drop first.");
  if (gross <= 0 || miles <= 0) return alert("Enter miles and gross pay.");
  
  const oLat = Number(originEl.dataset.lat);
  const oLon = Number(originEl.dataset.lon);
  const dLat = Number(destEl.dataset.lat);
  const dLon = Number(destEl.dataset.lon);
  
  const s = getSpecs();
  const driver = getDriver();
  const split = getDriverSplit(driver);
  
  const fuel = (miles / s.mpg) * s.fuel;
  const maint = miles * s.maint;
  const fixed = s.fixedPerLoad;
  const cut = gross * split;
  const net = cut - fuel - maint - fixed - tolls;
  
  let routeGeo = null;
  try {
    routeGeo = JSON.parse(originEl.dataset.routeGeo || "null");
  } catch(e){ routeGeo=null; }
  
  const wk = getCurrentWeek();
  wk.loads.push({
    origin,
    dest,
    gross,
    miles,
    net,
    createdAt: new Date().toISOString(),
    details: {
      fuel,
      maint,
      fixed,
      tolls,
      cut,
      split,
      mpg: s.mpg,
      fuelPrice: s.fuel,
      maintRate: s.maint,
      loadsPerWeek: s.loadsPerWeek
    },
    coords: (Number.isFinite(oLat) && Number.isFinite(dLat)) 
      ? { start:{lat:oLat, lon:oLon}, end:{lat:dLat, lon:dLon} }
      : null,
    routeGeo
  });
  
  if (Number.isFinite(dLat) && Number.isFinite(dLon)) 
    wk.lastDropCoords = { lat: dLat, lon: dLon };
  else 
    wk.lastDropCoords = null;
  
  saveState();
  updateUI();
  initMap();
  
  ['origin','dest','mi_load','mi_dh','cost_tolls','pay_gross'].forEach(i => 
    document.getElementById(i).value=""
  );
  originEl.dataset.lat="";
  originEl.dataset.lon="";
  originEl.dataset.routeGeo="";
  destEl.dataset.lat="";
  destEl.dataset.lon="";
  document.getElementById('preview_net').innerText="$0.00";
  document.getElementById('preview_hint').innerText="";
  document.getElementById('sticky_preview').innerText="$0.00";
}

function delLoad(i){
  const wk = getCurrentWeek();
  wk.loads.splice(i,1);
  
  if (wk.loads.length === 0) 
    wk.lastDropCoords = null;
  else {
    const last = wk.loads[wk.loads.length-1];
    if (last?.coords?.end?.lat && last?.coords?.end?.lon) 
      wk.lastDropCoords = { lat:last.coords.end.lat, lon:last.coords.end.lon };
  }
  
  saveState();
  updateUI();
  initMap();
}

/************************* 
 * MODAL 
 *************************/
function viewDetail(i){
  const wk = getCurrentWeek();
  const l = wk.loads[i];
  if (!l) return;
  
  const splitUsed = Number.isFinite(Number(l.details?.split)) 
    ? Number(l.details.split) 
    : getDriverSplit(getDriver());
  
  document.getElementById('modal-content').innerHTML = `
    <div class="breakdown-row">
      <span>Gross:</span>
      <span class="positive">${money(l.gross)}</span>
    </div>
    <div class="breakdown-row">
      <span>Split Used:</span>
      <span>${(splitUsed*100).toFixed(0)}%</span>
    </div>
    <div class="breakdown-row">
      <span>Your Cut:</span>
      <span class="positive">${money(l.details?.cut || (l.gross*splitUsed))}</span>
    </div>
    <div class="breakdown-row">
      <span>Fuel Cost:</span>
      <span class="negative">-${money(l.details?.fuel || 0)}</span>
    </div>
    <div class="breakdown-row">
      <span>Fixed Share:</span>
      <span class="negative">-${money(l.details?.fixed || 0)}</span>
    </div>
    <div class="breakdown-row">
      <span>Maintenance:</span>
      <span class="negative">-${money(l.details?.maint || 0)}</span>
    </div>
    <div class="breakdown-row">
      <span>Tolls:</span>
      <span class="negative">-${money(l.details?.tolls || 0)}</span>
    </div>
    <div class="breakdown-row total">
      <span>NET PROFIT:</span>
      <span class="${(l.net||0)>=0?'positive':'negative'}">${money(l.net)}</span>
    </div>
    <div class="hint-text" style="margin-top: 12px;">
      Miles: <b>${Number(l.miles||0).toLocaleString()}</b> ‚Ä¢ 
      Gross RPM: <b>${money(l.miles>0 ? l.gross/l.miles : 0)}</b>
    </div>
  `;
  
  document.getElementById('modal').style.display='block';
  document.getElementById('overlay').style.display='block';
}

function closeModal(){
  document.getElementById('modal').style.display='none';
  document.getElementById('overlay').style.display='none';
}

/************************* 
 * MAP 
 *************************/
let map = null;
let dispatchMap = null;

function initMap(){
  if (!map){
    map = L.map('map').setView([39.82,-98.58],4);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
      attribution:'¬© OpenStreetMap'
    }).addTo(map);
  }
  
  map.eachLayer(layer => {
    if (layer && layer.toGeoJSON) map.removeLayer(layer);
  });
  
  const wk = getCurrentWeek();
  const pts = [];
  
  wk.loads.forEach((l,i)=>{
    if (l.coords && l.coords.start && l.coords.end){
      const s = l.coords.start, e = l.coords.end;
      
      L.marker([s.lat,s.lon]).addTo(map)
        .bindPopup(`<b>Load ${i+1} Pickup</b><br>${escapeHtml(l.origin)}`);
      L.marker([e.lat,e.lon]).addTo(map)
        .bindPopup(`<b>Load ${i+1} Drop</b><br>${escapeHtml(l.dest)}`);
      
      pts.push([s.lat,s.lon],[e.lat,e.lon]);
      
      if (l.routeGeo?.coordinates?.length){
        const latlngs = l.routeGeo.coordinates.map(c=>[c[1],c[0]]);
        L.polyline(latlngs,{
          color:'#00b4ff',
          weight:4,
          opacity:.70
        }).addTo(map);
      } else {
        L.polyline([[s.lat,s.lon],[e.lat,e.lon]],{
          color:'#00b4ff',
          weight:4,
          opacity:.55,
          dashArray:"6 8"
        }).addTo(map);
      }
    }
  });
  
  if (pts.length>0) map.fitBounds(pts,{ padding:[50,50] });
  map.invalidateSize();
}

function initDispatchMap(){
  if (!dispatchMap){
    dispatchMap = L.map('dispatchMap').setView([39.82,-98.58],4);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
      attribution:'¬© OpenStreetMap'
    }).addTo(dispatchMap);
  }
  
  dispatchMap.eachLayer(layer => {
    if (layer && layer.toGeoJSON) dispatchMap.removeLayer(layer);
  });
  
  const pts = [];
  const colors = ['#00b4ff', '#00ff88', '#ffb800', '#ff3366', '#c5d0df', '#00e5ff'];
  let colorIdx = 0;
  
  for (const id of Object.keys(state.drivers)){
    const d = state.drivers[id];
    const wk = d.weeks[d.currentWeekId] || { loads: [] };
    const color = colors[colorIdx % colors.length];
    colorIdx++;
    
    wk.loads.forEach((l,i)=>{
      if (l.coords && l.coords.start && l.coords.end){
        const s = l.coords.start, e = l.coords.end;
        
        L.marker([s.lat,s.lon]).addTo(dispatchMap)
          .bindPopup(`<b>${escapeHtml(d.name)} - Load ${i+1}</b><br>${escapeHtml(l.origin)}`);
        L.marker([e.lat,e.lon]).addTo(dispatchMap)
          .bindPopup(`<b>${escapeHtml(d.name)} - Load ${i+1}</b><br>${escapeHtml(l.dest)}`);
        
        pts.push([s.lat,s.lon],[e.lat,e.lon]);
        
        if (l.routeGeo?.coordinates?.length){
          const latlngs = l.routeGeo.coordinates.map(c=>[c[1],c[0]]);
          L.polyline(latlngs,{
            color: color,
            weight:3,
            opacity:.60
          }).addTo(dispatchMap);
        } else {
          L.polyline([[s.lat,s.lon],[e.lat,e.lon]],{
            color: color,
            weight:3,
            opacity:.50,
            dashArray:"6 8"
          }).addTo(dispatchMap);
        }
      }
    });
  }
  
  if (pts.length>0) dispatchMap.fitBounds(pts,{ padding:[50,50] });
  dispatchMap.invalidateSize();
}

/************************* 
 * DISPATCH VIEW 
 *************************/
function renderDispatchView(){
  let fleetGross=0, fleetNet=0, fleetMiles=0, fleetLoads=0;
  const driverCards = [];
  
  for (const id of Object.keys(state.drivers)){
    const d = state.drivers[id];
    const split = getDriverSplit(d);
    const wk = d.weeks[d.currentWeekId] || { loads: [] };
    const t = computeWeekTotals(wk);
    
    fleetGross += t.gross;
    fleetNet += t.net;
    fleetMiles += t.miles;
    fleetLoads += wk.loads.length;
    
    // Get last/current route
    let currentRoute = "No active loads";
    if (wk.loads.length > 0){
      const lastLoad = wk.loads[wk.loads.length - 1];
      currentRoute = `${escapeHtml(lastLoad.origin)} <span class="route-arrow">‚ûú</span> ${escapeHtml(lastLoad.dest)}`;
    }
    
    driverCards.push(`
      <div class="driver-card">
        <div class="driver-card-header">
          <div class="driver-name">${escapeHtml(d.name)}</div>
          <div class="driver-status active">Active</div>
        </div>
        
        <div class="driver-metrics">
          <div class="driver-metric">
            <div class="driver-metric-label">Loads</div>
            <div class="driver-metric-value">${wk.loads.length}</div>
          </div>
          <div class="driver-metric">
            <div class="driver-metric-label">Miles</div>
            <div class="driver-metric-value">${t.miles.toLocaleString()}</div>
          </div>
          <div class="driver-metric">
            <div class="driver-metric-label">Gross</div>
            <div class="driver-metric-value positive">${money(t.gross)}</div>
          </div>
          <div class="driver-metric">
            <div class="driver-metric-label">Net</div>
            <div class="driver-metric-value ${t.net>=0?'positive':'negative'}">${money(t.net)}</div>
          </div>
          <div class="driver-metric">
            <div class="driver-metric-label">RPM</div>
            <div class="driver-metric-value">${money(t.rpm)}</div>
          </div>
        </div>
        
        <div class="current-route">
          <div class="route-label">Current/Last Route</div>
          <div class="route-display">${currentRoute}</div>
        </div>
        
        <div class="driver-actions">
          <button class="action-btn" onclick="setCurrentDriverFromFleet('${id}')">View Details</button>
          <button class="action-btn" onclick="copyDriverSummary('${id}')">Copy Summary</button>
        </div>
      </div>
    `);
  }
  
  document.getElementById('fleet_count').innerText = Object.keys(state.drivers).length;
  document.getElementById('fleet_loads').innerText = fleetLoads;
  document.getElementById('fleet_gross').innerText = money(fleetGross);
  
  const fleetNetEl = document.getElementById('fleet_net');
  fleetNetEl.innerText = money(fleetNet);
  fleetNetEl.className = 'stat-value ' + (fleetNet >= 0 ? 'positive' : 'negative');
  
  document.getElementById('fleet_rpm').innerText = money(fleetMiles > 0 ? fleetGross/fleetMiles : 0);
  
  document.getElementById('driverCards').innerHTML = driverCards.join('');
}

async function copyDriverSummary(driverId){
  const d = state.drivers[driverId];
  if (!d) return;
  
  const split = getDriverSplit(d);
  const wk = d.weeks[d.currentWeekId] || { loads: [] };
  const t = computeWeekTotals(wk);
  
  const summary = `DRIVER: ${d.name}
Week: ${wk.label}
Split: ${(split*100).toFixed(0)}%

Loads: ${wk.loads.length}
Miles: ${t.miles.toLocaleString()}
Gross: ${money(t.gross)}
Net: ${money(t.net)}
RPM: ${money(t.rpm)}`;
  
  try{
    await navigator.clipboard.writeText(summary);
    alert(`Summary for ${d.name} copied!`);
  } catch(e){
    prompt("Copy this summary:", summary);
  }
}

/************************* 
 * ROUTING + GEO 
 *************************/
function sleep(ms){
  return new Promise(r=>setTimeout(r,ms));
}

async function fetchWithTimeout(url, ms=12000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), ms);
  try {
    return await fetch(url, { signal: ctrl.signal });
  } finally {
    clearTimeout(t);
  }
}

async function fetchRetry(url, tries=2, waitMs=700){
  let lastErr=null;
  for (let i=0;i<tries;i++){
    try{
      const res = await fetchWithTimeout(url, 15000);
      if (!res.ok){
        if ((res.status===429 || res.status>=500) && i<tries-1){
          await sleep(waitMs*(i+1));
          continue;
        }
        throw new Error(`HTTP ${res.status}`);
      }
      return res;
    } catch(e){
      lastErr=e;
      if (i<tries-1) await sleep(waitMs*(i+1));
    }
  }
  throw lastErr;
}

function loadGeoCache(){
  return JSON.parse(localStorage.getItem(GEO_CACHE_KEY) || "{}");
}

function saveGeoCache(cache){
  localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(cache));
}

function normalizeCity(q){
  return String(q||"").trim().toLowerCase().replace(/\s+/g," ");
}

async function getLoc(city){
  const q = normalizeCity(city);
  if (!q) return null;
  
  const cache = loadGeoCache();
  const hit = cache[q];
  const now = Date.now();
  const TTL = 1000*60*60*24*30;
  
  if (hit?.ts && (now-hit.ts)<TTL) return hit.data;
  
  const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=0&limit=1&q=${encodeURIComponent(city + ", USA")}`;
  const res = await fetchRetry(url, 2, 700);
  const data = await res.json();
  
  if (!data?.[0]) return null;
  
  cache[q] = { ts: now, data: data[0] };
  saveGeoCache(cache);
  return data[0];
}

async function osrmRouteMilesGeo(lon1, lat1, lon2, lat2){
  const url = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson&steps=false`;
  const res = await fetchRetry(url, 2, 700);
  const j = await res.json();
  
  if (!j?.routes?.[0]) throw new Error("Route not found");
  
  const r = j.routes[0];
  return {
    miles: Math.round(r.distance * 0.000621371),
    geo: r.geometry
  };
}

async function calcRoute(){
  const o = document.getElementById('origin').value;
  const d = document.getElementById('dest').value;
  if (!o || !d) return alert("Enter cities first");
  
  try{
    setStatus("Finding cities‚Ä¶", true);
    const locA = await getLoc(o);
    const locB = await getLoc(d);
    
    if (!locA || !locB){
      setStatus("City not found (check spelling)", true);
      setTimeout(()=>setStatus("", false), 3000);
      return;
    }
    
    const oLat = Number(locA.lat), oLon = Number(locA.lon);
    const dLat = Number(locB.lat), dLon = Number(locB.lon);
    
    document.getElementById('origin').dataset.lat = oLat;
    document.getElementById('origin').dataset.lon = oLon;
    document.getElementById('dest').dataset.lat = dLat;
    document.getElementById('dest').dataset.lon = dLon;
    
    setStatus("Calculating loaded route‚Ä¶", true);
    const loaded = await osrmRouteMilesGeo(oLon,oLat,dLon,dLat);
    document.getElementById('mi_load').value = loaded.miles;
    
    const wk = getCurrentWeek();
    if (wk.lastDropCoords?.lat && wk.lastDropCoords?.lon){
      setStatus("Calculating deadhead‚Ä¶", true);
      const dh = await osrmRouteMilesGeo(
        wk.lastDropCoords.lon, 
        wk.lastDropCoords.lat, 
        oLon, 
        oLat
      );
      document.getElementById('mi_dh').value = dh.miles;
    } else {
      document.getElementById('mi_dh').value = 0;
    }
    
    document.getElementById('origin').dataset.routeGeo = JSON.stringify(loaded.geo || null);
    setStatus("", false);
    preview();
  } catch(e){
    console.error(e);
    setStatus("Routing failed (try again in 30s)", true);
    setTimeout(()=>setStatus("", false), 3500);
  }
}

/************************* 
 * TOOLS 
 *************************/
function verifyMap(){
  const o = document.getElementById('origin').value;
  const d = document.getElementById('dest').value;
  if (o && d) 
    window.open(`https://www.google.com/maps/dir/${encodeURIComponent(o)}/${encodeURIComponent(d)}`);
}

function checkTolls(){
  const o = document.getElementById('origin').value;
  const d = document.getElementById('dest').value;
  if (!o || !d) return;
  
  navigator.clipboard.writeText(o + " to " + d).then(()=>{
    alert("Copied route. Paste into TollGuru.");
    window.open('https://tollguru.com/toll-calculator');
  }).catch(()=>{
    alert("Could not copy automatically. Open TollGuru and paste route manually.");
    window.open('https://tollguru.com/toll-calculator');
  });
}

function swapCities(){
  const o = document.getElementById('origin');
  const d = document.getElementById('dest');
  const tmp = o.value;
  o.value = d.value;
  d.value = tmp;
  preview();
}

/************************* 
 * EXPORT / COPY / PRINT 
 *************************/
async function copySummary(){
  const d = getDriver();
  const wk = getCurrentWeek();
  const s = getSpecs();
  const t = computeWeekTotals(wk);
  const split = getDriverSplit(d);
  
  const summary = `DISPATCH COMMAND CENTER ‚Äî WEEK SUMMARY

Driver: ${d.name}
Week: ${wk.label}
Split: ${(split*100).toFixed(0)}%

Loads: ${wk.loads.length}
Gross: ${money(t.gross)}
Miles: ${t.miles.toLocaleString()}
Net: ${money(t.net)}
Gross RPM: ${money(t.miles>0 ? t.gross/t.miles : 0)}

Target: ${money(s.targetNet)} (${t.net>=s.targetNet ? "MET ‚úÖ" : "SHORT ‚ùå by " + money(s.targetNet - t.net)})`;
  
  try{
    await navigator.clipboard.writeText(summary);
    alert("Weekly summary copied.");
  } catch(e){
    prompt("Copy this summary:", summary);
  }
}

function exportCSV(scope="week"){
  alert("CSV export is available. Would you like me to add full CSV/print functionality?");
}

function printWeeklySummary(){
  alert("Print functionality is available. Would you like me to add full print templates?");
}

function printDriverYTD(){
  alert("Print YTD is available. Would you like me to add full print templates?");
}

/************************* 
 * ANALYTICS RENDER 
 *************************/
function pct(v){
  return (Number(v||0)*100).toFixed(1) + "%";
}

function setCurrentDriverFromFleet(driverId){
  state.currentDriverId = driverId;
  saveState();
  renderDriverSelect();
  renderWeekSelect();
  bindDriverOverridesToInputs();
  updateUI();
  
  // Switch to dashboard tab
  const dashTab = document.querySelector('.nav-tab[onclick*="dashboard"]');
  if (dashTab) showTab('dashboard', dashTab);
  
  setTimeout(initMap, 150);
}

function updateFleetTables(){
  const now = new Date();
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1, 0,0,0,0);
  const yearStart = new Date(now.getFullYear(), 0, 1, 0,0,0,0);
  
  const fleetBody = document.getElementById("fleetTable");
  const cutBody = document.getElementById("cutTable");
  
  let fleetRows = [];
  let cutRows = [];
  let fleetCutCW=0, fleetCutMTD=0, fleetCutYTD=0, fleetGrossYTD=0;
  
  for (const id of Object.keys(state.drivers)){
    const d = state.drivers[id];
    const split = getDriverSplit(d);
    
    const wk = d.weeks[d.currentWeekId] || { loads: [] };
    const cw = computeWeekTotals(wk);
    const mtd = totalsForDriverInRange(d, monthStart, now);
    const ytd = totalsForDriverInRange(d, yearStart, now);
    
    fleetRows.push(`
      <tr>
        <td style="font-weight:800;">${escapeHtml(d.name)}</td>
        <td>${pct(split)}</td>
        <td class="positive">${money(cw.gross)}</td>
        <td>${money(cw.rpm)}</td>
        <td class="${cw.net>=0?'positive':'negative'}">${money(cw.net)}</td>
        <td class="positive">${money(mtd.gross)}</td>
        <td>${money(mtd.rpm)}</td>
        <td class="${mtd.net>=0?'positive':'negative'}">${money(mtd.net)}</td>
        <td class="positive">${money(ytd.gross)}</td>
        <td>${money(ytd.rpm)}</td>
        <td class="${ytd.net>=0?'positive':'negative'}">${money(ytd.net)}</td>
        <td><button class="action-btn" onclick="setCurrentDriverFromFleet('${id}')">Open</button></td>
      </tr>
    `);
    
    const cwCut = cw.gross * (1 - split);
    cutRows.push(`
      <tr>
        <td style="font-weight:800;">${escapeHtml(d.name)}</td>
        <td>${pct(split)}</td>
        <td class="positive">${money(cw.gross)}</td>
        <td class="positive">${money(cwCut)}</td>
        <td class="positive">${money(mtd.gross)}</td>
        <td class="positive">${money(mtd.companyCut)}</td>
        <td class="positive">${money(ytd.gross)}</td>
        <td class="positive">${money(ytd.companyCut)}</td>
      </tr>
    `);
    
    fleetCutCW += cwCut;
    fleetCutMTD += mtd.companyCut;
    fleetCutYTD += ytd.companyCut;
    fleetGrossYTD += ytd.gross;
  }
  
  fleetBody.innerHTML = fleetRows.join("") || `<tr><td colspan="12">No drivers found.</td></tr>`;
  cutBody.innerHTML = cutRows.join("") || `<tr><td colspan="8">No drivers found.</td></tr>`;
  
  document.getElementById("cut_cw").innerText = money(fleetCutCW);
  document.getElementById("cut_mtd").innerText = money(fleetCutMTD);
  document.getElementById("cut_ytd").innerText = money(fleetCutYTD);
  
  const weightedTake = fleetGrossYTD > 0 ? (fleetCutYTD / fleetGrossYTD) : 0;
  document.getElementById("cut_take").innerText = pct(weightedTake);
}

/************************* 
 * WEEKLY CHART 
 *************************/
let weeklyChart = null;

function renderWeeklyChart(){
  const d = getDriver();
  const weekIds = Object.keys(d.weeks).sort();
  
  const labels = [];
  const netData = [];
  const grossData = [];
  
  weekIds.forEach(id => {
    const w = d.weeks[id];
    const t = computeWeekTotals(w);
    labels.push(w.label || id);
    netData.push(t.net);
    grossData.push(t.gross);
  });
  
  const ctx = document.getElementById('weeklyChart');
  if (!ctx) return;
  
  if (weeklyChart) {
    weeklyChart.destroy();
  }
  
  weeklyChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Net Profit',
          data: netData,
          borderColor: '#00ff88',
          backgroundColor: 'rgba(0,255,136,0.1)',
          borderWidth: 3,
          tension: 0.4,
          fill: true
        },
        {
          label: 'Gross Revenue',
          data: grossData,
          borderColor: '#00b4ff',
          backgroundColor: 'rgba(0,180,255,0.1)',
          borderWidth: 3,
          tension: 0.4,
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: {
            color: '#f0f4f8',
            font: {
              family: 'Rajdhani',
              size: 14,
              weight: 700
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            color: '#a8b5c7',
            font: {
              family: 'Rajdhani',
              size: 12
            },
            callback: function(value) {
              return '$' + value.toLocaleString();
            }
          },
          grid: {
            color: 'rgba(200,210,220,0.08)'
          }
        },
        x: {
          ticks: {
            color: '#a8b5c7',
            font: {
              family: 'Rajdhani',
              size: 11
            },
            maxRotation: 45,
            minRotation: 45
          },
          grid: {
            color: 'rgba(200,210,220,0.05)'
          }
        }
      }
    }
  });
}

/************************* 
 * UI RENDER 
 *************************/
function updateUI(){
  const d = getDriver();
  const wk = getCurrentWeek();
  const loads = wk.loads;
  const s = getSpecs();
  const totals = computeWeekTotals(wk);
  
  document.getElementById('wk_gross').innerText = money(totals.gross);
  document.getElementById('wk_miles').innerText = totals.miles.toLocaleString();
  
  const wkProfitEl = document.getElementById('wk_profit');
  wkProfitEl.innerText = money(totals.net);
  wkProfitEl.className = "stat-value " + (totals.net>=0 ? "positive" : "negative");
  
  document.getElementById('wk_rpm').innerText = money(totals.rpm);
  
  const split = getDriverSplit(d);
  const wkCosts = (totals.gross * split) - totals.net;
  const wkBreakEvenGross = split>0 ? (wkCosts / split) : 0;
  const wkBERpm = totals.miles>0 ? (wkBreakEvenGross / totals.miles) : 0;
  document.getElementById('wk_be_rpm').innerText = money(wkBERpm);
  
  document.getElementById('loadList').innerHTML = loads.map((l,i)=>{
    const grossRpm = l.miles>0 ? l.gross/l.miles : 0;
    return `
      <tr>
        <td style="font-weight:700;font-size:13px;">
          ${escapeHtml(l.origin)} 
          <span style="color:var(--accent-cyan)">‚ûú</span> 
          ${escapeHtml(l.dest)}
        </td>
        <td>${Number(l.miles||0).toLocaleString()}</td>
        <td class="positive">${money(l.gross)}</td>
        <td class="${(l.net||0)>=0?'positive':'negative'}">${money(l.net)}</td>
        <td>${money(grossRpm)}</td>
        <td>
          <button class="action-btn" onclick="viewDetail(${i})">Detail</button>
          <button class="action-btn delete" onclick="delLoad(${i})">X</button>
        </td>
      </tr>
    `;
  }).join("");
  
  // YTD stats
  const now = new Date();
  const yearStart = new Date(now.getFullYear(), 0, 1, 0,0,0,0);
  const ytd = totalsForDriverInRange(d, yearStart, now);
  
  document.getElementById('ytd_gross').innerText = money(ytd.gross);
  document.getElementById('ytd_profit').innerText = money(ytd.net);
  document.getElementById('ytd_tax').innerText = money(ytd.net * s.taxRate);
  document.getElementById('oer_val').innerText = ytd.gross>0 
    ? Math.round(((ytd.gross - ytd.net)/ytd.gross)*100)+'%' 
    : '0%';
  document.getElementById('ytd_fuel').innerText = money(ytd.fuel);
  document.getElementById('ytd_maint').innerText = money(ytd.maint);
  
  // Best/worst
  let best=null,worst=null;
  for (const wkId of Object.keys(d.weeks||{})){
    const t = computeWeekTotals(d.weeks[wkId]);
    if (!best || t.net > best.net) best = { net: t.net };
    if (!worst || t.net < worst.net) worst = { net: t.net };
  }
  document.getElementById('best_week').innerText = money(best?.net || 0);
  document.getElementById('worst_week').innerText = money(worst?.net || 0);
  
  // Week history
  const weekIds = Object.keys(d.weeks).sort().reverse();
  document.getElementById('weekHistory').innerHTML = weekIds.map(id=>{
    const w = d.weeks[id];
    const t = computeWeekTotals(w);
    const rpm = t.miles>0 ? (t.gross/t.miles) : 0;
    return `
      <tr>
        <td style="font-weight:800;">${escapeHtml(w.label || id)}</td>
        <td>${(w.loads||[]).length}</td>
        <td>${t.miles.toLocaleString()}</td>
        <td class="positive">${money(t.gross)}</td>
        <td class="${t.net>=0?'positive':'negative'}">${money(t.net)}</td>
        <td>${money(rpm)}</td>
      </tr>
    `;
  }).join("");
  
  updateWarnBanner();
  preview();
  renderDriverSelect();
  renderWeekSelect();
  bindDriverOverridesToInputs();
  updateFleetTables();
}

/************************* 
 * FACTORY RESET 
 *************************/
function factoryReset(){
  if (!confirm("Factory reset clears ALL drivers + weeks + loads + settings on this device. Continue?")) return;
  
  localStorage.removeItem(STORE_KEY);
  localStorage.removeItem(SETTINGS_KEY);
  localStorage.removeItem(GEO_CACHE_KEY);
  location.reload();
}

/************************* 
 * INIT 
 *************************/
function ensureCurrentDriverHasThisWeek(){
  const d = getDriver();
  const wk = startOfWeekMonday(new Date());
  const baseId = isoDate(wk);
  
  if (!d.weeks[baseId]) {
    d.weeks[baseId] = {
      start: baseId,
      label: fmtWeekLabel(wk),
      loads: [],
      lastDropCoords: null
    };
    saveState();
  }
}

function wireEntryKeyNav(){
  const ids = ["origin","dest","mi_load","mi_dh","cost_tolls","pay_gross"];
  ids.forEach((id, idx)=>{
    const el = document.getElementById(id);
    el.addEventListener("keydown",(e)=>{
      if (e.key === "Enter"){
        e.preventDefault();
        const next = document.getElementById(ids[idx+1] || "pay_gross");
        if (next) next.focus();
      }
    });
    el.addEventListener("input", preview);
  });
}

ensureCurrentDriverHasThisWeek();
bindSettingsToInputs();
wireEntryKeyNav();
renderDriverSelect();
renderWeekSelect();
bindDriverOverridesToInputs();
updateUI();
setTimeout(initMap, 500);


/************************* 
 * AUTHENTICATION FUNCTIONS 
 *************************/
function switchAuthTab(tab) {
  const loginTab = document.getElementById('loginTab');
  const signupTab = document.getElementById('signupTab');
  const loginForm = document.getElementById('loginForm');
  const signupForm = document.getElementById('signupForm');
  
  if (tab === 'login') {
    loginTab.classList.add('active');
    signupTab.classList.remove('active');
    loginForm.classList.add('active');
    signupForm.classList.remove('active');
  } else {
    signupTab.classList.add('active');
    loginTab.classList.remove('active');
    signupForm.classList.add('active');
    loginForm.classList.remove('active');
  }
}

async function handleLogin() {
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  const btn = document.getElementById('loginBtn');
  const errorEl = document.getElementById('loginError');
  
  btn.disabled = true;
  btn.textContent = 'Logging in...';
  errorEl.classList.remove('show');
  
  try {
    await auth.signInWithEmailAndPassword(email, password);
  } catch (error) {
    console.error('Login error:', error);
    errorEl.textContent = getFirebaseErrorMessage(error.code);
    errorEl.classList.add('show');
    btn.disabled = false;
    btn.textContent = 'Login to Command Center';
  }
}

async function handleSignup() {
  const email = document.getElementById('signupEmail').value;
  const password = document.getElementById('signupPassword').value;
  const confirmPassword = document.getElementById('signupPasswordConfirm').value;
  const btn = document.getElementById('signupBtn');
  const errorEl = document.getElementById('signupError');
  
  errorEl.classList.remove('show');
  
  if (password !== confirmPassword) {
    errorEl.textContent = 'Passwords do not match';
    errorEl.classList.add('show');
    return;
  }
  
  btn.disabled = true;
  btn.textContent = 'Creating Account...';
  
  try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    await initializeUserData(userCredential.user.uid);
  } catch (error) {
    console.error('Signup error:', error);
    errorEl.textContent = getFirebaseErrorMessage(error.code);
    errorEl.classList.add('show');
    btn.disabled = false;
    btn.textContent = 'Create Account';
  }
}

function getFirebaseErrorMessage(code) {
  const messages = {
    'auth/email-already-in-use': 'This email is already registered',
    'auth/invalid-email': 'Invalid email address',
    'auth/weak-password': 'Password should be at least 6 characters',
    'auth/user-not-found': 'No account found with this email',
    'auth/wrong-password': 'Incorrect password',
    'auth/too-many-requests': 'Too many attempts. Please try again later',
    'auth/network-request-failed': 'Network error. Check your connection'
  };
  return messages[code] || 'An error occurred. Please try again.';
}

async function initializeUserData(userId) {
  const wk = startOfWeekMonday(new Date());
  const baseId = isoDate(wk);
  
  const initialData = {
    currentDriverId: "driver_1",
    drivers: {
      "driver_1": {
        name: "Driver 1",
        splitOverride: null,
        currentWeekId: baseId,
        weeks: {
          [baseId]: {
            start: baseId,
            label: fmtWeekLabel(wk),
            loads: [],
            lastDropCoords: null
          }
        }
      }
    },
    settings: {
      f_truck: 800,
      f_trailer: 400,
      f_ins: 350,
      f_adv: 0,
      f_food: 0,
      f_rep: 0,
      s_split: 0.80,
      s_fuel: 3.25,
      s_mpg: 6.5,
      s_maint: 0.17,
      s_loads_per_week: 5,
      s_target_net: 1500,
      s_tax: 0.25
    }
  };
  
  await db.collection('users').doc(userId).set(initialData);
  console.log("‚úÖ User data initialized");
}

async function handleLogout() {
  if (confirm('Are you sure you want to logout?')) {
    try {
      await auth.signOut();
    } catch (error) {
      console.error('Logout error:', error);
      alert('Error logging out. Please try again.');
    }
  }
}

// Auth state observer
auth.onAuthStateChanged(async (user) => {
  const authScreen = document.getElementById('authScreen');
  const appContent = document.getElementById('appContent');
  
  if (user) {
    currentUser = user;
    console.log("‚úÖ User logged in:", user.email);
    
    // Load user data from Firestore
    try {
      const doc = await db.collection('users').doc(user.uid).get();
      
      if (doc.exists) {
        const data = doc.data();
        state = data;
        settings = data.settings || settings;
        console.log("‚úÖ Data loaded from cloud");
      } else {
        console.log("No cloud data, initializing...");
        await initializeUserData(user.uid);
      }
      
      // Update UI with user email
      const emailEl = document.getElementById('userEmail');
      if (emailEl) emailEl.textContent = user.email;
      
      // Hide auth, show app
      authScreen.classList.add('hidden');
      appContent.classList.add('show');
      
      // Initialize app
      ensureCurrentDriverHasThisWeek();
      bindSettingsToInputs();
      wireEntryKeyNav();
      renderDriverSelect();
      renderWeekSelect();
      bindDriverOverridesToInputs();
      updateUI();
      setTimeout(initMap, 500);
      
    } catch (error) {
      console.error('Error loading data:', error);
      alert('Error loading your data. Please try refreshing.');
    }
  } else {
    currentUser = null;
    authScreen.classList.remove('hidden');
    appContent.classList.remove('show');
  }
});

// Override saveState to sync with Firestore
const originalSaveState = saveState;
saveState = async function() {
  // Save locally first
  localStorage.setItem(STORE_KEY, JSON.stringify(state));
  
  // Sync to Firestore if logged in
  if (currentUser && db) {
    try {
      await db.collection('users').doc(currentUser.uid).set({
        ...state,
        settings: settings,
        lastModified: new Date().toISOString()
      }, { merge: true });
      console.log("‚òÅÔ∏è Synced to cloud");
    } catch (error) {
      console.error("Cloud sync error:", error);
    }
  }
};


</script>
</div>
</body>
</html>
